<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="StaffMaps">
<meta name="theme-color" content="#1a1a1a">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">
<title>StaffMaps — Tactical Map Engine</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{--bg:#1a1a1a;--fg:#f0f0f0;--accent:#4a9eff;--accent2:#ffd700;--panel-bg:#1a1a1a;--btn-bg:rgba(255,255,255,0.1);--btn-hover:rgba(255,255,255,0.2);--border:rgba(255,255,255,0.15);--danger:#ff4444;--success:#44cc44;--warning:#ffaa00;--safe-top:env(safe-area-inset-top,0px);--safe-right:env(safe-area-inset-right,0px);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-left:env(safe-area-inset-left,0px);--font:'SF Mono','Fira Code',Consolas,Monaco,monospace;--ui-scale:1}
[data-theme="light"]{--bg:#f0f0f0;--fg:#222;--panel-bg:rgba(245,245,245,0.97);--btn-bg:rgba(0,0,0,0.08);--btn-hover:rgba(0,0,0,0.15);--border:rgba(0,0,0,0.15)}
[data-theme="light"] select,[data-theme="light"] input[type="text"],[data-theme="light"] input[type="number"],[data-theme="light"] input[type="password"],[data-theme="light"] textarea{background:#fff;color:#222;border-color:rgba(0,0,0,.2)}
[data-theme="light"] select option{background:#fff;color:#222}
[data-theme="light"] .btn{background:rgba(0,0,0,.06);color:#222;border-color:rgba(0,0,0,.15)}
[data-theme="light"] .btn:hover{background:rgba(0,0,0,.12)}
[data-theme="light"] .btn.primary{background:rgba(74,158,255,.15);color:#1a6fcc;border-color:rgba(74,158,255,.4)}
[data-theme="light"] .btn.danger{color:#cc2222}
[data-theme="light"] .float-panel{background:rgba(245,245,245,0.97);box-shadow:0 4px 20px rgba(0,0,0,.15)}
[data-theme="light"] .editor-overlay{background:rgba(245,245,245,0.97);box-shadow:0 4px 24px rgba(0,0,0,.15)}
[data-theme="light"] #app{background:#e8e8e8}[data-theme="light"] .topbar{background:rgba(245,245,245,0.97)}
[data-theme="light"] .file-menu{background:rgba(245,245,245,0.98)}
[data-theme="light"] .mode-bar{background:rgba(245,245,245,0.97)}
[data-theme="light"] .toast{background:#333;color:#fff}
[data-theme="light"] .fp-body select option{background:#fff;color:#222}
[data-theme="light"] .ed-btn{background:rgba(0,0,0,.06);color:#222;border-color:rgba(0,0,0,.15)}
[data-theme="light"] .ed-btn.active{background:rgba(74,158,255,.15);border-color:var(--accent);color:#1a6fcc}
[data-theme="light"] .stack-btn:hover{background:#ddd;border-color:rgba(0,0,0,.3)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;background:#1a1a2e}body{width:100%;height:100%;min-height:100vh;min-height:-webkit-fill-available;margin:0;padding:0;overflow:hidden;overscroll-behavior:none;font-family:var(--font);background:#1a1a2e;color:var(--fg);touch-action:none;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}
@supports (-webkit-touch-callout: none){input,select,textarea{font-size:16px!important}}
#app{position:fixed;inset:0;display:flex;flex-direction:column;background:#1a1a2e}
.topbar{box-sizing:border-box;padding:0 4px;padding-top:calc(4px + var(--safe-top));padding-bottom:4px;padding-left:calc(4px + var(--safe-left));padding-right:calc(4px + var(--safe-right));display:flex;align-items:center;justify-content:space-between;background:var(--panel-bg);border-bottom:1px solid var(--border);z-index:100;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);flex-shrink:0;position:relative;zoom:var(--ui-scale)}
.topbar-left{display:flex;align-items:center;gap:6px}.topbar-dot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}.topbar-dot.connected{background:var(--success);box-shadow:0 0 4px var(--success)}.topbar-dot.connecting{background:var(--warning)}.topbar-dot.error{background:var(--danger)}
.topbar-title{font-size:13px;font-weight:700;letter-spacing:2px}.topbar-right{display:flex;align-items:center;gap:6px}.topbar-coords{font-size:10px;opacity:0.7;white-space:nowrap}
.btn{background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:4px;font-family:var(--font);font-size:11px;cursor:pointer;padding:4px 8px;touch-action:manipulation;transition:background .15s}.btn:hover{background:var(--btn-hover)}.btn:active{background:rgba(255,255,255,.25)}.btn.danger{border-color:var(--danger);color:var(--danger)}.btn.primary{border-color:var(--accent);color:var(--accent)}
.main{flex:1;position:relative;overflow:hidden}.main>#mapCanvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
.icon-stack{position:absolute;top:calc(4px + var(--safe-top));right:calc(4px + var(--safe-right));display:flex;flex-direction:column;gap:3px;z-index:70;zoom:var(--ui-scale);pointer-events:auto}
.stack-btn{width:44px;height:44px;border-radius:8px;border:1px solid var(--border);background:var(--panel-bg);display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation;position:relative;transition:background .15s,border-color .15s;box-shadow:0 1px 4px rgba(0,0,0,.3)}.stack-btn:hover{background:#333;border-color:rgba(255,255,255,.5)}.stack-btn.active{border-color:var(--accent);background:var(--accent);box-shadow:0 0 8px rgba(74,158,255,.4)}.stack-btn.active svg{stroke:#fff}.stack-btn.conn-blue svg{stroke:#4a9eff}.stack-btn.conn-green svg{stroke:#44cc44}.stack-btn svg{width:20px;height:20px;stroke:var(--fg);stroke-width:2.5;fill:none;stroke-linecap:round;stroke-linejoin:round}.stack-btn .badge{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:var(--danger);color:#fff;font-size:9px;display:flex;align-items:center;justify-content:center;padding:0 3px;font-weight:700}
.float-panel{position:absolute;top:calc(4px + var(--safe-top));right:calc(52px + var(--safe-right));width:min(320px,calc(100vw - 60px - var(--safe-right) - var(--safe-left)));max-height:calc(100% - 8px - var(--safe-top) - var(--safe-bottom));background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;z-index:65;display:none;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:slideIn .2s ease-out;zoom:var(--ui-scale)}.float-panel.open{display:flex}
@keyframes slideIn{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.fp-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0}.fp-title{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.fp-body{overflow-y:auto;padding:8px 10px;flex:1;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.2) transparent}.fp-body::-webkit-scrollbar{width:6px}.fp-body::-webkit-scrollbar-track{background:transparent}.fp-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}.fp-body::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.35)}
[data-theme="light"] .fp-body{scrollbar-color:rgba(0,0,0,.2) transparent}[data-theme="light"] .fp-body::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2)}[data-theme="light"] .fp-body::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.35)}.fp-body label{display:block;font-size:10px;opacity:.6;margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}.fp-body label.switch,.fp-body label.switch-sm{display:inline-block;opacity:1;font-size:inherit;margin-bottom:0;text-transform:none;letter-spacing:normal}.fp-body select,.fp-body input[type="text"],.fp-body input[type="number"],.fp-body input[type="password"]{width:100%;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:var(--font);font-size:11px;margin-bottom:8px;-webkit-appearance:none;appearance:none}.fp-body input,.editor-body input{autocomplete:off}.fp-body select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}.fp-body select option{background:#222;color:#e0e0e0}.fp-body input[type="range"]{width:100%;margin-bottom:8px}.fp-body .section{margin-bottom:12px}.fp-body .section-title{font-size:11px;font-weight:700;margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}.fp-body .row{display:flex;gap:4px;margin-bottom:4px}.fp-body .row .btn{flex:1}.fp-body .toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}.fp-body .toggle-row span{font-size:11px}
.editor-overlay{position:absolute;bottom:calc(4px + var(--safe-bottom));right:calc(52px + var(--safe-right));width:min(33vw,360px);min-width:280px;max-height:calc(var(--app-h,100vh) - 100px - var(--safe-top) - var(--safe-bottom));background:var(--panel-bg);border:1px solid var(--border);border-radius:12px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:60;display:none;flex-direction:column;animation:slideRight .2s ease-out;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.4);zoom:var(--ui-scale);color-scheme:dark}.editor-overlay.open{display:flex}@keyframes slideRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
[data-theme="light"] .editor-overlay{color-scheme:light}
.editor-grip{width:100%;height:20px;display:flex;align-items:center;justify-content:center;cursor:ns-resize;flex-shrink:0;touch-action:none}.editor-grip::after{content:'';width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)}
.editor-header{display:flex;align-items:center;justify-content:space-between;padding:4px 6px 4px 10px;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;z-index:1;background:transparent;border-radius:12px 12px 0 0;gap:4px}.editor-tabs{display:flex;gap:2px;min-width:0;overflow:hidden}
.editor-tab{padding:4px 8px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;border-radius:4px 4px 0 0;background:transparent;color:var(--fg);opacity:.5;border:none;font-family:var(--font);touch-action:manipulation;white-space:nowrap}.editor-tab.active{opacity:1;background:var(--btn-bg)}.editor-actions{display:flex;gap:4px;flex-shrink:0;margin-left:auto}
.editor-body{overflow-y:auto;overflow-x:hidden;padding:8px 10px;padding-bottom:12px;flex:1;-webkit-overflow-scrolling:touch;min-height:0;border-radius:0 0 12px 12px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.2) transparent}
.editor-body::-webkit-scrollbar{width:6px}.editor-body::-webkit-scrollbar-track{background:transparent}.editor-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}.editor-body::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.35)}
[data-theme="light"] .editor-body{scrollbar-color:rgba(0,0,0,.2) transparent}[data-theme="light"] .editor-body::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2)}[data-theme="light"] .editor-body::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.35)}
.editor-body .toggle-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}.editor-body .toggle-row span{font-size:11px}
.editor-body label{display:block;font-size:10px;opacity:.6;margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}.editor-body label.switch,.editor-body label.switch-sm{display:inline-block;opacity:1;font-size:inherit;margin-bottom:0;text-transform:none;letter-spacing:normal}
.editor-body input[type="range"]{width:100%;accent-color:var(--accent);-webkit-appearance:none;appearance:none;height:20px;background:transparent;outline:none;touch-action:none;margin:0}
.editor-body input[type="range"]::-webkit-slider-runnable-track{height:4px;background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,50%),rgba(255,255,255,.15) var(--val,50%),rgba(255,255,255,.15) 100%);border-radius:2px}
.editor-body input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4);transition:transform .1s;margin-top:-8px}
.editor-body input[type="range"]::-webkit-slider-thumb:active{transform:scale(1.2)}
.editor-body input[type="range"]::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.editor-body input[type="range"]::-moz-range-progress{background:var(--accent);border-radius:2px;height:4px}
.editor-body input[type="range"]::-moz-range-track{background:rgba(255,255,255,.15);border-radius:2px;height:4px}
[data-theme="light"] .editor-body input[type="range"]::-webkit-slider-runnable-track{background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,50%),rgba(0,0,0,.12) var(--val,50%),rgba(0,0,0,.12) 100%)}
[data-theme="light"] .editor-body input[type="range"]::-moz-range-track{background:rgba(0,0,0,.12)}
.switch-sm{position:relative;display:inline-block;width:34px;height:18px;flex-shrink:0}.switch-sm input{display:none}.switch-sm .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.25);border-radius:9px;transition:background .3s;border:none}.switch-sm .slider::before{content:'';position:absolute;height:14px;width:14px;left:2px;top:2px;background:rgba(255,255,255,.7);border-radius:50%;transition:transform .3s,background .3s}.switch-sm input:checked+.slider{background:var(--accent)}.switch-sm input:checked+.slider::before{transform:translateX(16px);background:#fff}
[data-theme="light"] .switch-sm .slider{background:rgba(0,0,0,.2)}[data-theme="light"] .switch-sm .slider::before{background:rgba(255,255,255,.9)}
.ed-section-title{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.5;margin:6px 0 3px}
.ed-input{width:100%;box-sizing:border-box;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:3px;padding:4px 6px;font-family:var(--font);font-size:11px;margin-bottom:4px}
.ed-btn-row{display:flex;flex-wrap:wrap;gap:2px;margin-bottom:4px}
.ed-btn{padding:3px 7px;font-size:10px;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:3px;cursor:pointer;font-family:var(--font);white-space:nowrap;transition:all .1s}.ed-btn:hover{background:rgba(255,255,255,.1);border-color:var(--fg)}.ed-btn.active{background:rgba(74,158,255,.25);border-color:var(--accent);color:#fff}
.icon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:3px;margin-bottom:8px}.icon-cell{aspect-ratio:1;border:2px solid transparent;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;background:transparent;touch-action:manipulation;transition:border-color .15s}.icon-cell:hover{border-color:rgba(255,255,255,.3)}[data-theme="light"] .icon-cell:hover{border-color:rgba(0,0,0,.2)}.icon-cell.selected{border-color:#ffd700;background:rgba(255,215,0,.08)}.icon-cell canvas{width:100%;height:100%}.icon-cell .tooltip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;white-space:nowrap;pointer-events:none;display:none;z-index:999}.icon-cell:hover .tooltip{display:block}
.color-swatches{display:flex;gap:6px;margin:4px 0 8px}.swatch{width:28px;height:28px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:border-color .15s,transform .1s}.swatch:hover{transform:scale(1.15)}.swatch.active{border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.5)}
.cat-header{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;padding:4px 0;margin-top:6px;cursor:pointer;display:flex;align-items:center;gap:4px;opacity:.7}.cat-header::before{content:'\25b8';font-size:8px;transition:transform .15s}.cat-header.open::before{transform:rotate(90deg)}
.mode-bar{position:absolute;bottom:calc(4px + var(--safe-bottom));left:50%;transform:translateX(-50%);background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:6px 10px;display:none;align-items:center;gap:8px;z-index:55;white-space:nowrap;box-shadow:0 2px 12px rgba(0,0,0,.4);zoom:var(--ui-scale)}.mode-bar.open{display:flex}.mode-info{font-size:11px;opacity:.8}.mode-bar .btn{min-width:44px;min-height:36px;font-size:14px}.mode-bar .btn.done{border-color:var(--accent2);color:var(--accent2)}.mode-bar .btn.done.ready{animation:goldPulse 1.5s infinite}@keyframes goldPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px var(--accent2)}}
.zoom-ctrl{position:absolute;bottom:calc(4px + var(--safe-bottom));right:calc(4px + var(--safe-right));display:flex;flex-direction:column;gap:3px;z-index:50;zoom:var(--ui-scale)}.zoom-ctrl .btn{width:44px;height:44px;font-size:18px;font-weight:700;border-radius:8px;background:var(--panel-bg);color:var(--fg);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.3);padding:0;min-height:unset}
.layer-indicator{position:absolute;bottom:calc(4px + var(--safe-bottom));left:calc(4px + var(--safe-left));display:flex;align-items:center;gap:4px;font-size:10px;opacity:.6;z-index:50}.layer-indicator .dot{width:8px;height:8px;border-radius:50%}
.file-menu{position:absolute;top:100%;left:0;min-width:220px;max-width:calc(100vw - 20px - var(--safe-left) - var(--safe-right));max-height:calc(var(--app-h,100vh) - 80px);overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--panel-bg);border:1px solid var(--border);border-radius:6px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:110;display:none;padding:4px 0}.file-menu.open{display:block}.file-menu .fm-section{padding:2px 8px;font-size:9px;text-transform:uppercase;letter-spacing:1px;opacity:.4;margin-top:4px}.file-menu .fm-item{padding:10px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;touch-action:manipulation;min-height:44px}.file-menu .fm-item:hover{background:var(--btn-hover)}.file-menu .fm-item.disabled{opacity:.3;pointer-events:none}.file-menu .fm-divider{height:1px;background:var(--border);margin:2px 0}.file-menu .fm-status{padding:4px 12px;font-size:9px;opacity:.4}
.toast{position:fixed;top:40px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;font-family:var(--font);z-index:9999;border:1px solid var(--accent);animation:toastIn .3s ease-out;box-shadow:0 4px 12px rgba(0,0,0,.4)}.toast.error{border-color:var(--danger)}@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.export-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;display:flex;align-items:center;justify-content:center;padding:16px}
.export-modal{background:var(--panel-bg);border:1px solid var(--border);border-radius:12px;width:min(420px,100%);max-height:80vh;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.export-modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700}
.export-modal-body{overflow-y:auto;padding:12px 16px;flex:1;-webkit-overflow-scrolling:touch}
.export-modal-footer{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.export-check-row{display:flex;align-items:center;gap:8px;padding:5px 4px;border-radius:4px;cursor:pointer;font-size:11px}.export-check-row:hover{background:var(--btn-hover)}
.export-check-row input[type=checkbox]{width:14px;height:14px;accent-color:var(--accent);cursor:pointer;flex-shrink:0}
.export-pkg-header{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;opacity:.5;margin:10px 0 4px;padding-left:4px}
.map-tooltip{position:fixed;background:rgba(20,20,30,.9);color:#fff;padding:3px 8px;border-radius:4px;font-size:11px;font-family:var(--font);pointer-events:none;z-index:100;white-space:nowrap;display:none;border:1px solid rgba(255,255,255,.2)}
.color-swatches{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px}.color-swatch{width:22px;height:22px;border-radius:3px;cursor:pointer;border:2px solid transparent;touch-action:manipulation}.color-swatch.selected{border-color:#fff;box-shadow:0 0 4px rgba(255,255,255,.5)}
.switch{position:relative;display:inline-block;width:42px;height:24px;flex-shrink:0;overflow:visible}.switch input{position:absolute;opacity:0;width:0;height:0;pointer-events:none}.switch .slider{display:block;width:42px;height:24px;background:rgba(255,255,255,.25);border-radius:12px;cursor:pointer;position:relative}.switch .slider::before{content:'';position:absolute;height:20px;width:20px;left:2px;top:2px;background:rgba(255,255,255,.7);border-radius:50%;transition:transform .3s}.switch input:checked+.slider{background:var(--accent)}.switch input:checked+.slider::before{transform:translateX(18px);background:#fff}
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:20px;background:transparent;outline:none;touch-action:none;margin:0}input[type="range"]::-webkit-slider-runnable-track{height:4px;background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,50%),rgba(255,255,255,.15) var(--val,50%),rgba(255,255,255,.15) 100%);border-radius:2px}input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4);margin-top:-7px}input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}input[type="range"]::-moz-range-progress{background:var(--accent);border-radius:2px;height:4px}input[type="range"]::-moz-range-track{background:rgba(255,255,255,.15);border-radius:2px;height:4px}
[data-theme="light"] input[type="range"]::-webkit-slider-runnable-track{background:linear-gradient(to right,var(--accent) 0%,var(--accent) var(--val,50%),rgba(0,0,0,.12) var(--val,50%),rgba(0,0,0,.12) 100%)}[data-theme="light"] input[type="range"]::-moz-range-track{background:rgba(0,0,0,.12)}
.layer-item{display:flex;align-items:center;gap:4px;padding:4px;border-radius:4px;margin-bottom:2px;cursor:pointer;font-size:11px}.layer-item:hover{background:var(--btn-hover)}.layer-item.active{background:rgba(74,158,255,.1);border-left:2px solid var(--accent)}.layer-item .layer-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px currentColor}.layer-item .layer-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.layer-item .layer-eye{opacity:.5;cursor:pointer;font-size:12px}.layer-item .layer-eye.visible{opacity:1}
.layer-objects{margin-left:18px;margin-bottom:6px}.layer-obj{display:flex;align-items:center;gap:4px;padding:3px 4px;border-radius:3px;margin-bottom:1px;cursor:pointer;font-size:10px;opacity:.8}.layer-obj:hover{background:var(--btn-hover);opacity:1}.layer-obj.active{background:rgba(74,158,255,.1);opacity:1}.layer-obj .layer-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.layer-move-select{background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:3px;font-size:9px;font-family:var(--font);padding:1px 4px;max-width:70px;-webkit-appearance:none;appearance:none;cursor:pointer}
.layer-rename-input{touch-action:manipulation}
.preview-wrap{display:flex;justify-content:center;margin-bottom:8px}.preview-wrap canvas{border:1px solid var(--border);border-radius:4px;background:#2a3a4a}
@media(max-width:700px){.topbar .btn{min-height:28px;padding:4px 8px}.float-panel{right:calc(52px + var(--safe-right));left:0;width:auto;max-height:50vh;top:auto;bottom:0;border-radius:12px 12px 0 0;padding-bottom:var(--safe-bottom)}.editor-overlay{right:calc(52px + var(--safe-right));left:0;bottom:0;width:auto;min-width:0;max-height:min(45vh,calc(var(--app-h,100vh) - 56px));min-height:180px;border-radius:12px 12px 0 0;box-shadow:0 -2px 20px rgba(0,0,0,.4);animation:slideUp .2s ease-out}.layer-item{padding:8px 6px;min-height:40px}.layer-obj{padding:6px 4px;min-height:36px;font-size:11px}.layer-move-select{font-size:11px;padding:4px 6px;max-width:90px}.btn{min-height:36px;padding:6px 10px}.stack-btn{width:48px;height:48px}.zoom-ctrl .btn{width:48px;height:48px;min-height:48px;padding:0}.editor-tab{padding:8px 8px;font-size:10px}.editor-actions .btn{min-width:36px;min-height:40px;padding:6px 8px;font-size:13px}.editor-header{align-items:stretch;padding-right:4px;padding-left:6px}.editor-tabs{align-items:stretch}.editor-tab{display:flex;align-items:center}.editor-grip{height:28px}.draw-tool-btn,.ed-btn{min-height:36px}.ed-btn-row{flex-wrap:wrap;overflow:hidden}.ed-btn-row .ed-btn{min-height:36px;flex:1 1 auto;white-space:nowrap}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}}
@media(min-width:501px) and (max-width:900px){.float-panel{width:300px}}
@media(max-height:500px) and (min-width:700px) and (min-aspect-ratio:2/1){
.icon-stack{flex-direction:row;top:auto;right:auto;bottom:calc(4px + var(--safe-bottom));left:50%;transform:translateX(-50%);gap:3px}
.stack-btn{width:36px;height:36px}
.float-panel{left:calc(4px + var(--safe-left));right:auto;top:calc(4px + var(--safe-top));bottom:auto;max-height:calc(100% - 50px - var(--safe-top) - var(--safe-bottom));width:min(280px,40vw);padding-bottom:0;border-radius:8px}
.zoom-ctrl{flex-direction:column;bottom:calc(44px + var(--safe-bottom));right:calc(12px + var(--safe-right));top:auto;left:auto;transform:none}
.zoom-ctrl .btn{width:36px;height:36px;min-height:36px;font-size:15px;padding:0}
.zoom-ctrl .stack-btn{width:36px;height:36px}
.editor-overlay{left:calc(4px + var(--safe-left));right:auto;bottom:calc(44px + var(--safe-bottom));top:auto;width:min(45vw,340px);min-width:220px;max-height:calc(100% - 50px - var(--safe-top) - var(--safe-bottom));border-radius:8px;animation:slideRight .2s ease-out}
.topbar{font-size:11px;padding-top:calc(2px + var(--safe-top));padding-bottom:2px}.topbar .btn{min-height:26px;padding:3px 8px;font-size:11px}
.layer-indicator{bottom:calc(44px + var(--safe-bottom));left:calc(4px + var(--safe-left))}
.mode-bar{bottom:calc(44px + var(--safe-bottom))}
.file-menu{left:auto;right:auto;max-width:min(240px,45vw);margin-top:2px}.topbar-left{position:relative}
}


@supports(padding-bottom:env(safe-area-inset-bottom)){#app::after{content:'';position:fixed;left:0;right:0;bottom:0;height:env(safe-area-inset-bottom,0px);background:inherit;z-index:9999;pointer-events:none}}
</style>
</head>
<body>
<div id="app"></div><div class="map-tooltip" id="map-tooltip"></div>
<script>
"use strict";

// === part_01_constants.js ===

const SVG_W=120,SVG_H=140,CX=60,CY=62,FRAME_W=70,FRAME_H=50,U=10,DEG=Math.PI/180,TILE_SIZE=256,MAX_UNDO=30;
const TILE_SOURCES={esri_topo:{name:"ESRI Topo",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",maxZoom:19},osm:{name:"OpenStreetMap",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:19},esri_sat:{name:"ESRI Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:19},esri_natgeo:{name:"ESRI NatGeo",url:"https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",maxZoom:16},opentopo:{name:"OpenTopo",url:"https://tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17},usgs_topo:{name:"USGS Topo",url:"https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}",maxZoom:16},google_sat:{name:"Google Satellite",url:"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",maxZoom:20},google_hybrid:{name:"Google Hybrid",url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",maxZoom:20},google_terrain:{name:"Google Terrain",url:"https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",maxZoom:20},google_roads:{name:"Google Roads",url:"https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",maxZoom:20}};
const AFFILIATIONS={friendly:{color:"#000",fill:"#80E0FF",shape:"rect",label:"Friendly"},hostile:{color:"#000",fill:"#FF8080",shape:"diamond",label:"Hostile"},neutral:{color:"#000",fill:"#AAFFAA",shape:"square",label:"Neutral"},unknown:{color:"#000",fill:"#FFFF80",shape:"quatrefoil",label:"Unknown"}};
const UNIT_CATEGORIES=[{name:"Infantry, Tanks & Artillery",types:[{id:"infantry",label:"Infantry"},{id:"naval_infantry",label:"Naval Infantry"},{id:"mechanized_infantry",label:"Mech Infantry"},{id:"ifv",label:"IFV"},{id:"armor",label:"Armor"},{id:"armored_wheeled",label:"Armor (Whl)"},{id:"cavalry",label:"Cavalry"},{id:"armored_recon",label:"Armored Cav"},{id:"artillery",label:"Field Artillery"},{id:"mechanized_artillery",label:"Mech Artillery"},{id:"rocket_artillery",label:"Rocket Arty"},{id:"mortar",label:"Mortar"},{id:"air_defense",label:"Air Defense Arty"},{id:"anti_armor",label:"Anti-Armor"},{id:"magtf",label:"MAGTF"}]},{name:"Aviation & Air Defense",types:[{id:"aviation",label:"Aviation"},{id:"attack_aviation",label:"Attack Aviation"},{id:"recon_aviation",label:"Recon Aviation"},{id:"medevac_aviation",label:"MEDEVAC"},{id:"uav",label:"UAS"},{id:"sam",label:"SAM"}]},{name:"Engineer",types:[{id:"engineer",label:"Engineer"},{id:"bridging",label:"Bridging"}]},{name:"Command, Signal & EW",types:[{id:"headquarters",label:"HQ"},{id:"signal",label:"Signal"},{id:"military_intelligence",label:"MI"},{id:"electronic_warfare",label:"EW"},{id:"cyber",label:"Cyber"}]},{name:"Logistics & Medical",types:[{id:"sustainment",label:"Sustainment"},{id:"medical",label:"Medical"},{id:"maintenance",label:"Maintenance"},{id:"transportation",label:"Transport"},{id:"supply",label:"Supply"},{id:"ordnance",label:"Ordnance"}]},{name:"Special Forces",types:[{id:"special_forces",label:"SF"},{id:"ranger",label:"Ranger"},{id:"civil_affairs",label:"Civil Affairs"},{id:"psyop",label:"PSYOP"}]},{name:"Waypoints",types:[{id:"waypoint",label:"Waypoint"}]}];
const TYPE_LABELS={};UNIT_CATEGORIES.forEach(c=>c.types.forEach(t=>{TYPE_LABELS[t.id]=t.label}));
const ECHELONS=[{id:"team",label:"Team/Crew",mark:"slashO"},{id:"squad",label:"Squad",mark:"dot1"},{id:"section",label:"Section",mark:"dot2"},{id:"platoon",label:"Platoon",mark:"dot3"},{id:"company",label:"Company",mark:"bar1"},{id:"battalion",label:"Battalion",mark:"bar2"},{id:"regiment",label:"Regt/Group",mark:"bar3"},{id:"brigade",label:"Brigade",mark:"x1"},{id:"division",label:"Division",mark:"x2"},{id:"corps",label:"Corps",mark:"x3"},{id:"army",label:"Theater Army",mark:"x4"},{id:"army_group",label:"Army Group",mark:"x5"},{id:"theater",label:"Theater",mark:"x6"},{id:"command",label:"Command",mark:"cmd"}];
const MODIFIERS=[{id:"reinforced",label:"+",symbol:"+"},{id:"reduced",label:"\u2212",symbol:"\u2212"},{id:"airborne",label:"Airborne",symbol:"\u2297"},{id:"air_assault",label:"Air Assault",symbol:"\u2298"},{id:"mountain",label:"Mountain",symbol:"\u25b2"},{id:"arctic",label:"Arctic",symbol:"\u2744"},{id:"amphibious",label:"Amphibious",symbol:"\u2248"},{id:"light",label:"Light",symbol:"L"},{id:"heavy",label:"Heavy",symbol:"H"},{id:"motorized",label:"Motorized",symbol:"\u2299"},{id:"mechanized",label:"Mechanized",symbol:"\u229b"},{id:"wheeled",label:"Wheeled",symbol:"W"}];
const EQUIPMENT_DEFAULTS={infantry:{vehicle:"HMMWV",crew:9,weapon:"M4/M249",maxRange:3600},naval_infantry:{vehicle:"AAV-7A1",crew:21,weapon:"M4/M249/Mk19",maxRange:3600},mechanized_infantry:{vehicle:"M2 Bradley",crew:9,weapon:"25mm/TOW",maxRange:3750,sensorRange:4000},ifv:{vehicle:"M2A3 Bradley",crew:9,weapon:"25mm/TOW",maxRange:3750,sensorRange:4000,speed:61},armor:{vehicle:"M1A2 Abrams",crew:4,weapon:"120mm",maxRange:4000,sensorRange:5000,speed:67},armored_wheeled:{vehicle:"Stryker",crew:9,weapon:"M2/.50 cal",maxRange:1800,sensorRange:4000,speed:97},cavalry:{vehicle:"M3 Bradley",crew:5,weapon:"25mm/TOW",maxRange:3750,sensorRange:6000},artillery:{vehicle:"M777",crew:8,weapon:"155mm",maxRange:30000},mechanized_artillery:{vehicle:"M109A7",crew:4,weapon:"155mm",maxRange:30000,speed:56},rocket_artillery:{vehicle:"M270 MLRS",crew:3,weapon:"MLRS",maxRange:70000},mortar:{vehicle:"M1129",crew:4,weapon:"120mm Mortar",maxRange:7200},air_defense:{vehicle:"M-SHORAD",crew:3,weapon:"Stinger/30mm",maxRange:8000,sensorRange:15000},anti_armor:{vehicle:"HMMWV",crew:4,weapon:"Javelin/TOW",maxRange:4750},magtf:{vehicle:"Various",crew:0,weapon:"Combined Arms"},aviation:{vehicle:"UH-60",crew:4,speed:294},attack_aviation:{vehicle:"AH-64D",crew:2,weapon:"Hellfire/30mm",maxRange:8000,sensorRange:12000,speed:293},uav:{vehicle:"MQ-1C Gray Eagle",sensorRange:25000,speed:280},sam:{vehicle:"Patriot",crew:3,weapon:"MIM-104",maxRange:160000,sensorRange:180000},engineer:{vehicle:"M9 ACE",crew:1},special_forces:{crew:12,weapon:"Various"},ranger:{crew:12,weapon:"Various"}};
const GRAPHIC_COLORS=["#ff4444","#4a9eff","#44cc44","#ffd700","#80E0FF","#FF8080","#80FF80","#FFFF80","#ff8800","#ffffff","#000000","#00ffff","#ff00ff","#8b4513"];
const OVERLAY_TYPES=[{id:"none",label:"Basic"},{id:"pl",label:"Phase Line"},{id:"ld",label:"Line of Departure"},{id:"boundary",label:"Boundary"},{id:"aa",label:"Assembly Area"},{id:"axis",label:"Axis of Advance"},{id:"route",label:"Route"}];


// === part_02_state_coords.js ===

let canvas,ctx;const tileCache=new Map();let _renderQueued=false,_fileMenuOpen=false;
const S={lat:38.8977,lon:-77.0365,zoom:12,tileSource:"esri_topo",theme:"dark",showGrid:true,showLabels:true,gridOpacity:0.25,gridColor:"#000000",gridMode:"mgrs",gridSpacing:"auto",coordDisplay:"mgrs",units:[],graphics:[],layers:[{id:"default",name:"Default",color:"#4a9eff",visible:true}],packages:[],activeLayerId:"default",selectedUnitId:null,selectedGraphicId:null,editorTab:"icon",editorPinned:false,_activePanel:null,_drawMode:null,_placementMode:null,_isPanning:false,_panStart:null,_lastPointerType:"mouse",_activePointers:new Map(),_pinchStartDist:null,_pinchStartZoom:null,_layout:"desktop",_isLandscape:false,undoStack:[],_net:{peer:null,conns:[],isHost:false,roomCode:null,hostConn:null,mode:"offline",persistentRoom:null,editMode:"observer",joinOrder:0,nextJoinOrder:1,peerName:localStorage.getItem("staffmaps_callsign")||"",peerNames:{},status:"",encEnabled:false,encKey:null,passphrase:"",chatMessages:[],unreadCount:0,chatTarget:"room",sharedLayers:{},sharedEditLayer:null,editScope:"local",defaultJoinMode:"view",peerPermissions:{},editRequests:[],editRequestStatus:null,roomRoster:[],
/* Wargame */
wargame:{active:false,phase:"planning",/* planning|execution */
roles:{},/* peerId -> {role:"blufor"|"opfor"|"observer", name:""} */
myRole:null,/* for peers: assigned role */
layerRoles:{},/* layerId -> "blufor"|"opfor"|"gm"|"all" */
orders:[],/* {id,peerId,role,type:"move"|"fire"|"draw",data:{},status:"pending"|"approved"|"denied"} */
turnNumber:1,turnLog:[]}},uiScale:parseFloat(localStorage.getItem("tacmap-uiscale")||"1.0"),iconSize:localStorage.getItem("tacmap-iconsize")||"medium",_overrides:JSON.parse(localStorage.getItem("tacmap-overrides")||'{}'),_mapTool:null,_measurePoints:[],_measureArea:[],_hoveredPtIdx:null,_hoveredPtGid:null};

function latlonToPixel(lat,lon,zoom){const s=Math.pow(2,zoom)*TILE_SIZE;return{x:((lon+180)/360)*s,y:(0.5-Math.log((1+Math.sin(lat*DEG))/(1-Math.sin(lat*DEG)))/(4*Math.PI))*s}}
function pixelToLatlon(px,py,zoom){const s=Math.pow(2,zoom)*TILE_SIZE,n=Math.PI-2*Math.PI*py/s;return{lat:(180/Math.PI)*Math.atan(.5*(Math.exp(n)-Math.exp(-n))),lon:(px/s)*360-180}}
function worldToScreen(wx,wy){const d=devicePixelRatio||1,c=latlonToPixel(S.lat,S.lon,S.zoom);return{x:(wx-c.x)*d+canvas.width/2,y:(wy-c.y)*d+canvas.height/2}}
function screenToWorld(sx,sy){const d=devicePixelRatio||1,c=latlonToPixel(S.lat,S.lon,S.zoom);return{x:(sx-canvas.width/2)/d+c.x,y:(sy-canvas.height/2)/d+c.y}}
function screenToLatlon(sx,sy){const d=devicePixelRatio||1,w=screenToWorld(sx*d,sy*d);return pixelToLatlon(w.x,w.y,S.zoom)}
function latlonToScreen(lat,lon){const p=latlonToPixel(lat,lon,S.zoom),s=worldToScreen(p.x,p.y),d=devicePixelRatio||1;return{x:s.x/d,y:s.y/d}}
function latlonToUTM(lat,lon){const z=Math.floor((lon+180)/6)+1,lo=(z-1)*6-180+3,a=6378137,ff=1/298.257223563,e2=2*ff-ff*ff,ep2=e2/(1-e2),k0=.9996,lr=lat*DEG,lonR=lon*DEG,l0=lo*DEG,N=a/Math.sqrt(1-e2*Math.sin(lr)*Math.sin(lr)),T=Math.tan(lr)**2,C=ep2*Math.cos(lr)**2,A=Math.cos(lr)*(lonR-l0),M=a*((1-e2/4-3*e2**2/64-5*e2**3/256)*lr-(3*e2/8+3*e2**2/32+45*e2**3/1024)*Math.sin(2*lr)+(15*e2**2/256+45*e2**3/1024)*Math.sin(4*lr)-(35*e2**3/3072)*Math.sin(6*lr));let e=k0*N*(A+(1-T+C)*A**3/6+(5-18*T+T**2+72*C-58*ep2)*A**5/120)+500000,n=k0*(M+N*Math.tan(lr)*(A**2/2+(5-T+9*C+4*C**2)*A**4/24+(61-58*T+T**2+600*C-330*ep2)*A**6/720));if(lat<0)n+=10000000;return{zone:z,easting:e,northing:n,letter:"CDEFGHJKLMNPQRSTUVWX"[lat<-80||lat>84?-1:Math.floor((lat+80)/8)]||"Z"}}
function UTMToLatlon(zone,easting,northing,northern){const a=6378137,ff=1/298.257223563,e2=2*ff-ff*ff,ep2=e2/(1-e2),e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2)),k0=.9996,x=easting-500000,y=northern?northing:northing-10000000,M=y/k0,mu=M/(a*(1-e2/4-3*e2**2/64-5*e2**3/256)),p1=mu+(3*e1/2-27*e1**3/32)*Math.sin(2*mu)+(21*e1**2/16-55*e1**4/32)*Math.sin(4*mu)+(151*e1**3/96)*Math.sin(6*mu),N1=a/Math.sqrt(1-e2*Math.sin(p1)**2),T1=Math.tan(p1)**2,C1=ep2*Math.cos(p1)**2,R1=a*(1-e2)/(1-e2*Math.sin(p1)**2)**1.5,D=x/(N1*k0);return{lat:(p1-(N1*Math.tan(p1)/R1)*(D**2/2-(5+3*T1+10*C1-4*C1**2-9*ep2)*D**4/24+(61+90*T1+298*C1+45*T1**2-252*ep2-3*C1**2)*D**6/720))/DEG,lon:(D-(1+2*T1+C1)*D**3/6+(5-2*C1+28*T1-3*C1**2+8*ep2+24*T1**2)*D**5/120)/Math.cos(p1)/DEG+(zone-1)*6-180+3}}
function toMGRS(lat,lon){try{const u=latlonToUTM(lat,lon),s=(u.zone-1)%6,cL="ABCDEFGHJKLMNPQRSTUVWXYZ",rL=s%2===0?"ABCDEFGHJKLMNPQRSTUV":"FGHJKLMNPQRSTUVABCDE",c=Math.floor(u.easting/1e5),r=Math.floor(u.northing%2e6/1e5);return`${u.zone}${u.letter} ${cL[(c-1+s*8)%24]||"?"}${rL[r%20]||"?"} ${String(Math.floor(u.easting%1e5)).padStart(5,"0")} ${String(Math.floor(u.northing%1e5)).padStart(5,"0")}`}catch(e){return"---"}}
function metersToPixels(m,lat,zoom){return m/((Math.cos(lat*DEG)*2*Math.PI*6378137)/(Math.pow(2,zoom)*TILE_SIZE))}
function haversine(lat1,lon1,lat2,lon2){const R=6371000,dLat=(lat2-lat1)*DEG,dLon=(lon2-lon1)*DEG,a=Math.sin(dLat/2)**2+Math.cos(lat1*DEG)*Math.cos(lat2*DEG)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
function formatDist(m){return m<1000?(m.toFixed(0)+"m"):(m/1000).toFixed(2)+"km"}
function polyArea(pts){/* Spherical excess for geodesic polygon area */if(pts.length<3)return 0;const R=6371000;let total=0;for(let i=0;i<pts.length;i++){const j=(i+1)%pts.length,k=(i+2)%pts.length;const lat1=pts[i].lat*DEG,lon1=pts[i].lon*DEG,lat2=pts[j].lat*DEG,lon2=pts[j].lon*DEG,lat3=pts[k].lat*DEG,lon3=pts[k].lon*DEG;total+=(lon3-lon1)*Math.sin(lat2)}return Math.abs(total*R*R/2)}
function formatArea(m2){return m2<1e6?(m2.toFixed(0)+" m²"):(m2/1e6).toFixed(2)+" km²"}
function parseMGRS(s){/* Parse MGRS string like "18S UJ 234 067" */try{s=s.replace(/\s+/g,"").toUpperCase();const m=s.match(/^(\d{1,2})([C-X])([A-Z]{2})(\d+)$/);if(!m)return null;const zone=parseInt(m[1]),band=m[2],sq=m[3],digits=m[4];if(digits.length%2!==0)return null;const half=digits.length/2,e5=parseInt(digits.substr(0,half)),n5=parseInt(digits.substr(half));const prec=5-half,eStr=String(e5).padEnd(5,"0"),nStr=String(n5).padEnd(5,"0");/* Decode 100km square */const L="ABCDEFGHJKLMNPQRSTUVWXYZ",sIdx=(zone-1)%6;const colLetter=sq[0],rowLetter=sq[1];const col=L.indexOf(colLetter);if(col<0)return null;const e100k=((col-sIdx*8%24+24)%24+1)*1e5;const rL=sIdx%2===0?"ABCDEFGHJKLMNPQRSTUV":"FGHJKLMNPQRSTUVABCDE";const row=rL.indexOf(rowLetter);if(row<0)return null;/* Band baseline */const bandIdx="CDEFGHJKLMNPQRSTUVWX".indexOf(band);if(bandIdx<0)return null;const bandLat=-80+bandIdx*8;const baseN=Math.floor(latlonToUTM(bandLat,(zone-1)*6-180+3).northing/2e6)*2e6;let n100k=row*1e5+baseN;/* Ensure northing is in correct band by checking ±2M */const easting=parseInt(eStr)+e100k;for(let adj=-2e6;adj<=4e6;adj+=2e6){const tryN=n100k+adj+parseInt(nStr);const nor=bandLat>=0;try{const ll=UTMToLatlon(zone,easting,tryN,nor);if(ll.lat>=bandLat-1&&ll.lat<=bandLat+9)return ll}catch(ex){}}return null}catch(ex){return null}}
function parseCoordInput(s){/* Try lat,lon first */s=s.trim();const llm=s.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);if(llm){const lat=parseFloat(llm[1]),lon=parseFloat(llm[2]);if(lat>=-90&&lat<=90&&lon>=-180&&lon<=180)return{lat,lon}}/* Try MGRS */const mgrs=parseMGRS(s);if(mgrs)return mgrs;return null}


// === part_03_render.js ===

function requestRender(){if(_renderQueued)return;_renderQueued=true;requestAnimationFrame(()=>{_renderQueued=false;render()})}
function clampView(){S.lat=Math.max(-80,Math.min(84,S.lat));const s=Math.pow(2,S.zoom)*TILE_SIZE;const halfScreenPx=window.innerWidth/(2*(devicePixelRatio||1));const cp=latlonToPixel(S.lat,S.lon,S.zoom);/* If screen is wider than the world, center it */if(halfScreenPx*2>=s){S.lon=0}else{if(cp.x-halfScreenPx<0){S.lon=pixelToLatlon(halfScreenPx,cp.y,S.zoom).lon}else if(cp.x+halfScreenPx>s){S.lon=pixelToLatlon(s-halfScreenPx,cp.y,S.zoom).lon}}}
var _gridFade=1,_gridFont="SF Mono,Fira Code,Consolas,Monaco,monospace";
function render(){if(!canvas||!ctx)return;clampView();const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;ctx.clearRect(0,0,W,H);ctx.fillStyle=S.theme==="dark"?"#1a1a2e":"#e8e8e8";ctx.fillRect(0,0,W,H);drawTiles();
if(_zoomAnim){_gridFade=0;return}
if(S._isPanning){_gridFade=0}
if(S.showGrid){if(_gridFade<1){ctx.save();ctx.globalAlpha=_gridFade*S.gridOpacity/Math.max(0.01,S.gridOpacity);drawGrid();ctx.restore();_gridFade=Math.min(1,_gridFade+0.2);requestRender()}else{drawGrid()}}
drawGraphics();capturePreviewBg();drawUnits();drawWargameOrders();drawMapTools();drawDrawPreview();drawFreehandPreview()}
/* Capture map background behind selected unit for live preview (before units drawn) */
let _previewBgData=null;
function capturePreviewBg(){
  _previewBgData=null;
  const u=S.units.find(x=>x.id===S.selectedUnitId);if(!u)return;
  const pcv=document.getElementById("preview-cv");if(!pcv)return;
  try{
    const d=devicePixelRatio||1,sp=latlonToScreen(u.lat,u.lon);
    const cropW=120,cropH=120;
    const sx=Math.round(sp.x*d-cropW/2),sy=Math.round(sp.y*d-cropH/2);
    const srcX=Math.max(0,sx),srcY=Math.max(0,sy);
    const srcW=Math.min(cropW,canvas.width-srcX),srcH=Math.min(cropH,canvas.height-srcY);
    if(srcW<=0||srcH<=0)return;
    _previewBgData={srcX,srcY,srcW,srcH,dstX:srcX-sx,dstY:srcY-sy};
    const pc=pcv.getContext("2d");pc.clearRect(0,0,120,120);
    pc.drawImage(canvas,srcX,srcY,srcW,srcH,srcX-sx,srcY-sy,srcW,srcH);
    /* Draw the unit icon on top */
    if(u.type==="waypoint"&&u.displayMode==="pin"){
      var px=60,py=95,pcol=u.pinColor||"#ff4444";
      pc.fillStyle=pcol;pc.strokeStyle="#fff";pc.lineWidth=2.5;
      pc.beginPath();pc.moveTo(px,py);pc.bezierCurveTo(px-22,py-30,px-22,py-55,px,py-55);pc.bezierCurveTo(px+22,py-55,px+22,py-30,px,py);pc.fill();pc.stroke();
      pc.fillStyle="#fff";pc.beginPath();pc.arc(px,py-38,7,0,Math.PI*2);pc.fill();
    }else{drawUnitIcon(pc,u,60,60,100)}
  }catch(e){}
}
function fetchTile(src,tz,twx,twy){const key=`${S.tileSource}/${tz}/${twx}/${twy}`;let t=tileCache.get(key);if(!t){t={img:new Image(),loaded:false,loadedAt:0};t.img.crossOrigin="anonymous";t.img.onload=()=>{t.loaded=true;t.loadedAt=performance.now();requestRender()};t.img.onerror=()=>{t.error=true};t.img.src=src.url.replace("{z}",tz).replace("{x}",twx).replace("{y}",twy);tileCache.set(key,t);if(tileCache.size>3000){tileCache.delete(tileCache.keys().next().value)}}return t}
let _preloadTimer=null,_fadeDuration=200;
function drawTiles(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height,src=TILE_SOURCES[S.tileSource];if(!src)return;const z=Math.floor(S.zoom),mt=1<<z,cen=latlonToPixel(S.lat,S.lon,S.zoom),sc=Math.pow(2,S.zoom-z),tss=TILE_SIZE*sc*d,now=performance.now();
let hasFading=false;
for(let tx=Math.floor((cen.x-W/(2*d))/TILE_SIZE/sc);tx<=Math.ceil((cen.x+W/(2*d))/TILE_SIZE/sc);tx++)for(let ty=Math.floor((cen.y-H/(2*d))/TILE_SIZE/sc);ty<=Math.ceil((cen.y+H/(2*d))/TILE_SIZE/sc);ty++){if(ty<0||ty>=mt)continue;const wx=((tx%mt)+mt)%mt,dx=(tx*TILE_SIZE*sc-cen.x)*d+W/2,dy=(ty*TILE_SIZE*sc-cen.y)*d+H/2;
const t=fetchTile(src,z,wx,ty);
if(t.loaded){
const age=now-t.loadedAt;
if(age<_fadeDuration){ctx.save();ctx.globalAlpha=age/_fadeDuration;ctx.drawImage(t.img,dx,dy,tss+1,tss+1);ctx.restore();hasFading=true}
else{ctx.drawImage(t.img,dx,dy,tss+1,tss+1)}}else{
/* Fallback: only check already-cached lower zoom tiles, never fetch new ones */
let drawn=false;
for(let fz=z-1;fz>=Math.max(2,z-3)&&!drawn;fz--){
const shift=z-fz,sub=1<<shift,fmx=wx>>shift,fmy=ty>>shift;
const fmt=1<<fz;if(fmx<0||fmx>=fmt||fmy<0||fmy>=fmt)continue;
const ft=tileCache.get(`${S.tileSource}/${fz}/${fmx}/${fmy}`);
if(ft&&ft.loaded){try{const sx=(wx-(fmx<<shift))*TILE_SIZE/sub,sy=(ty-(fmy<<shift))*TILE_SIZE/sub,ss2=TILE_SIZE/sub;
if(sx>=0&&sy>=0&&ss2>0){ctx.drawImage(ft.img,sx,sy,ss2,ss2,dx,dy,tss+1,tss+1);drawn=true}}catch(e){}}}}}
/* Loading indicator — show tile count */
var _loadPending=0;tileCache.forEach(function(t){if(!t.loaded&&!t.error)_loadPending++});
if(_loadPending>0){ctx.save();ctx.fillStyle="rgba(0,0,0,.6)";ctx.font="bold "+(12*d)+"px sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("Loading "+_loadPending+" tiles...",W/2,H-30*d);ctx.restore()}
/* Keep rendering during fade-in */
if(hasFading||_loadPending>0)requestRender();
/* Debounced preload: wait 300ms after last render to preload ±1 zoom, max 20 tiles */
clearTimeout(_preloadTimer);
_preloadTimer=setTimeout(()=>{if(!src)return;const curZ=Math.floor(S.zoom);
[curZ+1,curZ-1].forEach(pz=>{if(pz<2||pz>19)return;const pmt=1<<pz,psc2=Math.pow(2,S.zoom-pz);
const curCen=latlonToPixel(S.lat,S.lon,S.zoom);let count=0;
for(let ptx=Math.floor((curCen.x-W/(2*d))/TILE_SIZE/psc2);ptx<=Math.ceil((curCen.x+W/(2*d))/TILE_SIZE/psc2)&&count<10;ptx++)for(let pty=Math.floor((curCen.y-H/(2*d))/TILE_SIZE/psc2);pty<=Math.ceil((curCen.y+H/(2*d))/TILE_SIZE/psc2)&&count<10;pty++){if(pty<0||pty>=pmt)continue;const pwx=((ptx%pmt)+pmt)%pmt;const pk=`${S.tileSource}/${pz}/${pwx}/${pty}`;if(!tileCache.has(pk)){fetchTile(src,pz,pwx,pty);count++}}})},300)}
/* Wargame order visualization */
function drawWargameOrders(){
  const wg=S._net.wargame;if(!wg.active)return;
  const d=devicePixelRatio||1;
  /* Draw submitted orders as dashed arrows */
  wg.orders.forEach(function(o){
    if(o.status==="denied")return;
    var col=o.role==="blufor"?"#4a9eff":"#ff4444";
    var alpha=o.status==="approved"?0.9:0.5;
    ctx.save();ctx.globalAlpha=alpha;
    ctx.strokeStyle=col;ctx.lineWidth=2.5*d;
    ctx.setLineDash(o.status==="approved"?[]:[8*d,6*d]);
    if(o.type==="move"&&o.data.destLat!=null){
      var from=latlonToScreen(o.data.origLat,o.data.origLon);
      var to=latlonToScreen(o.data.destLat,o.data.destLon);
      ctx.beginPath();ctx.moveTo(from.x*d,from.y*d);ctx.lineTo(to.x*d,to.y*d);ctx.stroke();
      /* Arrowhead */
      var angle=Math.atan2((to.y-from.y)*d,(to.x-from.x)*d);
      var ahLen=14*d;
      ctx.beginPath();ctx.setLineDash([]);
      ctx.moveTo(to.x*d,to.y*d);
      ctx.lineTo(to.x*d-ahLen*Math.cos(angle-0.4),to.y*d-ahLen*Math.sin(angle-0.4));
      ctx.moveTo(to.x*d,to.y*d);
      ctx.lineTo(to.x*d-ahLen*Math.cos(angle+0.4),to.y*d-ahLen*Math.sin(angle+0.4));
      ctx.stroke();
      /* Ghost unit at destination (pending) */
      if(o.status==="pending"){
        ctx.beginPath();ctx.arc(to.x*d,to.y*d,8*d,0,Math.PI*2);
        ctx.fillStyle=col;ctx.globalAlpha=0.3;ctx.fill();ctx.globalAlpha=alpha;
      }
      /* Label */
      ctx.font=(10*d)+"px sans-serif";ctx.fillStyle=col;ctx.textAlign="center";
      ctx.fillText(o.status==="approved"?"\u2713":"MOV",(from.x+to.x)/2*d,(from.y+to.y)/2*d-8*d);
    }else if(o.type==="fire"&&o.data.targetLat!=null){
      var from2=latlonToScreen(o.data.originLat,o.data.originLon);
      var to2=latlonToScreen(o.data.targetLat,o.data.targetLon);
      ctx.beginPath();ctx.moveTo(from2.x*d,from2.y*d);ctx.lineTo(to2.x*d,to2.y*d);ctx.stroke();
      /* X at target */
      ctx.setLineDash([]);ctx.lineWidth=3*d;
      var cx=to2.x*d,cy=to2.y*d,cs=8*d;
      ctx.beginPath();ctx.moveTo(cx-cs,cy-cs);ctx.lineTo(cx+cs,cy+cs);ctx.stroke();
      ctx.beginPath();ctx.moveTo(cx+cs,cy-cs);ctx.lineTo(cx-cs,cy+cs);ctx.stroke();
      /* Label */
      ctx.font=(10*d)+"px sans-serif";ctx.fillStyle=col;ctx.textAlign="center";
      ctx.fillText(o.status==="approved"?"\u2713":"FIRE",(from2.x+to2.x)/2*d,(from2.y+to2.y)/2*d-8*d);
    }
    ctx.restore();
  });
  /* Draw in-progress order placement */
  var wop=S._wargameOrderPending;
  if(wop&&(wop.destLat!=null||wop.targetLat!=null)){
    ctx.save();ctx.globalAlpha=0.7;
    var myCol=S._net.wargame.myRole==="opfor"?"#ff4444":"#4a9eff";
    ctx.strokeStyle=myCol;ctx.lineWidth=3*d;ctx.setLineDash([6*d,4*d]);
    if(wop.type==="move"){
      var f=latlonToScreen(wop.origLat,wop.origLon),t=latlonToScreen(wop.destLat,wop.destLon);
      ctx.beginPath();ctx.moveTo(f.x*d,f.y*d);ctx.lineTo(t.x*d,t.y*d);ctx.stroke();
      ctx.beginPath();ctx.setLineDash([]);ctx.arc(t.x*d,t.y*d,10*d,0,Math.PI*2);ctx.stroke();
    }else if(wop.type==="fire"){
      var f2=latlonToScreen(wop.origLat,wop.origLon),t2=latlonToScreen(wop.targetLat,wop.targetLon);
      ctx.beginPath();ctx.moveTo(f2.x*d,f2.y*d);ctx.lineTo(t2.x*d,t2.y*d);ctx.stroke();
      ctx.setLineDash([]);var cx2=t2.x*d,cy2=t2.y*d,cs2=10*d;
      ctx.beginPath();ctx.moveTo(cx2-cs2,cy2-cs2);ctx.lineTo(cx2+cs2,cy2+cs2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(cx2+cs2,cy2-cs2);ctx.lineTo(cx2-cs2,cy2+cs2);ctx.stroke();
    }
    ctx.restore();
  }
}
function drawGrid(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;if(S.gridMode==="latlon"){drawLLGrid();return}ctx.save();ctx.globalAlpha=S.gridOpacity;ctx.strokeStyle=S.gridColor;ctx.fillStyle=S.gridColor;ctx.font=`${10*d}px ${_gridFont}`;let sp=S.gridSpacing==="auto"?(S.zoom<10?0:S.zoom<13?1e4:S.zoom<16?1e3:100):parseInt(S.gridSpacing);const tl=screenToLatlon(0,0),br=screenToLatlon(W/d,H/d),latMin=Math.max(br.lat,-80),latMax=Math.min(tl.lat,84),lonMin=tl.lon,lonMax=br.lon;const zMin=Math.max(1,Math.floor((lonMin+180)/6)+1),zMax=Math.min(60,Math.floor((lonMax+180)/6)+1);/* GZD zone boundaries and lat bands — always show when zoomed out */if(S.zoom<13){const L="CDEFGHJKLMNPQRSTUVWX";for(let zone=zMin;zone<=zMax;zone++){const zL0=(zone-1)*6-180,zL1=zone*6-180;/* zone boundary vertical lines */const spT=latlonToScreen(latMax,zL0),spB=latlonToScreen(latMin,zL0);ctx.beginPath();ctx.moveTo(spT.x*d,spT.y*d);ctx.lineTo(spB.x*d,spB.y*d);ctx.lineWidth=1.5*d;ctx.stroke();/* lat band boundaries */for(let i=0;i<=L.length;i++){const bL=-80+i*8;if(bL<latMin-2||bL>latMax+2)continue;const spA=latlonToScreen(bL,Math.max(lonMin,zL0)),spB2=latlonToScreen(bL,Math.min(lonMax,zL1));ctx.beginPath();ctx.moveTo(spA.x*d,spA.y*d);ctx.lineTo(spB2.x*d,spB2.y*d);ctx.lineWidth=1*d;ctx.stroke()}/* GZD labels at z5+ */if(S.zoom>=5){for(let i=0;i<L.length;i++){const bL=-80+i*8+4;if(bL<latMin-4||bL>latMax+4)continue;const ss=latlonToScreen(bL,(zL0+zL1)/2);ctx.globalAlpha=Math.min(S.gridOpacity,.8);ctx.font=`bold ${Math.min(16,10+S.zoom)*d}px ${_gridFont}`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(`${zone}${L[i]}`,ss.x*d,ss.y*d);ctx.globalAlpha=S.gridOpacity}}}if(!sp){ctx.restore();return}}/* UTM grid lines */const maxZones=Math.min(zMax,zMin+3);for(let zone=zMin;zone<=maxZones;zone++){const zL0=(zone-1)*6-180,zL1=zone*6-180,cL0=Math.max(lonMin,zL0+.01),cL1=Math.min(lonMax,zL1-.01),mLat=(latMin+latMax)/2,mLon=(cL0+cL1)/2;let uMin,uMax,nBot,nTop;try{uMin=latlonToUTM(mLat,cL0);uMax=latlonToUTM(mLat,cL1);nBot=latlonToUTM(latMin,mLon);nTop=latlonToUTM(latMax,mLon)}catch(e){continue}const eMin=Math.floor(uMin.easting/sp)*sp,eMax=Math.ceil(uMax.easting/sp)*sp,nMin=Math.floor(Math.min(nBot.northing,nTop.northing)/sp)*sp,nMax=Math.ceil(Math.max(nBot.northing,nTop.northing)/sp)*sp,nor=mLat>=0;const maxLines=40,nSteps=30;ctx.lineWidth=sp>=1e4?1.5*d:d;/* Vertical lines (constant easting) */let lc=0;for(let e=eMin;e<=eMax&&lc<maxLines;e+=sp,lc++){if(e<1e5||e>9e5)continue;ctx.beginPath();let f=true;const step=(nMax-nMin)/nSteps;for(let n=nMin;n<=nMax;n+=step){try{const ll=UTMToLatlon(zone,e,n,nor),ss=latlonToScreen(ll.lat,ll.lon);f?(ctx.moveTo(ss.x*d,ss.y*d),f=false):ctx.lineTo(ss.x*d,ss.y*d)}catch(ex){f=true}}ctx.stroke()}/* Horizontal lines (constant northing) */lc=0;const eStep=(eMax-eMin)/nSteps;for(let n=nMin;n<=nMax&&lc<maxLines;n+=sp,lc++){ctx.beginPath();let f=true;for(let e=Math.max(eMin,1e5);e<=Math.min(eMax,9e5);e+=Math.max(eStep,500)){try{const ll=UTMToLatlon(zone,e,n,nor),ss=latlonToScreen(ll.lat,ll.lon);f?(ctx.moveTo(ss.x*d,ss.y*d),f=false):ctx.lineTo(ss.x*d,ss.y*d)}catch(ex){f=true}}ctx.stroke()}}ctx.restore()}
function drawLLGrid(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;ctx.save();ctx.globalAlpha=S.gridOpacity;ctx.strokeStyle=S.gridColor;ctx.fillStyle=S.gridColor;ctx.lineWidth=d;ctx.font=`${9*d}px ${_gridFont}`;const tl=screenToLatlon(0,0),br=screenToLatlon(W/d,H/d),st=S.zoom<4?10:S.zoom<7?5:S.zoom<10?1:S.zoom<13?.1:.01;for(let lat=Math.floor(br.lat/st)*st;lat<=Math.ceil(tl.lat/st)*st;lat+=st){const a=latlonToScreen(lat,tl.lon),b=latlonToScreen(lat,br.lon);ctx.beginPath();ctx.moveTo(a.x*d,a.y*d);ctx.lineTo(b.x*d,b.y*d);ctx.stroke();ctx.fillText(`${lat.toFixed(st<1?2:0)}\u00b0`,4*d,a.y*d-3*d)}for(let lon=Math.floor(tl.lon/st)*st;lon<=Math.ceil(br.lon/st)*st;lon+=st){const a=latlonToScreen(tl.lat,lon),b=latlonToScreen(br.lat,lon);ctx.beginPath();ctx.moveTo(a.x*d,a.y*d);ctx.lineTo(b.x*d,b.y*d);ctx.stroke();ctx.fillText(`${lon.toFixed(st<1?2:0)}\u00b0`,a.x*d+3*d,14*d)}ctx.restore()}


// === part_04_units.js ===

function drawUnitIcon(c2,u,cx,cy,sz){const sc=sz/SVG_W;c2.save();c2.translate(cx,cy);if(u.rotation)c2.rotate(u.rotation*DEG);c2.translate(-sz/2,-sz/2);c2.scale(sc,sc);const a=AFFILIATIONS[u.affiliation||"friendly"],col=a.color,sw=4,hw=FRAME_W/2,hh=FRAME_H/2;/* UAV/drone uses house-shaped (pentagon) frame per MIL-STD-2525 equipment */const _isUAV=u.isEquipment&&u.type==="uav";const _cr=Math.max(hw,hh)+U*.1;const B=_isUAV?(CY+hh):a.shape==="circle"?CY+_cr:a.shape==="diamond"?CY+(hh+U*.6):CY+hh;if(u.isHQ){c2.beginPath();c2.moveTo(CX,B);c2.lineTo(CX,SVG_H-U*.5);c2.strokeStyle="#000";c2.lineWidth=sw;c2.stroke()}/* Frame */c2.fillStyle=a.fill;c2.strokeStyle=col;c2.lineWidth=sw;if(_isUAV){/* House/pentagon frame for drones */const hx=hw*.85,hy=hh+U*.2;const peakY=CY-hy-U*1.0;c2.beginPath();c2.moveTo(CX,peakY);c2.lineTo(CX+hx,CY-hy*.3);c2.lineTo(CX+hx,CY+hy);c2.lineTo(CX-hx,CY+hy);c2.lineTo(CX-hx,CY-hy*.3);c2.closePath();c2.fill();c2.stroke()}else switch(a.shape){case"circle":{const cr=_cr;c2.beginPath();c2.arc(CX,CY,cr,0,Math.PI*2);c2.fill();c2.stroke();break}case"rect":c2.beginPath();c2.rect(CX-hw,CY-hh,FRAME_W,FRAME_H);c2.fill();c2.stroke();break;case"diamond":{const dx=hw+U*.6,dy=hh+U*.6;c2.beginPath();c2.moveTo(CX,CY-dy);c2.lineTo(CX+dx,CY);c2.lineTo(CX,CY+dy);c2.lineTo(CX-dx,CY);c2.closePath();c2.fill();c2.stroke();break}case"square":{const sq=Math.max(hw,hh)+U*.2;c2.beginPath();c2.rect(CX-sq,CY-sq,sq*2,sq*2);c2.fill();c2.stroke();break}case"quatrefoil":{const r=hh*.55;c2.beginPath();c2.moveTo(CX,CY-hh-U*.3);c2.bezierCurveTo(CX+r,CY-hh-U*.3,CX+hw+U*.3,CY-r,CX+hw+U*.3,CY);c2.bezierCurveTo(CX+hw+U*.3,CY+r,CX+r,CY+hh+U*.3,CX,CY+hh+U*.3);c2.bezierCurveTo(CX-r,CY+hh+U*.3,CX-hw-U*.3,CY+r,CX-hw-U*.3,CY);c2.bezierCurveTo(CX-hw-U*.3,CY-r,CX-r,CY-hh-U*.3,CX,CY-hh-U*.3);c2.closePath();c2.fill();c2.stroke();break}}/* Interior bounds */var ihw=hw,ihh=hh;if(_isUAV){ihw=hw*.65;ihh=hh*.65}else switch(a.shape){case"circle":{ihw=_cr*.68;ihh=_cr*.68;break}case"diamond":ihw=hw*.58;ihh=hh*.58;break;case"square":{const sq=Math.max(hw,hh)+U*.2;ihw=sq*.7;ihh=sq*.7;break}case"quatrefoil":ihw=hw*.6;ihh=hh*.6;break}/* Icon interior */c2.strokeStyle="#000";c2.fillStyle="#000";c2.lineWidth=3;drawTS(c2,u.type,CX,CY,ihw,ihh);if(u.echelon)drawEch(c2,u.echelon,u.affiliation,u.type,u.isEquipment);if(u.modifiers&&u.modifiers.length)drawMods(c2,u.modifiers);/* Text labels outside frame — hide when icon is small */var _dpr=devicePixelRatio||1;if(S.showLabels&&sz/_dpr>60){c2.fillStyle="#000";c2.font=`bold ${U*2.0}px serif`;const textX=_isUAV?(hw*.85):a.shape==="circle"?_cr*0.72:hw;if(u.designation){c2.textAlign="right";c2.textBaseline="alphabetic";c2.fillText(u.designation,CX-textX-U*.3,B)}if(u.parentUnit){c2.textAlign="left";c2.textBaseline="alphabetic";c2.fillText(u.parentUnit,CX+textX+U*.3,B)}}c2.restore()}
function _drawTrefoil(c2,cx,cy,r,hh){
/* Aviation: two inverted triangles on vertical axis + horizontal lobes — compact */
var hw=r/.7;
/* Top triangle — wide at top, point at center */
var tw=hw*.22;
c2.beginPath();
c2.moveTo(cx-tw,cy-hh*.6);
c2.lineTo(cx+tw,cy-hh*.6);
c2.lineTo(cx,cy);
c2.closePath();c2.fill();
/* Bottom triangle — wide at bottom, point at center */
c2.beginPath();
c2.moveTo(cx-tw,cy+hh*.6);
c2.lineTo(cx+tw,cy+hh*.6);
c2.lineTo(cx,cy);
c2.closePath();c2.fill();
/* Horizontal lobes — smaller */
var d=hw*.3;
var lr=d*(hh/hw)*.85;
/* Left lobe */
c2.beginPath();
c2.moveTo(cx,cy);
c2.lineTo(cx-d,cy-lr);
c2.arc(cx-d,cy,lr,Math.PI*1.5,Math.PI*0.5,true);
c2.closePath();c2.fill();
/* Right lobe */
c2.beginPath();
c2.moveTo(cx,cy);
c2.lineTo(cx+d,cy-lr);
c2.arc(cx+d,cy,lr,Math.PI*1.5,Math.PI*0.5,false);
c2.closePath();c2.fill();
}
function drawTS(c2,t,cx,cy,hw,hh){var r=hw*.7;switch(t){case"infantry":c2.beginPath();c2.moveTo(cx-hw,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.moveTo(cx+hw,cy-hh);c2.lineTo(cx-hw,cy+hh);c2.stroke();break;case"naval_infantry":c2.beginPath();c2.moveTo(cx-hw,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.moveTo(cx+hw,cy-hh);c2.lineTo(cx-hw,cy+hh);c2.stroke();{/* Anchor overlay */const as=r*1.0,lw=c2.lineWidth;c2.lineWidth=2;/* Ring at top */c2.beginPath();c2.arc(cx,cy-as*.7,as*.15,0,Math.PI*2);c2.stroke();/* Vertical shaft */c2.beginPath();c2.moveTo(cx,cy-as*.55);c2.lineTo(cx,cy+as*.7);c2.stroke();/* Horizontal stock/crossbar */c2.beginPath();c2.moveTo(cx-as*.4,cy-as*.3);c2.lineTo(cx+as*.4,cy-as*.3);c2.stroke();/* Flukes - curved arms at bottom */c2.beginPath();c2.moveTo(cx-as*.5,cy+as*.15);c2.quadraticCurveTo(cx-as*.45,cy+as*.6,cx,cy+as*.7);c2.stroke();c2.beginPath();c2.moveTo(cx+as*.5,cy+as*.15);c2.quadraticCurveTo(cx+as*.45,cy+as*.6,cx,cy+as*.7);c2.stroke();c2.lineWidth=lw}break;case"mechanized_infantry":c2.beginPath();c2.moveTo(cx-hw,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.moveTo(cx+hw,cy-hh);c2.lineTo(cx-hw,cy+hh);c2.stroke();{const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke()}break;case"ifv":c2.beginPath();c2.moveTo(cx-hw,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.moveTo(cx+hw,cy-hh);c2.lineTo(cx-hw,cy+hh);c2.stroke();{const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke();/* Vertical line at left edge of racetrack */c2.beginPath();c2.moveTo(cx-aw,cy-hh);c2.lineTo(cx-aw,cy+hh);c2.stroke()}break;case"armor":{const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke();break}case"armored_wheeled":{/* Armor racetrack */const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke();/* 3 wheels below: smaller, thinner, with visible gaps */var wLeft=cx-aw+ar,wRight=cx+aw-ar;var wRadius=(wRight-wLeft)/8;var wY=cy+ah+(hh-ah)*.47;var olw=c2.lineWidth;c2.lineWidth=olw*.6;c2.beginPath();c2.arc(wLeft,wY,wRadius,0,Math.PI*2);c2.stroke();c2.beginPath();c2.arc(cx,wY,wRadius,0,Math.PI*2);c2.stroke();c2.beginPath();c2.arc(wRight,wY,wRadius,0,Math.PI*2);c2.stroke();c2.lineWidth=olw;break}case"cavalry":c2.beginPath();c2.moveTo(cx-hw,cy+hh);c2.lineTo(cx+hw,cy-hh);c2.stroke();break;case"armored_recon":c2.beginPath();c2.moveTo(cx-hw,cy+hh);c2.lineTo(cx+hw,cy-hh);c2.stroke();{const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke()}break;case"artillery":c2.beginPath();c2.arc(cx,cy,r*.22,0,Math.PI*2);c2.fill();break;case"mechanized_artillery":c2.beginPath();c2.arc(cx,cy,r*.22,0,Math.PI*2);c2.fill();{const aw=hw*.7,ah=hh*.5,ar=ah;c2.beginPath();c2.moveTo(cx-aw+ar,cy-ah);c2.lineTo(cx+aw-ar,cy-ah);c2.arc(cx+aw-ar,cy,ar,Math.PI*1.5,Math.PI*.5);c2.lineTo(cx-aw+ar,cy+ah);c2.arc(cx-aw+ar,cy,ar,Math.PI*.5,Math.PI*1.5);c2.closePath();c2.stroke()}break;case"rocket_artillery":{/* ADP 1-02: artillery dot centered + two chevrons above */
c2.beginPath();c2.arc(cx,cy+r*.1,r*.22,0,Math.PI*2);c2.fill();
const cw=r*.35,ch=r*.22,cg=r*.28;
c2.beginPath();c2.moveTo(cx-cw,cy-r*.12);c2.lineTo(cx,cy-r*.12-ch);c2.lineTo(cx+cw,cy-r*.12);c2.stroke();
c2.beginPath();c2.moveTo(cx-cw,cy-r*.12-cg);c2.lineTo(cx,cy-r*.12-ch-cg);c2.lineTo(cx+cw,cy-r*.12-cg);c2.stroke();
break}case"mortar":{/* ADP 1-02: open arrowhead on top, vertical shaft, hollow circle at bottom */
const cr=r*.18;
/* Hollow circle lower */
c2.beginPath();c2.arc(cx,cy+r*.45,cr,0,Math.PI*2);c2.stroke();
/* Vertical shaft from top of circle to arrow tip */
c2.beginPath();c2.moveTo(cx,cy+r*.45-cr);c2.lineTo(cx,cy-r*.65);c2.stroke();
/* Open arrowhead — wider angle, less pointy */
c2.beginPath();c2.moveTo(cx-cr,cy-r*.5);c2.lineTo(cx,cy-r*.65);c2.lineTo(cx+cr,cy-r*.5);c2.stroke();
break}case"air_defense":{/* ADP 1-02: radar dome — half circle on flat base */c2.beginPath();c2.arc(cx,cy-r*.05,r*.55,Math.PI,0);c2.stroke();c2.beginPath();c2.moveTo(cx-r*.65,cy-r*.05);c2.lineTo(cx+r*.65,cy-r*.05);c2.stroke();/* Small vertical line below */c2.beginPath();c2.moveTo(cx,cy-r*.05);c2.lineTo(cx,cy+r*.4);c2.stroke();break}case"anti_armor":c2.beginPath();c2.moveTo(cx-hw,cy+hh);c2.lineTo(cx,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.stroke();break;case"magtf":{/* MAGTF: infantry X + aviation propellers + wave below */
/* Infantry X */
c2.beginPath();c2.moveTo(cx-hw,cy-hh);c2.lineTo(cx+hw,cy+hh);c2.moveTo(cx+hw,cy-hh);c2.lineTo(cx-hw,cy+hh);c2.stroke();
/* Draw the aviation horizontal lobes only (not triangles) */
var md=hw*.42,mlr=md*(hh/hw)*.95;
c2.beginPath();c2.moveTo(cx,cy-hh*.12);c2.lineTo(cx-md,cy-hh*.12-mlr);c2.arc(cx-md,cy-hh*.12,mlr,Math.PI*1.5,Math.PI*0.5,true);c2.closePath();c2.fill();
c2.beginPath();c2.moveTo(cx,cy-hh*.12);c2.lineTo(cx+md,cy-hh*.12-mlr);c2.arc(cx+md,cy-hh*.12,mlr,Math.PI*1.5,Math.PI*0.5,false);c2.closePath();c2.fill();
/* Sine wave in lower portion — half wave + 3 full waves + half wave */
var waveY=cy+hh*.58,waveAmp=hh*.18,waveW=hw*1.9;
var slw2=c2.lineWidth;c2.lineWidth=slw2*1.2;
c2.beginPath();
var waveSteps=80,waves=3.5;
for(var wi=0;wi<=waveSteps;wi++){
  var wt=wi/waveSteps;
  var wx=cx-waveW/2+wt*waveW;
  /* Start at half wave (0.5) so left edge is a half, 3 full in middle, half on right */
  var wy=waveY+Math.sin((wt*waves+0.5)*Math.PI*2)*waveAmp;
  if(wi===0)c2.moveTo(wx,wy);else c2.lineTo(wx,wy);
}
c2.stroke();c2.lineWidth=slw2;
break}case"aviation":{_drawTrefoil(c2,cx,cy,r,hh);break}case"attack_aviation":{_drawTrefoil(c2,cx,cy,r,hh);
c2.beginPath();c2.moveTo(cx-hw*.7,cy-hh*.7);c2.lineTo(cx+hw*.7,cy+hh*.7);c2.moveTo(cx+hw*.7,cy-hh*.7);c2.lineTo(cx-hw*.7,cy+hh*.7);c2.stroke();break}case"recon_aviation":{_drawTrefoil(c2,cx,cy,r,hh);
c2.beginPath();c2.moveTo(cx-hw*.6,cy+hh*.7);c2.lineTo(cx+hw*.6,cy-hh*.7);c2.stroke();break}case"medevac_aviation":{_drawTrefoil(c2,cx,cy,r,hh);
/* Medical cross */
c2.beginPath();c2.moveTo(cx,cy-hh*.5);c2.lineTo(cx,cy+hh*.5);c2.moveTo(cx-hw*.4,cy);c2.lineTo(cx+hw*.4,cy);c2.stroke();break}case"uav":{/* Drone: thick flat V/chevron */
var vw=hw*.7,vh=hh*.45,vt=hh*.22;
c2.beginPath();
c2.moveTo(cx-vw,cy-vh);
c2.lineTo(cx,cy+vh*.4);
c2.lineTo(cx+vw,cy-vh);
c2.lineTo(cx+vw*.7,cy-vh);
c2.lineTo(cx,cy-vh+vh*.9);
c2.lineTo(cx-vw*.7,cy-vh);
c2.closePath();c2.fill();break}case"sam":{/* ADP 1-02: Surface-to-Air Missile — shallow dome at bottom touching corners, tall missile on top */
/* Shallow dome: endpoints exactly at bottom corners */
var domePeakY=cy+hh*0.3;
var halfChord=hw;
var domeH=(cy+hh)-domePeakY;
var domeR=(domeH/2)+(halfChord*halfChord)/(2*domeH);
var domeCY=domePeakY+domeR;
/* atan2 for exact angles to bottom corners */
var angL=Math.atan2((cy+hh)-domeCY,(cx-hw)-cx);
var angR=Math.atan2((cy+hh)-domeCY,(cx+hw)-cx);
c2.beginPath();c2.arc(cx,domeCY,domeR,angL,angR);c2.stroke();
/* Missile/silo: sits on dome peak, tall with rounded top */
var mw=r*.2,mBot=domePeakY,mTop=cy-hh*0.55;
c2.beginPath();c2.moveTo(cx-mw,mBot);c2.lineTo(cx-mw,mTop+mw);c2.arc(cx,mTop+mw,mw,Math.PI,0);c2.lineTo(cx+mw,mBot);c2.stroke();
break}case"engineer":c2.save();c2.lineWidth=3;c2.beginPath();c2.moveTo(cx-r*.5,cy+r*.6);c2.lineTo(cx-r*.5,cy-r*.2);c2.lineTo(cx+r*.5,cy-r*.2);c2.lineTo(cx+r*.5,cy+r*.6);c2.stroke();c2.restore();break;case"bridging":c2.beginPath();c2.moveTo(cx-r*.7,cy+r*.3);c2.lineTo(cx-r*.3,cy-r*.3);c2.lineTo(cx+r*.3,cy-r*.3);c2.lineTo(cx+r*.7,cy+r*.3);c2.stroke();break;case"headquarters":{/* ADP 1-02: HQ is shown via staff indicator (line below frame) + isHQ flag. Interior can show unit function or be blank */c2.font=`bold ${r*1.2}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("HQ",cx,cy);break}case"signal":{/* ADP 1-02: lightning flash */c2.beginPath();c2.moveTo(cx-r*.15,cy-r*.7);c2.lineTo(cx+r*.25,cy-r*.05);c2.lineTo(cx-r*.1,cy-r*.05);c2.lineTo(cx+r*.2,cy+r*.7);c2.stroke();break}case"military_intelligence":c2.font=`bold ${r*1.2}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("MI",cx,cy);break;case"electronic_warfare":{/* ADP 1-02: lightning zigzag — Z-shape */c2.beginPath();c2.moveTo(cx-r*.5,cy-r*.4);c2.lineTo(cx+r*.5,cy-r*.4);c2.lineTo(cx-r*.5,cy+r*.4);c2.lineTo(cx+r*.5,cy+r*.4);c2.stroke();break}case"cyber":c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("CY",cx,cy);break;case"sustainment":{/* ADP 1-02: "SUST" abbreviation */c2.font=`bold ${r*.7}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("SUST",cx,cy);break}case"medical":{/* ADP 1-02: Geneva cross */c2.lineWidth=3;c2.beginPath();c2.moveTo(cx,cy-r*.5);c2.lineTo(cx,cy+r*.5);c2.stroke();c2.beginPath();c2.moveTo(cx-r*.5,cy);c2.lineTo(cx+r*.5,cy);c2.stroke();break}case"maintenance":{/* ADP 1-02: double-end wrench */c2.beginPath();c2.moveTo(cx-r*.6,cy+r*.4);c2.lineTo(cx+r*.6,cy-r*.4);c2.stroke();c2.beginPath();c2.arc(cx-r*.5,cy+r*.3,r*.2,0,Math.PI*2);c2.stroke();c2.beginPath();c2.arc(cx+r*.5,cy-r*.3,r*.2,0,Math.PI*2);c2.stroke();break}case"transportation":{/* ADP 1-02: wheel */c2.beginPath();c2.arc(cx,cy,r*.45,0,Math.PI*2);c2.stroke();/* Spokes */for(let i=0;i<4;i++){const a=Math.PI*i/4;c2.beginPath();c2.moveTo(cx+Math.cos(a)*r*.15,cy+Math.sin(a)*r*.15);c2.lineTo(cx+Math.cos(a)*r*.45,cy+Math.sin(a)*r*.45);c2.moveTo(cx-Math.cos(a)*r*.15,cy-Math.sin(a)*r*.15);c2.lineTo(cx-Math.cos(a)*r*.45,cy-Math.sin(a)*r*.45);c2.stroke()}c2.beginPath();c2.arc(cx,cy,r*.15,0,Math.PI*2);c2.fill();break}case"supply":{/* ADP 1-02: "S" abbreviation */c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("S",cx,cy);break}case"ordnance":{/* ADP 1-02: bursting bomb — filled circle with flame/rays on top */c2.beginPath();c2.arc(cx,cy+r*.1,r*.3,0,Math.PI*2);c2.fill();/* Flame/fuse */c2.beginPath();c2.moveTo(cx+r*.15,cy-r*.15);c2.quadraticCurveTo(cx+r*.4,cy-r*.6,cx+r*.1,cy-r*.6);c2.stroke();break}case"special_forces":{/* ADP 1-02: "SF" abbreviation */c2.font=`bold ${r*1.1}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("SF",cx,cy);break}case"ranger":{c2.font=`bold ${r*.8}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("RGR",cx,cy);break}case"civil_affairs":c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("CA",cx,cy);break;case"psyop":{/* ADP 1-02: psychological operations — lightning bolt with arrow */c2.beginPath();c2.moveTo(cx-r*.2,cy-r*.6);c2.lineTo(cx+r*.15,cy);c2.lineTo(cx-r*.1,cy);c2.lineTo(cx+r*.2,cy+r*.6);c2.stroke();/* Arrow head */c2.beginPath();c2.moveTo(cx+r*.2,cy+r*.6);c2.lineTo(cx+r*.05,cy+r*.35);c2.moveTo(cx+r*.2,cy+r*.6);c2.lineTo(cx+r*.35,cy+r*.4);c2.stroke();break}case"waypoint":{/* Crosshair/pin symbol */c2.beginPath();c2.moveTo(cx,cy-r*.6);c2.lineTo(cx,cy+r*.6);c2.stroke();c2.beginPath();c2.moveTo(cx-r*.6,cy);c2.lineTo(cx+r*.6,cy);c2.stroke();c2.beginPath();c2.arc(cx,cy,r*.35,0,Math.PI*2);c2.stroke();break}}}
function drawEch(c2,ech,aff,utype,isEquip){const shape=AFFILIATIONS[aff||"friendly"].shape;const isH=shape==="diamond";const isC=shape==="circle";const hh=FRAME_H/2;const cr=isC?(Math.max(FRAME_W/2,hh)+U*.1):0;const _uav=isEquip&&utype==="uav";const by=_uav?CY-(hh+U*.2)-U*1.0-U*1.6:CY-hh-U*1.6-(isH?U*.6:0)-(isC?cr-hh:0);c2.strokeStyle="#000";c2.fillStyle="#000";c2.lineWidth=2.5;const e=ECHELONS.find(x=>x.id===ech);if(!e)return;const m=e.mark;if(m==="slashO"){const r=4;c2.beginPath();c2.arc(CX,by,r,0,Math.PI*2);c2.stroke();c2.beginPath();c2.moveTo(CX-r*.7,by+r*.7);c2.lineTo(CX+r*.7,by-r*.7);c2.stroke()}else if(m==="cmd"){/* Command: star shape */const r=6;c2.beginPath();for(let i=0;i<5;i++){const a1=Math.PI*2*i/5-Math.PI/2,a2=Math.PI*2*(i+0.5)/5-Math.PI/2;c2.lineTo(CX+Math.cos(a1)*r,by+Math.sin(a1)*r);c2.lineTo(CX+Math.cos(a2)*r*0.4,by+Math.sin(a2)*r*0.4)}c2.closePath();c2.fill()}else if(m.startsWith("dot")){const n=parseInt(m[3]),g=7,tw=(n-1)*g;for(let i=0;i<n;i++){c2.beginPath();c2.arc(CX-tw/2+i*g,by,2.8,0,Math.PI*2);c2.fill()}}else if(m.startsWith("bar")){const n=parseInt(m[3]),g=6,tw=(n-1)*g;for(let i=0;i<n;i++){const px=CX-tw/2+i*g;c2.beginPath();c2.moveTo(px,by-7);c2.lineTo(px,by+7);c2.stroke()}}else if(m.startsWith("x")){const n=parseInt(m[1]),g=10,tw=(n-1)*g;for(let i=0;i<n;i++){const px=CX-tw/2+i*g;c2.beginPath();c2.moveTo(px-4,by-5);c2.lineTo(px+4,by+5);c2.moveTo(px+4,by-5);c2.lineTo(px-4,by+5);c2.stroke()}}}
function drawMods(c2,mods){c2.fillStyle="#aaa";c2.font=`${U*.9}px sans-serif`;c2.textAlign="center";c2.textBaseline="top";c2.fillText(mods.map(m=>(MODIFIERS.find(x=>x.id===m)||{}).symbol||"").join(" "),CX,CY+FRAME_H/2+U*2)}
function drawUnits(){const d=devicePixelRatio||1;const _W2=canvas.width/d,_H2=canvas.height/d;
const _luv={};S.layers.forEach(l=>{_luv[l.id]=l.visible});
S.units.forEach(u=>{if(_luv[u.layerId]===false)return;if(!wargameCanSeeLayer(u.layerId))return;const sp=latlonToScreen(u.lat,u.lon);
if(sp.x<-100||sp.x>_W2+100||sp.y<-100||sp.y>_H2+100)return;
const sz=getUSS();ctx.save();
/* Pin display mode for waypoints */
if(u.type==="waypoint"&&u.displayMode==="pin"){const px=sp.x*d,py=sp.y*d,col=u.pinColor||"#ff4444";
ctx.fillStyle=col;ctx.strokeStyle="#fff";ctx.lineWidth=2*d;
ctx.beginPath();ctx.moveTo(px,py);ctx.bezierCurveTo(px-12*d,py-18*d,px-12*d,py-30*d,px,py-30*d);ctx.bezierCurveTo(px+12*d,py-30*d,px+12*d,py-18*d,px,py);ctx.fill();ctx.stroke();
ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(px,py-20*d,4*d,0,Math.PI*2);ctx.fill();
/* Label — show coords based on toggle (default true) */
if(u.showCoords!==false){
const mgrs=toMGRS(u.lat,u.lon);const ll=`${u.lat.toFixed(5)}°, ${u.lon.toFixed(5)}°`;
ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="left";ctx.textBaseline="top";
const lines=[u.designation||mgrs,ll];const lx=px+14*d;let ly=py-32*d;
lines.forEach(txt=>{const tw=ctx.measureText(txt).width;ctx.fillStyle="rgba(0,0,0,.75)";ctx.fillRect(lx-3*d,ly-1*d,tw+6*d,13*d);ctx.fillStyle="#fff";ctx.fillText(txt,lx,ly);ly+=14*d});
}else if(u.designation){
/* Show just designation label if coords hidden but has designation */
ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="left";ctx.textBaseline="top";
const lx=px+14*d,ly=py-32*d,tw=ctx.measureText(u.designation).width;
ctx.fillStyle="rgba(0,0,0,.75)";ctx.fillRect(lx-3*d,ly-1*d,tw+6*d,13*d);ctx.fillStyle="#fff";ctx.fillText(u.designation,lx,ly);
}
}else{
/* Draw range rings BEFORE the icon so icon sits on top */
if(u.rings&&u.rings.length)u.rings.forEach(ring=>{const rp=metersToPixels(ring.radius,u.lat,S.zoom)*d;if(rp<2*d)return;ctx.save();ctx.strokeStyle=ring.color||"#f00";ctx.lineWidth=2*d;var rs=ring.lineStyle||"solid";if(rs==="dash")ctx.setLineDash([6*d,4*d]);else if(rs==="dotted")ctx.setLineDash([2*d,3*d]);else ctx.setLineDash([]);ctx.beginPath();ctx.arc(sp.x*d,sp.y*d,rp,0,Math.PI*2);if(ring.fill){ctx.globalAlpha=ring.fillOpacity!=null?ring.fillOpacity:0.35;ctx.fillStyle=ring.color||"#f00";ctx.fill()}ctx.globalAlpha=ring.opacity!=null?ring.opacity:0.75;ctx.stroke();ctx.setLineDash([]);/* Ring label */if(rp>18*d){ctx.globalAlpha=0.9;var fam=getComputedStyle(document.body).fontFamily;ctx.font=`bold ${9*d}px ${fam}`;ctx.textAlign="center";ctx.textBaseline="bottom";var distTxt=ring.radius>=1000?(ring.radius/1000)+"km":ring.radius+"m";var lblTxt=ring.label?ring.label+" ("+distTxt+")":distTxt;ctx.strokeStyle="rgba(0,0,0,.7)";ctx.lineWidth=3*d;ctx.strokeText(lblTxt,sp.x*d,sp.y*d-rp-3*d);ctx.fillStyle=ring.color||"#f00";ctx.fillText(lblTxt,sp.x*d,sp.y*d-rp-3*d)}ctx.restore()});
if(u.customIcon&&u.useCustomIcon!==false){
const isH=u.affiliation==="hostile";const cimg=isH?getTintedIcon(u.customIcon,"#ff4444"):getCustomIconImage(u.customIcon);
const uScale=u.iconScale||1;
if(cimg.complete&&cimg.naturalWidth>0){const iSz=sz*d*uScale;ctx.drawImage(cimg,sp.x*d-iSz/2,sp.y*d-iSz/2,iSz,iSz)}
else{drawUnitIcon(ctx,u,sp.x*d,sp.y*d,sz*d)}}else{const uScale=u.iconScale||1;drawUnitIcon(ctx,u,sp.x*d,sp.y*d,sz*d*uScale)}}
ctx.restore();if(u.id===S.selectedUnitId){ctx.save();ctx.strokeStyle="#ffd700";ctx.lineWidth=2*d;ctx.setLineDash([4*d,4*d]);const h=sz*d/2+4*d;ctx.strokeRect(sp.x*d-h,sp.y*d-h,h*2,h*2);ctx.restore();/* Rotation handle — red dot around unit */const handleDist=(sz*d/2+20*d);const ang=(u.rotation||0)*DEG;const hx=sp.x*d+Math.sin(ang)*handleDist;const hy=sp.y*d-Math.cos(ang)*handleDist;/* Handle dot */ctx.save();ctx.fillStyle="#ff4444";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.beginPath();ctx.arc(hx,hy,5*d,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.restore();/* Angle text above icon */if(u.rotation){ctx.save();ctx.fillStyle="#fff";ctx.strokeStyle="rgba(0,0,0,.6)";ctx.lineWidth=3*d;ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="center";ctx.textBaseline="bottom";const txt=Math.round(u.rotation)+"\u00b0";ctx.strokeText(txt,sp.x*d,sp.y*d-h-4*d);ctx.fillText(txt,sp.x*d,sp.y*d-h-4*d);ctx.restore()}}})}
/* Custom icon image cache for KMZ-embedded images */
const _iconCache={};const _tintCache={};
function getCustomIconImage(dataUrl){if(_iconCache[dataUrl])return _iconCache[dataUrl];const img=new Image();img.src=dataUrl;_iconCache[dataUrl]=img;img.onload=()=>requestRender();return img}
function getTintedIcon(dataUrl,tint){const key=dataUrl+"|"+tint;if(_tintCache[key])return _tintCache[key];
const src=getCustomIconImage(dataUrl);if(!src.complete||!src.naturalWidth){_tintCache[key]=src;return src}
const oc=document.createElement("canvas");oc.width=src.naturalWidth;oc.height=src.naturalHeight;const ox=oc.getContext("2d");
ox.drawImage(src,0,0);ox.globalCompositeOperation="source-atop";ox.globalAlpha=0.55;ox.fillStyle=tint;ox.fillRect(0,0,oc.width,oc.height);
const ri=new Image();ri.src=oc.toDataURL();_tintCache[key]=ri;return ri}
function getUSS(){const bases={tiny:{min:28,base:36,rate:4},small:{min:36,base:46,rate:6},medium:{min:48,base:60,rate:8},large:{min:60,base:76,rate:10},xlarge:{min:72,base:92,rate:12}};const b=bases[S.iconSize]||bases.medium;return Math.max(b.min,Math.min(b.min*3,b.base+(S.zoom-10)*b.rate))}
function hitTestRotHandle(pos){if(!S.selectedUnitId)return null;const u=S.units.find(x=>x.id===S.selectedUnitId);if(!u)return null;const sp=latlonToScreen(u.lat,u.lon),sz=getUSS(),handleDist=sz/2+20,ang=(u.rotation||0)*DEG,hx=sp.x+Math.sin(ang)*handleDist,hy=sp.y-Math.cos(ang)*handleDist;if(Math.hypot(pos.x-hx,pos.y-hy)<12)return u;return null}


// === part_05_graphics.js ===

function setDash(c2,s,d){c2.setLineDash(s==="dashed"?[10*d,6*d]:s==="dotted"?[3*d,3*d]:[])}
function drawHatchClipped(c2,pts,type,col,d,opts){/* Draw hatching lines clipped to polygon/shape path - uses offscreen canvas to avoid shadow bleed */
opts=opts||{};var hatchCol=opts.hatchColor||col,hatchLw=(opts.hatchLineWidth||1)*d,userSp=opts.hatchSpacing||0,hatchOp=opts.hatchOpacity||0.35;
const mnx=Math.min(...pts.map(p=>p.x)),mny=Math.min(...pts.map(p=>p.y)),mxx=Math.max(...pts.map(p=>p.x)),mxy=Math.max(...pts.map(p=>p.y));
const pw=mxx-mnx,ph=mxy-mny;if(pw<1||ph<1)return;
/* Hard cap: skip hatching if offscreen canvas would be too large (>4000px in any dim) */
if(pw>4000*d||ph>4000*d)return;
const dim=Math.max(pw,ph);var sp=userSp>0?userSp*d:Math.max(dim/20,10*d);
/* Hard cap: never more than 30 lines across the shape */
const maxLines=30;sp=Math.max(sp,dim/maxLines);
sp=Math.max(sp,6*d);/* absolute pixel floor */
const margin=Math.ceil(hatchLw+2*d);
const oc=document.createElement("canvas");oc.width=Math.ceil(pw+margin*2);oc.height=Math.ceil(ph+margin*2);
const o=oc.getContext("2d");
o.beginPath();pts.forEach((p,i)=>i?o.lineTo(p.x-mnx+margin,p.y-mny+margin):o.moveTo(p.x-mnx+margin,p.y-mny+margin));o.closePath();o.clip();
o.strokeStyle=hatchCol;o.lineWidth=hatchLw;o.globalAlpha=hatchOp;
const lw=pw+margin*2,lh=ph+margin*2;
if(type==="fwd"||type==="cross"){o.beginPath();for(let i=-lh;i<lw;i+=sp){o.moveTo(i,0);o.lineTo(i+lh,lh)}o.stroke()}
if(type==="back"||type==="cross"){o.beginPath();for(let i=-lh;i<lw;i+=sp){o.moveTo(lw-i,0);o.lineTo(lw-i-lh,lh)}o.stroke()}
c2.save();c2.shadowColor="transparent";c2.shadowBlur=0;c2.shadowOffsetX=0;c2.shadowOffsetY=0;
c2.drawImage(oc,mnx-margin,mny-margin);c2.restore()}
function drawAH(c2,fr,to,lw,col,as){as=as||1;const a=Math.atan2(to.y-fr.y,to.x-fr.x),sz=(lw*3+6)*as;c2.save();c2.fillStyle=col;c2.beginPath();c2.moveTo(to.x,to.y);c2.lineTo(to.x-sz*Math.cos(a-.4),to.y-sz*Math.sin(a-.4));c2.lineTo(to.x-sz*Math.cos(a+.4),to.y-sz*Math.sin(a+.4));c2.closePath();c2.fill();c2.restore()}
function drawGraphics(){const d=devicePixelRatio||1;const _gW=canvas.width/d,_gH=canvas.height/d;
const _lgv={};S.layers.forEach(l=>{_lgv[l.id]=l.visible});
S.graphics.forEach(g=>{if(_lgv[g.layerId]===false)return;if(!wargameCanSeeLayer(g.layerId))return;if(!g.points||g.points.length<1)return;
if(g.points.length>=2){var _mn=90,_mx=-90,_mln=180,_mlx=-180;for(var _i=0;_i<g.points.length;_i++){var _p=g.points[_i];if(_p.lat<_mn)_mn=_p.lat;if(_p.lat>_mx)_mx=_p.lat;if(_p.lon<_mln)_mln=_p.lon;if(_p.lon>_mlx)_mlx=_p.lon}var _tl=screenToLatlon(0,0),_br=screenToLatlon(_gW,_gH);if(_mx<_br.lat||_mn>_tl.lat||_mlx<_tl.lon||_mln>_br.lon)return}
/* Decimate large polygons for rendering */
var _rpts=g.points;var _maxRPts=S.zoom>=14?2000:S.zoom>=12?1000:500;if(g.points.length>_maxRPts){var _rs=Math.ceil(g.points.length/_maxRPts);_rpts=[];for(var _ri=0;_ri<g.points.length;_ri+=_rs)_rpts.push(g.points[_ri]);if(_ri-_rs!==g.points.length-1)_rpts.push(g.points[g.points.length-1])}
const pts=_rpts.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});
/* Decimate for drawing if too many points */
var dpts=pts;if(pts.length>_maxRPts){var ds=Math.ceil(pts.length/_maxRPts);dpts=[];for(var di=0;di<pts.length;di+=ds)dpts.push(pts[di]);if(di-ds!==pts.length-1)dpts.push(pts[pts.length-1])}ctx.save();if(g.shadow){ctx.shadowColor="rgba(0,0,0,.5)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=d;ctx.shadowOffsetY=d}const col=g.color||"#f44",lw=Math.max(1,(g.lineWidth||2))*d;ctx.strokeStyle=col;ctx.lineWidth=lw;setDash(ctx,g.lineStyle,d);if(g.overlayType&&g.overlayType!=="none")drawOvl(ctx,g,pts,d);else switch(g.tool){case"line":case"arrow":ctx.beginPath();dpts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();if(g.tool==="arrow"&&dpts.length>=2){const as=(g.arrowSize||1)*d;drawAH(ctx,dpts[dpts.length-2],dpts[dpts.length-1],lw,col,as)}break;case"polygon":ctx.beginPath();dpts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.closePath();if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=g.fillOpacity||.2;ctx.fill();ctx.globalAlpha=1;if(g.fillHatch&&g.fillHatch!=="none")drawHatchClipped(ctx,pts,g.fillHatch,col,d,{hatchColor:g.hatchColor,hatchLineWidth:g.hatchLineWidth,hatchSpacing:g.hatchSpacing,hatchOpacity:g.hatchOpacity})}ctx.stroke();if(g.label&&S.showLabels){var pcx=0,pcy=0;pts.forEach(p=>{pcx+=p.x;pcy+=p.y});pcx/=pts.length;pcy/=pts.length;var bMinX=Infinity,bMaxX=-Infinity,bMinY=Infinity,bMaxY=-Infinity;pts.forEach(p=>{if(p.x<bMinX)bMinX=p.x;if(p.x>bMaxX)bMaxX=p.x;if(p.y<bMinY)bMinY=p.y;if(p.y>bMaxY)bMaxY=p.y});var bSz=Math.min(bMaxX-bMinX,bMaxY-bMinY);var lox=g.labelOffset?g.labelOffset.x*d:0,loy=g.labelOffset?g.labelOffset.y*d:-20*d;var fSz=g.fontSize?(g.fontSize*d):Math.max(10*d,Math.min(24*d,Math.max(bSz,20*d)*.08));var lAlpha=bSz>3000*d?Math.max(0,1-(bSz-3000*d)/1000*d):1;ctx.save();ctx.globalAlpha=lAlpha;ctx.font=`${g.labelBold!==false?'bold ':''}${fSz}px sans-serif`;ctx.fillStyle=col;ctx.textAlign="center";ctx.textBaseline="middle";if(g.labelShadow){ctx.shadowColor="rgba(0,0,0,.7)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=1*d;ctx.shadowOffsetY=1*d}else{ctx.shadowColor="transparent";ctx.shadowBlur=0}ctx.fillText(g.label,pcx+lox,pcy+loy);ctx.restore()}break;case"circle":if(pts.length>=2){const r=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);ctx.beginPath();ctx.arc(pts[0].x,pts[0].y,r,0,Math.PI*2);if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=g.fillOpacity||.2;ctx.fill();ctx.globalAlpha=1;if(g.fillHatch&&g.fillHatch!=="none"){const np=64,cpts=[];for(let i=0;i<np;i++){const a=Math.PI*2*i/np;cpts.push({x:pts[0].x+Math.cos(a)*r,y:pts[0].y+Math.sin(a)*r})}drawHatchClipped(ctx,cpts,g.fillHatch,col,d,{hatchColor:g.hatchColor,hatchLineWidth:g.hatchLineWidth,hatchSpacing:g.hatchSpacing,hatchOpacity:g.hatchOpacity})}}ctx.stroke();if(g.label&&S.showLabels&&r>4*d){var lox2=g.labelOffset?g.labelOffset.x*d:0,loy2=g.labelOffset?g.labelOffset.y*d:-20*d;var fSz2=g.fontSize?(g.fontSize*d):Math.max(10*d,Math.min(24*d,r*.08));var lAlpha2=r>1500*d?Math.max(0,1-(r-1500*d)/500*d):1;ctx.save();ctx.globalAlpha=lAlpha2;ctx.font=`${g.labelBold!==false?'bold ':''}${fSz2}px sans-serif`;ctx.fillStyle=col;ctx.textAlign="center";ctx.textBaseline="middle";if(g.labelShadow){ctx.shadowColor="rgba(0,0,0,.7)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=1*d;ctx.shadowOffsetY=1*d}else{ctx.shadowColor="transparent";ctx.shadowBlur=0}ctx.fillText(g.label,pts[0].x+lox2,pts[0].y+loy2);ctx.restore()}}break;case"rectangle":if(pts.length>=2){const x=Math.min(pts[0].x,pts[1].x),y=Math.min(pts[0].y,pts[1].y),w=Math.abs(pts[1].x-pts[0].x),h=Math.abs(pts[1].y-pts[0].y),rcx=x+w/2,rcy=y+h/2;ctx.save();if(g.rotation){ctx.translate(rcx,rcy);ctx.rotate(g.rotation*Math.PI/180);ctx.translate(-rcx,-rcy)}if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=g.fillOpacity||.2;ctx.fillRect(x,y,w,h);ctx.globalAlpha=1;if(g.fillHatch&&g.fillHatch!=="none"){const rpts=[{x,y},{x:x+w,y},{x:x+w,y:y+h},{x,y:y+h}];drawHatchClipped(ctx,rpts,g.fillHatch,col,d,{hatchColor:g.hatchColor,hatchLineWidth:g.hatchLineWidth,hatchSpacing:g.hatchSpacing,hatchOpacity:g.hatchOpacity})}}ctx.strokeRect(x,y,w,h);var rSz=Math.min(w,h);if(g.label){var lox3=g.labelOffset?g.labelOffset.x*d:0,loy3=g.labelOffset?g.labelOffset.y*d:-20*d;var fSz3=g.fontSize?(g.fontSize*d):Math.max(10*d,Math.min(24*d,Math.max(rSz,20*d)*.08));var lAlpha3=rSz>3000*d?Math.max(0,1-(rSz-3000*d)/1000*d):1;ctx.globalAlpha=lAlpha3;ctx.font=`${g.labelBold!==false?'bold ':''}${fSz3}px sans-serif`;ctx.fillStyle=col;ctx.textAlign="center";ctx.textBaseline="middle";if(g.labelShadow){ctx.shadowColor="rgba(0,0,0,.7)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=1*d;ctx.shadowOffsetY=1*d}else{ctx.shadowColor="transparent";ctx.shadowBlur=0}ctx.fillText(g.label,rcx+lox3,rcy+loy3)}ctx.restore()}break;case"text":if(pts.length>=1&&g.label){ctx.save();if(g.rotation){ctx.translate(pts[0].x,pts[0].y);ctx.rotate(g.rotation*Math.PI/180);ctx.translate(-pts[0].x,-pts[0].y)}ctx.font=`${g.labelBold!==false?'bold ':''}${(g.fontSize||14)*d}px ${g.fontFamily||"sans-serif"}`;ctx.fillStyle=col;ctx.textAlign="left";ctx.textBaseline="top";if(g.labelShadow){ctx.shadowColor="rgba(0,0,0,.7)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=1*d;ctx.shadowOffsetY=1*d}ctx.fillText(g.label,pts[0].x,pts[0].y);ctx.restore()}break}ctx.restore();/* Measurement labels for converted measure graphics */
if(g.showMeasure&&g._measureData){ctx.save();ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;
if(g._measureData.type==="distance"&&g._measureData.segments){
for(let i=1;i<pts.length&&i-1<g._measureData.segments.length;i++){const mx=(pts[i-1].x+pts[i].x)/2,my=(pts[i-1].y+pts[i].y)/2;const txt=formatDist(g._measureData.segments[i-1]);const tw=ctx.measureText(txt).width;ctx.fillStyle="rgba(0,0,0,.75)";ctx.fillRect(mx-tw/2-3*d,my-14*d,tw+6*d,14*d);ctx.textAlign="center";ctx.textBaseline="bottom";ctx.fillStyle="#ffd700";ctx.fillText(txt,mx,my-2*d)}
const lp=pts[pts.length-1];const ttxt="Total: "+formatDist(g._measureData.totalDist);const ttw=ctx.measureText(ttxt).width;ctx.font=`bold ${11*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.fillStyle="rgba(0,0,0,.85)";ctx.fillRect(lp.x+8*d,lp.y-6*d,ttw+8*d,16*d);ctx.textAlign="left";ctx.textBaseline="top";ctx.fillStyle="#ffd700";ctx.fillText(ttxt,lp.x+12*d,lp.y-4*d)}
if(g._measureData.type==="area"){let cx2=0,cy2=0;pts.forEach(p=>{cx2+=p.x;cy2+=p.y});cx2/=pts.length;cy2/=pts.length;
ctx.textAlign="center";ctx.textBaseline="middle";
const lines2=["P: "+formatDist(g._measureData.totalPerim),"A: "+formatArea(g._measureData.area)];let ly2=cy2-8*d;
lines2.forEach(txt=>{const tw=ctx.measureText(txt).width;ctx.fillStyle="rgba(0,0,0,.85)";ctx.fillRect(cx2-tw/2-4*d,ly2-8*d,tw+8*d,16*d);ctx.fillStyle="#ffd700";ctx.fillText(txt,cx2,ly2);ly2+=16*d})}
ctx.restore()}
/* Highlight glow for hovered strokes in MCOO panel */
if(S._highlightGfx&&g.id===S._highlightGfx&&pts.length>=2){ctx.save();ctx.strokeStyle="#fff";ctx.lineWidth=(lw+6*d);ctx.globalAlpha=0.5;ctx.lineCap="round";ctx.lineJoin="round";ctx.setLineDash([]);ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();ctx.restore()}
if(g.id===S.selectedGraphicId){pts.forEach((p,pi)=>{ctx.save();ctx.fillStyle="#4a9eff";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.beginPath();ctx.arc(p.x,p.y,7*d,0,Math.PI*2);ctx.fill();ctx.stroke();/* Show point index if hovered in editor */if(S._hoveredPtIdx===pi&&S._hoveredPtGid===g.id){ctx.fillStyle="#fff";ctx.strokeStyle="rgba(0,0,0,.8)";ctx.lineWidth=3*d;ctx.font=`bold ${12*d}px sans-serif`;ctx.textAlign="center";ctx.textBaseline="bottom";ctx.strokeText(String(pi+1),p.x,p.y-10*d);ctx.fillText(String(pi+1),p.x,p.y-10*d)}ctx.restore()});
/* Center handle for closed shapes (polygon, circle, rectangle) */
if((g.tool==="polygon"&&g.points.length>=3)||(g.tool==="circle"&&g.points.length>=2)||(g.tool==="rectangle"&&g.points.length>=2)){let cx,cy;if(g.tool==="polygon"){cx=0;cy=0;pts.forEach(p=>{cx+=p.x;cy+=p.y});cx/=pts.length;cy/=pts.length}else if(g.tool==="rectangle"){cx=(Math.min(pts[0].x,pts[1].x)+Math.max(pts[0].x,pts[1].x))/2;cy=(Math.min(pts[0].y,pts[1].y)+Math.max(pts[0].y,pts[1].y))/2}else{cx=pts[0].x;cy=pts[0].y}
ctx.save();ctx.fillStyle="#4a9eff";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.beginPath();ctx.arc(cx,cy,8*d,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.strokeStyle="#fff";ctx.lineWidth=1.5*d;ctx.beginPath();ctx.moveTo(cx-4*d,cy);ctx.lineTo(cx+4*d,cy);ctx.moveTo(cx,cy-4*d);ctx.lineTo(cx,cy+4*d);ctx.stroke();ctx.restore();
/* Label drag handle if label exists — offset to left of text */
if(g.label){var lcx=cx+(g.labelOffset?g.labelOffset.x*d:0),lcy=cy+(g.labelOffset?g.labelOffset.y*d:-20*d);
/* Label drag handle — gold dot to the left of text */
ctx.save();ctx.font=`${g.labelBold!==false?'bold ':''}${(g.fontSize||14)*d}px sans-serif`;var tw=ctx.measureText(g.label).width;ctx.restore();var hdx=lcx-tw/2-10*d;
ctx.save();ctx.fillStyle="#ffd700";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.beginPath();ctx.arc(hdx,lcy,5*d,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.restore()}}}})}
function drawOvl(c2,g,pts,d){const col=g.color||"#f44";
/* Helper: draw label at both endpoints, following line angle */
function drawEndpointLabels(label,prefix){if(!label||pts.length<2)return;c2.setLineDash([]);c2.font=`bold ${11*d}px sans-serif`;c2.fillStyle=col;c2.strokeStyle="rgba(0,0,0,.6)";c2.lineWidth=3*d;var txt=prefix?prefix+" "+label:label;
/* First endpoint — offset outward along line direction */var p0=pts[0],p1=pts[1];var dx=p0.x-p1.x,dy=p0.y-p1.y,len=Math.hypot(dx,dy)||1;var ox=dx/len*14*d,oy=dy/len*14*d;var ang=Math.atan2(p1.y-p0.y,p1.x-p0.x);c2.save();c2.translate(p0.x+ox,p0.y+oy);var ra=ang;if(ra>Math.PI/2||ra<-Math.PI/2)ra+=Math.PI;c2.rotate(ra);c2.textAlign="center";c2.textBaseline="bottom";c2.strokeText(txt,0,-2*d);c2.fillText(txt,0,-2*d);c2.restore();
/* Last endpoint — offset outward */var pN=pts[pts.length-1],pN1=pts[pts.length-2];dx=pN.x-pN1.x;dy=pN.y-pN1.y;len=Math.hypot(dx,dy)||1;ox=dx/len*14*d;oy=dy/len*14*d;ang=Math.atan2(pN.y-pN1.y,pN.x-pN1.x);c2.save();c2.translate(pN.x+ox,pN.y+oy);ra=ang;if(ra>Math.PI/2||ra<-Math.PI/2)ra+=Math.PI;c2.rotate(ra);c2.textAlign="center";c2.textBaseline="bottom";c2.strokeText(txt,0,-2*d);c2.fillText(txt,0,-2*d);c2.restore()}
switch(g.overlayType){case"pl":setDash(c2,g.lineStyle||"dashed",d);c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();drawEndpointLabels(g.label,"PL");break;case"ld":setDash(c2,g.lineStyle||"dashed",d);c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();drawEndpointLabels(g.label,"LD");break;case"boundary":{/* Boundary: dashed line with echelon marks at segment midpoints, gaps in line */
c2.setLineDash([]);
var bEch=g.echelon||"brigade",bE=ECHELONS.find(x=>x.id===bEch),bMark=bE?bE.mark:"x1";
/* Compute mark size based on echelon type */var ts=10*d,gapR=ts*1.8;
if(bMark.startsWith("x")){var nX=parseInt(bMark[1]),xGap=10*d;ts=(nX-1)*xGap/2+5*d;gapR=ts+8*d}
else if(bMark.startsWith("bar")){var nB=parseInt(bMark[3]),bGap=6*d;ts=(nB-1)*bGap/2+4*d;gapR=ts+8*d}
else if(bMark.startsWith("dot")){var nD=parseInt(bMark[3]),dGap=7*d;ts=(nD-1)*dGap/2+4*d;gapR=ts+8*d}
else{gapR=14*d}
/* Collect mark positions at midpoint of each segment */var xMarks=[];for(let i=0;i<pts.length-1;i++){var mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;xMarks.push({x:mx,y:my,seg:i})}
/* Draw line segments with gaps around each mark */setDash(c2,g.lineStyle||"dashed",d);
for(let i=0;i<pts.length-1;i++){var p0=pts[i],p1=pts[i+1];var segLen=Math.hypot(p1.x-p0.x,p1.y-p0.y);if(segLen<1)continue;var dx=(p1.x-p0.x)/segLen,dy=(p1.y-p0.y)/segLen;
var xm=xMarks.find(m=>m.seg===i);if(xm&&segLen>gapR*3){var midT=0.5,gapStart=midT*segLen-gapR,gapEnd=midT*segLen+gapR;
c2.beginPath();c2.moveTo(p0.x,p0.y);c2.lineTo(p0.x+dx*gapStart,p0.y+dy*gapStart);c2.stroke();
c2.beginPath();c2.moveTo(p0.x+dx*gapEnd,p0.y+dy*gapEnd);c2.lineTo(p1.x,p1.y);c2.stroke()}else{c2.beginPath();c2.moveTo(p0.x,p0.y);c2.lineTo(p1.x,p1.y);c2.stroke()}}
/* Draw echelon marks and labels */c2.setLineDash([]);var saveLW=c2.lineWidth;c2.lineWidth=Math.max(2*d,saveLW);c2.strokeStyle=col;c2.fillStyle=col;
xMarks.forEach(function(xm){
/* Draw the echelon mark at xm position */
if(bMark.startsWith("x")){var nX=parseInt(bMark[1]),xGap=10*d,tw=(nX-1)*xGap;for(let i=0;i<nX;i++){var px=xm.x-tw/2+i*xGap;c2.beginPath();c2.moveTo(px-4*d,xm.y-5*d);c2.lineTo(px+4*d,xm.y+5*d);c2.moveTo(px+4*d,xm.y-5*d);c2.lineTo(px-4*d,xm.y+5*d);c2.stroke()}}
else if(bMark.startsWith("bar")){var nB=parseInt(bMark[3]),bGap2=6*d,tw2=(nB-1)*bGap2;for(let i=0;i<nB;i++){var px2=xm.x-tw2/2+i*bGap2;c2.beginPath();c2.moveTo(px2,xm.y-7*d);c2.lineTo(px2,xm.y+7*d);c2.stroke()}}
else if(bMark.startsWith("dot")){var nD2=parseInt(bMark[3]),dGap2=7*d,tw3=(nD2-1)*dGap2;for(let i=0;i<nD2;i++){c2.beginPath();c2.arc(xm.x-tw3/2+i*dGap2,xm.y,2.8*d,0,Math.PI*2);c2.fill()}}
else if(bMark==="slashO"){var r2=4*d;c2.beginPath();c2.arc(xm.x,xm.y,r2,0,Math.PI*2);c2.stroke();c2.beginPath();c2.moveTo(xm.x-r2*.7,xm.y+r2*.7);c2.lineTo(xm.x+r2*.7,xm.y-r2*.7);c2.stroke()}
else if(bMark==="cmd"){var r3=6*d;c2.beginPath();for(let i=0;i<5;i++){var a1=Math.PI*2*i/5-Math.PI/2,a2=Math.PI*2*(i+0.5)/5-Math.PI/2;c2.lineTo(xm.x+Math.cos(a1)*r3,xm.y+Math.sin(a1)*r3);c2.lineTo(xm.x+Math.cos(a2)*r3*0.4,xm.y+Math.sin(a2)*r3*0.4)}c2.closePath();c2.fill()}
/* Compute mark vertical extent for label positioning */
var markH=ts;
/* Unit labels above and below */var ua=g.unitAbove||"",ub=g.unitBelow||"";if(ua||ub){c2.font=`bold ${10*d}px sans-serif`;c2.fillStyle=col;c2.textAlign="center";if(ua){c2.textBaseline="bottom";c2.fillText(ua,xm.x,xm.y-markH-3*d)}if(ub){c2.textBaseline="top";c2.fillText(ub,xm.x,xm.y+markH+3*d)}}
c2.lineWidth=saveLW});
drawEndpointLabels(g.label,"");break}case"aa":if(pts.length>=2){const x=Math.min(pts[0].x,pts[1].x),y=Math.min(pts[0].y,pts[1].y),w=Math.abs(pts[1].x-pts[0].x),h=Math.abs(pts[1].y-pts[0].y);c2.fillStyle=col;c2.globalAlpha=.1;c2.fillRect(x,y,w,h);c2.globalAlpha=1;setDash(c2,g.lineStyle||"dashed",d);c2.strokeRect(x,y,w,h);c2.setLineDash([]);if(g.label){var aacx=x+w/2,aacy=y+h/2;var aalox=g.labelOffset?g.labelOffset.x*d:0,aaloy=g.labelOffset?g.labelOffset.y*d:-20*d;c2.font=`bold ${12*d}px sans-serif`;c2.fillStyle=col;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("AA "+g.label,aacx+aalox,aacy+aaloy)}}break;case"axis":if(pts.length>=2){const lw=c2.lineWidth,as=(g.arrowSize||1)*d;c2.lineWidth=lw*6;c2.globalAlpha=.2;c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();c2.globalAlpha=1;c2.lineWidth=lw;c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();drawAH(c2,pts[pts.length-2],pts[pts.length-1],lw*2,col,as)}break;case"route":c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();{const as=(g.arrowSize||1)*d;for(let i=0;i<pts.length-1;i++){const mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;drawAH(c2,pts[i],{x:mx,y:my},c2.lineWidth,col,as)}}break}}
function drawDrawPreview(){if(!S._drawMode)return;const d=devicePixelRatio||1,dm=S._drawMode;if(!dm.points.length)return;
/* Rectangle: special ghost preview with cursor tracking and rotation handle */
if(dm.tool==="rectangle"&&dm.points.length===1&&dm._cursor){
  const p0=latlonToScreen(dm.points[0].lat,dm.points[0].lon);
  const p1=dm._cursor;
  const x0=p0.x*d,y0=p0.y*d,x1=p1.x*d,y1=p1.y*d;
  const rx=Math.min(x0,x1),ry=Math.min(y0,y1),rw=Math.abs(x1-x0),rh=Math.abs(y1-y0);
  const rcx=rx+rw/2,rcy=ry+rh/2;
  const rot=(dm.rotation||0)*Math.PI/180;
  ctx.save();
  ctx.translate(rcx,rcy);ctx.rotate(rot);ctx.translate(-rcx,-rcy);
  ctx.strokeStyle=dm.color||"#ffd700";ctx.lineWidth=Math.max(1,(dm.lineWidth||2))*d;
  ctx.setLineDash([6*d,3*d]);ctx.strokeRect(rx,ry,rw,rh);ctx.setLineDash([]);
  /* Corner anchor dot */
  ctx.beginPath();ctx.arc(x0,y0,6*d,0,Math.PI*2);ctx.fillStyle="#ffd700";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.fill();ctx.stroke();
  /* Rotation handle — red dot above center */
  const handleDist=Math.max(rw,rh)/2+28*d;
  const hx=rcx,hy=rcy-handleDist;/* before rotation it's straight up */
  /* actual handle in rotated space */
  const cosR=Math.cos(rot),sinR=Math.sin(rot);
  const dhx=rcx+(hx-rcx)*cosR-(hy-rcy)*sinR;
  const dhy=rcy+(hx-rcx)*sinR+(hy-rcy)*cosR;
  /* Line from center to handle */
  ctx.restore();ctx.save();
  ctx.strokeStyle="rgba(255,68,68,.7)";ctx.lineWidth=1.5*d;ctx.setLineDash([3*d,3*d]);
  ctx.beginPath();ctx.moveTo(rcx,rcy);ctx.lineTo(dhx,dhy);ctx.stroke();ctx.setLineDash([]);
  /* Handle dot */
  ctx.fillStyle="#ff4444";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;
  ctx.beginPath();ctx.arc(dhx,dhy,5*d,0,Math.PI*2);ctx.fill();ctx.stroke();
  /* Rotation angle text */
  if(dm.rotation){
    ctx.fillStyle="#fff";ctx.strokeStyle="rgba(0,0,0,.6)";ctx.lineWidth=3*d;
    ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.textAlign="center";ctx.textBaseline="bottom";
    const txt=Math.round(dm.rotation)+"°";
    ctx.strokeText(txt,dhx,dhy-8*d);ctx.fillText(txt,dhx,dhy-8*d);
  }
  ctx.restore();
  /* Store handle position for hit-testing */
  dm._rotHandle={x:dhx/d,y:dhy/d};
  return;
}
const pts=dm.points.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});ctx.save();ctx.strokeStyle=dm.color||"#ffd700";ctx.lineWidth=Math.max(1,(dm.lineWidth||2))*d;ctx.setLineDash([6*d,3*d]);ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));if(dm.tool==="polygon"&&pts.length>2)ctx.lineTo(pts[0].x,pts[0].y);ctx.stroke();ctx.setLineDash([]);pts.forEach((p,i)=>{const isLast=i===pts.length-1;ctx.beginPath();if(isLast){ctx.arc(p.x,p.y,10*d,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle="#ffd700";ctx.lineWidth=3*d;ctx.stroke()}else{ctx.arc(p.x,p.y,6*d,0,Math.PI*2);ctx.fillStyle="#ffd700";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.fill();ctx.stroke()}});ctx.restore()}


// === part_05b_maptools.js ===

function drawMapTools(){const d=devicePixelRatio||1;
/* Draw measure line */
if(S._measurePoints.length>=1){ctx.save();
const pts=S._measurePoints.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});
ctx.strokeStyle="#ffd700";ctx.lineWidth=2.5*d;ctx.setLineDash([8*d,4*d]);
ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();ctx.setLineDash([]);
/* Dots at vertices */
pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,5*d,0,Math.PI*2);ctx.fillStyle="#ffd700";ctx.fill();ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.stroke()});
/* Segment labels */
let totalDist=0;
for(let i=1;i<S._measurePoints.length;i++){const a=S._measurePoints[i-1],b=S._measurePoints[i];const seg=haversine(a.lat,a.lon,b.lat,b.lon);totalDist+=seg;
const mx=(pts[i-1].x+pts[i].x)/2,my=(pts[i-1].y+pts[i].y)/2;
ctx.font=`bold ${10*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="center";ctx.textBaseline="bottom";
const txt=formatDist(seg);const tw=ctx.measureText(txt).width;
ctx.fillStyle="rgba(0,0,0,.75)";ctx.fillRect(mx-tw/2-3*d,my-14*d,tw+6*d,14*d);
ctx.fillStyle="#ffd700";ctx.fillText(txt,mx,my-2*d)}
/* Total label at last point */
if(S._measurePoints.length>=2){const lp=pts[pts.length-1];
ctx.font=`bold ${11*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="left";ctx.textBaseline="top";
const txt="Total: "+formatDist(totalDist);const tw=ctx.measureText(txt).width;
ctx.fillStyle="rgba(0,0,0,.85)";ctx.fillRect(lp.x+8*d,lp.y-6*d,tw+8*d,16*d);
ctx.fillStyle="#ffd700";ctx.fillText(txt,lp.x+12*d,lp.y-4*d)}
ctx.restore()}
/* Draw area measure */
if(S._measureArea.length>=1){ctx.save();
const pts=S._measureArea.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});
/* Fill */
if(pts.length>=3){ctx.fillStyle="rgba(255,215,0,.15)";ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.closePath();ctx.fill()}
/* Outline */
ctx.strokeStyle="#ffd700";ctx.lineWidth=2*d;ctx.setLineDash([6*d,3*d]);
ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));if(pts.length>=3)ctx.closePath();ctx.stroke();ctx.setLineDash([]);
/* Dots */
pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,5*d,0,Math.PI*2);ctx.fillStyle="#ffd700";ctx.fill();ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.stroke()});
/* Perimeter and area labels */
if(S._measureArea.length>=2){let perim=0;for(let i=1;i<S._measureArea.length;i++)perim+=haversine(S._measureArea[i-1].lat,S._measureArea[i-1].lon,S._measureArea[i].lat,S._measureArea[i].lon);
if(S._measureArea.length>=3)perim+=haversine(S._measureArea[S._measureArea.length-1].lat,S._measureArea[S._measureArea.length-1].lon,S._measureArea[0].lat,S._measureArea[0].lon);
const area=polyArea(S._measureArea);
/* Centroid */
let cx2=0,cy2=0;pts.forEach(p=>{cx2+=p.x;cy2+=p.y});cx2/=pts.length;cy2/=pts.length;
ctx.font=`bold ${11*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="center";ctx.textBaseline="middle";
const lines2=["P: "+formatDist(perim)];if(S._measureArea.length>=3)lines2.push("A: "+formatArea(area));
let ly2=cy2-lines2.length*8*d;
lines2.forEach(txt=>{const tw=ctx.measureText(txt).width;ctx.fillStyle="rgba(0,0,0,.85)";ctx.fillRect(cx2-tw/2-4*d,ly2-8*d,tw+8*d,16*d);ctx.fillStyle="#ffd700";ctx.fillText(txt,cx2,ly2);ly2+=16*d})}
ctx.restore()}}

function activateMapTool(tool){
if(S._mapTool===tool||tool===null){S._mapTool=null;_freehandActive=false;_freehandPoints=[];hideModeBar();canvas.style.cursor=""}
else{S._mapTool=tool;deselectAll();if(tool==="freehand"){canvas.style.cursor="crosshair";showFreehandBar()}else{showModeBar();updateModeBar()}}
requestRender();renderFloatingPanel()}

/* Freehand helpers */
function simplifyFreehand(pts,tolerance){
  if(pts.length<=2)return pts;
  var out=[pts[0]];
  for(var i=1;i<pts.length;i++){
    var last=out[out.length-1];
    if(Math.hypot(pts[i].x-last.x,pts[i].y-last.y)>=tolerance){out.push(pts[i])}
  }
  if(out.length<2)out.push(pts[pts.length-1]);
  return out}

function showFreehandBar(){
  var mb=document.getElementById("mode-bar");mb.style.display="flex";mb.classList.add("open");
  renderFreehandBar()}

function renderFreehandBar(){
  var mb=document.getElementById("mode-bar");if(!mb)return;
  var h='<div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap">';
  /* Color wheel input */
  h+='<label style="position:relative;cursor:pointer;width:26px;height:26px;flex-shrink:0">';
  h+='<input type="color" id="mcoo-colorpicker" value="'+_freehandOpts.color+'" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer">';
  h+='<div style="width:26px;height:26px;border-radius:50%;background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red);border:2px solid rgba(255,255,255,.6)"></div>';
  h+='</label>';
  /* Active color preview */
  h+='<div style="width:22px;height:22px;border-radius:3px;background:'+_freehandOpts.color+';border:2px solid #fff;flex-shrink:0;cursor:pointer" onclick="mcooAddSwatch()" title="Pin this color"></div>';
  h+='<span style="opacity:.2;margin:0 1px">|</span>';
  /* Pinned swatches */
  _pinnedSwatches.forEach(function(c,i){
    var sel=_freehandOpts.color===c;
    h+='<div style="width:20px;height:20px;border-radius:3px;background:'+c+';cursor:pointer;border:2px solid '+(sel?'#fff':'transparent')+';flex-shrink:0;position:relative" onclick="_freehandOpts.color=\''+c+'\';renderFreehandBar()" oncontextmenu="event.preventDefault();mcooRemoveSwatch('+i+')">';
    h+='</div>';
  });
  h+='<span style="opacity:.2;margin:0 1px">|</span>';
  /* Width buttons */
  FREEHAND_WIDTHS.forEach(function(w){
    var sel=_freehandOpts.lineWidth===w;
    h+='<button class="btn'+(sel?' primary':'')+'" onclick="_freehandOpts.lineWidth='+w+';renderFreehandBar()" style="padding:1px 5px;font-size:9px;min-height:24px;min-width:24px">'+w+'</button>';
  });
  h+='<span style="opacity:.2;margin:0 1px">|</span>';
  /* Stroke count */
  var strokeCount=S.graphics.filter(function(g){return g.layerId===_mcooLayerId&&g._freehand}).length;
  h+='<span style="font-size:9px;opacity:.4">'+strokeCount+'/'+MCOO_MAX_STROKES+'</span>';
  h+='<button class="btn danger" onclick="activateMapTool(null)" style="padding:2px 6px;font-size:11px;min-height:24px">\u2715</button>';
  h+='</div>';
  mb.innerHTML=h;
  /* Wire color picker */
  var cp=document.getElementById("mcoo-colorpicker");
  if(cp)cp.addEventListener("input",function(e){_freehandOpts.color=e.target.value;renderFreehandBar()})}

function mcooAddSwatch(){
  if(_pinnedSwatches.indexOf(_freehandOpts.color)<0&&_pinnedSwatches.length<12){
    _pinnedSwatches.push(_freehandOpts.color);
    localStorage.setItem("tacmap-mcoo-swatches",JSON.stringify(_pinnedSwatches));
    renderFreehandBar();notify("Color pinned")}}
function mcooRemoveSwatch(idx){
  _pinnedSwatches.splice(idx,1);
  localStorage.setItem("tacmap-mcoo-swatches",JSON.stringify(_pinnedSwatches));
  renderFreehandBar();notify("Swatch removed")}

function drawFreehandPreview(){
  if(!_freehandActive||_freehandPoints.length<2)return;
  var d=devicePixelRatio||1;
  ctx.save();
  ctx.strokeStyle=_freehandOpts.color;
  ctx.lineWidth=_freehandOpts.lineWidth*d;
  ctx.lineCap="round";ctx.lineJoin="round";
  ctx.globalAlpha=_freehandOpts.opacity;
  ctx.beginPath();
  _freehandPoints.forEach(function(p,i){
    if(i===0)ctx.moveTo(p.x*d,p.y*d);
    else ctx.lineTo(p.x*d,p.y*d);
  });
  ctx.stroke();
  ctx.restore()}

function clearMapToolData(type){if(type==="distance")S._measurePoints=[];if(type==="area")S._measureArea=[];requestRender();renderFloatingPanel()}

function convertMeasureToGraphic(type){
if(type==="distance"&&S._measurePoints.length>=2){
let total=0;for(let i=1;i<S._measurePoints.length;i++)total+=haversine(S._measurePoints[i-1].lat,S._measurePoints[i-1].lon,S._measurePoints[i].lat,S._measurePoints[i].lon);
const segs=[];for(let i=1;i<S._measurePoints.length;i++)segs.push(haversine(S._measurePoints[i-1].lat,S._measurePoints[i-1].lon,S._measurePoints[i].lat,S._measurePoints[i].lon));
const g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:"line",points:[...S._measurePoints],color:"#ffd700",lineWidth:2,lineStyle:"dashed",overlayType:"none",fill:false,fillColor:"#ffd700",label:formatDist(total),layerId:S.activeLayerId,_measureData:{type:"distance",totalDist:total,segments:segs},showMeasure:true};
S.graphics.push(g);S._measurePoints=[];selectGraphic(g.id);netBroadcast({type:"graphicAdd",graphic:g});notify("Converted to line");requestRender();renderFloatingPanel()}
if(type==="area"&&S._measureArea.length>=3){
let perim=0;for(let i=1;i<S._measureArea.length;i++)perim+=haversine(S._measureArea[i-1].lat,S._measureArea[i-1].lon,S._measureArea[i].lat,S._measureArea[i].lon);
perim+=haversine(S._measureArea[S._measureArea.length-1].lat,S._measureArea[S._measureArea.length-1].lon,S._measureArea[0].lat,S._measureArea[0].lon);
const area=polyArea(S._measureArea);
const g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:"polygon",points:[...S._measureArea],color:"#ffd700",lineWidth:2,lineStyle:"dashed",overlayType:"none",fill:true,fillColor:"#ffd700",label:formatArea(area),layerId:S.activeLayerId,_measureData:{type:"area",totalPerim:perim,area:area},showMeasure:true};
S.graphics.push(g);S._measureArea=[];selectGraphic(g.id);netBroadcast({type:"graphicAdd",graphic:g});notify("Converted to polygon");requestRender();renderFloatingPanel()}}

function coordSearch(){const inp=document.getElementById("coord-search-input");if(!inp)return;const result=parseCoordInput(inp.value);if(!result){notify("Invalid coordinates. Use lat,lon or MGRS","error");return}
/* Drop a waypoint unit and pan to it */
const u={id:"u"+Date.now()+Math.random().toString(36).substr(2,4),type:"waypoint",affiliation:"friendly",displayMode:"pin",pinColor:"#ff4444",lat:result.lat,lon:result.lon,layerId:S.activeLayerId,designation:toMGRS(result.lat,result.lon).split(" ").slice(0,2).join(""),echelon:null,modifiers:[],isHQ:false,rings:[],equipment:{}};
S.units.push(u);S.editorTab="info";smoothPanTo(result.lat,result.lon,600);S.zoom=Math.max(S.zoom,14);
selectUnit(u.id);netBroadcast({type:"unitAdd",unit:u});
notify("Found: "+toMGRS(result.lat,result.lon));requestRender();renderFloatingPanel()}

// === part_06_interaction.js ===

function smoothPanTo(lat,lon,dur){dur=dur||400;
  /* Calculate offset for mobile bottom sheet editor only */
  const ed=document.getElementById("editor");
  let offsetLat=0;
  const isMobile=window.innerWidth<=700;
  const edH=isMobile&&ed&&ed.classList.contains("open")?(ed.offsetHeight||0):0;
  if(edH>0){
    const screenH=window.innerHeight;
    /* visible center is at (screenH - edH)/2 from top, screen center is screenH/2 */
    /* shift target down by half the editor height in screen coords */
    const shiftPx=edH/2;
    /* convert pixel shift to lat offset: at current zoom, how many degrees per pixel? */
    const c1=screenToLatlon(0,screenH/2);
    const c2=screenToLatlon(0,screenH/2+1);
    const degPerPx=c1.lat-c2.lat;
    offsetLat=shiftPx*degPerPx;
  }
  const tLat=lat-offsetLat,tLon=lon;
  const sLat=S.lat,sLon=S.lon,sT=performance.now();function step(t){const p=Math.min(1,(t-sT)/dur),e=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;S.lat=sLat+(tLat-sLat)*e;S.lon=sLon+(tLon-sLon)*e;requestRender();if(p<1)requestAnimationFrame(step)}requestAnimationFrame(step)}
var _canvasRect=null;function _updateCanvasRect(){_canvasRect=canvas?canvas.getBoundingClientRect():null}
function getPos(e){_updateCanvasRect();var r=_canvasRect;return e.clientX!==undefined?{x:e.clientX-r.left,y:e.clientY-r.top}:e.touches&&e.touches[0]?{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}:{x:0,y:0}}
function hitTestUnit(pos){const sz=getUSS(),r=sz*0.4;const _hv={};S.layers.forEach(l=>{_hv[l.id]=l.visible});for(let i=S.units.length-1;i>=0;i--){const u=S.units[i];if(_hv[u.layerId]===false)continue;const sp=latlonToScreen(u.lat,u.lon);if(Math.abs(pos.x-sp.x)<r&&Math.abs(pos.y-sp.y)<r)return u;/* Check range rings — click near ring edge selects unit */if(u.rings&&u.rings.length){const dist=Math.hypot(pos.x-sp.x,pos.y-sp.y);for(const ring of u.rings){if(!ring.radius)continue;const rp=metersToPixels(ring.radius,u.lat,S.zoom);if(Math.abs(dist-rp)<10)return u}}}return null}
function pointInPoly(px,py,pts){/* Ray casting algorithm */let inside=false;for(let i=0,j=pts.length-1;i<pts.length;j=i++){const xi=pts[i].x,yi=pts[i].y,xj=pts[j].x,yj=pts[j].y;if(((yi>py)!==(yj>py))&&(px<(xj-xi)*(py-yi)/(yj-yi)+xi))inside=!inside}return inside}
function hitTestGraphic(pos){
function _gsa(g){if(!g.points||g.points.length<2)return 1e18;var n=Infinity,x=-Infinity,ny=Infinity,xy=-Infinity;var st=Math.max(1,Math.floor(g.points.length/100));for(var i=0;i<g.points.length;i+=st){var s=latlonToScreen(g.points[i].lat,g.points[i].lon);if(s.x<n)n=s.x;if(s.x>x)x=s.x;if(s.y<ny)ny=s.y;if(s.y>xy)xy=s.y}return(x-n)*(xy-ny)||1e18}
function _bbox(g){var mn=90,mx=-90,ml=180,mL=-180;for(var i=0;i<g.points.length;i++){var p=g.points[i];if(p.lat<mn)mn=p.lat;if(p.lat>mx)mx=p.lat;if(p.lon<ml)ml=p.lon;if(p.lon>mL)mL=p.lon}return{mn,mx,ml,mL}}
const _hv={};S.layers.forEach(l=>{_hv[l.id]=l.visible});var cands=[];
for(let i=S.graphics.length-1;i>=0;i--){const g=S.graphics[i];if(_hv[g.layerId]===false)continue;if(!g.points||g.points.length<1)continue;
/* Lat/lon bbox pre-check — fast rejection without latlonToScreen */
if(g.points.length>=4){var bb=_bbox(g);var tl=screenToLatlon(pos.x-30,pos.y-30),br=screenToLatlon(pos.x+30,pos.y+30);if(bb.mx<br.lat||bb.mn>tl.lat||bb.mL<tl.lon||bb.ml>br.lon)continue}
/* Vertex/edge proximity — sample max 200 points */
var vh=false,np=g.points.length,stp=np>200?Math.ceil(np/200):1;
for(var vi=0;vi<np&&!vh;vi+=stp){var sp=latlonToScreen(g.points[vi].lat,g.points[vi].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<15)vh=true}
if(!vh&&np>=2){for(var ei=0;ei<np-1&&!vh;ei+=stp){var a=latlonToScreen(g.points[ei].lat,g.points[ei].lon),ni=Math.min(ei+stp,np-1),b=latlonToScreen(g.points[ni].lat,g.points[ni].lon),dx=b.x-a.x,dy=b.y-a.y,len=Math.hypot(dx,dy);if(len<1)continue;var t=Math.max(0,Math.min(1,((pos.x-a.x)*dx+(pos.y-a.y)*dy)/(len*len))),px=a.x+t*dx,py=a.y+t*dy;if(Math.hypot(pos.x-px,pos.y-py)<15)vh=true}}
if(vh){cands.push({g,a:0});continue}
/* Interior — sample polygon for pointInPoly */
if(g.tool==="polygon"&&np>=3){var ps=np>500?Math.ceil(np/500):1,sa=[];for(var pi=0;pi<np;pi+=ps)sa.push(latlonToScreen(g.points[pi].lat,g.points[pi].lon));if(pointInPoly(pos.x,pos.y,sa)){cands.push({g,a:_gsa(g)});continue}}
if(g.tool==="circle"&&np>=2){var c=latlonToScreen(g.points[0].lat,g.points[0].lon),e2=latlonToScreen(g.points[1].lat,g.points[1].lon),r=Math.hypot(e2.x-c.x,e2.y-c.y);if(Math.hypot(pos.x-c.x,pos.y-c.y)<=r){cands.push({g,a:_gsa(g)});continue}}
if(g.tool==="rectangle"&&np>=2){var ra=latlonToScreen(g.points[0].lat,g.points[0].lon),rb=latlonToScreen(g.points[1].lat,g.points[1].lon);if(pos.x>=Math.min(ra.x,rb.x)&&pos.x<=Math.max(ra.x,rb.x)&&pos.y>=Math.min(ra.y,rb.y)&&pos.y<=Math.max(ra.y,rb.y)){cands.push({g,a:_gsa(g)});continue}}
if(g.overlayType==="obj"&&np>=2){var oc=latlonToScreen(g.points[0].lat,g.points[0].lon),oe=latlonToScreen(g.points[1].lat,g.points[1].lon),or=Math.hypot(oe.x-oc.x,oe.y-oc.y);if(Math.hypot(pos.x-oc.x,pos.y-oc.y)<=or){cands.push({g,a:_gsa(g)});continue}}
if(g.overlayType==="aa"&&np>=2){var aa=latlonToScreen(g.points[0].lat,g.points[0].lon),ab=latlonToScreen(g.points[1].lat,g.points[1].lon);if(pos.x>=Math.min(aa.x,ab.x)&&pos.x<=Math.max(aa.x,ab.x)&&pos.y>=Math.min(aa.y,ab.y)&&pos.y<=Math.max(aa.y,ab.y)){cands.push({g,a:_gsa(g)});continue}}}
if(!cands.length)return null;cands.sort((a,b)=>a.a-b.a);return cands[0].g}
function selectUnit(id){if(id!==S.selectedUnitId){S._lastClickTime=0;S._lastClickUnit=null;S._editorHeight=null}S.selectedUnitId=id;S.selectedGraphicId=null;if(id){openEditor();centerOnSelected()}requestRender()}
function selectGraphic(id){if(id!==S.selectedGraphicId){S._editorHeight=null}S.selectedGraphicId=id;S.selectedUnitId=null;if(id){openEditor();centerOnSelected()}requestRender()}
function centerOnSelected(){
  /* Center the selected unit/graphic in the visible area, offset for editor/panels */
  var u=S.selectedUnitId?S.units.find(function(x){return x.id===S.selectedUnitId}):null;
  var g=(!u&&S.selectedGraphicId)?S.graphics.find(function(x){return x.id===S.selectedGraphicId}):null;
  if(!u&&!g)return;
  var lat,lon;
  if(u){lat=u.lat;lon=u.lon}
  else if(g&&g.points&&g.points.length){
    lat=0;lon=0;g.points.forEach(function(p){lat+=p.lat;lon+=p.lon});
    lat/=g.points.length;lon/=g.points.length;
  }else return;
  /* Check if already reasonably centered */
  var sp=latlonToScreen(lat,lon);
  var w=window.innerWidth,h=window.innerHeight;
  var margin=80;
  if(sp.x>margin&&sp.x<w-margin&&sp.y>margin&&sp.y<h-margin)return;
  /* Animate to center, offset for editor */
  var edOffset=0;
  if(window.innerWidth>700){edOffset=180}/* desktop: editor on right */
  var targetX=w/2-edOffset/2,targetY=h/2;
  var curSp=latlonToScreen(lat,lon);
  var dx=curSp.x-targetX,dy=curSp.y-targetY;
  var curPx=latlonToPixel(S.lat,S.lon,S.zoom);
  var newCenter=pixelToLatlon(curPx.x+dx,curPx.y+dy,S.zoom);
  S.lat=newCenter.lat;S.lon=newCenter.lon;
}
function deselectAll(){S.selectedUnitId=null;S.selectedGraphicId=null;if(!S.editorPinned)closeEditor();requestRender()}

let _ptrDownPos=null,_ptrDownTime=0,_selOnDown=false,_dragUnit=null,_dragGV=null,_rotUnit=null,_dragStartPos=null,_gfxSelOnDown=null;
/* Freehand drawing state (MCOO) */
var _freehandActive=false,_freehandPoints=[],_freehandPressures=[];
var _freehandOpts={color:"#ff4444",lineWidth:3,opacity:1.0};
var FREEHAND_WIDTHS=[1,2,3,5,8,12];
/* Pinned swatches — user can add/remove favorites */
var _pinnedSwatches=JSON.parse(localStorage.getItem("tacmap-mcoo-swatches")||'["#ff4444","#4a9eff","#44cc44","#ffd700","#ff8800","#000000","#ffffff","#8b4513"]');
/* MCOO state */
var _mcooLayerId=null,_mcooAoId=null;
/* Performance: max points per stroke, max strokes on MCOO layer */
var MCOO_MAX_PTS_PER_STROKE=200,MCOO_MAX_STROKES=150;

function onPointerDown(e){if(e.target!==canvas)return;S._lastPointerType=e.pointerType||"mouse";const pos=getPos(e);_ptrDownPos=pos;_ptrDownTime=Date.now();_selOnDown=false;_gfxSelOnDown=null;_dragUnit=null;_dragGV=null;_rotUnit=null;S._pendingGfxSelect=null;
/* Freehand mode — start stroke */
if(S._mapTool==="freehand"){
  _freehandActive=true;_freehandPoints=[pos];_freehandPressures=[e.pressure||0.5];
  if(e.pointerId!==undefined)try{canvas.setPointerCapture(e.pointerId)}catch(ex){}
  e.preventDefault();return}
const tt=document.getElementById("map-tooltip");if(tt)tt.style.display="none";
if(e.pointerId!==undefined)S._activePointers.set(e.pointerId,pos);
if(S._activePointers.size===2){const pts=[...S._activePointers.values()];S._pinchStartDist=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);S._pinchStartZoom=S.zoom;return}
if(S._placementMode)return;
/* Allow dragging vertices of selected graphic even without draw mode */
if(S.selectedGraphicId&&!S._drawMode&&!S._panLockMode){const g=S.graphics.find(x=>x.id===S.selectedGraphicId);if(g&&g.points){
/* MCOO lock — skip all vertex/move handles, allow label drag only */
var _gLocked=!!g._mcooEnabled;
/* Ensure editor is open for the selected graphic */
openEditor();
/* Check center handle first for closed shapes */
if((g.tool==="polygon"&&g.points.length>=3)||(g.tool==="circle"&&g.points.length>=2)||(g.tool==="rectangle"&&g.points.length>=2)){let cx,cy;if(g.tool==="polygon"){cx=0;cy=0;g.points.forEach(p=>{const sp=latlonToScreen(p.lat,p.lon);cx+=sp.x;cy+=sp.y});cx/=g.points.length;cy/=g.points.length}else if(g.tool==="rectangle"){const sp0=latlonToScreen(g.points[0].lat,g.points[0].lon),sp1=latlonToScreen(g.points[1].lat,g.points[1].lon);cx=(sp0.x+sp1.x)/2;cy=(sp0.y+sp1.y)/2}else{const sp=latlonToScreen(g.points[0].lat,g.points[0].lon);cx=sp.x;cy=sp.y}
/* Label handle check first */
if(g.label){var lcx=cx+(g.labelOffset?g.labelOffset.x:0),lcy=cy+(g.labelOffset?g.labelOffset.y:-20);
/* Approximate text half-width for handle placement */var _tmpC=document.createElement("canvas").getContext("2d");_tmpC.font="bold 13px sans-serif";var _tw=_tmpC.measureText(g.label).width/2+10;var hdx=lcx-_tw;
if(Math.hypot(pos.x-hdx,pos.y-lcy)<15){_dragGV={gid:g.id,idx:-2,labelDrag:true,startPos:pos,startOffset:{x:g.labelOffset?g.labelOffset.x:0,y:g.labelOffset?g.labelOffset.y:-20}};_selOnDown=true;return}}
if(!_gLocked&&Math.hypot(pos.x-cx,pos.y-cy)<20){_dragGV={gid:g.id,idx:-1,moveAll:true,startPos:pos,startPts:g.points.map(p=>({lat:p.lat,lon:p.lon}))};_selOnDown=true;return}}
/* Then check individual vertices — skip if locked */
if(!_gLocked){for(let i=0;i<g.points.length;i++){const sp=latlonToScreen(g.points[i].lat,g.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<20){_dragGV={gid:g.id,idx:i};_selOnDown=true;return}}}
/* No handle hit on selected graphic — check if clicking something else */
var _nhUnit=hitTestUnit(pos);if(_nhUnit){selectUnit(_nhUnit.id);_dragUnit=_nhUnit;_dragStartPos={lat:_nhUnit.lat,lon:_nhUnit.lon};_selOnDown=true;return}
var _nhGfx=hitTestGraphic(pos);if(_nhGfx&&_nhGfx.id!==g.id){_gfxSelOnDown=_nhGfx.id;S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon};return}
/* Inside selected graphic or empty space — pan, allow deselect on pointerUp */
S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon};return}}
/* During active drawing, allow dragging existing points of the in-progress shape */
if(S._drawMode&&S._drawMode.points.length>0){
/* Rectangle draw-mode rotation handle hit */
if(S._drawMode.tool==="rectangle"&&S._drawMode.points.length===1&&S._drawMode._rotHandle){
  const rh=S._drawMode._rotHandle;
  if(Math.hypot(pos.x-rh.x,pos.y-rh.y)<14){S._drawMode._rotDrag=true;_selOnDown=true;return}
}
for(let i=0;i<S._drawMode.points.length;i++){const sp=latlonToScreen(S._drawMode.points[i].lat,S._drawMode.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<20){_dragGV={drawMode:true,idx:i};_selOnDown=true;return}}}
if(S._drawMode)return;
/* Pan Lock mode — skip all selection, just pan */
if(S._panLockMode){S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon};return}
/* Map tool active — allow panning but skip unit selection */
if(S._mapTool){canvas.style.cursor="crosshair";S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon};return}
/* Check rotation handle first */
const rh=hitTestRotHandle(pos);if(rh){_rotUnit=rh;_selOnDown=true;return}
const hit=hitTestUnit(pos),isTouch=S._lastPointerType==="touch",isCtrl=e.ctrlKey||e.metaKey,isShift=e.shiftKey;
if(hit){if(isTouch){if(hit.id===S.selectedUnitId){_dragUnit=hit;_dragStartPos={lat:hit.lat,lon:hit.lon};_selOnDown=true;openEditor()}else{selectUnit(hit.id);_selOnDown=true}}else{selectUnit(hit.id);_dragUnit=hit;_dragStartPos={lat:hit.lat,lon:hit.lon};_selOnDown=true}return}
const hitG=hitTestGraphic(pos);if(hitG){_gfxSelOnDown=hitG.id;S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon};return}
S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon}}

function onPointerMove(e){const pos=getPos(e);if(e.pointerId!==undefined)S._activePointers.set(e.pointerId,pos);
/* Freehand stroke capture */
if(_freehandActive&&S._mapTool==="freehand"){
  var last=_freehandPoints[_freehandPoints.length-1];
  var dist=Math.hypot(pos.x-last.x,pos.y-last.y);
  if(dist>2){_freehandPoints.push(pos);_freehandPressures.push(e.pressure||0.5);requestRender()}
  e.preventDefault();return}
if(S._activePointers.size===2&&S._pinchStartDist){const pts=[...S._activePointers.values()],dist=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);S.zoom=Math.max(2,Math.min(19,S._pinchStartZoom+Math.log2(dist/S._pinchStartDist)));requestRender();updateCoords(pos);return}
if(_rotUnit){canvas.style.cursor="grabbing";const sp=latlonToScreen(_rotUnit.lat,_rotUnit.lon);const dx=pos.x-sp.x,dy=-(pos.y-sp.y);let ang=Math.atan2(dx,dy)/DEG;ang=((ang%360)+360)%360;_rotUnit.rotation=Math.round(ang);debouncedUnitSync(_rotUnit);openEditor();requestRender();return}
/* Rectangle draw-mode rotation drag */
if(S._drawMode&&S._drawMode.tool==="rectangle"&&S._drawMode._rotDrag){
  const dm=S._drawMode;
  const p0=latlonToScreen(dm.points[0].lat,dm.points[0].lon);
  const p1=dm._cursor||pos;
  const rcx=(p0.x+(p1.x))/2,rcy=(p0.y+(p1.y))/2;
  const dx=pos.x-rcx,dy=-(pos.y-rcy);
  let ang=Math.atan2(dx,dy)/DEG;ang=((ang%360)+360)%360;
  dm.rotation=Math.round(ang);requestRender();return;
}
if(_dragUnit){const ll=screenToLatlon(pos.x,pos.y);_dragUnit.lat=ll.lat;_dragUnit.lon=ll.lon;debouncedUnitSync(_dragUnit);requestRender();return}
if(_dragGV){if(_dragGV.drawMode){/* Dragging a vertex of the in-progress drawing */const ll=screenToLatlon(pos.x,pos.y);S._drawMode.points[_dragGV.idx]={lat:ll.lat,lon:ll.lon};requestRender();return}const g=S.graphics.find(x=>x.id===_dragGV.gid);if(g){if(_dragGV.labelDrag){/* Drag label offset */var dx2=pos.x-_dragGV.startPos.x,dy2=pos.y-_dragGV.startPos.y;g.labelOffset={x:_dragGV.startOffset.x+dx2,y:_dragGV.startOffset.y+dy2};debouncedGfxSync(g.id);requestRender();return}if(_dragGV.moveAll){/* Move all points by delta */const dx=pos.x-_dragGV.startPos.x,dy=pos.y-_dragGV.startPos.y;for(let i=0;i<g.points.length;i++){const origSp=latlonToScreen(_dragGV.startPts[i].lat,_dragGV.startPts[i].lon);const nl=screenToLatlon(origSp.x+dx,origSp.y+dy);g.points[i]={lat:nl.lat,lon:nl.lon}}}else{const ll=screenToLatlon(pos.x,pos.y);g.points[_dragGV.idx]={lat:ll.lat,lon:ll.lon}}debouncedGfxSync(g.id);requestRender()}return}
if(S._isPanning&&S._panStart){const dx=pos.x-S._panStart.x,dy=pos.y-S._panStart.y,d=devicePixelRatio||1,c=latlonToPixel(S._panStart.lat,S._panStart.lon,S.zoom);const newC=pixelToLatlon(c.x-dx,c.y-dy,S.zoom);S.lat=newC.lat;S.lon=newC.lon;requestRender()}
/* Track cursor for rectangle ghost preview */
if(S._drawMode&&S._drawMode.tool==="rectangle"&&S._drawMode.points.length===1){
  S._drawMode._cursor=pos;requestRender();
}
updateCoords(pos);
/* Unit hover tooltip — skip on touch (no hover on mobile) */
if(S._lastPointerType!=="touch"&&!S._isPanning&&!_dragUnit&&!_dragGV&&!_rotUnit&&!S._placementMode){
  /* Vertex hover for selected graphic */
  if(S.selectedGraphicId&&!S._drawMode){const g=S.graphics.find(x=>x.id===S.selectedGraphicId);if(g&&g.points){let onHandle=false;
/* Center handle check */
if((g.tool==="polygon"&&g.points.length>=3)||(g.tool==="circle"&&g.points.length>=2)||(g.tool==="rectangle"&&g.points.length>=2)){let cx,cy;if(g.tool==="polygon"){cx=0;cy=0;g.points.forEach(p=>{const sp=latlonToScreen(p.lat,p.lon);cx+=sp.x;cy+=sp.y});cx/=g.points.length;cy/=g.points.length}else if(g.tool==="rectangle"){const sp0=latlonToScreen(g.points[0].lat,g.points[0].lon),sp1=latlonToScreen(g.points[1].lat,g.points[1].lon);cx=(sp0.x+sp1.x)/2;cy=(sp0.y+sp1.y)/2}else{const sp=latlonToScreen(g.points[0].lat,g.points[0].lon);cx=sp.x;cy=sp.y}
if(g.label){var lcx2=cx+(g.labelOffset?g.labelOffset.x:0),lcy2=cy+(g.labelOffset?g.labelOffset.y:-20);var _tmpC2=document.createElement("canvas").getContext("2d");_tmpC2.font="bold 13px sans-serif";var _tw2=_tmpC2.measureText(g.label).width/2+10;var hdx2=lcx2-_tw2;if(Math.hypot(pos.x-hdx2,pos.y-lcy2)<15){canvas.style.cursor="move";onHandle=true}}
if(!onHandle&&Math.hypot(pos.x-cx,pos.y-cy)<20){canvas.style.cursor="move";onHandle=true}}
if(!onHandle){for(let i=0;i<g.points.length;i++){const sp=latlonToScreen(g.points[i].lat,g.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<20){canvas.style.cursor="move";onHandle=true;break}}}if(onHandle)return}}
  /* Draw mode vertex hover */
  if(S._drawMode&&S._drawMode.points.length>0){
    /* Rectangle rotation handle hover */
    if(S._drawMode.tool==="rectangle"&&S._drawMode._rotHandle){const rh=S._drawMode._rotHandle;if(Math.hypot(pos.x-rh.x,pos.y-rh.y)<14){canvas.style.cursor="grab";return}}
    let onVert=false;for(let i=0;i<S._drawMode.points.length;i++){const sp=latlonToScreen(S._drawMode.points[i].lat,S._drawMode.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<20){canvas.style.cursor="move";onVert=true;break}}if(onVert)return}
  if(S._drawMode)return;
  /* Rotation handle hover */
  const rh=hitTestRotHandle(pos);
  if(rh){canvas.style.cursor="grab";const tt=document.getElementById("map-tooltip");if(tt)tt.style.display="none";return}
  const hit=hitTestUnit(pos);const tt=document.getElementById("map-tooltip");
  if(hit&&tt){
    let label;
    if(hit.originalName&&!hit._useStructuredLabel){
      label=hit.originalName;
    }else if(hit.customIcon&&hit.useCustomIcon!==false&&hit.originalName){
      /* KMZ custom icon — show original name instead of possibly wrong type */
      label=hit.originalName;
    }else{
      const ech=hit.echelon?ECHELONS.find(x=>x.id===hit.echelon):null;
      const parts=[];
      if(hit.designation)parts.push(hit.designation);
      if(ech)parts.push(ech.label);
      parts.push(TYPE_LABELS[hit.type]||hit.type);
      if(hit.parentUnit)parts.push("/ "+hit.parentUnit);
      label=parts.join(" \u2022 ");
    }
    tt.textContent=label;
    tt.style.display="block";tt.style.left=(e.clientX+12)+"px";tt.style.top=(e.clientY-28)+"px";
    canvas.style.cursor="pointer";
  }else{if(tt)tt.style.display="none";canvas.style.cursor=""}}}

function onPointerUp(e){const pos=getPos(e);if(e.pointerId!==undefined)S._activePointers.delete(e.pointerId);
/* Clear rectangle draw rotation drag */
if(S._drawMode&&S._drawMode._rotDrag){S._drawMode._rotDrag=false;_selOnDown=true;return}
/* Freehand stroke complete */
if(_freehandActive){
  _freehandActive=false;
  if(_freehandPoints.length>=2){
    /* Check stroke limit */
    var mcooStrokes=S.graphics.filter(function(g){return g.layerId===_mcooLayerId&&g._freehand}).length;
    if(mcooStrokes>=MCOO_MAX_STROKES){notify("Stroke limit reached ("+MCOO_MAX_STROKES+")","error");_freehandPoints=[];_freehandPressures=[];requestRender();return}
    /* Simplify with adaptive tolerance based on point count */
    var tol=_freehandPoints.length>100?3:_freehandPoints.length>50?2:1.5;
    var simplified=simplifyFreehand(_freehandPoints,tol);
    /* Cap max points per stroke */
    if(simplified.length>MCOO_MAX_PTS_PER_STROKE){
      var step=Math.ceil(simplified.length/MCOO_MAX_PTS_PER_STROKE);
      var capped=[simplified[0]];for(var si=step;si<simplified.length-1;si+=step)capped.push(simplified[si]);
      capped.push(simplified[simplified.length-1]);simplified=capped}
    var gPoints=simplified.map(function(p){var ll=screenToLatlon(p.x,p.y);return{lat:ll.lat,lon:ll.lon}});
    var g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:"line",
      points:gPoints,color:_freehandOpts.color,
      lineWidth:_freehandOpts.lineWidth,lineStyle:"solid",
      overlayType:"none",fill:false,fillColor:_freehandOpts.color,
      label:"",layerId:_mcooLayerId||S.activeLayerId,arrowSize:1,
      _freehand:true};
    S.graphics.push(g);netBroadcast({type:"graphicAdd",graphic:g});
    renderFreehandBar();/* update stroke count */
  }
  _freehandPoints=[];_freehandPressures=[];requestRender();return}
if(S._activePointers.size<2){S._pinchStartDist=null;S._pinchStartZoom=null}
const isCanvas=e.target===canvas;
const wasPan=S._isPanning,moved=_ptrDownPos?Math.hypot(pos.x-_ptrDownPos.x,pos.y-_ptrDownPos.y):0;
const wasDraggingVertex=!!_dragGV;
/* Push single undo entry for completed drag */
if(_dragUnit&&_dragStartPos&&(moved>5)){
  S.undoStack.push({type:"move",unitId:_dragUnit.id,lat:_dragStartPos.lat,lon:_dragStartPos.lon});
  if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();updateUndoBtn()}
/* Final broadcast to ensure last position is synced */
if(_dragUnit)netBroadcast({type:"unitEdit",unit:_dragUnit});
if(_rotUnit)netBroadcast({type:"unitEdit",unit:_rotUnit});
if(_dragGV){var _fgG=S.graphics.find(function(x){return x.id===_dragGV.gid});if(_fgG)netBroadcast({type:"graphicEdit",graphic:_fgG})}
S._isPanning=false;_dragUnit=null;_dragGV=null;_rotUnit=null;_dragStartPos=null;requestRender();

if(S._drawMode&&moved<10&&!wasDraggingVertex){const ll=screenToLatlon(pos.x,pos.y);const dm=S._drawMode;
/* Check if click is on an existing point — don't add duplicate */
let onExisting=false;
for(let i=0;i<dm.points.length;i++){const sp=latlonToScreen(dm.points[i].lat,dm.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<20){onExisting=true;break}}
if(!onExisting){
if(dm.tool==="circle"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}
if(dm.tool==="circle"&&dm.points.length===1){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
if(dm.tool==="rectangle"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}
if(dm.tool==="rectangle"&&dm.points.length===1){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
if(dm.tool==="text"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}
return}

if(S._placementMode&&moved<10){const ll=screenToLatlon(pos.x,pos.y);const u={...S._placementMode,id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat:ll.lat,lon:ll.lon,layerId:S.activeLayerId,rings:[],equipment:{...(EQUIPMENT_DEFAULTS[S._placementMode.type]||{})},isEquipment:!!S._placementMode.isEquipment};S.units.push(u);S._placementMode=null;selectUnit(u.id);hideModeBar();netBroadcast({type:"unitAdd",unit:u});requestRender();return}

/* Wargame order destination tap */
if(S._wargameOrderPending&&moved<10){
  const ll=screenToLatlon(pos.x,pos.y);var wop=S._wargameOrderPending;
  if(wop.type==="move"){
    var srcU=S.units.find(function(x){return x.id===wop.unitId});
    wop.origLat=srcU?srcU.lat:ll.lat;wop.origLon=srcU?srcU.lon:ll.lon;
    wop.destLat=ll.lat;wop.destLon=ll.lon;
    /* Update mode bar to show confirm ready */
    var mb=document.getElementById("mode-bar");
    if(mb){var cBtn=mb.querySelector(".done");if(cBtn)cBtn.classList.add("ready")}
  }else if(wop.type==="fire"){
    var srcU2=S.units.find(function(x){return x.id===wop.unitId});
    wop.origLat=srcU2?srcU2.lat:ll.lat;wop.origLon=srcU2?srcU2.lon:ll.lon;
    wop.targetLat=ll.lat;wop.targetLon=ll.lon;
    var mb2=document.getElementById("mode-bar");
    if(mb2){var cBtn2=mb2.querySelector(".done");if(cBtn2)cBtn2.classList.add("ready")}
  }
  requestRender();return}

/* Map tools */
if(S._mapTool&&moved<10){const ll=screenToLatlon(pos.x,pos.y);
if(S._mapTool==="pin"){const u={id:"u"+Date.now()+Math.random().toString(36).substr(2,4),type:"waypoint",affiliation:"friendly",displayMode:"pin",pinColor:"#ff4444",lat:ll.lat,lon:ll.lon,layerId:S.activeLayerId,designation:"",echelon:null,modifiers:[],isHQ:false,rings:[],equipment:{}};S.units.push(u);S.editorTab="info";selectUnit(u.id);netBroadcast({type:"unitAdd",unit:u});S._mapTool=null;hideModeBar();canvas.style.cursor="";requestRender();return}
if(S._mapTool==="distance"){S._measurePoints.push({lat:ll.lat,lon:ll.lon});requestRender();updateModeBar();return}
if(S._mapTool==="area"){S._measureArea.push({lat:ll.lat,lon:ll.lon});requestRender();updateModeBar();return}}

/* Graphic selection — use generous threshold for taps (touch has natural drift) */
var _tapThresh=S._lastPointerType==="touch"?25:15;
/* Graphic selection — re-test at original click position */
var _tapTime=S._lastPointerType==="touch"?400:300;
var _elapsed=Date.now()-_ptrDownTime;
if(!_selOnDown&&_ptrDownPos&&_elapsed<_tapTime&&moved<50&&!S._panLockMode&&!S._drawMode&&!S._mapTool){
var _reHit=hitTestGraphic(_ptrDownPos);
if(_reHit){selectGraphic(_reHit.id);return}}
if(_ptrDownPos&&moved<_tapThresh&&!_selOnDown){
if(S._lastPointerType==="touch"&&!S._drawMode&&!S._placementMode&&checkDoubleTap(pos))return;
deselectAll()}
}

function onDblClick(e){if(S._drawMode||S._placementMode)return;if(S._lastPointerType==="touch")return;/* handled by tap detection below */const pos=getPos(e);const hit=hitTestUnit(pos);if(hit){const u=S.units.find(x=>x.id===hit.id);if(u)smoothPanTo(u.lat,u.lon,1000)}}

/* Double-tap detection for touch devices */
let _lastTapTime=0,_lastTapPos=null;
function checkDoubleTap(pos){
const now=Date.now(),dt=now-_lastTapTime;
if(dt<350&&_lastTapPos&&Math.hypot(pos.x-_lastTapPos.x,pos.y-_lastTapPos.y)<30){
_lastTapTime=0;_lastTapPos=null;
const hit=hitTestUnit(pos);if(hit){const u=S.units.find(x=>x.id===hit.id);if(u)smoothPanTo(u.lat,u.lon,1000)}
return true}
_lastTapTime=now;_lastTapPos=pos;return false}

let _wheelAccum=0,_wheelTimer=null,_zoomAnim=null,_zoomTarget=null;
function smoothZoom(targetZoom,cursorPos){
targetZoom=Math.max(2,Math.min(19,targetZoom));
/* If already animating, just update the target — don't restart */
if(_zoomAnim&&_zoomTarget!==null){_zoomTarget=targetZoom;return}
_zoomTarget=targetZoom;
const startZoom=S.zoom,startLat=S.lat,startLon=S.lon;
/* Determine anchor point — selected unit/graphic takes priority */
let anchorLat=S.lat,anchorLon=S.lon,useAnchor=false;
const selU=S.selectedUnitId?S.units.find(x=>x.id===S.selectedUnitId):null;
const selG=(!selU&&S.selectedGraphicId)?S.graphics.find(x=>x.id===S.selectedGraphicId):null;
if(selU){anchorLat=selU.lat;anchorLon=selU.lon;useAnchor=true}
else if(selG&&selG.points&&selG.points.length){
let clat=0,clon=0;selG.points.forEach(p=>{clat+=p.lat;clon+=p.lon});
anchorLat=clat/selG.points.length;anchorLon=clon/selG.points.length;useAnchor=true}
/* Editor offset for centering */
let offsetLat=0;
if(useAnchor){
const ed=document.getElementById("editor");
const edH=(window.innerWidth<=700)&&ed&&ed.classList.contains("open")?(ed.offsetHeight||0):0;
if(edH>0){const screenH=window.innerHeight,c1=screenToLatlon(0,screenH/2),c2=screenToLatlon(0,screenH/2+1);offsetLat=(edH/2)*(c1.lat-c2.lat)}}
function step(){
const diff=_zoomTarget-S.zoom;
if(Math.abs(diff)<0.01){S.zoom=_zoomTarget;_zoomAnim=null;_zoomTarget=null;requestRender();setTimeout(requestRender,50);return}
/* Lerp 30% per frame — smooth chase */
S.zoom+=diff*0.3;
if(useAnchor){const tLat=anchorLat-offsetLat,tLon=anchorLon;
S.lat+=(tLat-S.lat)*0.3;S.lon+=(tLon-S.lon)*0.3}
requestRender();_zoomAnim=requestAnimationFrame(step)}
if(!_zoomAnim)_zoomAnim=requestAnimationFrame(step)}

function onWheel(e){e.preventDefault();const pos=getPos(e);
const isTrackpad=Math.abs(e.deltaY)<50;
if(isTrackpad){
/* Continuous trackpad: map deltaY directly to zoom delta, smoothed by the animation */
const delta=-e.deltaY*0.004;
const cur=_zoomTarget!==null?_zoomTarget:S.zoom;
smoothZoom(Math.max(2,Math.min(19,cur+delta)),pos);
}else{
const delta=e.deltaY>0?-0.35:0.35;
const cur=_zoomTarget!==null?_zoomTarget:S.zoom;
smoothZoom(Math.max(2,Math.min(19,cur+delta)),pos);
}
updateCoords(pos)}
function onContextMenu(e){e.preventDefault();if(S._mapTool==="distance"||S._mapTool==="area"){S._mapTool=null;hideModeBar();canvas.style.cursor="";requestRender();renderFloatingPanel();return}if(S._drawMode&&S._drawMode.points.length>=getMinPoints(S._drawMode.tool)){finishDrawing();return}/* Right-click force deselect */if(S.selectedUnitId||S.selectedGraphicId){deselectAll();return}}
function updateCoords(pos){const el=document.getElementById("coords");if(!el||!pos)return;const ll=screenToLatlon(pos.x,pos.y);if(S.coordDisplay==="mgrs")el.textContent=`\u2197 ${toMGRS(ll.lat,ll.lon)} z${S.zoom.toFixed(1)}`;else el.textContent=`\u2197 ${ll.lat.toFixed(4)}\u00b0 ${ll.lon.toFixed(4)}\u00b0 z${S.zoom.toFixed(1)}`}


// === part_07_ui_init.js ===

function notify(msg,type){const t=document.createElement("div");t.className="toast"+(type==="error"?" error":"");t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3500)}

S._panLockMode=false;
function togglePanLock(){S._panLockMode=!S._panLockMode;updatePanLockBtn();if(S._panLockMode){deselectAll();closeEditor();S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>{if(b.id!=="sb-panlock")b.classList.remove("active")})}requestRender()}
function updatePanLockBtn(){const btn=document.getElementById("sb-panlock");if(!btn)return;if(S._panLockMode){btn.classList.add("active");btn.title="Pan Only Mode ON — tap to unlock"}else{btn.classList.remove("active");btn.title="Pan Only Mode (lock editing)"}}
function togglePanel(name){
  if(S._activePanel===name||name===null){S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"))}
  else{S._activePanel=name;S.selectedUnitId=null;S.selectedGraphicId=null;closeEditor();renderFloatingPanel();document.getElementById("float-panel").classList.add("open");
  document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"));
  const btn=document.getElementById("sb-"+name);if(btn)btn.classList.add("active");
  if(name==="chat"){S._net.unreadCount=0;updateChatBadge();setTimeout(function(){var el=document.getElementById("chat-messages");if(el)el.scrollTop=el.scrollHeight},50)}}}

function applyUIScale(v){S.uiScale=Math.round(v*10)/10;document.documentElement.style.setProperty("--ui-scale",S.uiScale);localStorage.setItem("tacmap-uiscale",S.uiScale);renderFloatingPanel()}
function renderFloatingPanel(){
  const title=document.getElementById("fp-title"),body=document.getElementById("fp-body");
  if(!S._activePanel){title.textContent="";body.innerHTML="";return}
  switch(S._activePanel){
    case"settings":title.textContent="Settings";body.innerHTML=renderSettings();break;
    case"comms":title.textContent="Comms";body.innerHTML=renderComms();
      (function(){
        var _e=function(id){return document.getElementById(id)};
        var _cs=_e("net-custom-sig");if(_cs)_cs.onclick=function(){if(this.checked){S._signalServer={host:"",port:9000,secure:false}}else{S._signalServer=null}localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer));renderFloatingPanel()};
        var _ssl=_e("net-sig-secure");if(_ssl)_ssl.onclick=function(){if(!S._signalServer)S._signalServer={};S._signalServer.secure=this.checked;localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer))};
        if(_e("net-sig-host"))_e("net-sig-host").onchange=function(){if(!S._signalServer)S._signalServer={};S._signalServer.host=this.value;localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer))};
        if(_e("net-sig-port"))_e("net-sig-port").onchange=function(){if(!S._signalServer)S._signalServer={};S._signalServer.port=parseInt(this.value)||9000;localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer))};
        if(_e("net-turn-host"))_e("net-turn-host").onchange=function(){if(!S._turnServer)S._turnServer={};S._turnServer.host=this.value;localStorage.setItem("sm_turnServer",JSON.stringify(S._turnServer))};
        if(_e("net-turn-port"))_e("net-turn-port").onchange=function(){if(!S._turnServer)S._turnServer={};S._turnServer.port=parseInt(this.value)||3478;localStorage.setItem("sm_turnServer",JSON.stringify(S._turnServer))};
        if(_e("net-turn-user"))_e("net-turn-user").onchange=function(){if(!S._turnServer)S._turnServer={};S._turnServer.user=this.value;localStorage.setItem("sm_turnServer",JSON.stringify(S._turnServer))};
        if(_e("net-turn-pass"))_e("net-turn-pass").onchange=function(){if(!S._turnServer)S._turnServer={};S._turnServer.pass=this.value;localStorage.setItem("sm_turnServer",JSON.stringify(S._turnServer))};
        var _pr=_e("net-persist-room");if(_pr)_pr.onclick=function(){if(this.checked){S._net.persistentRoom=S._net.roomCode;IO.autosave();IO.notify("Room "+S._net.roomCode+" will auto-host on next load","success")}else{S._net.persistentRoom=null;IO.autosave();IO.notify("Persistent room cleared")}renderFloatingPanel()};
      })();
      break;
    case"chat":title.textContent="Chat";body.innerHTML=renderChat();break;
    case"layers":title.textContent="Layers";body.innerHTML=renderLayers();break;
    case"graphics":title.textContent="Add / Draw";body.innerHTML=renderGraphicsPanel();break;
    case"addunit":title.textContent="Add / Draw";body.innerHTML=renderAddUnitPanel();break;
    case"maptools":title.textContent="Map Tools";body.innerHTML=renderMapToolsPanel();break;
    case"ipb":title.textContent="IPB Wizard";body.innerHTML=renderIPBPanel();break;
  }
  bindPanelEvents()}

function renderSettings(){
  let h='<div class="section"><div class="section-title">Map</div>';
  h+='<label>Tile Source</label><select id="set-tiles">';
  for(const[k,v]of Object.entries(TILE_SOURCES))h+=`<option value="${k}"${S.tileSource===k?" selected":""}>${v.name}</option>`;
  h+='</select>';
  h+='<label>Theme</label><select id="set-theme"><option value="dark"'+(S.theme==="dark"?" selected":"")+'>Dark</option><option value="light"'+(S.theme==="light"?" selected":"")+'>Light</option></select>';
  h+='</div><div class="section"><div class="section-title">Grid</div>';
  h+='<div class="toggle-row"><span>Show Grid</span><label class="switch"><input type="checkbox" id="set-grid"'+(S.showGrid?" checked":"")+'><span class="slider"></span></label></div>';
  h+='<div class="toggle-row"><span>Show Labels</span><label class="switch"><input type="checkbox" id="set-labels"'+(S.showLabels?" checked":"")+'><span class="slider"></span></label></div>';
  h+='<label>Grid Mode</label><select id="set-gridmode"><option value="mgrs"'+(S.gridMode==="mgrs"?" selected":"")+'>MGRS</option><option value="latlon"'+(S.gridMode==="latlon"?" selected":"")+'>Lat/Lon</option></select>';
  h+='<label>Coord Display</label><select id="set-coorddisp"><option value="mgrs"'+(S.coordDisplay==="mgrs"?" selected":"")+'>MGRS</option><option value="latlon"'+(S.coordDisplay==="latlon"?" selected":"")+'>Lat/Lon</option></select>';
  h+='<label>Grid Color</label><div class="color-swatches" id="set-gridcolor">';
  const gridColors=[["#00ff00","Green"],["#00cccc","Teal"],["#ffffff","White"],["#000000","Black"],["#ff4444","Red"],["#888888","Gray"]];
  gridColors.forEach(([c,n])=>h+=`<div class="swatch${S.gridColor===c?" active":""}" style="background:${c}" onclick="S.gridColor='${c}';requestRender();renderFloatingPanel()" title="${n}"></div>`);
  h+='</div>';
  h+='<label>Grid Opacity</label><input type="range" id="set-gridop" min="0" max="1" step="0.01" value="'+S.gridOpacity+'">';
  h+='</div><div class="section"><div class="section-title">UI Scale</div>';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="set-uiscale" min="0.6" max="2.0" step="0.05" value="'+S.uiScale+'" style="flex:1"><span id="uiscale-val" style="font-size:11px;min-width:32px;text-align:right">'+Math.round(S.uiScale*100)+'%</span></div>';
  h+='<div class="row">';
  [0.8,1.0,1.2,1.5].forEach(v=>h+=`<button class="btn${S.uiScale===v?' primary':''}" onclick="applyUIScale(${v})">${Math.round(v*100)}%</button>`);
  h+='</div>';
  h+='</div><div class="section"><div class="section-title">Map Icon Size</div>';
  h+='<div class="row">';
  ["tiny","small","medium","large","xlarge"].forEach(v=>{const labels={tiny:"XS",small:"S",medium:"M",large:"L",xlarge:"XL"};h+=`<button class="btn${S.iconSize===v?' primary':''}" onclick="S.iconSize='${v}';localStorage.setItem('tacmap-iconsize','${v}');requestRender();renderFloatingPanel()">${labels[v]}</button>`});
  h+='</div>';
  h+='</div><div class="section"><div class="section-title">Device Overrides</div>';
  h+='<label>Layout</label><select id="set-layout"><option value="auto">Auto</option><option value="phone">Phone</option><option value="tablet">Tablet</option><option value="desktop">Desktop</option></select>';
  h+='</div>';
  h+='<div class="section"><div class="section-title">Display</div>';
  if(document.fullscreenEnabled||document.webkitFullscreenEnabled){
    var isFS=!!(document.fullscreenElement||document.webkitFullscreenElement);
    h+='<button class="btn'+(isFS?' primary':'')+'" onclick="toggleFullscreen()" style="width:100%;margin-bottom:6px">'+(isFS?'Exit Fullscreen':'\u26f6 Fullscreen')+'</button>';
  }
  h+='</div>';
  h+='<div class="section"><div class="section-title">About</div>';
  h+='<div style="font-size:10px;opacity:.5;margin-bottom:6px">StaffMaps v'+APP_VERSION+'</div>';
  h+='<button class="btn" onclick="forceUpdate()" style="margin-bottom:4px;width:100%">\u21bb Force Update (Clear Cache)</button>';
  h+='<div style="font-size:9px;opacity:.35">Clears service worker cache and reloads from server</div>';
  h+='</div>';
  return h}

function renderComms(){
  const n=S._net;let h='<div class="section"><div class="section-title">Connection</div>';
  h+='<label>Callsign</label><input type="text" id="net-name" value="'+escAttr(n.peerName||"")+'" placeholder="Your callsign" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">';
  if(n.mode==="offline"){
    var _step=S._commsStep||"role";
    var _ss=S._signalServer||{};var _ssOn=!!S._signalServer;
    var _ts=S._turnServer||{};
    var _bk='<div style="margin-top:8px"><button class="btn" onclick="S._commsStep=null;renderFloatingPanel()" style="font-size:10px;padding:3px 8px">\u2190 Back</button></div>';

    if(_step==="role"){
      /* Choose role */
      h+='<div style="margin-top:16px;display:flex;flex-direction:column;gap:8px">';
      h+='<button class="btn primary" style="padding:14px;font-size:13px;font-weight:600" onclick="S._commsStep=\'server\';S._commsRole=\'host\';renderFloatingPanel()">\u25B6 Host a Room</button>';
      h+='<button class="btn" style="padding:14px;font-size:13px;font-weight:600" onclick="S._commsStep=\'server\';S._commsRole=\'join\';renderFloatingPanel()">\u2192 Join a Room</button>';
      h+='</div>';

    } else if(_step==="server"){
      h+=_bk;
      h+='<div class="ed-section-title" style="margin-top:8px">SERVER TYPE</div>';
      h+='<div style="font-size:11px;opacity:.7;margin-bottom:10px">How should devices find each other?</div>';
      h+='<div style="display:flex;flex-direction:column;gap:8px">';
      h+='<button class="btn'+(! _ssOn?' primary':'')+'" style="padding:12px;text-align:left" onclick="S._signalServer=null;localStorage.setItem(\'sm_signalServer\',null);S._commsStep=\'go\';renderFloatingPanel()"><strong>Default Cloud</strong><br><span style=\"font-size:10px;opacity:.7\">Works anywhere with internet. No setup needed.</span></button>';
      h+='<button class="btn'+(_ssOn?' primary':'')+'" style="padding:12px;text-align:left" onclick="if(!S._signalServer)S._signalServer={host:\'\',port:9000,secure:false};localStorage.setItem(\'sm_signalServer\',JSON.stringify(S._signalServer));S._commsStep=\'host\';renderFloatingPanel()"><strong>Custom Server</strong><br><span style=\"font-size:10px;opacity:.7\">Use your own signal server on a local network.</span></button>';
      h+='</div>';

    } else if(_step==="host"){
      h+=_bk;
      h+='<div class="ed-section-title" style="margin-top:8px">SERVER ADDRESS</div>';
      h+='<div style="font-size:11px;opacity:.7;margin-bottom:6px">Enter the IP address or hostname of your signal server. Get this from whoever set up the server.</div>';
      h+='<label>Host</label><input type="text" id="net-sig-host" value="'+escAttr(_ss.host||'')+'" placeholder="e.g. 192.168.1.100">';
      h+='<div style="display:flex;justify-content:flex-end;margin-top:4px"><button class="btn primary" onclick="S._commsStep=\'port\';renderFloatingPanel()">Next \u2192</button></div>';

    } else if(_step==="port"){
      h+=_bk;
      h+='<div class="ed-section-title" style="margin-top:8px">SERVER PORT</div>';
      h+='<div style="font-size:11px;opacity:.7;margin-bottom:6px">Default is 9000. If you don\'t know, leave it as-is.</div>';
      h+='<label>Port</label><input type="number" id="net-sig-port" value="'+(_ss.port||9000)+'" placeholder="9000">';
      h+='<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px">';
      h+='<button class="btn" onclick="S._commsStep=\'turn\';renderFloatingPanel()">Next \u2192</button>';
      h+='</div>';

    } else if(_step==="turn"){
      h+=_bk;
      h+='<div class="ed-section-title" style="margin-top:8px">TURN RELAY</div>';
      h+='<div style="font-size:11px;opacity:.7;margin-bottom:10px">A TURN relay helps connections work across firewalls. Most local networks don\'t need one. If unsure, skip this.</div>';
      h+='<div style="display:flex;flex-direction:column;gap:8px">';
      h+='<button class="btn primary" style="padding:10px" onclick="S._commsStep=\'go\';renderFloatingPanel()">Skip — I don\'t need TURN</button>';
      h+='<button class="btn" style="padding:10px" onclick="S._commsStep=\'turnconfig\';renderFloatingPanel()">Configure TURN relay</button>';
      h+='</div>';

    } else if(_step==="turnconfig"){
      h+=_bk;
      h+='<div class="ed-section-title" style="margin-top:8px">TURN RELAY SETTINGS</div>';
      h+='<div style="font-size:11px;opacity:.7;margin-bottom:6px">Get these from your server admin. If your TURN server runs on the same machine as your signal server, use the same host.</div>';
      h+='<label>Host</label><input type="text" id="net-turn-host" value="'+escAttr(_ts.host||'')+'" placeholder="Same as signal server">';
      h+='<label>Port</label><input type="number" id="net-turn-port" value="'+(_ts.port||3478)+'" placeholder="3478">';
      h+='<label>Username</label><input type="text" id="net-turn-user" value="'+escAttr(_ts.user||'')+'" placeholder="staffmaps">';
      h+='<label>Password</label><input type="password" id="net-turn-pass" value="'+escAttr(_ts.pass||'')+'" placeholder="staffmaps">';
      h+='<div style="display:flex;justify-content:flex-end;margin-top:4px"><button class="btn primary" onclick="S._commsStep=\'go\';renderFloatingPanel()">Next \u2192</button></div>';

    } else if(_step==="go"){
      h+=_bk;
      if(_ssOn){
        h+='<div style="font-size:10px;opacity:.5;margin-bottom:8px">Server: '+escHtml(_ss.host||"cloud")+':'+(_ss.port||9000)+'</div>';
      } else {
        h+='<div style="font-size:10px;opacity:.5;margin-bottom:8px">Using default PeerJS cloud</div>';
      }
      if(S._commsRole==="host"){
        h+='<div class="ed-section-title">CREATE ROOM</div>';
        h+='<button class="btn primary" style="width:100%;padding:14px;font-size:13px;font-weight:600" onclick="netCreateRoom()">Create Room</button>';
      } else {
        h+='<div class="ed-section-title">JOIN ROOM</div>';
        h+='<div style="font-size:11px;opacity:.7;margin-bottom:6px">Enter the 6-character room code from the host.</div>';
        h+='<div class="row" style="align-items:stretch"><input type="text" id="net-code" placeholder="Room code" maxlength="6" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false" style="flex:2;margin-bottom:0"><button class="btn primary" onclick="netJoinRoom()" style="min-height:0;align-self:stretch">Join</button></div>';
      }
    }
  }

else{
    h+='<div style="font-size:11px;margin-bottom:6px">Room: <strong>'+(n.roomCode||"---")+'</strong> <button class="btn" onclick="navigator.clipboard.writeText(\''+(n.roomCode||"")+'\')" style="padding:1px 4px;font-size:9px">Copy</button></div>';
    if(n.isHost){var _isPersist=!!n.persistentRoom;h+='<div class="toggle-row" style="margin-bottom:6px"><label class="switch"><input type="checkbox" id="net-persist-room"'+(_isPersist?' checked':'')+'><span class="slider"></span></label><span style="font-size:11px">Persistent room</span></div>';}

    h+='<div style="font-size:11px;margin-bottom:6px">Mode: '+(n.isHost?"HOST":"PEER")+'</div>';
    h+='<div style="font-size:11px;margin-bottom:6px">Status: '+n.status+'</div>';
    if(n.isHost){
      h+='<div class="toggle-row"><span>Default Join: View Only</span><label class="switch"><input type="checkbox" id="net-djm"'+(n.defaultJoinMode==="view"?" checked":"")+'><span class="slider"></span></label></div>';
      /* Active edit requests — show as actionable notifications */
      const activeReqs=n.editRequests.filter(r=>r.status==="pending"&&(Date.now()-r.ts<15000));
      const staleReqs=n.editRequests.filter(r=>r.status==="pending"&&(Date.now()-r.ts>=15000));
      const handledReqs=n.editRequests.filter(r=>r.status!=="pending");
      if(activeReqs.length){
        h+='<div style="margin-bottom:8px">';
        activeReqs.forEach((r,i)=>{
          const idx=n.editRequests.indexOf(r);
          h+='<div style="display:flex;align-items:center;gap:4px;padding:6px 8px;margin-bottom:4px;border-radius:6px;background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.3);animation:pulse 1.5s ease-in-out infinite">';
          h+='<span style="font-size:11px;flex:1"><strong>'+escHtml(r.name||"Peer")+'</strong> requests edit</span>';
          h+='<button class="btn" onclick="handleEditRequest('+idx+',true)" style="padding:2px 8px;font-size:12px;min-height:28px;color:#44cc44;border-color:#44cc44" title="Approve">✓</button>';
          h+='<button class="btn" onclick="handleEditRequest('+idx+',false)" style="padding:2px 8px;font-size:12px;min-height:28px;color:#ff4444;border-color:#ff4444" title="Deny">✗</button>';
          h+='<button class="btn" onclick="dismissEditRequest('+idx+')" style="padding:2px 6px;font-size:9px;min-height:28px;opacity:.5" title="Dismiss">—</button>';
          h+='</div>';
        });
        h+='</div>';
      }
      /* Stale/dismissed requests — collapsed management section */
      if(staleReqs.length||handledReqs.length){
        const total=staleReqs.length+handledReqs.length;
        h+='<div style="margin-bottom:8px">';
        h+='<div style="font-size:10px;opacity:.5;cursor:pointer;margin-bottom:4px" onclick="S._showStaleReqs=!S._showStaleReqs;renderFloatingPanel()">'+(!S._showStaleReqs?'▶':'▼')+' Past requests ('+total+')</div>';
        if(S._showStaleReqs){
          staleReqs.concat(handledReqs).forEach(r=>{
            const idx=n.editRequests.indexOf(r);
            const stale=r.status==="pending";
            h+='<div style="display:flex;align-items:center;gap:4px;padding:3px 6px;margin-bottom:2px;border-radius:4px;background:rgba(255,255,255,.03);font-size:10px">';
            h+='<span style="flex:1;opacity:.6">'+escHtml(r.name||"Peer");
            if(r.status==="approved")h+=' <span style="color:#44cc44">✓</span>';
            else if(r.status==="denied")h+=' <span style="color:#ff4444">✗</span>';
            else h+=' <span style="opacity:.4">stale</span>';
            h+='</span>';
            if(stale){
              h+='<button class="btn" onclick="handleEditRequest('+idx+',true)" style="padding:1px 6px;font-size:9px;min-height:22px;color:#44cc44" title="Approve">✓</button>';
              h+='<button class="btn" onclick="handleEditRequest('+idx+',false)" style="padding:1px 6px;font-size:9px;min-height:22px;color:#ff4444" title="Deny">✗</button>';
            }
            h+='<button class="btn" onclick="clearEditRequest('+idx+')" style="padding:1px 4px;font-size:9px;min-height:22px;opacity:.4" title="Remove">✗</button>';
            h+='</div>';
          });
        }
        h+='</div>';
      }
      /* Shared Layers section for host */
      h+='<div class="section-title" style="margin-top:8px">Shared Layers <span style="cursor:pointer;font-size:12px;opacity:.5;margin-left:4px" onclick="S._showShareInfo=!S._showShareInfo;renderFloatingPanel()" title="Sharing Guide">\u2139\ufe0f</span></div>';
      if(S._showShareInfo){
        h+='<div style="font-size:10px;opacity:.7;margin-bottom:8px;padding:6px;border:1px solid var(--border);border-radius:4px;background:rgba(255,255,255,.03);line-height:1.4">';
        h+='<strong>\ud83d\udc41 Visible</strong> \u2014 Peers can see this layer<br>';
        h+='<strong>\u270e Editable</strong> \u2014 Peers with edit permission can modify units/graphics on this layer<br>';
        
        h+='<div style="margin-top:4px;padding-top:4px;border-top:1px solid var(--border)">';
        h+='<strong>Two requirements for peer editing:</strong><br>';
        h+='1. Peer must have <span style="color:#44cc44">EDIT</span> permission (toggle in Room Members below)<br>';
        h+='2. Layer must be marked \u270e editable (toggle per-layer above)<br>';
        h+='Both are needed. This lets you give a peer edit access but restrict which layers they can modify.</div>';
        h+='</div>';
      }
      h+='<div style="font-size:10px;opacity:.5;margin-bottom:6px">Toggle layers visible/editable for peers</div>';
      function renderCommLayerRow(l){
        var rh='';const sh=n.sharedLayers[l.id]||{};
        const isVis=!!sh.visible;const isEdit=!!sh.editable;
        rh+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px;padding:3px 4px;border-radius:4px">';
        rh+='<span style="font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(l.name)+'</span>';
        rh+='<button class="btn'+(isVis?" primary":"")+'" onclick="toggleSharedLayer(\''+l.id+'\',\'visible\')" style="padding:1px 5px;font-size:9px;min-height:24px;min-width:0" title="Visible to peers">\ud83d\udc41</button>';
        rh+='<button class="btn'+(isEdit?" primary":"")+'" onclick="toggleSharedLayer(\''+l.id+'\',\'editable\')" style="padding:1px 5px;font-size:9px;min-height:24px;min-width:0" title="Editable by peers">\u270e</button>';
        
        rh+='</div>';return rh}
      /* Package layers */
      var _cpkgIds=new Set();S.packages.forEach(function(p){p.layerIds.forEach(function(id){_cpkgIds.add(id)})});
      S.packages.forEach(function(pkg){
        var pkgLayers=pkg.layerIds.map(function(id){return S.layers.find(function(l){return l.id===id})}).filter(Boolean);
        if(!pkgLayers.length)return;
        var cpkgKey='_commPkg_'+pkg.id;
        var cpkgCollapsed=S[cpkgKey]!==false;
        h+='<div style="margin-bottom:4px;border:1px solid var(--border);border-radius:4px;overflow:hidden">';
        h+='<div style="display:flex;align-items:center;gap:4px;padding:3px 6px;background:rgba(255,255,255,.03);cursor:pointer;font-size:11px" onclick="S[\''+cpkgKey+'\']=!S[\''+cpkgKey+'\'];if(S[\''+cpkgKey+'\']===undefined)S[\''+cpkgKey+'\']=false;renderFloatingPanel()">';
        h+='<span style="font-size:9px;opacity:.6;transform:rotate('+(cpkgCollapsed?'0':'90')+'deg)">\u25b6</span>';
        h+='<span style="font-weight:600;flex:1">'+escHtml(pkg.name)+'</span>';
        h+='<span style="font-size:9px;opacity:.4">('+pkgLayers.length+')</span>';
        /* Package share toggles */
        var _pkgAllVis=pkgLayers.every(function(l){var sh=n.sharedLayers[l.id];return sh&&sh.visible});
        var _pkgAllEdit=pkgLayers.every(function(l){var sh=n.sharedLayers[l.id];return sh&&sh.editable});
        h+='<button class="btn'+(_pkgAllVis?" primary":"")+'" onclick="event.stopPropagation();togglePkgShare(\''+pkg.id+'\',\'visible\')" style="padding:1px 5px;font-size:9px;min-height:22px;min-width:0" title="Share all layers">\ud83d\udc41</button>';
        h+='<button class="btn'+(_pkgAllEdit?" primary":"")+'" onclick="event.stopPropagation();togglePkgShare(\''+pkg.id+'\',\'editable\')" style="padding:1px 5px;font-size:9px;min-height:22px;min-width:0" title="Edit all layers">\u270e</button>';
        h+='</div>';
        if(!cpkgCollapsed){
          h+='<div style="padding:2px 4px 4px">';

          pkgLayers.forEach(function(l){h+=renderCommLayerRow(l)});
          h+='</div>';
        }
        h+='</div>';
      });
      /* Standalone layers */
      var standaloneLayers=S.layers.filter(function(l){return!_cpkgIds.has(l.id)});
      standaloneLayers.forEach(function(l){h+=renderCommLayerRow(l)});
      h+='<button class="btn" onclick="broadcastSharedConfig()" style="margin-top:4px;font-size:10px">Push to Peers</button>';
      /* Room Members — host + all peers with roles */
      h+='<div class="section-title" style="margin-top:8px">Room Members</div>';
      h+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;padding:3px 0">';
      h+='<span style="flex:1;font-weight:600">'+escHtml(n.peerName||"Host")+'</span>';
      h+='<span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(74,158,255,.15);color:var(--accent)">HOST</span>';
      h+='</div>';
      const peers=Object.entries(n.peerNames);
      peers.forEach(([id,name])=>{
        const canEdit=n.peerPermissions[id]&&n.peerPermissions[id].canEdit;
        h+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;padding:3px 0">';
        h+='<span style="flex:1">'+escHtml(name||id.substr(0,8))+'</span>';
        h+='<span style="font-size:9px;padding:2px 5px;border-radius:3px;background:'+(canEdit?'rgba(68,204,68,.12)':'rgba(255,255,255,.06)')+';color:'+(canEdit?'#44cc44':'rgba(255,255,255,.5)')+'">'+( canEdit?'EDIT':'VIEW')+'</span>';
        h+='<button class="btn'+(canEdit?" primary":"")+'" onclick="togglePeerEdit(\''+id+'\')" style="padding:1px 5px;font-size:9px;min-height:24px;min-width:0" title="Toggle edit permission">✎</button>';
        h+='</div>';
      });
      if(!peers.length)h+='<div style="font-size:10px;opacity:.4;padding:2px 0">No peers connected</div>';
      /* === WARGAME SECTION === */
      var wg=n.wargame;
      h+='<div class="section-title" style="margin-top:12px">Wargame <span style="cursor:pointer;font-size:12px;opacity:.5;margin-left:4px" onclick="S._showWargameInfo=!S._showWargameInfo;renderFloatingPanel()" title="Wargame Guide">\u2139\ufe0f</span></div>';
      /* Info guide */
      if(S._showWargameInfo){
        h+='<div style="font-size:10px;line-height:1.5;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:rgba(74,158,255,.05)">';
        h+='<div style="font-weight:700;margin-bottom:4px;font-size:11px">Wargame Process</div>';
        h+='<div style="margin-bottom:6px"><strong>1. Setup (GM)</strong><br>Assign roles (BLUFOR/OPFOR/Observer). Set layer visibility to control what each side sees. Prepare the scenario — place OPFOR, define boundaries, set the situation.</div>';
        h+='<div style="margin-bottom:6px"><strong>2. Planning Phase</strong><br>Both sides freely move their own units and draw graphics on their visible layers. BLUFOR plans their COA, OPFOR positions according to doctrine. Players can also submit formal Move/Fire orders for GM adjudication.</div>';
        h+='<div style="margin-bottom:6px"><strong>3. Execution Phase</strong><br>GM locks the board and resolves the turn. Adjudicate combat, movement conflicts, and effects. Approve or deny any pending orders. Reveal information as appropriate.</div>';
        h+='<div style="margin-bottom:6px"><strong>4. Next Turn</strong><br>Advance the turn counter, return to planning. Repeat until scenario conclusion.</div>';
        h+='<div style="opacity:.6;margin-top:4px;border-top:1px solid var(--border);padding-top:4px"><strong>GM Role:</strong> Sees all layers, adjudicates orders, controls what each side sees. Can freely add/move units on any layer at any time.<br><strong>Players:</strong> Can freely move units on their visible/editable layers during Planning. Locked during Execution.</div>';
        h+='</div>';
      }
      if(!wg.active){
        h+='<div style="font-size:10px;opacity:.5;margin-bottom:6px">Start a wargame to assign roles and manage turns</div>';
        h+='<button class="btn primary" onclick="wargameStart()" style="width:100%;margin-bottom:4px">Start Wargame</button>';
      }else{
        /* Turn & phase header */
        h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
        h+='<span style="font-size:11px;font-weight:600">Turn '+wg.turnNumber+'</span>';
        var phBg=wg.phase==="planning"?'rgba(74,158,255,.15)':wg.phase==="execution"?'rgba(255,170,0,.15)':'rgba(68,204,68,.15)';
        var phCol=wg.phase==="planning"?'var(--accent)':wg.phase==="execution"?'#ffaa00':'#44cc44';
        var phLabel=wg.phase==="planning"?"\ud83d\udcdd Planning":"\u2694\ufe0f Execution";
        h+='<span style="font-size:10px;padding:2px 6px;border-radius:3px;background:'+phBg+';color:'+phCol+'">'+phLabel+'</span>';
        h+='<span style="flex:1"></span>';
        h+='<button class="btn danger" onclick="wargameEnd()" style="padding:2px 6px;font-size:9px">End</button>';
        h+='</div>';
        /* Phase controls */
        if(wg.phase==="planning"){
          h+='<button class="btn" onclick="wargameAdvance()" style="width:100%;margin-bottom:6px;border-color:#ffaa00;color:#ffaa00">\u2694\ufe0f Begin Execution</button>';
        }else{
          h+='<button class="btn primary" onclick="wargameAdvance()" style="width:100%;margin-bottom:6px">\u25b6 Next Turn ('+(wg.turnNumber+1)+')</button>';
        }
        /* Role assignments */
        h+='<div style="font-size:10px;font-weight:600;margin-bottom:4px">ROLE ASSIGNMENTS</div>';
        h+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;padding:3px 0;margin-bottom:2px">';
        h+='<span style="flex:1;font-weight:600">'+escHtml(n.peerName||"Host")+' (You)</span>';
        h+='<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(255,215,0,.15);color:#ffd700">GM</span>';
        h+='</div>';
        peers.forEach(function(pr){
          var pid=pr[0],pname=pr[1];
          var pRole=(wg.roles[pid]&&wg.roles[pid].role)||"observer";
          h+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;padding:3px 0;margin-bottom:2px">';
          h+='<span style="flex:1">'+escHtml(pname||pid.substr(0,8))+'</span>';
          h+='<select onchange="wargameSetRole(\''+pid+'\',this.value)" style="font-size:10px;padding:2px 4px;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:3px">';
          [["blufor","BLUFOR"],["opfor","OPFOR"],["observer","Observer"]].forEach(function(r){
            h+='<option value="'+r[0]+'"'+(pRole===r[0]?' selected':'')+'>'+r[1]+'</option>';
          });
          h+='</select></div>';
        });
        if(!peers.length)h+='<div style="font-size:9px;opacity:.4;padding:2px 0">No players connected yet</div>';
        /* Layer role assignments */
        h+='<div style="font-size:10px;font-weight:600;margin-top:8px;margin-bottom:4px">LAYER VISIBILITY</div>';
        h+='<div style="font-size:9px;opacity:.4;margin-bottom:4px">Control what each side can see</div>';
        S.layers.forEach(function(l){
          var lRole=wg.layerRoles[l.id]||"all";
          h+='<div style="display:flex;align-items:center;gap:4px;font-size:10px;padding:2px 0">';
          h+='<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(l.name)+'</span>';
          h+='<select onchange="wargameSetLayerRole(\''+l.id+'\',this.value)" style="font-size:9px;padding:1px 3px;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:3px">';
          [["all","All"],["blufor","BLUFOR"],["opfor","OPFOR"],["gm","GM Only"]].forEach(function(r){
            h+='<option value="'+r[0]+'"'+(lRole===r[0]?' selected':'')+'>'+r[1]+'</option>';
          });
          h+='</select></div>';
        });
        /* Orders queue */
        var pendingOrders=wg.orders.filter(function(o){return o.status==="pending"});
        if(pendingOrders.length>0){
          h+='<div style="font-size:10px;font-weight:600;margin-top:8px;margin-bottom:4px">PENDING ORDERS ('+pendingOrders.length+')</div>';
          pendingOrders.forEach(function(o){
            var oRole=o.role==="blufor"?"BLUFOR":"OPFOR";
            var oColor=o.role==="blufor"?"#4a9eff":"#ff4444";
            h+='<div style="display:flex;align-items:center;gap:4px;font-size:10px;padding:3px 4px;margin-bottom:2px;border-radius:3px;border:1px solid var(--border)">';
            h+='<span style="color:'+oColor+';font-weight:600">'+oRole+'</span>';
            h+='<span style="flex:1">'+o.type+': '+(o.data.description||o.data.unitId||"").substring(0,20)+'</span>';
            h+='<button class="btn" onclick="wargameOrderDecide(\''+o.id+'\',true)" style="padding:1px 5px;font-size:9px;min-height:22px;color:#44cc44">\u2713</button>';
            h+='<button class="btn" onclick="wargameOrderDecide(\''+o.id+'\',false)" style="padding:1px 5px;font-size:9px;min-height:22px;color:#ff4444">\u2717</button>';
            h+='</div>';
          });
        }
      }
    }else{
      /* Peer side — show own permission status and request button */
      const myPerm=n.editRequestStatus;
      h+='<div style="font-size:11px;margin-bottom:6px">Permission: <strong>'+(myPerm==="approved"?"Edit":"View Only")+'</strong></div>';
      if(myPerm!=="approved"){
        if(myPerm==="pending"){
          h+='<div style="font-size:10px;opacity:.6;margin-bottom:6px;padding:4px 8px;border-radius:4px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2)">Edit request pending...</div>';
        }else if(myPerm==="denied"){
          h+='<div style="font-size:10px;color:#ff6666;margin-bottom:6px">Edit request denied</div>';
          h+='<button class="btn" onclick="requestEditAccess()" style="font-size:10px;margin-bottom:6px">Request Again</button>';
        }else{
          h+='<button class="btn" onclick="requestEditAccess()" style="font-size:10px;margin-bottom:6px">Request Edit Access</button>';
        }
      }
      /* Room Members roster (received from host) */
      if(n.roomRoster.length){
        h+='<div class="section-title" style="margin-top:8px">Room Members</div>';
        n.roomRoster.forEach(m=>{
          h+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;padding:3px 0">';
          h+='<span style="flex:1;'+(m.isHost?'font-weight:600':'')+'">'+escHtml(m.name)+'</span>';
          if(m.isHost){
            h+='<span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(74,158,255,.15);color:var(--accent)">HOST</span>';
          }else{
            h+='<span style="font-size:9px;padding:2px 5px;border-radius:3px;background:'+(m.canEdit?'rgba(68,204,68,.12)':'rgba(255,255,255,.06)')+';color:'+(m.canEdit?'#44cc44':'rgba(255,255,255,.5)')+'">'+( m.canEdit?'EDIT':'VIEW')+'</span>';
          }
          h+='</div>';
        });
      }
      /* Peer view of shared layers */
      if(n.sharedEditLayer||Object.keys(n.sharedLayers).length){
        h+='<div class="section-title" style="margin-top:8px">Shared Layers</div>';
        function renderPeerLayerRow(l){
          var rh='';const sh=n.sharedLayers[l.id];if(!sh)return'';
          rh+='<div style="font-size:11px;padding:2px 0;display:flex;align-items:center;gap:4px">';
          rh+='<span style="flex:1">'+escHtml(l.name)+'</span>';
          if(sh.visible)rh+='<span style="font-size:9px;opacity:.6">visible</span>';
          if(sh.editable)rh+='<span style="font-size:9px;color:var(--accent)">editable</span>';
          if(n.sharedEditLayer===l.id)rh+='<span style="font-size:9px;color:#ffd700">\u2605 primary</span>';
          rh+='</div>';return rh}
        var _ppkgIds=new Set();S.packages.forEach(function(p){p.layerIds.forEach(function(id){_ppkgIds.add(id)})});
        S.packages.forEach(function(pkg){
          var pkgLayers=pkg.layerIds.map(function(id){return S.layers.find(function(l){return l.id===id})}).filter(Boolean);
          var hasShared=pkgLayers.some(function(l){return!!n.sharedLayers[l.id]});
          if(!hasShared)return;
          var ppKey='_peerPkg_'+pkg.id;var ppCollapsed=S[ppKey]!==false;
          h+='<div style="margin-bottom:4px">';
          h+='<div style="cursor:pointer;font-size:11px;font-weight:600;padding:2px 0" onclick="S[\''+ppKey+'\']=!S[\''+ppKey+'\'];if(S[\''+ppKey+'\']===undefined)S[\''+ppKey+'\']=false;renderFloatingPanel()">';
          h+='<span style="font-size:9px;opacity:.6;display:inline-block;transform:rotate('+(ppCollapsed?'0':'90')+'deg);transition:transform .15s">\u25b6</span> '+escHtml(pkg.name)+'</div>';
          if(!ppCollapsed){pkgLayers.forEach(function(l){h+=renderPeerLayerRow(l)})}
          h+='</div>';
        });
        var peerStandalone=S.layers.filter(function(l){return!_ppkgIds.has(l.id)});
        peerStandalone.forEach(function(l){h+=renderPeerLayerRow(l)});
      }
    }
    /* === PEER WARGAME VIEW === */
    var wg=n.wargame;
    if(wg.active){
      h+='<div class="section-title" style="margin-top:12px">Wargame <span style="cursor:pointer;font-size:12px;opacity:.5;margin-left:4px" onclick="S._showWargameInfo=!S._showWargameInfo;renderFloatingPanel()" title="Wargame Guide">\u2139\ufe0f</span></div>';
      if(S._showWargameInfo){
        h+='<div style="font-size:10px;line-height:1.5;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:rgba(74,158,255,.05)">';
        h+='<div style="font-weight:700;margin-bottom:4px;font-size:11px">Wargame Process</div>';
        h+='<div style="margin-bottom:6px"><strong>1. Planning Phase</strong><br>Move your units and draw graphics freely on your layers. You can also submit formal Move/Fire orders for the GM to adjudicate.</div>';
        h+='<div style="margin-bottom:6px"><strong>2. Execution Phase</strong><br>The board is locked. The GM resolves combat, adjudicates orders, and advances the situation.</div>';
        h+='<div style="margin-bottom:6px"><strong>3. Next Turn</strong><br>GM advances to the next turn. Plan again.</div>';
        h+='</div>';
      }
      /* Turn + phase */
      h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
      h+='<span style="font-size:11px;font-weight:600">Turn '+wg.turnNumber+'</span>';
      var phBg2=wg.phase==="planning"?'rgba(74,158,255,.15)':'rgba(255,170,0,.15)';
      var phCol2=wg.phase==="planning"?'var(--accent)':'#ffaa00';
      var phLabel2=wg.phase==="planning"?"\ud83d\udcdd Planning":"\u2694\ufe0f Execution";
      h+='<span style="font-size:10px;padding:2px 6px;border-radius:3px;background:'+phBg2+';color:'+phCol2+'">'+phLabel2+'</span>';
      h+='</div>';
      /* My role */
      var myRole=wg.myRole||"observer";
      var roleLabel=myRole==="blufor"?"BLUFOR":myRole==="opfor"?"OPFOR":"Observer";
      var roleColor=myRole==="blufor"?"#4a9eff":myRole==="opfor"?"#ff4444":"#888";
      h+='<div style="font-size:12px;font-weight:700;color:'+roleColor+';margin-bottom:6px;padding:4px 8px;border-radius:4px;border:1px solid '+roleColor+';text-align:center">'+roleLabel+'</div>';
      if(wg.phase==="planning"&&myRole!=="observer"){
        h+='<div style="font-size:10px;opacity:.6;margin-bottom:6px;padding:4px 6px;border-radius:4px;background:rgba(74,158,255,.05)">Move your units freely. You can also submit formal orders for GM adjudication below.</div>';
        /* Optional formal orders */
        var selU=S.selectedUnitId?S.units.find(function(u){return u.id===S.selectedUnitId}):null;
        if(selU){
          h+='<div style="font-size:10px;margin-bottom:4px;opacity:.7">Selected: <strong>'+escHtml(selU.name||selU.designation||selU.type)+'</strong></div>';
          h+='<div class="row"><button class="btn" onclick="wargameSubmitMove()" style="flex:1;font-size:10px">\ud83d\udccd Move Order</button>';
          h+='<button class="btn" onclick="wargameSubmitFire()" style="flex:1;font-size:10px">\ud83c\udfaf Fire Order</button></div>';
        }
        /* Pending orders */
        var myOrders=wg.orders.filter(function(o){return o.role===myRole});
        if(myOrders.length>0){
          h+='<div style="font-size:10px;font-weight:600;margin-top:6px;margin-bottom:4px">YOUR ORDERS ('+myOrders.length+')</div>';
          myOrders.forEach(function(o){
            var statusColor=o.status==="pending"?"#ffd700":o.status==="approved"?"#44cc44":"#ff4444";
            var statusIcon=o.status==="pending"?"\u231b":o.status==="approved"?"\u2713":"\u2717";
            h+='<div style="display:flex;align-items:center;gap:4px;font-size:10px;padding:2px 0">';
            h+='<span style="flex:1">'+o.type+': '+(o.data.description||"").substring(0,25)+'</span>';
            h+='<span style="color:'+statusColor+'">'+statusIcon+' '+o.status+'</span>';
            if(o.status==="pending")h+='<button class="btn" onclick="wargameCancelOrder(\''+o.id+'\')" style="padding:1px 4px;font-size:9px;min-height:20px;color:#ff4444">\u2717</button>';
            h+='</div>';
          });
        }
      }else if(wg.phase==="execution"){
        h+='<div style="font-size:10px;text-align:center;padding:8px;border-radius:4px;background:rgba(255,170,0,.08);border:1px solid rgba(255,170,0,.2);color:#ffaa00">\u2694\ufe0f Board locked — GM is resolving...</div>';
      }else if(myRole==="observer"){
        h+='<div style="font-size:10px;opacity:.4;text-align:center;padding:8px">Observing — view only</div>';
      }
    }
    h+='<div class="row" style="margin-top:8px"><button class="btn danger" onclick="netLeave()">Leave Room</button></div>';
  }
  h+='<div class="section">';
  h+='<div class="section-title">Connection Troubleshooting</div>';
  h+='<div style="font-size:11px;color:#aaa;margin-bottom:8px">If auto-connect fails on restricted networks, use manual signaling below.</div>';
  h+='<button class="btn" style="width:100%;margin-bottom:6px" onclick="netDiag()">Run Diagnostics</button>';
  h+='<div id="net-diag-out" style="font-size:10px;color:#aaa;min-height:16px;margin-bottom:6px;max-height:300px;overflow-y:auto"></div>';
  h+='<button class="btn" style="width:100%;margin-bottom:4px" onclick="netManualToggle()">Manual Connect (Firewall Bypass)</button>';
  h+='<div id="net-manual" style="display:none;font-size:10px;margin-top:6px">';
  h+='<div style="color:#aaa;margin-bottom:8px">Same building WiFi required. Pick your role.</div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:8px">';
  h+='<button id="mr-host" class="btn" style="flex:1" onclick="netManualRole(\'host\')">I am HOST</button>';
  h+='<button id="mr-peer" class="btn" style="flex:1" onclick="netManualRole(\'peer\')">I am PEER</button>';
  h+='</div>';
  h+='<div id="net-manual-host" style="display:none">';
  h+='<div style="background:#1e2a1e;border:1px solid #3a5a3a;border-radius:6px;padding:8px;margin-bottom:8px">';
  h+='<b style="color:#7fc97f">STEP 1 — Generate offer</b>';
  h+='<div style="color:#aaa;font-size:9px;margin:4px 0">Click, wait 5s, send copied text to peer via Teams/text. Repeat per peer.</div>';
  h+='<button class="btn primary" style="width:100%;margin-bottom:6px" onclick="netManualOffer()">Generate Offer</button>';
  h+='<textarea id="net-manual-out" readonly placeholder="Offer appears here — auto-copied" style="width:100%;height:50px;font-size:9px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;padding:4px;box-sizing:border-box;resize:none"></textarea>';
  h+='<div id="net-manual-qr" style="margin-top:6px;display:flex;justify-content:center"></div>';
  h+='<button class="btn" style="width:100%;margin-top:4px" onclick="netManualCopy()">Copy Again</button>';
  h+='</div>';
  h+='<div style="background:#2a1e1e;border:1px solid #5a3a3a;border-radius:6px;padding:8px">';
  h+='<b style="color:#c97f7f">STEP 2 — Apply answer</b>';
  h+='<div style="color:#aaa;font-size:9px;margin:4px 0">Paste answer received from peer, then apply.</div>';
  h+='<textarea id="net-manual-in2" placeholder="Paste answer from peer..." style="width:100%;height:50px;font-size:9px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;padding:4px;box-sizing:border-box;resize:none;margin-bottom:4px"></textarea>';
  h+='<button class="btn primary" style="width:100%" onclick="netManualApply()">Apply Answer</button>';
  h+='</div>';
  h+='</div>';
  h+='<div id="net-manual-peer" style="display:none">';
  h+='<div style="background:#1e1e2a;border:1px solid #3a3a5a;border-radius:6px;padding:8px">';
  h+='<b style="color:#7f9fc9">YOUR STEP — Respond to host</b>';
  h+='<div style="color:#aaa;font-size:9px;margin:4px 0">Paste offer, generate answer, send it back to host.</div>';
  h+='<textarea id="net-manual-in" placeholder="Paste offer from host..." style="width:100%;height:50px;font-size:9px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;padding:4px;box-sizing:border-box;resize:none;margin-bottom:4px"></textarea>';
  h+='<button class="btn primary" style="width:100%" onclick="netManualAnswer()">Generate Answer &amp; Copy</button>';
  h+='</div>';
  h+='</div>';
  h+='</div>';
  h+='</div>';

    h+='<div class="section"><div class="section-title">Encryption</div>';
  h+='<div class="toggle-row"><span>Encrypt</span><label class="switch"><input type="checkbox" id="net-enc"'+(n.encEnabled?" checked":"")+'><span class="slider"></span></label></div>';
  h+='<div id="enc-fields" style="'+(n.encEnabled?'':'display:none')+'">';
  h+='<label>Passphrase</label><input type="password" id="net-pass" value="'+(n.passphrase||"")+'" placeholder="Passphrase">';
  h+='</div>';
  h+='</div></div>';
  return h}

function renderChat(){
  const n=S._net;if(n.mode==="offline")return'<div style="font-size:11px;opacity:.5;text-align:center;padding:20px">Connect to a room to chat</div>';
  var tgt=n.chatTarget||"room";
  let h='';
  /* Target selector: Room + each connected peer */
  h+='<div style="display:flex;gap:3px;margin-bottom:6px;flex-wrap:wrap">';
  var roomActive=tgt==="room";
  h+='<button class="btn'+(roomActive?" primary":"")+'" onclick="S._net.chatTarget=\'room\';renderFloatingPanel()" style="font-size:10px;padding:3px 8px;min-height:22px">Room</button>';
  if(n.isHost){
    n.conns.forEach(function(c){
      var pn=n.peerNames[c.peerId]||c.peerId.substring(0,6);
      var isActive=tgt===c.peerId;
      /* Check for unread DMs from this peer */
      var hasUnread=n.chatMessages.some(function(m){return m.from===c.peerId&&m.to!=="room"&&!m._read});
      h+='<button class="btn'+(isActive?" primary":"")+'" onclick="S._net.chatTarget=\''+c.peerId+'\';renderFloatingPanel()" style="font-size:10px;padding:3px 8px;min-height:22px;position:relative">'+escHtml(pn)+(hasUnread?'<span style="position:absolute;top:-2px;right:-2px;width:6px;height:6px;background:#ff4444;border-radius:50%"></span>':'')+'</button>';
    });
  }else if(n.hostConn){
    /* Peer can DM the host */
    var hostActive=tgt==="host";
    var hostUnread=n.chatMessages.some(function(m){return m.from!=="me"&&m.to!=="room"&&!m._read});
    h+='<button class="btn'+(hostActive?" primary":"")+'" onclick="S._net.chatTarget=\'host\';renderFloatingPanel()" style="font-size:10px;padding:3px 8px;min-height:22px;position:relative">Host'+(hostUnread?'<span style="position:absolute;top:-2px;right:-2px;width:6px;height:6px;background:#ff4444;border-radius:50%"></span>':'')+'</button>';
  }
  h+='</div>';
  /* Filter messages for current target */
  h+='<div style="flex:1;overflow-y:auto;max-height:280px;margin-bottom:6px;-webkit-overflow-scrolling:touch" id="chat-messages">';
  var filtered=n.chatMessages.filter(function(m){
    if(tgt==="room")return m.to==="room";
    /* DM view: show messages between me and the target */
    if(m.from==="me"&&m.to===tgt)return true;
    if(m.from===tgt&&m.to!=="room")return true;
    if(tgt==="host"&&m.from!=="me"&&m.to!=="room")return true;
    return false;
  });
  if(filtered.length===0){
    h+='<div style="font-size:10px;opacity:.4;text-align:center;padding:16px">'+(tgt==="room"?"No messages yet":"No DMs with this user")+'</div>';
  }
  filtered.forEach(function(m){
    var isMe=m.from==="me";
    var isDM=m.to!=="room";
    var timeStr="";
    if(m.ts){var d=new Date(m.ts);timeStr=String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")}
    h+='<div style="font-size:11px;margin-bottom:3px;padding:3px 6px;border-radius:4px;'
      +(isMe?'background:rgba(74,158,255,.1);text-align:right':'background:rgba(255,255,255,.03)')
      +(isDM?';border-left:2px solid #ffd700':'')
      +'">';
    h+='<span style="opacity:.35;font-size:9px;margin-right:4px">'+timeStr+'</span>';
    if(!isMe)h+='<strong style="color:'+(isDM?'#ffd700':'inherit')+'">'+escHtml(m.fromName||"???")+'</strong>: ';
    h+=escHtml(m.text);
    h+='</div>';
    /* Mark DMs as read when viewing */
    if(isDM&&!isMe)m._read=true;
  });
  h+='</div>';
  /* Input */
  var placeholder=tgt==="room"?"Message room...":"DM "+((n.isHost?(n.peerNames[tgt]||"peer"):tgt==="host"?"host":"peer"))+"...";
  h+='<div class="row" style="align-items:stretch"><input type="text" id="chat-input" placeholder="'+placeholder+'" style="flex:1;margin-bottom:0" maxlength="500" autocomplete="off" autocorrect="off" spellcheck="false"><button class="btn primary" onclick="sendChat()" style="min-height:0;align-self:stretch">Send</button></div>';
  return h}

function renderLayers(){
  let h='';
  const inRoom=S._net&&S._net.mode!=="offline";
  /* Guard: ensure at least default layer exists */
  if(!S.layers||S.layers.length===0){S.layers=[{id:"default",name:"Default",visible:true,hasErrors:false}];S.activeLayerId="default";}
  h+='<div class="row" style="margin-bottom:8px"><button class="btn primary" onclick="addLayer()">+ Add Layer</button></div>';
  /* Packages section */
  const pkgLayerIds=new Set();
  S.packages.forEach(p=>p.layerIds.forEach(id=>pkgLayerIds.add(id)));
  if(S.packages.length>0){
    h+='<div class="section-title" style="margin-bottom:4px">PACKAGES</div>';
    S.packages.forEach(pkg=>{
      const pkgLayers=pkg.layerIds.map(id=>S.layers.find(l=>l.id===id)).filter(Boolean);
      const pkgObjCount=pkgLayers.reduce((s,l)=>s+S.units.filter(u=>u.layerId===l.id).length+S.graphics.filter(g=>g.layerId===l.id).length,0);
      h+='<div style="margin-bottom:4px;border:1px solid var(--border);border-radius:6px;overflow:hidden">';
      h+='<div style="display:flex;align-items:center;gap:4px;padding:4px 6px;background:rgba(255,255,255,.03);cursor:pointer" onclick="togglePackageCollapse(\''+pkg.id+'\')">';
      h+='<span style="font-size:10px;opacity:.6;transition:transform .15s;transform:rotate('+(pkg.collapsed?'0':'90')+'deg)">\u25b6</span>';
      h+='<span style="font-size:11px;font-weight:600;flex:1">'+escHtml(pkg.name)+'</span>';
      h+='<span style="font-size:9px;opacity:.4">('+pkgObjCount+')</span>';
      /* Package visibility toggle */
      var pkgVis=pkgLayers.every(l=>l.visible);
      h+='<span style="cursor:pointer;font-size:14px;opacity:.7;padding:2px 4px" onclick="event.stopPropagation();togglePackageVis(\''+pkg.id+'\')">'+(pkgVis?"\ud83d\udc41":"\ud83d\udc41\u200d\ud83d\udde8")+'</span>';
      if(S._confirmDeletePkg===pkg.id){h+='<span style="cursor:pointer;font-size:9px;color:var(--danger);padding:2px 4px;font-weight:700" onclick="event.stopPropagation();removePackage(\''+pkg.id+'\')">Delete all?</span>';h+='<span style="cursor:pointer;font-size:9px;opacity:.5;padding:2px" onclick="event.stopPropagation();S._confirmDeletePkg=null;renderFloatingPanel()">cancel</span>';}else{h+='<span style="cursor:pointer;font-size:10px;opacity:.4;padding:2px" onclick="event.stopPropagation();removePackage(\''+pkg.id+'\')">\u2715</span>';}
      h+='</div>';
      if(!pkg.collapsed){
        pkgLayers.forEach(l=>{
          h+=renderLayerItem(l,inRoom);
        });
      }
      h+='</div>';
    });
  }
  /* Standalone layers (not in any package) */
  const standaloneLayers=S.layers.filter(l=>!pkgLayerIds.has(l.id));
  if(standaloneLayers.length>0){
    if(S.packages.length>0)h+='<div class="section-title" style="margin-top:8px;margin-bottom:4px">LAYERS</div>';
    standaloneLayers.forEach(l=>{
      h+=renderLayerItem(l,inRoom);
    });
  }
  return h}
function renderLayerItem(l,inRoom){
  var h='';
  const isActive=l.id===S.activeLayerId;
  const layerUnits=S.units.filter(u=>u.layerId===l.id);
  const layerGfx=S.graphics.filter(g=>g.layerId===l.id);
  const objCount=layerUnits.length+layerGfx.length;
  /* Collapse rules: any layer can be collapsed */
  const canCollapse=objCount>0;
  const collapsed=l.collapsed&&canCollapse;
  h+=`<div class="layer-item${isActive?" active":""}" onclick="setActiveLayer('${l.id}')">`;
  if(objCount>0){
    h+=`<span style="cursor:${canCollapse?'pointer':'default'};font-size:10px;opacity:${canCollapse?'.6':'.25'};padding:2px 4px;min-width:16px;text-align:center;transition:transform .15s;transform:rotate(${collapsed?'0':'90'}deg)" onclick="event.stopPropagation();${canCollapse?"toggleLayerCollapse('"+l.id+"')":''}">\u25b6</span>`;
  }else{
    h+=`<span style="width:16px;display:inline-block"></span>`;
  }
  h+=`<div class="layer-dot" style="background:${layerDotColor(l)};color:${layerDotColor(l)}"></div>`;
  if(S._renamingLayerId===l.id){
    h+=`<input type="text" class="layer-rename-input" value="${escAttr(l.name)}" id="layer-rename-${l.id}" onclick="event.stopPropagation()" onblur="commitLayerRename('${l.id}')" onkeydown="if(event.key==='Enter'){commitLayerRename('${l.id}')}" style="flex:1;background:var(--btn-bg);color:var(--fg);border:1px solid var(--accent);border-radius:3px;padding:2px 4px;font-size:11px;font-family:var(--font);min-width:0">`;
  }else{
    h+=`<span class="layer-name" ondblclick="event.stopPropagation();startLayerRename('${l.id}')">${escHtml(l.name)}</span>`;
    if(objCount>0)h+=`<span style="font-size:9px;opacity:.4;margin-left:2px">(${objCount})</span>`;
    h+=`<span style="cursor:pointer;font-size:14px;opacity:.7;padding:4px 6px;min-width:28px;text-align:center" onclick="event.stopPropagation();startLayerRename('${l.id}')" title="Rename">\u270e</span>`;
  }
  h+=`<span class="layer-eye ${l.visible?"visible":""}" onclick="event.stopPropagation();toggleLayerVis('${l.id}')">${l.visible?"\ud83d\udc41":"\ud83d\udc41\u200d\ud83d\udde8"}</span>`;
  if(inRoom){
    const sh=S._net.sharedLayers[l.id];const isPrimary=S._net.sharedEditLayer===l.id;
    if(sh&&sh.visible)h+=`<span style="font-size:9px;padding:1px 3px;border-radius:3px;${isPrimary?'background:rgba(255,215,0,.2);color:#ffd700':'background:rgba(74,158,255,.15);color:var(--accent)'}" title="${sh.editable?'Shared (editable)':'Shared (view only)'}${isPrimary?' - Primary edit':''}">📡${isPrimary?'★':''}</span>`;
  }
  if(l.id!=="default"){
    if(S._confirmDeleteLayer===l.id){
      h+=`<span style="cursor:pointer;font-size:9px;color:var(--danger);padding:2px 4px;font-weight:700;white-space:nowrap" onclick="event.stopPropagation();removeLayer('${l.id}')">Delete all?</span>`;
      h+=`<span style="cursor:pointer;font-size:9px;opacity:.5;padding:2px" onclick="event.stopPropagation();S._confirmDeleteLayer=null;renderFloatingPanel()">cancel</span>`;
    }else{
      h+=`<span style="cursor:pointer;font-size:10px;opacity:.5;padding:2px" onclick="event.stopPropagation();removeLayer('${l.id}')">\u2715</span>`;
    }
  }
  h+='</div>';
  if(!collapsed&&(layerUnits.length||layerGfx.length)){
    h+='<div class="layer-objects">';
    layerUnits.forEach(u=>{
      const sel=u.id===S.selectedUnitId?" active":"";
      const affColor=({friendly:"#4a9eff",hostile:"#ff4444",neutral:"#44cc44",unknown:"#ffd700"})[u.affiliation]||"#888";
      h+=`<div class="layer-obj${sel}" onclick="selectUnit('${u.id}');requestRender()">`;
      h+=`<span style="font-size:9px;color:${affColor}">\u25a0</span> `;
      h+=`<span class="layer-name">${escHtml(u.originalName||u.designation||u.type)}</span>`;
      h+=`<span style="font-size:8px;opacity:.4;margin-left:2px">${u.affiliation.charAt(0).toUpperCase()}</span>`;
      h+=`<select class="layer-move-select" onclick="event.stopPropagation()" onchange="moveToLayer('unit','${u.id}',this.value)">`;
      S.layers.forEach(ll=>{h+=`<option value="${ll.id}"${ll.id===l.id?" selected":""}>${escHtml(ll.name)}</option>`});
      h+=`</select></div>`;
    });
    layerGfx.forEach(g=>{
      const sel=g.id===S.selectedGraphicId?" active":"";
      h+=`<div class="layer-obj${sel}" onclick="selectGraphic('${g.id}');requestRender()">`;
      h+=`<span style="color:${g.color||'#f44'};font-size:9px">\u25cf</span> `;
      h+=`<span class="layer-name">${g.overlayType&&g.overlayType!=="none"?escHtml(g.overlayType.toUpperCase())+" ":""}${escHtml(g.label||g.tool)}</span>`;
      h+=`<select class="layer-move-select" onclick="event.stopPropagation()" onchange="moveToLayer('graphic','${g.id}',this.value)">`;
      S.layers.forEach(ll=>{h+=`<option value="${ll.id}"${ll.id===l.id?" selected":""}>${escHtml(ll.name)}</option>`});
      h+=`</select></div>`;
    });
    h+='</div>';
  }
  return h;
}

function renderGraphicsPanel(){
  /* Now integrated into addunit panel — redirect */
  S._addUnitTab="draw";S._activePanel="addunit";return renderAddUnitPanel()}

function renderAddUnitPanel(){
  const tab=S._addUnitTab||"formations";
  let h='<div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:6px">';
  h+='<button class="btn'+(tab==="formations"?" primary":"")+'" onclick="S._addUnitTab=\'formations\';renderFloatingPanel()" style="flex:1;font-size:11px;padding:5px 8px">Formations</button>';
  h+='<button class="btn'+(tab==="equipment"?" primary":"")+'" onclick="S._addUnitTab=\'equipment\';renderFloatingPanel()" style="flex:1;font-size:11px;padding:5px 8px">Equipment</button>';
  h+='<button class="btn'+(tab==="draw"?" primary":"")+'" onclick="S._addUnitTab=\'draw\';renderFloatingPanel()" style="flex:1;font-size:11px;padding:5px 8px">Draw</button>';
  h+='</div>';
  if(tab==="draw"){
    h+='<div class="section"><div class="section-title">Drawing Tools</div>';
    const tools=[["line","Line"],["polygon","Polygon"],["circle","Circle"],["rectangle","Rect"],["arrow","Arrow"],["text","Text"]];
    h+='<div class="row" style="flex-wrap:wrap">';tools.forEach(([id,label])=>h+=`<button class="btn" onclick="startDrawing('${id}')" style="min-width:55px">${label}</button>`);h+='</div></div>';
    h+='<div class="section"><div class="section-title">OPORD Overlays</div><div class="row" style="flex-wrap:wrap">';
    OVERLAY_TYPES.filter(o=>o.id!=="none").forEach(o=>h+=`<button class="btn" onclick="startOverlayDraw('${o.id}')" style="min-width:80px">${o.label}</button>`);
    h+='</div></div>';
    return h;
  }
  if(tab==="equipment"){
    h+='<label>Affiliation</label><div class="row" style="margin-bottom:8px">';
    const curAffEq=S._addUnitAff||"friendly";
    for(const[k,v]of Object.entries(AFFILIATIONS)){var abgE=curAffEq===k?v.fill:'transparent';var afgE=curAffEq===k?'#000':v.fill;h+='<button class="btn'+(curAffEq===k?' primary':'')+'" onclick="S._addUnitAff=\''+k+'\';renderFloatingPanel()" style="flex:1 1 22%;min-width:0;background:'+abgE+';color:'+afgE+';border:1.5px solid '+v.fill+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:6px 4px">'+v.label+'</button>'}
    h+='</div>';
    var EQUIP_CATEGORIES=[{name:"Drones / UAS",types:[{id:"uav",label:"UAS"}]}];
    EQUIP_CATEGORIES.forEach(function(cat,ci){
      h+='<div class="cat-header open" onclick="this.classList.toggle(\'open\');this.nextElementSibling.style.display=this.classList.contains(\'open\')?\'\':\'none\'">'+cat.name+'</div><div class="icon-grid">';
      cat.types.forEach(function(t){h+='<div class="icon-cell" onclick="startPlacement(\''+t.id+'\',\''+curAffEq+'\',true);togglePanel(null)"><canvas width="100" height="100" data-utype="'+t.id+'" data-uaff="'+curAffEq+'" data-equip="1"></canvas><div class="tooltip">'+t.label+'</div></div>'});
      h+='</div>'});
    setTimeout(function(){document.querySelectorAll(".icon-cell canvas[data-equip]").forEach(function(cv){var c=cv.getContext("2d");drawUnitIcon(c,{type:cv.dataset.utype,affiliation:cv.dataset.uaff||"friendly",isEquipment:true},50,50,88)})},10);
    return h;
  }
  /* Formations tab */
  h+='<label>Affiliation</label><div class="row" style="margin-bottom:8px">';
  const curAff=S._addUnitAff||"friendly";
  for(const[k,v]of Object.entries(AFFILIATIONS)){var abg2=curAff===k?v.fill:'transparent';var afg2=curAff===k?'#000':v.fill;h+=`<button class="btn${curAff===k?" primary":""}" onclick="S._addUnitAff='${k}';renderFloatingPanel()" style="flex:1 1 22%;min-width:0;background:${abg2};color:${afg2};border:1.5px solid ${v.fill};overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:6px 4px">${v.label}</button>`}
  h+='</div>';
  UNIT_CATEGORIES.forEach((cat,ci)=>{
    h+=`<div class="cat-header open" onclick="this.classList.toggle('open');this.nextElementSibling.style.display=this.classList.contains('open')?'':'none'">${cat.name}</div><div class="icon-grid">`;
    cat.types.forEach(t=>{h+=`<div class="icon-cell" onclick="startPlacement('${t.id}','${curAff}');togglePanel(null)"><canvas width="100" height="100" data-utype="${t.id}" data-uaff="${curAff}"></canvas><div class="tooltip">${t.label}</div></div>`});
    h+='</div>'});
  setTimeout(()=>{document.querySelectorAll(".icon-cell canvas[data-utype]").forEach(cv=>{const c=cv.getContext("2d");drawUnitIcon(c,{type:cv.dataset.utype,affiliation:cv.dataset.uaff||"friendly"},50,50,88)})},10);
  return h}


function renderMapToolsPanel(){
  let h='<div class="section"><div class="section-title">Coordinate Search</div>';
  h+='<div style="display:flex;gap:4px;align-items:stretch"><input type="text" id="coord-search-input" placeholder="MGRS or lat,lon" autocomplete="off" autocorrect="off" spellcheck="false" style="flex:1;margin:0"><button class="btn primary" onclick="coordSearch()" style="margin:0;white-space:nowrap">Go</button></div>';
  h+='<div style="font-size:9px;opacity:.5;margin-top:3px">e.g. 18SUJ2340067 or 38.8977,-77.0365</div></div>';
  h+='<div class="section"><div class="section-title">Tools</div><div class="row" style="flex-wrap:wrap;gap:4px">';
  h+=`<button class="btn${S._mapTool==='pin'?' primary':''}" onclick="activateMapTool('pin');togglePanel(null)" style="flex:1;min-width:70px">📍 Pin [P]</button>`;
  h+=`<button class="btn${S._mapTool==='distance'?' primary':''}" onclick="activateMapTool('distance');togglePanel(null)" style="flex:1;min-width:70px">📏 Dist [M]</button>`;
  h+=`<button class="btn${S._mapTool==='area'?' primary':''}" onclick="activateMapTool('area');togglePanel(null)" style="flex:1;min-width:70px">📐 Area [A]</button>`;
  h+='</div></div>';
  /* Active measurement data */
  if(S._measurePoints.length>=2){
    h+='<div class="section"><div class="section-title">Distance Measurement</div>';
    let total=0;for(let i=1;i<S._measurePoints.length;i++)total+=haversine(S._measurePoints[i-1].lat,S._measurePoints[i-1].lon,S._measurePoints[i].lat,S._measurePoints[i].lon);
    h+=`<div style="font-size:12px;font-weight:600">Total: ${formatDist(total)}</div>`;
    h+=`<div style="font-size:10px;opacity:.6">${S._measurePoints.length} points, ${S._measurePoints.length-1} segments</div>`;
    h+=`<div class="row" style="margin-top:4px;gap:4px"><button class="btn" onclick="convertMeasureToGraphic('distance')" style="font-size:10px">→ Convert to Line</button><button class="btn danger" onclick="clearMapToolData('distance')" style="font-size:10px">Clear</button></div>`;
    h+='</div>'}
  if(S._measureArea.length>=3){
    h+='<div class="section"><div class="section-title">Area Measurement</div>';
    let perim=0;for(let i=1;i<S._measureArea.length;i++)perim+=haversine(S._measureArea[i-1].lat,S._measureArea[i-1].lon,S._measureArea[i].lat,S._measureArea[i].lon);
    perim+=haversine(S._measureArea[S._measureArea.length-1].lat,S._measureArea[S._measureArea.length-1].lon,S._measureArea[0].lat,S._measureArea[0].lon);
    const area=polyArea(S._measureArea);
    h+=`<div style="font-size:12px;font-weight:600">Area: ${formatArea(area)}</div>`;
    h+=`<div style="font-size:10px;opacity:.6">Perimeter: ${formatDist(perim)} • ${S._measureArea.length} vertices</div>`;
    h+=`<div class="row" style="margin-top:4px;gap:4px"><button class="btn" onclick="convertMeasureToGraphic('area')" style="font-size:10px">→ Convert to Polygon</button><button class="btn danger" onclick="clearMapToolData('area')" style="font-size:10px">Clear</button></div>`;
    h+='</div>'}
  return h}

/* ── IPB Wizard ── */
function renderIPBPanel(){
  if(!S._ipb)S._ipb={step:1,assignments:{}};/* assignments: graphicId -> "ao"|"ai"|"aoi"|null */
  var ipb=S._ipb;
  var h='';
  /* Step tabs */
  h+='<div style="display:flex;gap:2px;margin-bottom:8px">';
  [1,2,3,4].forEach(function(s){
    var labels=["Define","Effects","Threat","COAs"];
    var done=ipbStepComplete(s);
    var active=ipb.step===s;
    h+='<button class="btn'+(active?' primary':'')+'" onclick="S._ipb.step='+s+';renderFloatingPanel()" style="flex:1;font-size:9px;padding:3px 2px;position:relative">';
    if(done)h+='<span style="color:#44cc44;margin-right:2px">\u2713</span>';
    h+=s+'. '+labels[s-1]+'</button>';
  });
  h+='</div>';

  if(ipb.step===1){
    /* Step 1: Define the Battlefield Environment */
    h+='<div class="section-title">Step 1: Define the Battlefield</div>';
    h+='<div style="font-size:10px;opacity:.6;margin-bottom:8px;line-height:1.4">Identify your Area of Operations (AO), Area of Interest (AI), and Area of Influence (AOI) from existing graphics, or draw new ones.</div>';
    
    /* Scan for eligible graphics: polygons, rectangles, boundaries */
    var eligible=S.graphics.filter(function(g){
      if(!g.points||g.points.length<2)return false;
      var t=g.tool||"";var ot=g.overlayType||"none";
      return t==="polygon"||t==="rectangle"||t==="circle"||ot==="aa"||ot==="boundary"||(t==="line"&&g.points.length>=3);
    });

    /* Status summary */
    var aoCount=0,aiCount=0,aoiCount=0;
    eligible.forEach(function(g){
      var role=ipb.assignments[g.id];
      if(role==="ao")aoCount++;
      else if(role==="ai")aiCount++;
      else if(role==="aoi")aoiCount++;
    });
    h+='<div style="display:flex;gap:6px;margin-bottom:8px">';
    h+='<div style="flex:1;text-align:center;padding:6px;border-radius:4px;border:1px solid '+(aoCount?'#44cc44':'var(--border)')+';background:'+(aoCount?'rgba(68,204,68,.08)':'transparent')+'"><div style="font-size:16px">'+(aoCount?'\u2713':'\u2014')+'</div><div style="font-size:9px;font-weight:600">AO</div></div>';
    h+='<div style="flex:1;text-align:center;padding:6px;border-radius:4px;border:1px solid '+(aiCount?'#44cc44':'var(--border)')+';background:'+(aiCount?'rgba(68,204,68,.08)':'transparent')+'"><div style="font-size:16px">'+(aiCount?'\u2713':'\u2014')+'</div><div style="font-size:9px;font-weight:600">AI</div></div>';
    h+='<div style="flex:1;text-align:center;padding:6px;border-radius:4px;border:1px solid '+(aoiCount?'#4a9eff':'var(--border)')+';background:'+(aoiCount?'rgba(74,158,255,.08)':'transparent')+'"><div style="font-size:16px">'+(aoiCount?'\u2713':'\u2014')+'</div><div style="font-size:9px;font-weight:600">AOI</div><div style="font-size:8px;opacity:.4">optional</div></div>';
    h+='</div>';

    if(eligible.length===0){
      h+='<div style="font-size:10px;opacity:.5;text-align:center;padding:12px;border:1px dashed var(--border);border-radius:6px;margin-bottom:8px">No polygons, rectangles, or boundaries found.<br>Draw some first, then come back to assign them.</div>';
      h+='<button class="btn primary" onclick="togglePanel(\'addunit\')" style="width:100%;font-size:10px">\u270e Go to Draw Tools</button>';
    }else{
      /* Search filter */
      var ipbFilter=S._ipbFilter||"";
      h+='<div style="margin-bottom:6px"><input type="text" id="ipb-search" value="'+ipbFilter.replace(/"/g,'&quot;')+'" placeholder="\ud83d\udd0d Search graphics..." style="width:100%;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:4px;padding:5px 8px;font-family:var(--font);font-size:11px;box-sizing:border-box"></div>';
      /* Filter eligible */
      var filtered=eligible;
      if(ipbFilter){
        var lf=ipbFilter.toLowerCase();
        filtered=eligible.filter(function(g){
          var n=(g.label||g.name||g.originalName||g.tool||"").toLowerCase();
          var ot=(g.overlayType||"").toLowerCase();
          var lr=(g.ipbRole||"").toLowerCase();
          return n.indexOf(lf)>=0||ot.indexOf(lf)>=0||lr.indexOf(lf)>=0;
        });
      }
      if(filtered.length===0&&ipbFilter){
        h+='<div style="font-size:10px;opacity:.4;text-align:center;padding:8px">No matches for "'+ipbFilter+'"</div>';
      }
      /* Group by layer/package */
      var byLayer={};
      filtered.forEach(function(g){
        var lid=g.layerId||"default";
        if(!byLayer[lid])byLayer[lid]=[];
        byLayer[lid].push(g);
      });

      Object.keys(byLayer).forEach(function(lid){
        var layer=S.layers.find(function(l){return l.id===lid});
        var layerName=layer?layer.name:"Unknown";
        var graphics=byLayer[lid];
        if(graphics.length>1){
          h+='<div style="font-size:9px;opacity:.4;margin-bottom:2px;margin-top:6px">'+layerName+' layer</div>';
        }
        graphics.forEach(function(g){
          var gName=g.label||g.name||g.originalName||"";
          if(!gName){var ot2=g.overlayType&&g.overlayType!=="none"?g.overlayType.toUpperCase():"";gName=ot2||(g.tool||"Graphic")}
          var gType=g.tool+(g.overlayType&&g.overlayType!=="none"?" / "+g.overlayType:"");
          var role=ipb.assignments[g.id]||"";
          var roleColor=role==="ao"?"#44cc44":role==="ai"?"#44cc44":role==="aoi"?"#4a9eff":"";
          h+='<div style="padding:5px 6px;margin-bottom:3px;border-radius:4px;border:1px solid '+(roleColor||'var(--border)')+';background:'+(roleColor?roleColor+'18':'transparent')+'">';
          /* Top row: color dot + name + layer badge */
          h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px;cursor:pointer" onclick="selectGraphic(\''+g.id+'\');ipbZoomTo(\''+g.id+'\')">';
          h+='<div style="width:10px;height:10px;border-radius:2px;background:'+(g.color||'#888')+';flex-shrink:0"></div>';
          h+='<span style="font-size:11px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+gType+'">'+gName+'</span>';
          if(graphics.length<=1){h+='<span style="font-size:8px;opacity:.3">'+layerName+'</span>'}
          h+='</div>';
          /* Bottom row: type info + role buttons */
          h+='<div style="display:flex;align-items:center;gap:3px">';
          h+='<span style="font-size:9px;opacity:.4;flex-shrink:0">'+gType+'</span>';
          h+='<span style="flex:1"></span>';
          [["","—"],["ao","AO"],["ai","AI"],["aoi","AOI"]].forEach(function(r){
            var active=role===r[0];
            var btnCol=r[0]==="ao"||r[0]==="ai"?"#44cc44":r[0]==="aoi"?"#4a9eff":"";
            h+='<button class="ed-btn'+(active?' active':'')+'" onclick="event.stopPropagation();ipbAssign(\''+g.id+'\',\''+r[0]+'\')" style="padding:1px 6px;font-size:9px;min-height:20px;'+(active&&btnCol?'border-color:'+btnCol+';color:'+btnCol:'')+'">'+r[1]+'</button>';
          });
          h+='</div>';
          h+='</div>';
        });
      });
      h+='<div style="margin-top:6px;border-top:1px solid var(--border);padding-top:6px">';
      h+='<button class="btn" onclick="togglePanel(\'addunit\')" style="width:100%;font-size:10px;margin-bottom:4px">\u270e Draw More Graphics</button>';
      if(aoCount>0)h+='<button class="btn primary" onclick="S._ipb.step=2;renderFloatingPanel()" style="width:100%;font-size:10px">\u25b6 Next: Battlefield Effects</button>';
      h+='</div>';
    }
  }else if(ipb.step===2){
    h+='<div class="section-title">Step 2: MCOO (Modified Combined Obstacle Overlay)</div>';
    /* Find AO graphic */
    var aoGfx=null;
    Object.keys(ipb.assignments).forEach(function(gid){
      if(ipb.assignments[gid]==="ao"){var g=S.graphics.find(function(x){return x.id===gid});if(g)aoGfx=g}
    });
    if(!aoGfx){
      h+='<div style="font-size:10px;opacity:.6;padding:12px;border:1px dashed var(--border);border-radius:6px;text-align:center;line-height:1.5">';
      h+='⚠️ No AO Defined<br><span style="font-size:9px">Go back to Step 1 and assign an Area of Operations</span></div>';
      h+='<button class="btn" onclick="S._ipb.step=1;renderFloatingPanel()" style="width:100%;margin-top:6px;font-size:10px">← Back to Step 1</button>';
    }else{
      var aoName=aoGfx.label||aoGfx.name||'AO';
      h+='<div style="font-size:10px;opacity:.7;margin-bottom:6px">AO: <strong>'+escHtml(aoName)+'</strong></div>';
      if(!aoGfx._mcooEnabled){
        /* Prompt to enable MCOO on this graphic */
        h+='<div style="padding:12px;border:1px dashed var(--border);border-radius:6px;text-align:center">';
        h+='<div style="font-size:10px;opacity:.6;line-height:1.5;margin-bottom:8px">Enable MCOO on this AO to begin freehand annotation.<br><span style="font-size:9px;color:var(--danger)">⚠️ This locks the AO\'s shape and position permanently.</span></div>';
        h+='<button class="btn primary" onclick="mcooEnable(\''+aoGfx.id+'\')" style="width:100%;font-size:11px">🔒 Enable MCOO on AO</button>';
        h+='</div>';
      }else{
        /* MCOO enabled — show draw controls */
        _mcooLayerId=aoGfx.layerId;_mcooAoId=aoGfx.id;
        h+='<div style="font-size:9px;color:#44cc44;margin-bottom:6px">🔒 MCOO enabled — AO locked</div>';
        h+='<button class="btn primary" onclick="mcooStartDraw(\''+aoGfx.id+'\')" style="width:100%;font-size:11px;margin-bottom:6px">✏️ Draw on MCOO</button>';
        /* Stroke stats */
        var strokes=S.graphics.filter(function(g){return g.layerId===aoGfx.layerId&&g._freehand});
        h+='<div style="font-size:9px;opacity:.4;margin-bottom:6px">Strokes: '+strokes.length+'/'+MCOO_MAX_STROKES;
        var totalPts=0;strokes.forEach(function(s){totalPts+=s.points.length});
        h+=' &nbsp;|&nbsp; Points: '+totalPts+'</div>';
        /* Stroke list */
        if(strokes.length>0){
          h+='<div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:2px">';
          strokes.forEach(function(s,i){
            h+='<div style="display:flex;align-items:center;gap:4px;padding:2px 4px;font-size:9px" onmouseenter="highlightGraphic(\''+s.id+'\')" onmouseleave="highlightGraphic(null)">';
            h+='<div style="width:12px;height:3px;background:'+s.color+';border-radius:1px;flex-shrink:0"></div>';
            h+='<span style="opacity:.6;flex:1">Stroke '+(i+1)+' ('+s.points.length+' pts)</span>';
            h+='<button class="btn danger" onclick="mcooDeleteStroke(\''+s.id+'\')" style="padding:0 4px;font-size:9px;min-height:16px">✕</button>';
            h+='</div>';
          });
          h+='</div>';
          h+='<button class="btn danger" onclick="mcooClearAll()" style="width:100%;margin-top:4px;font-size:9px">Clear All Strokes</button>';
        }
      }
    }
  }else if(ipb.step===3){
    h+='<div class="section-title">Step 3: Evaluate the Threat</div>';
    h+='<div style="font-size:10px;opacity:.5;line-height:1.4;padding:8px;border:1px dashed var(--border);border-radius:6px;text-align:center">Threat Template<br><span style="font-size:9px">Coming soon — OPFOR unit placement with range rings</span></div>';
  }else if(ipb.step===4){
    h+='<div class="section-title">Step 4: Determine Threat COAs</div>';
    h+='<div style="font-size:10px;opacity:.5;line-height:1.4;padding:8px;border:1px dashed var(--border);border-radius:6px;text-align:center">Threat COA Overlays<br><span style="font-size:9px">Coming soon — enemy course of action graphics</span></div>';
  }
  return h}

function ipbAssign(graphicId,role){
  if(!S._ipb)S._ipb={step:1,assignments:{}};
  if(role)S._ipb.assignments[graphicId]=role;
  else delete S._ipb.assignments[graphicId];
  var g=S.graphics.find(function(x){return x.id===graphicId});
  if(g)g.ipbRole=role||null;
  renderFloatingPanel();requestRender()}

function ipbAssignFromEditor(graphicId,role){
  if(!S._ipb)S._ipb={step:1,assignments:{}};
  if(role)S._ipb.assignments[graphicId]=role;
  else delete S._ipb.assignments[graphicId];
  var g=S.graphics.find(function(x){return x.id===graphicId});
  if(g)g.ipbRole=role||null;
  renderEditor();requestRender()}

function ipbZoomTo(graphicId){
  var g=S.graphics.find(function(x){return x.id===graphicId});
  if(!g||!g.points||!g.points.length)return;
  var cx=0,cy=0;g.points.forEach(function(p){cx+=p.lat;cy+=p.lon});
  cx/=g.points.length;cy/=g.points.length;
  smoothPanTo(cx,cy,500)}

/* MCOO Layer Management */
function escHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
function escAttr(s){return escHtml(s)}
/* Sanitize + truncate user strings */
function sanitizeStr(s,maxLen){s=String(s||"");if(maxLen&&s.length>maxLen)s=s.slice(0,maxLen);return s}
/* Length limits for user input fields */
const APP_VERSION="10.5";
function toggleFullscreen(){
  var d=document;
  if(d.fullscreenElement||d.webkitFullscreenElement){
    if(d.exitFullscreen)d.exitFullscreen();else if(d.webkitExitFullscreen)d.webkitExitFullscreen();
  }else{
    var e=d.documentElement;
    if(e.requestFullscreen)e.requestFullscreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();
  }
  setTimeout(function(){renderFloatingPanel()},300);
}
function forceUpdate(){
  if("serviceWorker" in navigator){
    navigator.serviceWorker.getRegistrations().then(function(regs){
      var p=regs.map(function(r){return r.unregister()});
      return Promise.all(p);
    }).then(function(){
      return caches.keys();
    }).then(function(names){
      return Promise.all(names.map(function(n){return caches.delete(n)}));
    }).then(function(){
      notify("Cache cleared — reloading...");
      setTimeout(function(){location.reload(true)},500);
    }).catch(function(){location.reload(true)});
  }else{location.reload(true)}
}
const INPUT_LIMITS={designation:50,parentUnit:50,label:100,name:50,callsign:20,chatMsg:500,layerName:30,roomCode:6,ringLabel:30};
/* Sanitize an entire unit object (from P2P or file import) */
function sanitizeUnit(u){
  if(!u||typeof u!=="object")return null;
  u.isEquipment=!!u.isEquipment;u.designation=sanitizeStr(u.designation,INPUT_LIMITS.designation);
  u.parentUnit=sanitizeStr(u.parentUnit,INPUT_LIMITS.parentUnit);
  u.name=sanitizeStr(u.name,INPUT_LIMITS.name);
  u.originalName=sanitizeStr(u.originalName,INPUT_LIMITS.name);
  if(u.rings&&Array.isArray(u.rings)){u.rings=u.rings.slice(0,20);u.rings.forEach(r=>{r.label=sanitizeStr(r.label,INPUT_LIMITS.ringLabel);r.radius=Math.max(0,Math.min(Number(r.radius)||0,1e7))})}
  if(typeof u.lat!=="number"||typeof u.lon!=="number")return null;
  u.lat=Math.max(-90,Math.min(90,u.lat));u.lon=Math.max(-180,Math.min(180,u.lon));
  if(u.customIcon&&(typeof u.customIcon!=="string"||!/^data:image\//i.test(u.customIcon)||u.customIcon.length>500000))u.customIcon=null;
  return u}
/* Sanitize a graphic object */
function sanitizeGraphic(g){
  if(!g||typeof g!=="object")return null;
  g.label=sanitizeStr(g.label,INPUT_LIMITS.label);
  if(g.points&&Array.isArray(g.points)){g.points=g.points.slice(0,5000);g.points.forEach(p=>{if(typeof p.lat==="number")p.lat=Math.max(-90,Math.min(90,p.lat));if(typeof p.lon==="number")p.lon=Math.max(-180,Math.min(180,p.lon))})}
  return g}
/* Sanitize incoming P2P message */
function sanitizeNetMsg(msg){
  if(!msg||typeof msg!=="object")return null;
  msg.type=sanitizeStr(msg.type,20);
  if(msg.fromName)msg.fromName=sanitizeStr(msg.fromName,INPUT_LIMITS.callsign);
  if(msg.text)msg.text=sanitizeStr(msg.text,INPUT_LIMITS.chatMsg);
  if(msg.unit)sanitizeUnit(msg.unit);
  if(msg.graphic)sanitizeGraphic(msg.graphic);
  if(msg.data){
    if(Array.isArray(msg.data.units))msg.data.units=msg.data.units.slice(0,500).map(u=>sanitizeUnit(u)).filter(Boolean);
    if(Array.isArray(msg.data.graphics))msg.data.graphics=msg.data.graphics.slice(0,1000).map(g=>sanitizeGraphic(g)).filter(Boolean);
    if(Array.isArray(msg.data.layers))msg.data.layers=msg.data.layers.slice(0,50).map(l=>{l.name=sanitizeStr(l.name,INPUT_LIMITS.layerName);return l})}
  return msg}

function mcooEnable(aoId){
  var g=S.graphics.find(function(x){return x.id===aoId});
  if(!g)return;
  g._mcooEnabled=true;
  _mcooLayerId=g.layerId;_mcooAoId=aoId;
  notify("MCOO enabled — AO locked");
  netBroadcast({type:"graphicEdit",graphic:g});
  renderFloatingPanel();requestRender()}

function mcooStartDraw(aoId){
  var aoGfx=S.graphics.find(function(x){return x.id===aoId});
  if(!aoGfx||!aoGfx._mcooEnabled){notify("Enable MCOO first","error");return}
  _mcooLayerId=aoGfx.layerId;_mcooAoId=aoId;
  S.activeLayerId=aoGfx.layerId;
  S._activePanel=null;
  renderFloatingPanel();
  S._mapTool="freehand";
  canvas.style.cursor="crosshair";
  showFreehandBar();
  requestRender()}

function mcooDeleteStroke(gid){
  var idx=S.graphics.findIndex(function(g){return g.id===gid});
  if(idx>=0){S.graphics.splice(idx,1);netBroadcast({type:"graphicDelete",graphicId:gid})}
  renderFloatingPanel();requestRender()}

function mcooClearAll(){
  if(!_mcooLayerId)return;
  var toRemove=S.graphics.filter(function(g){return g.layerId===_mcooLayerId&&g._freehand});
  toRemove.forEach(function(g){
    var idx=S.graphics.indexOf(g);if(idx>=0)S.graphics.splice(idx,1);
    netBroadcast({type:"graphicDelete",graphicId:g.id});
  });
  notify("Cleared "+toRemove.length+" strokes");
  renderFloatingPanel();requestRender()}

function highlightGraphic(gid){S._highlightGfx=gid;requestRender()}

function ipbStepComplete(step){
  if(!S._ipb)return false;
  if(step===1){
    var vals=Object.values(S._ipb.assignments);
    return vals.indexOf("ao")>=0;
  }
  return false}

function bindPanelEvents(){
  const el=id=>document.getElementById(id);
  if(el("set-tiles"))el("set-tiles").onchange=e=>{S.tileSource=e.target.value;tileCache.clear();requestRender()};
  if(el("set-theme"))el("set-theme").onchange=e=>{S.theme=e.target.value;document.body.setAttribute("data-theme",S.theme);document.documentElement.style.background=S.theme==="light"?"#e8e8e8":"#1a1a2e";requestRender()};
  if(el("set-grid"))el("set-grid").onchange=e=>{S.showGrid=e.target.checked;requestRender()};
  if(el("set-labels"))el("set-labels").onchange=e=>{S.showLabels=e.target.checked;requestRender()};
  if(el("set-gridmode"))el("set-gridmode").onchange=e=>{S.gridMode=e.target.value;requestRender()};
  if(el("set-coorddisp"))el("set-coorddisp").onchange=e=>{S.coordDisplay=e.target.value};
  if(el("set-gridop")){trackFill(el("set-gridop"));el("set-gridop").oninput=e=>{S.gridOpacity=parseFloat(e.target.value);trackFill(e.target);requestRender()}};
  if(el("set-uiscale")){trackFill(el("set-uiscale"));el("set-uiscale").oninput=e=>{applyUIScale(parseFloat(e.target.value));trackFill(e.target);if(el("uiscale-val"))el("uiscale-val").textContent=Math.round(S.uiScale*100)+"%"}};
  if(el("net-name"))el("net-name").onchange=e=>{var v=sanitizeStr(e.target.value,INPUT_LIMITS.callsign);S._net.peerName=v;localStorage.setItem("staffmaps_callsign",v)};

  if(el("net-djm"))el("net-djm").onchange=e=>{S._net.defaultJoinMode=e.target.checked?"view":"edit";renderFloatingPanel()};
  if(el("net-enc"))el("net-enc").onchange=e=>{S._net.encEnabled=e.target.checked;const ef=document.getElementById("enc-fields");if(ef)ef.style.display=e.target.checked?"":"none"};
  if(el("chat-input")){el("chat-input").onkeydown=e=>{if(e.key==="Enter")sendChat()};el("chat-input").onfocus=function(){setTimeout(function(){window.scrollTo(0,0)},300)}}
  if(el("coord-search-input"))el("coord-search-input").onkeydown=e=>{if(e.key==="Enter")coordSearch()};
  if(el("ipb-search")){el("ipb-search").oninput=function(e){S._ipbFilter=e.target.value;renderFloatingPanel()};if(S._ipbFilter){el("ipb-search").focus();var v=el("ipb-search").value;el("ipb-search").setSelectionRange(v.length,v.length)}}
  /* Init trackFill on all range inputs in floating panel */
  document.querySelectorAll("#float-panel input[type='range']").forEach(function(inp){trackFill(inp)});
}

// Editor
function openEditor(){if(S._panLockMode)return;S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"));const el=document.getElementById("editor");el.style.display="flex";el.classList.add("open");if(S._editorHeight>180){el.style.maxHeight=S._editorHeight+"px";el.style.minHeight=S._editorHeight+"px"}else{el.style.maxHeight="";el.style.minHeight=""}renderEditor()}
function closeEditor(){S.selectedUnitId=null;S.selectedGraphicId=null;const el=document.getElementById("editor");el.classList.remove("open");el.style.display="none";el.style.maxHeight="";el.style.minHeight="";requestRender()}
// Editor grip drag-to-resize
(function(){let dragging=false,startY=0,startH=0;
document.addEventListener("pointerdown",function(e){
  if(e.target.id!=="editor-grip"&&e.target.parentElement&&e.target.parentElement.id!=="editor-grip")return;
  const ed=document.getElementById("editor");if(!ed)return;
  dragging=true;startY=e.clientY;startH=ed.offsetHeight;e.preventDefault();
});
document.addEventListener("pointermove",function(e){
  if(!dragging)return;
  const ed=document.getElementById("editor");if(!ed)return;
  const dy=startY-e.clientY;
  const maxH=window.innerWidth<=700?window.innerHeight*0.85:window.innerHeight-60;
  const newH=Math.max(180,Math.min(maxH,startH+dy));
  ed.style.maxHeight=newH+"px";ed.style.minHeight=newH+"px";S._editorHeight=newH;e.preventDefault();
});
document.addEventListener("pointerup",function(){dragging=false});
document.addEventListener("pointercancel",function(){dragging=false});
})();
function trackFill(inp){if(!inp)return;var pct=((inp.value-inp.min)/(inp.max-inp.min))*100;inp.style.setProperty("--val",pct+"%")}
function renderEditor(){
  const el=document.getElementById("editor");if(!el)return;
  /* Save scroll position */
  const body=el.querySelector(".editor-body");const scrollTop=body?body.scrollTop:0;
  /* Graphic editor */
  const g=S.graphics.find(x=>x.id===S.selectedGraphicId);
  if(g){
    let h='<div class="editor-grip" id="editor-grip"></div>';
    h+='<div class="editor-header"><div class="editor-tabs"><button class="editor-tab active">GRAPHIC</button></div><div class="editor-actions">';
    h+='<button class="btn'+(S.editorPinned?' primary':'')+'" onclick="S.editorPinned=!S.editorPinned;renderEditor()" title="Pin" style="padding:2px 5px">\ud83d\udccc</button>';
    if(g._mcooEnabled){h+='<button class="btn" disabled style="padding:2px 5px;opacity:.3;cursor:not-allowed" title="MCOO locked">Del</button>'}
    else{h+='<button class="btn danger" onclick="deleteGraphic(\''+g.id+'\')" style="padding:2px 5px">Del</button>'}
    h+='<button class="btn" onclick="closeEditor()" style="padding:2px 5px">\u2715</button>';
    h+='</div></div><div class="editor-body">';
    if(g._mcooEnabled){h+='<div style="font-size:9px;color:#ffd700;margin-bottom:4px;display:flex;align-items:center;gap:4px">🔒 MCOO Locked — shape &amp; position fixed</div>'};
    h+='<div class="ed-section-title">LABEL</div>';
    h+='<input type="text" id="ed-glabel" value="'+escAttr(g.label||'')+'" placeholder="Label text" class="ed-input" maxlength="100">';
    h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
    h+='<label style="font-size:9px;opacity:.6;margin:0;min-width:28px">Size</label>';
    h+='<input type="range" id="ed-gfontsize" min="8" max="48" step="1" value="'+(g.fontSize||14)+'" style="flex:1">';
    h+='<span id="ed-gfontsize-val" style="font-size:10px;min-width:28px;text-align:right">'+(g.fontSize||14)+'px</span>';
    h+='</div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:6px">';
    h+='<div class="toggle-row" style="margin:0;flex:1"><label class="switch-sm"><input type="checkbox" id="ed-glabelbold"'+((g.labelBold!==false)?' checked':'')+'><span class="slider"></span></label><span style="font-size:10px">Bold</span></div>';
    h+='<div class="toggle-row" style="margin:0;flex:1"><label class="switch-sm"><input type="checkbox" id="ed-glabelshadow"'+(g.labelShadow?' checked':'')+'><span class="slider"></span></label><span style="font-size:10px">Shadow</span></div>';
    h+='</div>';
    if(g.tool==="text"||g.tool==="rectangle"){
      var grot=Math.round(g.rotation||0);
      h+='<div class="ed-section-title">ROTATION</div>';
      h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:6px">';
      h+='<button class="ed-btn" onclick="editGraphicProp(\''+g.id+'\',\'rotation\',((('+grot+'-15)%360)+360)%360)" style="padding:2px 7px">&minus;15°</button>';
      h+='<input type="range" id="ed-grotation" min="0" max="359" step="1" value="'+grot+'" style="flex:1">';
      h+='<button class="ed-btn" onclick="editGraphicProp(\''+g.id+'\',\'rotation\',('+grot+'+15)%360)" style="padding:2px 7px">+15°</button>';
      h+='</div>';
      h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:8px">';
      h+='<span id="ed-grotation-val" style="font-size:11px;min-width:32px">'+grot+'°</span>';
      h+='<button class="ed-btn" onclick="editGraphicProp(\''+g.id+'\',\'rotation\',0)" style="font-size:10px;padding:2px 6px">Reset</button>';
      h+='</div>';
    }
    /* IPB Role */
    h+='<div class="ed-section-title">IPB ROLE</div>';
    h+='<div class="ed-btn-row" style="margin-bottom:6px">';
    var ipbR=g.ipbRole||"";
    [["","None"],["ao","AO"],["ai","AI"],["aoi","AOI"]].forEach(function(r){
      h+='<button class="ed-btn'+(ipbR===r[0]?' active':'')+'" onclick="ipbAssignFromEditor(\''+g.id+'\',\''+r[0]+'\')">'+r[1]+'</button>';
    });
    h+='</div>';
    if(g.overlayType==="boundary"){
      h+='<div class="ed-section-title">BOUNDARY UNITS</div>';
      h+='<label style="font-size:10px;opacity:.7">Unit Above Line</label>';
      h+='<input type="text" id="ed-bunitabove" value="'+escAttr(g.unitAbove||'')+'" placeholder="e.g. 1BCT" class="ed-input" maxlength="50">';
      h+='<label style="font-size:10px;opacity:.7">Unit Below Line</label>';
      h+='<input type="text" id="ed-bunitbelow" value="'+escAttr(g.unitBelow||'')+'" placeholder="e.g. 2BCT" class="ed-input" maxlength="50">';
      h+='<div class="ed-section-title">ECHELON</div><div class="ed-btn-row" style="flex-wrap:wrap">';
      ECHELONS.forEach(function(e){h+='<button class="ed-btn'+((g.echelon||"brigade")===e.id?' active':'')+'" onclick="editGraphicProp(\''+g.id+'\',\'echelon\',\''+e.id+'\')">'+e.label+'</button>'});
      h+='</div>';
    }
    if(!g._mcooEnabled&&(g.overlayType==="boundary"||g.overlayType==="pl"||g.overlayType==="ld")){
      h+='<div class="ed-section-title" style="display:flex;justify-content:space-between;align-items:center">POINTS <button class="btn" onclick="addGraphicPoint(\''+g.id+'\')" style="padding:1px 6px;font-size:10px">+ Add</button></div>';
      g.points.forEach(function(pt,i){
        var mgrs=toMGRS(pt.lat,pt.lon);
        h+='<div style="display:flex;gap:3px;align-items:center;margin-bottom:2px" onmouseenter="S._hoveredPtIdx='+i+';S._hoveredPtGid=\''+g.id+'\';requestRender()" onmouseleave="S._hoveredPtIdx=null;S._hoveredPtGid=null;requestRender()">';
        h+='<span style="font-size:9px;opacity:.4;min-width:12px;text-align:right">'+(i+1)+'</span>';
        h+='<input type="text" value="'+mgrs+'" class="ed-input" style="flex:1;font-size:9px;font-family:monospace;margin:0;padding:3px 4px;height:22px" data-ptidx="'+i+'" data-gid="'+g.id+'" onfocus="S._hoveredPtIdx='+i+';S._hoveredPtGid=\''+g.id+'\';requestRender()" onblur="S._hoveredPtIdx=null;S._hoveredPtGid=null;requestRender()" onchange="editGraphicPointCoord(this)">';
        if(g.points.length>2){h+='<button class="btn danger" onclick="removeGraphicPoint(\''+g.id+'\','+i+')" style="padding:1px 4px;font-size:9px;min-height:20px;line-height:1">\u2715</button>'}
        h+='</div>'});
    }
    /* Grid points for polygons/rectangles/lines (not circles, not already shown above) */
    if(!g._mcooEnabled&&g.tool!=="circle"&&g.overlayType!=="boundary"&&g.overlayType!=="pl"&&g.overlayType!=="ld"&&g.points&&g.points.length>=2){
      var showPts=S._showGfxPoints;
      h+='<div class="ed-section-title" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="S._showGfxPoints=!S._showGfxPoints;renderEditor()"><span>'+(showPts?'\u25bc':'\u25b6')+' POINTS ('+g.points.length+')</span><button class="btn" onclick="event.stopPropagation();addGraphicPoint(\''+g.id+'\')" style="padding:1px 6px;font-size:10px">+ Add</button></div>';
      if(showPts){
        g.points.forEach(function(pt,i){
          var mgrs=toMGRS(pt.lat,pt.lon);
          h+='<div style="display:flex;gap:3px;align-items:center;margin-bottom:2px" onmouseenter="S._hoveredPtIdx='+i+';S._hoveredPtGid=\''+g.id+'\';requestRender()" onmouseleave="S._hoveredPtIdx=null;S._hoveredPtGid=null;requestRender()">';
          h+='<span style="font-size:9px;opacity:.4;min-width:12px;text-align:right">'+(i+1)+'</span>';
          h+='<input type="text" value="'+mgrs+'" class="ed-input" style="flex:1;font-size:9px;font-family:monospace;margin:0;padding:3px 4px;height:22px" data-ptidx="'+i+'" data-gid="'+g.id+'" onfocus="S._hoveredPtIdx='+i+';S._hoveredPtGid=\''+g.id+'\';requestRender()" onblur="S._hoveredPtIdx=null;S._hoveredPtGid=null;requestRender()" onchange="editGraphicPointCoord(this)">';
          if(g.points.length>2){h+='<button class="btn danger" onclick="event.stopPropagation();removeGraphicPoint(\''+g.id+'\','+i+')" style="padding:1px 4px;font-size:9px;min-height:20px;line-height:1">\u2715</button>'}
          h+='</div>'});
      }
    }
    h+='<div class="ed-section-title">TYPE</div>';
    h+='<div style="font-size:11px;opacity:.7;margin-bottom:6px">'+(g.overlayType&&g.overlayType!=="none"?g.overlayType.toUpperCase()+" ("+g.tool+")":g.tool)+' \u2022 '+g.points.length+' pts</div>';
    h+='<div class="ed-section-title">COLOR</div>';
    h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
    h+='<div style="width:28px;height:28px;border-radius:4px;background:'+(g.color||'#ff4444')+';border:2px solid rgba(255,255,255,.3);flex-shrink:0"></div>';
    h+='<button class="btn" onclick="S._showGfxColors=!S._showGfxColors;renderEditor()" style="font-size:10px;padding:3px 8px;min-height:24px">'+(S._showGfxColors?'Hide':'Change')+'</button>';
    h+='</div>';
    if(S._showGfxColors){h+='<div class="ed-btn-row">';
    GRAPHIC_COLORS.forEach(function(c){h+='<div style="width:28px;height:28px;border-radius:4px;background:'+c+';cursor:pointer;border:2px solid '+(g.color===c?'#fff':'transparent')+'" onclick="editGraphicProp(\''+g.id+'\',\'color\',\''+c+'\');S._showGfxColors=false"></div>'});
    h+='</div>';}
    if(g.tool==="polygon"||g.tool==="circle"||g.tool==="rectangle"){
      h+='<div class="ed-section-title">FILL</div>';
      h+='<div class="toggle-row"><label class="switch-sm"><input type="checkbox" id="ed-gfill"'+(g.fill?' checked':'')+'><span class="slider"></span></label><span>Fill Shape</span></div>';
      if(g.fill){
        h+='<label>Fill Color</label><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
        h+='<div style="width:22px;height:22px;border-radius:3px;background:'+((g.fillColor||g.color))+';border:2px solid rgba(255,255,255,.3);flex-shrink:0"></div>';
        h+='<button class="btn" onclick="S._showFillColors=!S._showFillColors;renderEditor()" style="font-size:10px;padding:2px 6px;min-height:22px">'+(S._showFillColors?'Hide':'Change')+'</button></div>';
        if(S._showFillColors){h+='<div class="ed-btn-row" style="margin-bottom:6px">';
        GRAPHIC_COLORS.forEach(function(c){h+='<div style="width:22px;height:22px;border-radius:3px;background:'+c+';cursor:pointer;border:2px solid '+((g.fillColor||g.color)===c?'#fff':'transparent')+'" onclick="editGraphicProp(\''+g.id+'\',\'fillColor\',\''+c+'\');S._showFillColors=false"></div>'});
        h+='</div>';}
        h+='<label>Opacity</label><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-gfillop" min="0.05" max="0.8" step="0.01" value="'+(g.fillOpacity||0.2)+'" style="flex:1"><span id="ed-gfillop-val" style="font-size:11px;min-width:28px;text-align:right">'+Math.round((g.fillOpacity||0.2)*100)+'%</span></div>';
        h+='<label>Hatch Pattern</label><div class="ed-btn-row">';
        [["none","None"],["fwd","/ / /"],["back","\\\\ \\\\ \\\\"],["cross","X X"]].forEach(function(p){h+='<button class="ed-btn'+((g.fillHatch||"none")===p[0]?' active':'')+'" onclick="editGraphicProp(\''+g.id+'\',\'fillHatch\',\''+p[0]+'\')">'+p[1]+'</button>'});
        h+='</div>';
        if(g.fillHatch&&g.fillHatch!=="none"){
          h+='<label>Hatch Color</label><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
          h+='<div style="width:18px;height:18px;border-radius:3px;background:'+((g.hatchColor||g.color))+';border:2px solid rgba(255,255,255,.3);flex-shrink:0"></div>';
          h+='<button class="btn" onclick="S._showHatchColors=!S._showHatchColors;renderEditor()" style="font-size:9px;padding:2px 5px;min-height:20px">'+(S._showHatchColors?'Hide':'Change')+'</button></div>';
          if(S._showHatchColors){h+='<div class="ed-btn-row" style="margin-bottom:6px">';
          GRAPHIC_COLORS.forEach(function(c){h+='<div style="width:18px;height:18px;border-radius:3px;background:'+c+';cursor:pointer;border:2px solid '+((g.hatchColor||g.color)===c?'#fff':'transparent')+'" onclick="editGraphicProp(\''+g.id+'\',\'hatchColor\',\''+c+'\');S._showHatchColors=false"></div>'});
          h+='</div>';}
          h+='<label>Hatch Line Weight</label><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-hatchlw" min="0.5" max="4" step="0.1" value="'+(g.hatchLineWidth||1)+'" style="flex:1"><span id="ed-hatchlw-val" style="font-size:11px;min-width:28px;text-align:right">'+(g.hatchLineWidth||1)+'px</span></div>';
          h+='<label>Hatch Density</label><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-hatchden" min="10" max="80" step="1" value="'+(g.hatchSpacing||30)+'" style="flex:1"><span id="ed-hatchden-val" style="font-size:11px;min-width:38px;text-align:right">'+(g.hatchSpacing||30)+'px</span></div>';
          h+='<label>Hatch Opacity</label><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-hatchop" min="0.05" max="1.0" step="0.01" value="'+(g.hatchOpacity||0.35)+'" style="flex:1"><span id="ed-hatchop-val" style="font-size:11px;min-width:28px;text-align:right">'+Math.round((g.hatchOpacity||0.35)*100)+'%</span></div>';
        }
      }
    }
    h+='<div class="ed-section-title">LINE STYLE</div><div class="ed-btn-row">';
    [["solid","Solid"],["dashed","Dashed"],["dotted","Dotted"]].forEach(function(s){h+='<button class="ed-btn'+(g.lineStyle===s[0]?' active':'')+'" onclick="editGraphicProp(\''+g.id+'\',\'lineStyle\',\''+s[0]+'\')">'+s[1]+'</button>'});
    h+='</div>';
    h+='<div class="ed-section-title">LINE WIDTH</div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-glw" min="1" max="10" step="0.1" value="'+(g.lineWidth||2)+'" style="flex:1"><span id="ed-glw-val" style="font-size:11px;min-width:28px;text-align:right">'+(g.lineWidth||2)+'px</span></div>';
    h+='<div class="toggle-row"><label class="switch-sm"><input type="checkbox" id="ed-gshadow"'+(g.shadow?' checked':'')+'><span class="slider"></span></label><span>Drop Shadow</span></div>';
    h+='<div class="ed-section-title">DRAW ORDER</div>';
    h+='<div style="display:flex;gap:4px;margin-bottom:6px">';
    h+='<button class="btn" id="ed-zback" style="flex:1;font-size:10px;padding:3px 0" title="Draw behind other graphics">⬇ Send Back</button>';
    h+='<button class="btn" id="ed-zfront" style="flex:1;font-size:10px;padding:3px 0" title="Draw in front of other graphics">⬆ Bring Front</button>';
    h+='</div>';
    if(g.tool==="arrow"){
      h+='<div class="ed-section-title">ARROW SIZE</div>';
      h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><input type="range" id="ed-garrow" min="0.5" max="5" step="0.1" value="'+(g.arrowSize||1)+'" style="flex:1"><span id="ed-garrow-val" style="font-size:11px;min-width:28px;text-align:right">'+(g.arrowSize||1)+'x</span></div>';
    }
    /* Measurement data */
    if(g._measureData){
      h+='<div class="ed-section-title">MEASUREMENT DATA</div>';
      h+='<div class="toggle-row"><label class="switch-sm"><input type="checkbox" id="ed-gshowmeasure"'+(g.showMeasure?' checked':'')+'><span class="slider"></span></label><span>Show on Map</span></div>';
      if(g._measureData.type==="distance"){
        h+='<div style="font-size:11px;margin-bottom:4px"><strong>Total:</strong> '+formatDist(g._measureData.totalDist)+'</div>';
        if(g._measureData.segments)g._measureData.segments.forEach(function(s,i){h+='<div style="font-size:10px;opacity:.7">Seg '+(i+1)+': '+formatDist(s)+'</div>'});
      }else if(g._measureData.type==="area"){
        h+='<div style="font-size:11px;margin-bottom:4px"><strong>Area:</strong> '+formatArea(g._measureData.area)+'</div>';
        h+='<div style="font-size:10px;opacity:.7">Perimeter: '+formatDist(g._measureData.totalPerim)+'</div>';
      }
    }
    h+='</div>';
    /* Lock height only if user has drag-resized the editor */
    if(S._editorHeight>180){el.style.minHeight=S._editorHeight+"px";el.style.maxHeight=S._editorHeight+"px"}
    el.innerHTML=h;
    /* Suppress iOS AutoFill bar */
    el.querySelectorAll("input[type='text'],input[type='number']").forEach(function(inp){inp.setAttribute("autocomplete","off");inp.setAttribute("data-form-type","other");inp.setAttribute("autocorrect","off");inp.setAttribute("spellcheck","false")});
    /* Capture height after first render if not yet set */
    if(!S._editorHeight){var newH=el.offsetHeight;if(newH>180)S._editorHeight=newH}
    /* Restore scroll */
    var newBody=el.querySelector(".editor-body");if(newBody)newBody.scrollTop=scrollTop;
    var labelIn=document.getElementById("ed-glabel");
    if(labelIn)labelIn.addEventListener("input",function(){g.label=sanitizeStr(this.value,INPUT_LIMITS.label);debouncedGfxSync();requestRender()});
    var bunitAboveIn=document.getElementById("ed-bunitabove");
    if(bunitAboveIn)bunitAboveIn.addEventListener("input",function(){g.unitAbove=sanitizeStr(this.value,INPUT_LIMITS.designation);debouncedGfxSync();requestRender()});
    var bunitBelowIn=document.getElementById("ed-bunitbelow");
    if(bunitBelowIn)bunitBelowIn.addEventListener("input",function(){g.unitBelow=sanitizeStr(this.value,INPUT_LIMITS.designation);debouncedGfxSync();requestRender()});
    var fillIn=document.getElementById("ed-gfill");
    if(fillIn)fillIn.addEventListener("change",function(){g.fill=this.checked;if(g.fill&&!g.fillColor)g.fillColor=g.color;debouncedGfxSync();requestRender();renderEditor()});
    var fillOpIn=document.getElementById("ed-gfillop");
    if(fillOpIn){trackFill(fillOpIn);fillOpIn.addEventListener("input",function(){g.fillOpacity=parseFloat(this.value);document.getElementById("ed-gfillop-val").textContent=Math.round(g.fillOpacity*100)+"%";trackFill(this);debouncedGfxSync();requestRender()})};
    var hatchLwIn=document.getElementById("ed-hatchlw");
    if(hatchLwIn){trackFill(hatchLwIn);hatchLwIn.addEventListener("input",function(){g.hatchLineWidth=parseFloat(this.value);document.getElementById("ed-hatchlw-val").textContent=Math.round(g.hatchLineWidth*10)/10+"px";trackFill(this);debouncedGfxSync();requestRender()})};
    var hatchDenIn=document.getElementById("ed-hatchden");
    if(hatchDenIn){trackFill(hatchDenIn);hatchDenIn.addEventListener("input",function(){g.hatchSpacing=parseInt(this.value);document.getElementById("ed-hatchden-val").textContent=g.hatchSpacing+"px";trackFill(this);debouncedGfxSync();requestRender()})}
    var hatchOpIn=document.getElementById("ed-hatchop");
    if(hatchOpIn){trackFill(hatchOpIn);hatchOpIn.addEventListener("input",function(){g.hatchOpacity=parseFloat(this.value);document.getElementById("ed-hatchop-val").textContent=Math.round(g.hatchOpacity*100)+"%";trackFill(this);debouncedGfxSync();requestRender()})};
    var showMIn=document.getElementById("ed-gshowmeasure");
    if(showMIn)showMIn.addEventListener("change",function(){g.showMeasure=this.checked;debouncedGfxSync();requestRender()});
    var lwIn=document.getElementById("ed-glw");
    if(lwIn){trackFill(lwIn);lwIn.addEventListener("input",function(){g.lineWidth=parseFloat(this.value);document.getElementById("ed-glw-val").textContent=Math.round(g.lineWidth*10)/10+"px";trackFill(this);debouncedGfxSync();requestRender()})};
    var shadowIn=document.getElementById("ed-gshadow");
    if(shadowIn){shadowIn.addEventListener("change",function(){g.shadow=this.checked;netBroadcast({type:"graphicEdit",graphic:g});requestRender()})};
    var zBackBtn=document.getElementById("ed-zback");
    if(zBackBtn)zBackBtn.addEventListener("click",function(){var idx=S.graphics.findIndex(x=>x.id===g.id);if(idx>0){S.graphics.splice(idx,1);S.graphics.unshift(g);netBroadcast({type:"graphicReorder",order:S.graphics.map(function(x){return x.id})});requestRender();renderFloatingPanel()}});
    var zFrontBtn=document.getElementById("ed-zfront");
    if(zFrontBtn)zFrontBtn.addEventListener("click",function(){var idx=S.graphics.findIndex(x=>x.id===g.id);if(idx<S.graphics.length-1){S.graphics.splice(idx,1);S.graphics.push(g);netBroadcast({type:"graphicReorder",order:S.graphics.map(function(x){return x.id})});requestRender();renderFloatingPanel()}});    var fontSizeIn=document.getElementById("ed-gfontsize");
    if(fontSizeIn){trackFill(fontSizeIn);fontSizeIn.addEventListener("input",function(){g.fontSize=parseInt(this.value);document.getElementById("ed-gfontsize-val").textContent=g.fontSize+"px";trackFill(this);debouncedGfxSync();requestRender()})};
    var labelShadowIn=document.getElementById("ed-glabelshadow");
    if(labelShadowIn)labelShadowIn.addEventListener("change",function(){g.labelShadow=this.checked;debouncedGfxSync();requestRender()});
    var grotIn=document.getElementById("ed-grotation");
    if(grotIn){trackFill(grotIn);grotIn.addEventListener("input",function(){g.rotation=parseInt(this.value);var v=document.getElementById("ed-grotation-val");if(v)v.textContent=g.rotation+"°";trackFill(this);debouncedGfxSync();requestRender()})}
    var labelBoldIn=document.getElementById("ed-glabelbold");
    if(labelBoldIn)labelBoldIn.addEventListener("change",function(){g.labelBold=this.checked;debouncedGfxSync();requestRender()});
    var arrowIn=document.getElementById("ed-garrow");
    if(arrowIn){trackFill(arrowIn);arrowIn.addEventListener("input",function(){g.arrowSize=parseFloat(this.value);document.getElementById("ed-garrow-val").textContent=Math.round(g.arrowSize*10)/10+"x";trackFill(this);debouncedGfxSync();requestRender()})};
    return}
  /* Unit editor */
  const u=S.units.find(x=>x.id===S.selectedUnitId);if(!u){if(S.editorPinned){el.innerHTML='<div class="editor-grip" id="editor-grip"></div><div class="editor-body"><div style="opacity:.4;text-align:center;padding:20px">Select a unit to edit</div></div>';return}closeEditor();return}
  const tab=S.editorTab||"icon";
  let h='<div class="editor-grip" id="editor-grip"></div>';
  // Header: tabs + actions
  h+='<div class="editor-header"><div class="editor-tabs">';
  ["icon","info","equip","rings"].forEach(function(t){h+='<button class="editor-tab'+(tab===t?' active':'')+'" onclick="S.editorTab=\''+t+'\';renderEditor()">'+t+'</button>'});
  h+='</div><div class="editor-actions">';
  h+='<button class="btn'+(S.editorPinned?' primary':'')+'" onclick="S.editorPinned=!S.editorPinned;renderEditor()" title="Pin" style="padding:2px 5px">\ud83d\udccc</button>';
  h+='<button class="btn danger" onclick="deleteUnit(\''+u.id+'\')" style="padding:2px 5px">Del</button>';
  h+='<button class="btn" onclick="closeEditor()" style="padding:2px 5px">\u2715</button>';
  h+='</div></div>';
  h+='<div class="editor-body">';
  if(tab==="icon"){
    // Preview + designation side by side
    h+='<div style="display:flex!important;flex-direction:row!important;align-items:flex-start;gap:10px;margin-bottom:8px">';
    h+='<canvas id="preview-cv" width="120" height="120" style="display:block;width:60px;height:60px;min-width:60px;border:1px solid var(--border);border-radius:4px"></canvas>';
    h+='<div style="flex:1;min-width:0;overflow:hidden">';
    h+='<input type="text" id="ed-desig" value="'+escAttr(u.designation||'')+'" placeholder="Designation, e.g. 1-67 AR" class="ed-input" maxlength="50">';
    h+='<input type="text" id="ed-parent" value="'+escAttr(u.parentUnit||'')+'" placeholder="Higher HQ, e.g. 2 ABCT" class="ed-input" maxlength="50">';
    h+='</div></div>';
    // Affiliation
    h+='<div class="ed-section-title">AFFILIATION</div><div class="ed-btn-row" style="flex-wrap:wrap;overflow:hidden">';
    for(var k in AFFILIATIONS){var v=AFFILIATIONS[k];var abg=u.affiliation===k?v.fill:'transparent';var afg=u.affiliation===k?'#000':v.fill;h+='<button class="ed-btn'+(u.affiliation===k?' active':'')+'" onclick="editUnit(\''+u.id+'\',{affiliation:\''+k+'\'})" style="background:'+abg+';color:'+afg+';border:1.5px solid '+v.fill+';flex:1 1 22%;min-width:0;overflow:hidden;text-overflow:ellipsis">'+v.label+'</button>'}
    h+='</div>';
    /* Waypoint display mode toggle */
    if(u.type==="waypoint"){
    h+='<div class="ed-section-title">DISPLAY MODE</div><div class="ed-btn-row">';
    h+='<button class="ed-btn'+(u.displayMode==="pin"?' active':'')+'" onclick="editUnit(\''+u.id+'\',{displayMode:\'pin\'})">📍 Pin</button>';
    h+='<button class="ed-btn'+(!u.displayMode||u.displayMode==="icon"?' active':'')+'" onclick="editUnit(\''+u.id+'\',{displayMode:\'icon\'})">⬜ Unit Icon</button>';
    h+='</div>';
    if(u.displayMode==="pin"){
    h+='<div class="ed-section-title">PIN COLOR</div><div class="ed-btn-row">';
    var pinColors=["#ff4444","#4a9eff","#44cc44","#ffd700","#ff8800","#ff00ff","#00ffff","#ffffff"];
    pinColors.forEach(function(c){h+='<div style="width:28px;height:28px;border-radius:4px;background:'+c+';cursor:pointer;border:2px solid '+((u.pinColor||"#ff4444")===c?'#fff':'transparent')+'" onclick="editUnit(\''+u.id+'\',{pinColor:\''+c+'\'})"></div>'});
    h+='</div>'}
    }
    // Echelon
    h+='<div class="ed-section-title">ECHELON</div><div class="ed-btn-row">';
    ECHELONS.forEach(function(e){h+='<button class="ed-btn'+(u.echelon===e.id?' active':'')+'" onclick="editUnit(\''+u.id+'\',{echelon:'+(u.echelon===e.id?'null':'\''+e.id+'\'')+'})">'+ e.label+'</button>'});
    h+='</div>';
    // Unit Type - icon grid by category
    h+='<div class="ed-section-title">UNIT TYPE</div>';
    UNIT_CATEGORIES.forEach(function(cat){
      h+='<div class="cat-header open" onclick="this.classList.toggle(\'open\');this.nextElementSibling.style.display=this.classList.contains(\'open\')?\'\':\' none\'">'+cat.name+'</div><div class="icon-grid">';
      cat.types.forEach(function(t){h+='<div class="icon-cell'+(u.type===t.id?' selected':'')+'" onclick="editUnit(\''+u.id+'\',{type:\''+t.id+'\'})" title="'+t.label+'"><canvas width="100" height="100" data-type="'+t.id+'" data-aff="'+u.affiliation+'"></canvas><div class="tooltip">'+t.label+'</div></div>'});
      h+='</div>'});
    // Modifiers
    h+='<div class="ed-section-title">MODIFIERS</div><div class="ed-btn-row">';
    MODIFIERS.forEach(function(m){h+='<button class="ed-btn'+((u.modifiers||[]).includes(m.id)?' active':'')+'" onclick="toggleMod(\''+u.id+'\',\''+m.id+'\')">'+m.label+'</button>'});
    h+='<button class="ed-btn'+(u.isHQ?' active':'')+'" onclick="editUnit(\''+u.id+'\',{isHQ:'+(!u.isHQ)+'})">HQ</button>';
    h+='</div>';
    var rot=Math.round(u.rotation||0);
    h+='<div class="ed-section-title">ROTATION</div>';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{rotation:((('+(rot-5)+'%360)+360)%360})" style="padding:2px 7px">&minus;5</button>';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{rotation:((('+(rot-1)+'%360)+360)%360})" style="padding:2px 7px">&minus;1</button>';
    h+='<input type="number" id="ed-rotation" value="'+rot+'" min="0" max="359" step="1" class="ed-input" style="width:56px;text-align:center;flex:none">';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{rotation:(('+(rot+1)+')%360)})" style="padding:2px 7px">+1</button>';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{rotation:(('+(rot+5)+')%360)})" style="padding:2px 7px">+5</button>';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{rotation:0})" style="padding:2px 7px">Reset</button>';
    h+='</div>';
    // Per-unit icon scale
    var usc=u.iconScale||1;
    h+='<div class="ed-section-title">ICON SIZE</div>';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">';
    h+='<input type="range" id="ed-iconscale" min="0.5" max="3" step="0.1" value="'+usc+'" style="flex:1">';
    h+='<span id="ed-iconscale-val" style="font-size:10px;min-width:32px;text-align:center">'+Math.round(usc*100)+'%</span>';
    h+='<button class="ed-btn" onclick="editUnit(\''+u.id+'\',{iconScale:1})" style="padding:2px 7px;font-size:9px">Reset</button>';
    h+='</div>';
  } else if(tab==="info"){
    h+='<div class="ed-section-title">COORDINATES</div>';
    /* Show coords toggle for pin waypoints */
    if(u.type==="waypoint"&&u.displayMode==="pin"){
      h+='<div class="toggle-row" style="margin-bottom:6px"><label class="switch-sm"><input type="checkbox" id="ed-showcoords"'+(u.showCoords!==false?' checked':'')+'><span class="slider"></span></label><span style="font-size:10px">Show on map</span></div>';
    }
    /* Editable MGRS */
    h+='<div style="display:flex;gap:4px;align-items:center;margin-bottom:4px;font-size:11px">';
    h+='<input type="text" id="ed-mgrs" value="'+toMGRS(u.lat,u.lon)+'" class="ed-input" style="flex:1;font-family:var(--font);font-size:11px" placeholder="MGRS">';
    h+='<button class="btn" onclick="navigator.clipboard.writeText(document.getElementById(\'ed-mgrs\').value).then(()=>notify(\'MGRS copied\'))" style="padding:1px 6px;font-size:9px">Copy</button></div>';
    /* Editable Lat/Lon */
    h+='<div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;font-size:11px">';
    h+='<input type="text" id="ed-latlon" value="'+u.lat.toFixed(6)+', '+u.lon.toFixed(6)+'" class="ed-input" style="flex:1;font-family:var(--font);font-size:11px" placeholder="Lat, Lon">';
    h+='<button class="btn" onclick="navigator.clipboard.writeText(document.getElementById(\'ed-latlon\').value).then(()=>notify(\'Lat/Lon copied\'))" style="padding:1px 6px;font-size:9px">Copy</button></div>';
    h+='<div class="ed-section-title">DESIGNATION / HIGHER HQ</div>';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Designation</label>';
    h+='<input type="text" id="ed-desig" value="'+escAttr(u.designation||'')+'" placeholder="e.g., 1 or 1-67" class="ed-input" maxlength="50">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Parent Unit</label>';
    h+='<input type="text" id="ed-parent" value="'+escAttr(u.parentUnit||'')+'" placeholder="e.g., 3 CO" class="ed-input" maxlength="50">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Higher HQ</label>';
    h+='<input type="text" id="ed-higher" value="'+(u.higherUnit||'')+'" placeholder="e.g., 3 MECH BN" class="ed-input">';
    h+='<div class="ed-section-title" style="margin-top:8px">HQ</div>';
    h+='<div class="toggle-row"><label class="switch-sm"><input type="checkbox" id="ed-hq"'+(u.isHQ?' checked':'')+'><span class="slider"></span></label><span>Headquarters</span></div>';
    if(u.customIcon){
      h+='<div class="ed-section-title" style="margin-top:8px">CUSTOM ICON</div>';
      h+='<div class="toggle-row"><label class="switch-sm"><input type="checkbox" id="ed-use-custom-icon"'+(u.useCustomIcon!==false?' checked':'')+'><span class="slider"></span></label><span>Use KMZ icon</span></div>';
      h+='<div style="text-align:center;margin:4px 0"><img src="'+u.customIcon+'" style="max-width:48px;max-height:48px;border:1px solid var(--border);border-radius:4px;background:#fff"></div>';
    }
    if(u.importNotes){
      h+='<div class="ed-section-title" style="margin-top:8px">IMPORT SOURCE</div>';
      h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">';
      h+='<span style="font-size:10px;opacity:.6;flex:1">Hover shows '+(u._useStructuredLabel?'structured':'original')+' text</span>';
      h+='<label class="switch-sm"><input type="checkbox" id="ed-struct-label"'+(u._useStructuredLabel?' checked':'')+'><span class="slider"></span></label>';
      h+='</div>';
      h+='<div style="font-size:10px;opacity:.6;white-space:pre-wrap;word-break:break-word;background:var(--btn-bg);border-radius:4px;padding:6px 8px;margin-bottom:6px;max-height:80px;overflow-y:auto">'+u.importNotes.replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</div>';
    }
  } else if(tab==="equip"){
    var eq=u.equipment||{};
    h+='<div class="ed-section-title">EQUIPMENT</div>';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Vehicle</label><input type="text" id="ed-vehicle" value="'+(eq.vehicle||'')+'" class="ed-input">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Weapon</label><input type="text" id="ed-weapon" value="'+(eq.weapon||'')+'" class="ed-input">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Crew</label><input type="number" id="ed-crew" value="'+(eq.crew||'')+'" class="ed-input">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Speed (km/h)</label><input type="number" id="ed-speed" value="'+(eq.speed||'')+'" class="ed-input">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Max Range (m)</label><input type="number" id="ed-maxrange" value="'+(eq.maxRange||'')+'" class="ed-input">';
    h+='<label style="font-size:10px;opacity:.6;display:block;margin-bottom:2px">Sensor Range (m)</label><input type="number" id="ed-sensorrange" value="'+(eq.sensorRange||'')+'" class="ed-input">';
  } else if(tab==="rings"){
    h+='<div class="ed-section-title">RANGE RINGS</div>';
    h+='<button class="btn primary" onclick="addRing(\''+u.id+'\')" style="margin-bottom:8px">+ Add Range Ring</button>';
    if(u.rings)u.rings.forEach(function(r,i){
      var ringColors=[RING_COLORS.friendly,RING_COLORS.hostile,RING_COLORS.neutral,RING_COLORS.unknown,"#ff0000","#00ff00","#ffd700","#ff8800","#ff00ff","#00ffff","#ffffff"];
      var rStyle=r.lineStyle||"solid";
      h+='<div style="margin-bottom:10px;padding:6px 8px;background:rgba(255,255,255,.04);border-radius:6px;border:1px solid var(--border)">';
      /* Row 0: label + radius + delete */
      h+='<div style="display:flex;gap:4px;align-items:center;margin-bottom:6px"><input type="text" value="'+escAttr(r.label||'')+'" oninput="editRing(\''+u.id+'\','+i+',\'label\',this.value)" style="width:80px;margin-bottom:0" placeholder="Label" class="ed-input" maxlength="30"><input type="number" value="'+r.radius+'" onchange="editRing(\''+u.id+'\','+i+',\'radius\',this.value)" style="flex:1;margin-bottom:0" placeholder="Radius (m)" class="ed-input"><button class="btn danger" onclick="removeRing(\''+u.id+'\','+i+')" style="padding:4px 8px">\u2715</button></div>';
      /* Row 2: line style buttons */
      h+='<div style="display:flex;gap:3px;margin-bottom:6px">';
      [["solid","Solid"],["dash","Dash"],["dotted","Dotted"]].forEach(function(ls){
        h+='<button class="ed-btn'+(rStyle===ls[0]?' active':'')+'" onclick="editRing(\''+u.id+'\','+i+',\'lineStyle\',\''+ls[0]+'\')" style="flex:1;padding:3px 4px;font-size:10px">'+ls[1]+'</button>';
      });
      h+='</div>';
      /* Row 3: opacity slider */
      var opVal=r.opacity!=null?r.opacity:0.3;
      h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:10px;opacity:.6;min-width:44px">Opacity</span><input type="range" id="ring-op-'+i+'" min="0.05" max="1.0" step="0.05" value="'+opVal+'" oninput="editRing(\''+u.id+'\','+i+',\'opacity\',this.value);document.getElementById(\'ring-op-val-'+i+'\').textContent=Math.round(this.value*100)+\'%\';var p=((this.value-this.min)/(this.max-this.min))*100;this.style.setProperty(\'--val\',p+\'%\')" style="flex:1"><span id="ring-op-val-'+i+'" style="font-size:10px;min-width:28px;text-align:right">'+Math.round(opVal*100)+'%</span></div>';
      /* Row 3b: fill toggle */
      var hasFill=r.fill||false;
      h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><span style="font-size:10px;opacity:.6">Fill Ring</span><label class="switch-sm"><input type="checkbox" '+(hasFill?'checked':'')+' onchange="editRing(\''+u.id+'\','+i+',\'fill\',this.checked)"><span class="slider"></span></label></div>';
      /* Row 3c: fill opacity slider (only when fill is on) */
      if(hasFill){var fopVal=r.fillOpacity!=null?r.fillOpacity:0.35;
      h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:10px;opacity:.6;min-width:44px">Fill Op</span><input type="range" id="ring-fop-'+i+'" min="0.05" max="1.0" step="0.01" value="'+fopVal+'" oninput="editRing(\''+u.id+'\','+i+',\'fillOpacity\',this.value);document.getElementById(\'ring-fop-val-'+i+'\').textContent=Math.round(this.value*100)+\'%\';var p=((this.value-this.min)/(this.max-this.min))*100;this.style.setProperty(\'--val\',p+\'%\')" style="flex:1"><span id="ring-fop-val-'+i+'" style="font-size:10px;min-width:28px;text-align:right">'+Math.round(fopVal*100)+'%</span></div>';}
      /* Row 4: color swatch button + hidden swatches */
      h+='<div style="display:flex;align-items:center;gap:6px"><span style="font-size:10px;opacity:.6">Color</span><div style="width:22px;height:22px;border-radius:3px;background:'+(r.color||"#ff0000")+';border:1px solid rgba(255,255,255,.3);cursor:pointer" onclick="var sw=document.getElementById(\'ring-sw-'+i+'\');sw.style.display=sw.style.display===\'none\'?\'flex\':\'none\'"></div></div>';
      h+='<div id="ring-sw-'+i+'" style="display:none;gap:3px;flex-wrap:wrap;margin-top:4px">';
      ringColors.forEach(function(c){
        var sel=(r.color||AFFILIATIONS[u.affiliation||"friendly"].fill)===c;
        h+='<div style="width:22px;height:22px;border-radius:3px;background:'+c+';cursor:pointer;border:2px solid '+(sel?'#fff':'transparent')+'" onclick="editRing(\''+u.id+'\','+i+',\'color\',\''+c+'\')"></div>';
      });
      h+='</div>';
      h+='</div>';
    });
    var eq2=u.equipment||{};
    var hasSuggestions=(eq2.maxRange&&!(u.rings||[]).some(function(r){return r.radius==eq2.maxRange}))||(eq2.sensorRange&&!(u.rings||[]).some(function(r){return r.radius==eq2.sensorRange}));
    if(hasSuggestions){
      h+='<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">';
      h+='<div style="font-size:10px;opacity:.5;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Quick Add from Equipment</div>';
      if(eq2.maxRange&&!(u.rings||[]).some(function(r){return r.radius==eq2.maxRange})){
        var wpnLabel=eq2.weapon||'Weapon';
        h+='<button class="btn" onclick="addAutoRing(\''+u.id+'\',\'maxRange\','+eq2.maxRange+')" style="margin-bottom:4px;width:100%;text-align:left">+ Max Range \u2014 '+wpnLabel+' ('+eq2.maxRange.toLocaleString()+'m)</button>';
      }
      if(eq2.sensorRange&&!(u.rings||[]).some(function(r){return r.radius==eq2.sensorRange})){
        var snsLabel=eq2.vehicle||'Sensor';
        h+='<button class="btn" onclick="addAutoRing(\''+u.id+'\',\'sensor\','+eq2.sensorRange+')" style="margin-bottom:4px;width:100%;text-align:left">+ Sensor Range \u2014 '+snsLabel+' ('+eq2.sensorRange.toLocaleString()+'m)</button>';
      }
      h+='</div>';
    }
  }
  h+='</div>';
  /* Lock height only if user has drag-resized the editor */
  if(S._editorHeight>180){el.style.minHeight=S._editorHeight+"px";el.style.maxHeight=S._editorHeight+"px"}
  el.innerHTML=h;bindEditorEvents(u);
  /* Capture height after first render if not yet set */
  if(!S._editorHeight){var newH2=el.offsetHeight;if(newH2>180)S._editorHeight=newH2}
  /* Restore scroll position */
  var newBody2=el.querySelector(".editor-body");if(newBody2)newBody2.scrollTop=scrollTop;}


function bindEditorEvents(u){
  const el=id=>document.getElementById(id);
  /* Coordinate editing */
  if(el("ed-mgrs"))el("ed-mgrs").onchange=e=>{
    const ll=parseMGRS(e.target.value);
    if(ll){editUnit(u.id,{lat:ll.lat,lon:ll.lon});notify("Position updated")}
    else{notify("Invalid MGRS","error");e.target.value=toMGRS(u.lat,u.lon)}};
  if(el("ed-latlon"))el("ed-latlon").onchange=e=>{
    const parts=e.target.value.split(/[,\s]+/).map(Number);
    if(parts.length>=2&&!isNaN(parts[0])&&!isNaN(parts[1])&&Math.abs(parts[0])<=90&&Math.abs(parts[1])<=180){
      editUnit(u.id,{lat:parts[0],lon:parts[1]});notify("Position updated")}
    else{notify("Invalid coordinates","error");e.target.value=u.lat.toFixed(6)+", "+u.lon.toFixed(6)}};
  if(el("ed-showcoords"))el("ed-showcoords").onchange=e=>editUnit(u.id,{showCoords:e.target.checked});
  if(el("ed-desig"))el("ed-desig").onchange=e=>editUnit(u.id,{designation:sanitizeStr(e.target.value,INPUT_LIMITS.designation)});
  if(el("ed-parent"))el("ed-parent").onchange=e=>editUnit(u.id,{parentUnit:sanitizeStr(e.target.value,INPUT_LIMITS.parentUnit)});
  if(el("ed-higher"))el("ed-higher").onchange=e=>editUnit(u.id,{higherUnit:sanitizeStr(e.target.value,INPUT_LIMITS.parentUnit)});
  if(el("ed-hq"))el("ed-hq").onchange=e=>editUnit(u.id,{isHQ:e.target.checked});
  if(el("ed-use-custom-icon"))el("ed-use-custom-icon").onchange=e=>{editUnit(u.id,{useCustomIcon:e.target.checked})};
  if(el("ed-struct-label"))el("ed-struct-label").onchange=e=>editUnit(u.id,{_useStructuredLabel:e.target.checked});
  if(el("ed-rotation"))el("ed-rotation").onchange=e=>{var v=parseInt(e.target.value)||0;editUnit(u.id,{rotation:((v%360)+360)%360});};
  if(el("ed-iconscale"))el("ed-iconscale").oninput=e=>{var v=parseFloat(e.target.value)||1;el("ed-iconscale-val").textContent=Math.round(v*100)+"%";editUnit(u.id,{iconScale:v})};
  ["vehicle","crew","weapon","maxrange","sensorrange","speed"].forEach(function(f){
    var inp=el("ed-"+f);if(inp)inp.onchange=function(e){var eq=Object.assign({},u.equipment||{});eq[f==="maxrange"?"maxRange":f==="sensorrange"?"sensorRange":f]=inp.type==="number"?parseFloat(e.target.value):e.target.value;editUnit(u.id,{equipment:eq})}});
  /* Ring opacity sliders use inline oninput, just need trackFill init */
  if(u.rings)u.rings.forEach(function(r,i){
    var rop=document.getElementById("ring-op-"+i);
    if(rop){trackFill(rop)}
  });
  /* Init trackFill on ALL range inputs in editor to set --val */
  document.querySelectorAll("#editor input[type='range']").forEach(function(inp){trackFill(inp)});
  /* Suppress iOS AutoFill bar on all editor text inputs */
  document.querySelectorAll("#editor input[type='text'],#editor input[type='number']").forEach(function(inp){
    inp.setAttribute("autocomplete","off");inp.setAttribute("autocorrect","off");
    inp.setAttribute("autocapitalize","off");inp.setAttribute("spellcheck","false");
    inp.setAttribute("data-form-type","other");
  });
  requestAnimationFrame(function(){
    // Icon grid previews
    document.querySelectorAll(".icon-cell canvas[data-type]").forEach(function(cv){
      var c=cv.getContext("2d"),t=cv.dataset.type,a=cv.dataset.aff;
      drawUnitIcon(c,{type:t,affiliation:a||"friendly"},50,50,88)});
    // Main preview is updated by capturePreviewBg() in render loop
    requestRender()})}

function editUnit(id,changes){
  const u=S.units.find(x=>x.id===id);if(!u)return;
  S.undoStack.push({type:"edit",unitId:id,prev:{...u}});if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();
  Object.assign(u,changes);netBroadcast({type:"unitEdit",unit:stripHeavyProps(u)});updateUndoBtn();renderEditor();requestRender()}
function deleteUnit(id){
  const u=S.units.find(x=>x.id===id);if(!u)return;
  S.undoStack.push({type:"delete",unit:{...u}});if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();
  S.units=S.units.filter(x=>x.id!==id);S.selectedUnitId=null;closeEditor();netBroadcast({type:"unitDelete",unitId:id});updateUndoBtn();requestRender()}
function toggleMod(id,mod){
  const u=S.units.find(x=>x.id===id);if(!u)return;u.modifiers=u.modifiers||[];
  if(u.modifiers.includes(mod))u.modifiers=u.modifiers.filter(m=>m!==mod);else u.modifiers.push(mod);
  editUnit(id,{modifiers:u.modifiers})}
const RING_COLORS={friendly:"#4a9eff",hostile:"#ff4444",neutral:"#44bb44",unknown:"#ddaa00"};
function addRing(id){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings=u.rings||[];var ac=RING_COLORS[u.affiliation||"friendly"]||"#4a9eff";u.rings.push({radius:1000,color:ac,opacity:0.75,fillOpacity:0.35,lineStyle:"solid",label:""});editUnit(id,{rings:u.rings})}
function addAutoRing(id,type,radius){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings=u.rings||[];var ac=RING_COLORS[u.affiliation||"friendly"]||"#4a9eff";u.rings.push({radius:radius,color:ac,opacity:0.75,fillOpacity:0.35,lineStyle:"solid",label:""});editUnit(id,{rings:u.rings})}
function editRing(id,idx,field,val){const u=S.units.find(x=>x.id===id);if(!u||!u.rings||!u.rings[idx])return;
  if(field==="radius"||field==="opacity"||field==="fillOpacity")u.rings[idx][field]=parseFloat(val);
  else if(field==="fill")u.rings[idx][field]=!!val;
  else u.rings[idx][field]=val;
  netBroadcast({type:"unitEdit",unit:u});requestRender();
  if(field!=="opacity"&&field!=="fillOpacity"&&field!=="label")renderEditor()}
function removeRing(id,idx){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings.splice(idx,1);editUnit(id,{rings:u.rings})}
function deleteGraphic(id){const g=S.graphics.find(x=>x.id===id);if(!g)return;if(g._mcooEnabled){notify("Cannot delete — MCOO locked","error");return}if(g)S.undoStack.push({type:"deleteGraphic",graphic:{...g,points:g.points?g.points.map(p=>({...p})):[]}}); if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();S.graphics=S.graphics.filter(x=>x.id!==id);if(S.selectedGraphicId===id){S.selectedGraphicId=null;if(!S.editorPinned)closeEditor()}netBroadcast({type:"graphicDelete",graphicId:id});updateUndoBtn();requestRender();if(S._activePanel==="addunit")renderFloatingPanel()}
var _unitSyncTimer=null;
function debouncedUnitSync(u){
  clearTimeout(_unitSyncTimer);
  var _uid=u.id;
  _unitSyncTimer=setTimeout(function(){
    var unit=S.units.find(function(x){return x.id===_uid});
    if(unit)netBroadcast({type:"unitEdit",unit:stripHeavyProps(unit)});
  },80);
}
function stripHeavyProps(u){
  /* Strip large data (customIcon) from incremental edits to avoid WebRTC message size limits */
  if(!u.customIcon)return u;
  var lite={};for(var k in u)if(k!=="customIcon")lite[k]=u[k];
  return lite;
}
var _gfxSyncTimer=null,_gfxSyncId=null;
function syncSelectedGraphic(){
  if(!S.selectedGraphicId)return;
  var g=S.graphics.find(function(x){return x.id===S.selectedGraphicId});
  if(!g)return;
  netBroadcast({type:"graphicEdit",graphic:g});
}
function debouncedGfxSync(gid){
  /* Debounce: batch rapid changes (sliders, typing) into one broadcast */
  _gfxSyncId=gid||S.selectedGraphicId;
  clearTimeout(_gfxSyncTimer);
  _gfxSyncTimer=setTimeout(function(){
    var g=S.graphics.find(function(x){return x.id===_gfxSyncId});
    if(g)netBroadcast({type:"graphicEdit",graphic:g});
    _gfxSyncId=null;
  },150);
}
function editGraphicProp(id,prop,val){const g=S.graphics.find(x=>x.id===id);if(!g)return;g[prop]=val;if(prop==="color")g.fillColor=val;netBroadcast({type:"graphicEdit",graphic:g});requestRender();renderEditor()}
function editGraphicPointCoord(inp){var gid=inp.dataset.gid,idx=parseInt(inp.dataset.ptidx);var g=S.graphics.find(x=>x.id===gid);if(!g||!g.points[idx])return;var ll=parseCoordInput(inp.value);if(ll){g.points[idx].lat=ll.lat;g.points[idx].lon=ll.lon;requestRender();renderEditor()}else{IO.notify("Invalid coordinate","error");inp.value=toMGRS(g.points[idx].lat,g.points[idx].lon)}}
function addGraphicPoint(id){var g=S.graphics.find(x=>x.id===id);if(!g||!g.points||g.points.length<2)return;/* Add point at midpoint of last segment */var last=g.points[g.points.length-1],prev=g.points[g.points.length-2];var newPt={lat:(last.lat+prev.lat)/2+0.001,lon:(last.lon+prev.lon)/2+0.001};g.points.push(newPt);requestRender();renderEditor()}
function removeGraphicPoint(id,idx){var g=S.graphics.find(x=>x.id===id);if(!g||!g.points||g.points.length<=2)return;g.points.splice(idx,1);requestRender();renderEditor()}

// Drawing
function getMinPoints(tool){return{line:2,arrow:2,polygon:3,circle:2,rectangle:2,text:1}[tool]||2}
function startDrawing(tool){deselectAll();S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"));document.getElementById("sb-addunit").classList.add("active");S._drawMode={tool,points:[],color:GRAPHIC_COLORS[1],lineWidth:2,lineStyle:"solid",overlayType:"none",fill:false,label:"",arrowSize:1};showModeBar();requestRender()}
function startOverlayDraw(type){deselectAll();S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"));document.getElementById("sb-addunit").classList.add("active");const toolMap={pl:"line",ld:"line",boundary:"line",aa:"rectangle",axis:"line",route:"line"};S._drawMode={tool:toolMap[type]||"line",points:[],color:GRAPHIC_COLORS[0],lineWidth:2,lineStyle:"solid",overlayType:type,fill:type==="aa",label:"",arrowSize:1,echelon:type==="boundary"?"brigade":null,unitAbove:"",unitBelow:""};showModeBar();requestRender()}
function finishDrawing(){
  if(!S._drawMode)return;const dm=S._drawMode;
  if(dm.points.length<getMinPoints(dm.tool)){notify("Not enough points","error");return}
  const g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:dm.tool,points:[...dm.points],color:dm.color,lineWidth:dm.lineWidth,lineStyle:dm.lineStyle,overlayType:dm.overlayType,fill:dm.fill,fillColor:dm.color,label:dm.label||"",layerId:S.activeLayerId,arrowSize:dm.arrowSize||1,rotation:dm.rotation||0};
  S.graphics.push(g);S._drawMode=null;hideModeBar();document.getElementById("sb-addunit").classList.remove("active");selectGraphic(g.id);netBroadcast({type:"graphicAdd",graphic:g});requestRender();if(S._activePanel==="addunit")renderFloatingPanel();
  setTimeout(()=>fitToGraphic(g),200)}
function fitToGraphic(g){
  if(!g.points||g.points.length<1)return;
  let minLat=90,maxLat=-90,minLon=180,maxLon=-180;
  g.points.forEach(p=>{minLat=Math.min(minLat,p.lat);maxLat=Math.max(maxLat,p.lat);minLon=Math.min(minLon,p.lon);maxLon=Math.max(maxLon,p.lon)});
  const cLat=(minLat+maxLat)/2,cLon=(minLon+maxLon)/2;
  /* Don't auto-pan if graphic is far off the current view — avoids accidental teleport */
  const curSp=latlonToScreen(cLat,cLon);
  const W=canvas.offsetWidth,H=canvas.offsetHeight;
  const margin=Math.max(W,H)*2;/* allow up to 2 screen-widths away */
  if(curSp.x<-margin||curSp.x>W+margin||curSp.y<-margin||curSp.y>H+margin)return;
  const padLat=(maxLat-minLat)*.2||.002,padLon=(maxLon-minLon)*.2||.002;
  minLat-=padLat;maxLat+=padLat;minLon-=padLon;maxLon+=padLon;
  /* Account for editor: on mobile bottom sheet it reduces visible height */
  const ed=document.getElementById("editor");
  const isMobile=window.innerWidth<=700;
  const edH=isMobile&&ed&&ed.classList.contains("open")?(ed.offsetHeight||Math.min(window.innerHeight*.35,300)):0;
  const screenH=window.innerHeight;
  const screenW=window.innerWidth;
  const visH=screenH-edH;
  const visW=screenW;
  /* Find best zoom: start from current zoom, only zoom out if needed */
  let targetZoom=Math.min(18,S.zoom);
  for(let z=targetZoom;z>=2;z--){
    /* At zoom z with center at cLat/cLon, where would the bounds appear on screen? */
    const cPx=latlonToPixel(cLat,cLon,z);
    const tlPx=latlonToPixel(maxLat,minLon,z);
    const brPx=latlonToPixel(minLat,maxLon,z);
    /* Pixel distances from center */
    const halfW=Math.max(Math.abs(tlPx.x-cPx.x),Math.abs(brPx.x-cPx.x));
    const topDist=Math.abs(cPx.y-tlPx.y); /* pixels from center to top of bounds */
    const botDist=Math.abs(brPx.y-cPx.y); /* pixels from center to bottom of bounds */
    /* Available space: center of visible area is at visH/2 from top */
    const availUp=visH/2*.9;
    const availDown=visH/2*.9;
    const availW=visW/2*.9;
    if(halfW<=availW&&topDist<=availUp&&botDist<=availDown){targetZoom=z;break}
    targetZoom=z;
  }
  /* Offset center for editor (mobile bottom sheet only) */
  let offsetLat=0;
  if(edH>0){
    const c1=pixelToLatlon(0,0,targetZoom),c2=pixelToLatlon(0,1,targetZoom);
    const degPerPx=c1.lat-c2.lat;
    offsetLat=(edH/2)*degPerPx;
  }
  const sLat=S.lat,sLon=S.lon,sZoom=S.zoom;
  const tLat=cLat-offsetLat,tLon=cLon,tZoom=targetZoom;
  const dur=800,sT=performance.now();
  function step(t){const p=Math.min(1,(t-sT)/dur),e=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;
    S.lat=sLat+(tLat-sLat)*e;S.lon=sLon+(tLon-sLon)*e;S.zoom=sZoom+(tZoom-sZoom)*e;
    requestRender();if(p<1)requestAnimationFrame(step)}
  requestAnimationFrame(step)}
function cancelDrawing(){S._drawMode=null;hideModeBar();document.getElementById("sb-addunit").classList.remove("active");requestRender()}
function undoDrawPoint(){if(!S._drawMode||!S._drawMode.points.length)return;S._drawMode.points.pop();updateModeBar();requestRender()}

// Mode bar
function showModeBar(){document.getElementById("mode-bar").classList.add("open");document.getElementById("mode-bar").style.display="flex";updateModeBar()}
function hideModeBar(){const mb=document.getElementById("mode-bar");mb.classList.remove("open");mb.style.display="none"}
function showPlacementBar(){document.getElementById("mode-bar").style.display="flex";document.getElementById("mode-bar").classList.add("open");document.getElementById("mode-bar").innerHTML='<span class="mode-info">TAP MAP TO PLACE UNIT</span><button class="btn danger" onclick="S._placementMode=null;hideModeBar()">\u2715 Cancel</button>'}
function updateModeBar(){
  /* Map tools mode bar */
  if(S._mapTool){const labels={pin:"📍 DROP PIN — click map to place",distance:"📏 MEASURE — click points",area:"📐 AREA — click vertices"};
  const n=S._mapTool==="distance"?S._measurePoints.length:S._mapTool==="area"?S._measureArea.length:S._mapPins.length;
  let info=labels[S._mapTool]||"";
  if(S._mapTool==="distance"&&S._measurePoints.length>=2){let t=0;for(let i=1;i<S._measurePoints.length;i++)t+=haversine(S._measurePoints[i-1].lat,S._measurePoints[i-1].lon,S._measurePoints[i].lat,S._measurePoints[i].lon);info+=" • "+formatDist(t)}
  if(S._mapTool==="area"&&S._measureArea.length>=3){info+=" • "+formatArea(polyArea(S._measureArea))}
  document.getElementById("mode-bar").innerHTML=`<span class="mode-info">${info} (${n}pts)</span>${S._mapTool!=="pin"?`<button class="btn" onclick="mapToolUndo()">↩</button><button class="btn done${n>=2?' ready':''}" onclick="S._mapTool=null;hideModeBar();canvas.style.cursor='';requestRender();renderFloatingPanel()">✓</button>`:''}<button class="btn danger" onclick="S._mapTool=null;hideModeBar();canvas.style.cursor='';requestRender();renderFloatingPanel()">✕</button>`;return}
  if(!S._drawMode)return;const dm=S._drawMode,n=dm.points.length,min=getMinPoints(dm.tool);
  let dist="";if(n>=2){let total=0;for(let i=1;i<n;i++){const a=dm.points[i-1],b=dm.points[i];total+=Math.sqrt((a.lat-b.lat)**2+(a.lon-b.lon)**2)*111139}dist=total>1000?`${(total/1000).toFixed(2)}km`:`${Math.round(total)}m`}
  document.getElementById("mode-bar").innerHTML=`<span class="mode-info">${dm.overlayType!=="none"?dm.overlayType.toUpperCase():dm.tool.toUpperCase()} ${n}pts ${dist}</span><button class="btn" onclick="undoDrawPoint()"${n===0?" disabled":""}">\u21a9</button><button class="btn done${n>=min?" ready":""}" onclick="finishDrawing()"${n<min?" disabled":""}>\u2713</button><button class="btn danger" onclick="cancelDrawing()">\u2715</button>`}

function mapToolUndo(){if(S._mapTool==="distance"&&S._measurePoints.length)S._measurePoints.pop();if(S._mapTool==="area"&&S._measureArea.length)S._measureArea.pop();requestRender();updateModeBar()}

// Layers
function addLayer(){const id="l"+Date.now();S.layers.push({id,name:"Layer "+(S.layers.length+1),visible:true,hasErrors:false});S.activeLayerId=id;renderFloatingPanel();updateLayerIndicator()}
function setActiveLayer(id){S.activeLayerId=id;renderFloatingPanel();updateLayerIndicator();requestRender()}
function toggleLayerVis(id){const l=S.layers.find(x=>x.id===id);if(l)l.visible=!l.visible;renderFloatingPanel();requestRender()}
function removeLayer(id){if(S.layers.length<=1)return;const l=S.layers.find(x=>x.id===id);const unitCount=S.units.filter(u=>u.layerId===id).length;const gfxCount=S.graphics.filter(g=>g.layerId===id).length;const total=unitCount+gfxCount;const name=l?l.name:id;if(total>0){if(!S._confirmDeleteLayer||S._confirmDeleteLayer!==id){S._confirmDeleteLayer=id;renderFloatingPanel();return}}S._confirmDeleteLayer=null;S.units=S.units.filter(u=>u.layerId!==id);S.graphics=S.graphics.filter(g=>g.layerId!==id);S.layers=S.layers.filter(l=>l.id!==id);/* Remove from packages */S.packages.forEach(p=>{p.layerIds=p.layerIds.filter(lid=>lid!==id)});S.packages=S.packages.filter(p=>p.layerIds.length>0);if(S.activeLayerId===id)S.activeLayerId=S.layers[0].id;if(S.selectedUnitId&&!S.units.find(u=>u.id===S.selectedUnitId)){S.selectedUnitId=null;closeEditor()}if(S.selectedGraphicId&&!S.graphics.find(g=>g.id===S.selectedGraphicId)){S.selectedGraphicId=null;closeEditor()}renderFloatingPanel();updateLayerIndicator();requestRender()}
function startLayerRename(id){S._renamingLayerId=id;renderFloatingPanel();setTimeout(()=>{const inp=document.getElementById("layer-rename-"+id);if(inp){inp.focus();inp.select()}},50)}
function commitLayerRename(id){const inp=document.getElementById("layer-rename-"+id);if(inp){const l=S.layers.find(x=>x.id===id);if(l){const v=sanitizeStr(inp.value.trim(),INPUT_LIMITS.layerName);if(v)l.name=v}}S._renamingLayerId=null;renderFloatingPanel();updateLayerIndicator()}
function moveToLayer(kind,id,newLayerId){if(kind==="unit"){const u=S.units.find(x=>x.id===id);if(u){u.layerId=newLayerId;netBroadcast({type:"unitEdit",unit:u})}}else{const g=S.graphics.find(x=>x.id===id);if(g){g.layerId=newLayerId;netBroadcast({type:"graphicEdit",graphic:g})}}renderFloatingPanel();requestRender()}
function toggleLayerCollapse(id){const l=S.layers.find(x=>x.id===id);if(l)l.collapsed=!l.collapsed;renderFloatingPanel()}
function togglePackageCollapse(id){const p=S.packages.find(x=>x.id===id);if(p)p.collapsed=!p.collapsed;renderFloatingPanel()}
function togglePackageVis(id){const p=S.packages.find(x=>x.id===id);if(!p)return;const layers=p.layerIds.map(lid=>S.layers.find(l=>l.id===lid)).filter(Boolean);const allVis=layers.every(l=>l.visible);layers.forEach(l=>l.visible=!allVis);requestRender();renderFloatingPanel()}
function removePackage(id){const p=S.packages.find(x=>x.id===id);if(!p)return;if(!S._confirmDeletePkg||S._confirmDeletePkg!==id){S._confirmDeletePkg=id;renderFloatingPanel();return}S._confirmDeletePkg=null;p.layerIds.forEach(lid=>{S.units=S.units.filter(u=>u.layerId!==lid);S.graphics=S.graphics.filter(g=>g.layerId!==lid);S.layers=S.layers.filter(l=>l.id!==lid)});S.packages=S.packages.filter(x=>x.id!==id);if(!S.layers.find(l=>l.id===S.activeLayerId))S.activeLayerId=S.layers[0]?S.layers[0].id:"default";renderFloatingPanel();updateLayerIndicator();requestRender()}
function layerDotColor(l){if(l.hasErrors)return"#ff4444";if(l.id===S.activeLayerId)return"#44cc44";if(l.visible)return"#4a9eff";return"#666"}
function updateLayerIndicator(){const el=document.querySelector(".layer-indicator");if(!el)return;const l=S.layers.find(x=>x.id===S.activeLayerId);var h=l?`<div class="dot" style="background:${layerDotColor(l)}"></div>${l.name}`:``;
  var wg=S._net.wargame;if(wg.active){
    var roleLabel=S._net.isHost?"GM":wg.myRole==="blufor"?"BLU":wg.myRole==="opfor"?"OPF":"OBS";
    var roleCol=S._net.isHost?"#ffd700":wg.myRole==="blufor"?"#4a9eff":wg.myRole==="opfor"?"#ff4444":"#888";
    h+=' <span style="padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;color:'+roleCol+';border:1px solid '+roleCol+';margin-left:6px">'+roleLabel+' T'+wg.turnNumber+'</span>';
  }
  el.innerHTML=h}

// Undo
function undo(){if(!S.undoStack.length)return;const a=S.undoStack.pop();switch(a.type){case"delete":S.units.push(a.unit);netBroadcast({type:"unitAdd",unit:stripHeavyProps(a.unit)});break;case"deleteGraphic":S.graphics.push(a.graphic);netBroadcast({type:"graphicAdd",graphic:a.graphic});break;case"move":{const u=S.units.find(x=>x.id===a.unitId);if(u){u.lat=a.lat;u.lon=a.lon;netBroadcast({type:"unitEdit",unit:stripHeavyProps(u)})}}break;case"edit":{const idx=S.units.findIndex(x=>x.id===a.unitId);if(idx>=0){S.units[idx]=a.prev;netBroadcast({type:"unitEdit",unit:stripHeavyProps(a.prev)})}}break}requestRender();updateUndoBtn();if(S._activePanel)renderFloatingPanel()}
function copySelected(){
  if(S.selectedUnitId){
    const u=S.units.find(x=>x.id===S.selectedUnitId);
    if(u){S._clipboard={kind:"unit",data:JSON.parse(JSON.stringify(u))};notify("Copied unit")}
  }else if(S.selectedGraphicId){
    const g=S.graphics.find(x=>x.id===S.selectedGraphicId);
    if(g){S._clipboard={kind:"graphic",data:JSON.parse(JSON.stringify(g))};notify("Copied graphic")}
  }
}
function pasteClipboard(){
  if(!S._clipboard)return;
  const c=S._clipboard;
  /* Small lat/lon offset so paste doesn't land exactly on original */
  const off=0.001;
  if(c.kind==="unit"){
    const u={...JSON.parse(JSON.stringify(c.data)),id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat:c.data.lat+off,lon:c.data.lon+off,layerId:S.activeLayerId};
    S.units.push(u);selectUnit(u.id);netBroadcast({type:"unitAdd",unit:stripHeavyProps(u)});notify("Pasted unit");
  }else if(c.kind==="graphic"){
    const g=JSON.parse(JSON.stringify(c.data));
    g.id="g"+Date.now()+Math.random().toString(36).substr(2,4);
    g.layerId=S.activeLayerId;
    /* Offset all points */
    if(g.points)g.points=g.points.map(p=>({...p,lat:p.lat+off,lon:p.lon+off}));
    S.graphics.push(g);selectGraphic(g.id);netBroadcast({type:"graphicAdd",graphic:g});notify("Pasted graphic");
  }
  requestRender();
}
function updateUndoBtn(){const btn=document.getElementById("undo-btn");if(btn){btn.style.opacity=S.undoStack.length?"1":"0.3";btn.style.pointerEvents=S.undoStack.length?"auto":"none"}}

// File menu
function toggleFileMenu(){_fileMenuOpen=!_fileMenuOpen;const m=document.getElementById("file-menu");if(m){renderFileMenuItems();m.classList.toggle("open",_fileMenuOpen)}}
function closeFileMenu(){_fileMenuOpen=false;const m=document.getElementById("file-menu");if(m)m.classList.remove("open")}
function renderFileMenuItems(){const m=document.getElementById("file-menu");if(!m)return;
  const hasData=S.units.length||S.graphics.length;
  m.innerHTML=`<div class="fm-section">PROJECT</div>
<div class="fm-item" onclick="if(S.units.length||S.graphics.length){if(!confirm('Delete all units and graphics? This cannot be undone.'))return}IO.autosaveClear();S.units=[];S.graphics=[];S.packages=[];S.layers=[{id:'default',name:'Default',visible:true,hasErrors:false}];S.activeLayerId='default';S.selectedUnitId=null;S.selectedGraphicId=null;closeEditor();requestRender();updateLayerIndicator();closeFileMenu()">New Project</div>
<div class="fm-item danger" onclick="S.units=[];S.graphics=[];S.layers=[];S.packages=[];IO.autosaveClear();localStorage.clear();location.reload()">Clear All Data &amp; Reload</div>
<div class="fm-item" onclick="IO.projectSave();closeFileMenu()">Save Project (.tacmap)</div>
<div class="fm-item" onclick="closeFileMenu();IO.requestImport()">Open Project</div>
<div class="fm-section">IMPORT</div>
<div class="fm-item" onclick="closeFileMenu();IO.requestImport()">Import File (.tacmap .geojson .kml .kmz)</div>
<div class="fm-section">EXPORT</div>
<div class="fm-item${hasData?'':' disabled'}" onclick="IO.openExportPanel();closeFileMenu()">Export…</div>

<div class="fm-status">${S.units.length} units, ${S.graphics.length} graphics</div>`;}

// Chat
function sendChat(){const inp=document.getElementById("chat-input");if(!inp||!inp.value.trim())return;const n=S._net;const txt=sanitizeStr(inp.value.trim(),INPUT_LIMITS.chatMsg);var tgt=n.chatTarget||"room";
  /* For peers, "host" target needs to send without a specific peerId — host will see it as a DM */
  var sendTo=tgt==="host"?"dm_host":tgt;
  const msg={type:"chat",fromName:sanitizeStr(n.peerName||"Anon",INPUT_LIMITS.callsign),to:sendTo,text:txt};
  n.chatMessages.push({from:"me",fromName:n.peerName||"Me",to:tgt,text:txt,ts:Date.now()});
  /* DMs: send directly to target, not broadcast */
  if(tgt!=="room"&&n.isHost){
    /* Host sending DM to specific peer */
    var c=n.conns.find(function(x){return x.peerId===tgt});
    if(c)try{c.conn.send(JSON.stringify(msg))}catch(e){}
  }else{
    netBroadcast(msg);
  }
  inp.value="";renderFloatingPanel();
  setTimeout(function(){var el=document.getElementById("chat-messages");if(el)el.scrollTop=el.scrollHeight},50)}
function updateChatBadge(){const btn=document.getElementById("sb-chat");if(!btn)return;const existing=btn.querySelector(".badge");if(existing)existing.remove();if(S._net.unreadCount>0){const b=document.createElement("span");b.className="badge";b.textContent=S._net.unreadCount;btn.appendChild(b)}}

// Place unit from palette
function startPlacement(type,affiliation,isEquip){S._placementMode={type:type,affiliation:affiliation||"friendly",echelon:null,designation:"",modifiers:[],isHQ:type==="headquarters",isEquipment:!!isEquip};showPlacementBar()}

function detectLayout(){const w=window.innerWidth,h=window.innerHeight;S._isLandscape=h<500;S._layout=S._overrides.layout&&S._overrides.layout!=="auto"?S._overrides.layout:w<500?"phone":w<900?"tablet":"desktop";document.body.setAttribute("data-layout",S._layout);document.body.setAttribute("data-orientation",S._isLandscape?"landscape":"portrait")}


// === part_08_net_fileio_init.js ===

// ─── P2P NETWORKING ──────────────────────
function toggleSharedLayer(layerId,prop){
  const n=S._net;if(!n.sharedLayers[layerId])n.sharedLayers[layerId]={visible:false,editable:false};
  n.sharedLayers[layerId][prop]=!n.sharedLayers[layerId][prop];
  /* If making not visible, also remove editable */
  if(prop==="visible"&&!n.sharedLayers[layerId].visible){n.sharedLayers[layerId].editable=false;if(n.sharedEditLayer===layerId)n.sharedEditLayer=null}
  /* If making editable, also make visible */
  if(prop==="editable"&&n.sharedLayers[layerId].editable)n.sharedLayers[layerId].visible=true;
  renderFloatingPanel()}
function setSharedEditLayer(layerId){
  const n=S._net;
  if(n.sharedEditLayer===layerId){n.sharedEditLayer=null}
  else{n.sharedEditLayer=layerId;if(!n.sharedLayers[layerId])n.sharedLayers[layerId]={visible:false,editable:false};n.sharedLayers[layerId].visible=true;n.sharedLayers[layerId].editable=true}
  renderFloatingPanel()}
function togglePkgShare(pkgId,prop){
  var pkg=S.packages.find(function(p){return p.id===pkgId});if(!pkg)return;
  var n=S._net;
  /* Check if all layers in package already have this prop */
  var allSet=pkg.layerIds.every(function(lid){var sh=n.sharedLayers[lid];return sh&&sh[prop]});
  pkg.layerIds.forEach(function(lid){
    if(!n.sharedLayers[lid])n.sharedLayers[lid]={visible:false,editable:false};
    n.sharedLayers[lid][prop]=!allSet;
  });
  renderFloatingPanel()}
function broadcastSharedConfig(){
  const n=S._net;
  /* Build layer data package — only shared layers */
  const sharedLayerData=[];const sharedUnits=[];const sharedGraphics=[];
  S.layers.forEach(l=>{
    const sh=n.sharedLayers[l.id];if(!sh||!sh.visible)return;
    sharedLayerData.push({...l,_shared:sh});
    S.units.filter(u=>u.layerId===l.id).forEach(u=>sharedUnits.push(u));
    S.graphics.filter(g=>g.layerId===l.id).forEach(g=>sharedGraphics.push(g));
  });
  netBroadcast({type:"sharedConfig",sharedLayers:n.sharedLayers,sharedEditLayer:n.sharedEditLayer,layers:sharedLayerData,units:sharedUnits,graphics:sharedGraphics,editMode:n.editMode});
  notify("Pushed to peers")}
/* ── Permissions ── */
function broadcastRoster(){
  const n=S._net;if(!n.isHost)return;
  const roster=[{name:n.peerName||"Host",isHost:true,canEdit:true}];
  n.conns.forEach(c=>{
    const id=c.peerId;const name=n.peerNames[id]||id.substr(0,8);
    const canEdit=n.peerPermissions[id]&&n.peerPermissions[id].canEdit;
    roster.push({peerId:id,name,isHost:false,canEdit:!!canEdit,joinOrder:c.joinOrder||999});
  });
  /* Send roster with room code so peers can attempt host migration */
  netBroadcast({type:"roster",roster,roomCode:n.roomCode})}
function togglePeerEdit(peerId){
  const n=S._net;if(!n.peerPermissions[peerId])n.peerPermissions[peerId]={canEdit:false};
  n.peerPermissions[peerId].canEdit=!n.peerPermissions[peerId].canEdit;
  /* Notify the peer of their new permission */
  const c=n.conns.find(x=>x.peerId===peerId);
  if(c)try{c.conn.send(JSON.stringify({type:"permissionUpdate",canEdit:n.peerPermissions[peerId].canEdit}))}catch(e){}
  broadcastRoster();renderFloatingPanel()}
function requestEditAccess(){
  const n=S._net;if(!n.hostConn)return;
  n.editRequestStatus="pending";
  n.hostConn.send(JSON.stringify({type:"editRequest",name:n.peerName||"Peer"}));
  renderFloatingPanel()}
function handleEditRequest(idx,approve){
  const n=S._net;const r=n.editRequests[idx];if(!r)return;
  r.status=approve?"approved":"denied";
  /* Find peer connection and send result + update permissions */
  const c=n.conns.find(x=>x.peerId===r.peerId);
  if(c){
    if(approve){if(!n.peerPermissions[r.peerId])n.peerPermissions[r.peerId]={canEdit:false};n.peerPermissions[r.peerId].canEdit=true}
    try{c.conn.send(JSON.stringify({type:"editRequestResult",approved:approve}))}catch(e){}
    try{c.conn.send(JSON.stringify({type:"permissionUpdate",canEdit:!!approve}))}catch(e){}
  }
  broadcastRoster();renderFloatingPanel()}
function dismissEditRequest(idx){
  const n=S._net;const r=n.editRequests[idx];if(r)r.status="dismissed";
  renderFloatingPanel()}
function clearEditRequest(idx){
  S._net.editRequests.splice(idx,1);renderFloatingPanel()}
/* Heartbeat: host pings peers every 5s, removes dead ones after 15s */
setInterval(function(){
  var n=S._net;if(!n.isHost)return;
  var now=Date.now();
  /* Send ping to all peers */
  n.conns.forEach(function(c){
    try{c.conn.send(JSON.stringify({type:"ping",ts:now}))}catch(e){c._dead=true}
  });
  /* Remove peers that haven't responded in 15s */
  var dead=n.conns.filter(function(c){return c._dead||(c._lastPong&&now-c._lastPong>15000)});
  if(dead.length){
    dead.forEach(function(c){
      var pid=c.peerId||c.conn.peer;
      try{c.conn.close()}catch(e){}
      delete n.peerNames[pid];delete n.peerPermissions[pid];
    });
    n.conns=n.conns.filter(function(c){return!c._dead&&!(c._lastPong&&now-c._lastPong>15000)});
    n.status=n.conns.length+" peer(s)";
    broadcastRoster();renderFloatingPanel();
  }
},5000);
/* Peer: send pong on ping, detect host gone */
setInterval(function(){
  var n=S._net;
  if(n.mode==="connected"&&n.hostConn){
    if(n._lastHostPing&&Date.now()-n._lastHostPing>20000){
      /* Host gone — attempt migration */
      n.hostConn=null;
      attemptHostMigration();
    }
  }
},5000);
/* Auto-refresh stale requests every 5s when hosting */
setInterval(()=>{if(S._net.isHost&&S._net.editRequests.some(r=>r.status==="pending")&&S._activePanel==="comms")renderFloatingPanel()},5000);

/* ── Host Migration ── */
function attemptHostMigration(){
  var n=S._net;
  if(n._migrating)return;
  n._migrating=true;
  /* Determine if we should become host: lowest joinOrder among connected peers */
  var shouldHost=true;
  if(n.roomRoster&&n.roomRoster.length>1){
    var myOrder=n._myJoinOrder||999;
    n.roomRoster.forEach(function(r){
      if(!r.isHost&&r.peerId!==n.peer.id&&r.joinOrder<myOrder)shouldHost=false;
    });
  }
  if(!shouldHost||!n.roomCode){
    /* Wait for another peer to become host, then reconnect */
    n.persistentRoom=null;S._commsStep=null;S._commsRole=null;n.mode="offline";n.status="Reconnecting...";
    updateNetDot("connecting");notify("Host lost — waiting for new host...","warning");renderFloatingPanel();
    setTimeout(function(){
      n._migrating=false;
      if(n.mode==="offline"&&n.roomCode){
        /* Try to rejoin */
        n.status="Rejoining...";renderFloatingPanel();
        netJoinRoom();
      }
    },5000);
    return;
  }
  /* We become the new host */
  notify("Host disconnected — taking over as host");
  n.status="Migrating...";updateNetDot("connecting");renderFloatingPanel();
  /* Destroy old peer connection */
  if(n.peer)try{n.peer.destroy()}catch(e){}
  /* Preserve current state */
  var savedUnits=S.units.slice();
  var savedGraphics=S.graphics.slice();
  var savedLayers=S.layers.slice();
  var savedPkgs=S.packages.slice();
  var savedShared=JSON.parse(JSON.stringify(n.sharedLayers||{}));
  var savedCode=n.roomCode;
  var savedName=n.peerName;
  /* Create new peer with same room code */
  n.peer=new Peer("staffmaps-"+savedCode,_peerOpts());
  n.peer.on("open",function(){
    n.isHost=true;n.mode="hosting";n.roomCode=savedCode;
    n.hostConn=null;n.conns=[];n.peerNames={};n.peerPermissions={};
    n.sharedLayers=savedShared;n.defaultJoinMode="edit";
    n.nextJoinOrder=1;n._migrating=false;
    /* Mark all shared layers visible+editable for seamless continuation */
    Object.keys(n.sharedLayers).forEach(function(id){
      n.sharedLayers[id]={visible:true,editable:true};
    });
    /* Restore state */
    S.units=savedUnits;S.graphics=savedGraphics;S.layers=savedLayers;S.packages=savedPkgs;
    n.status="Hosting (migrated)";updateNetDot("connected");
    notify("You are now the host","success");renderFloatingPanel();
  });
  n.peer.on("connection",function(conn){
    conn.on("open",function(){
      n.conns.push({conn:conn,peerId:conn.peer,joinOrder:n.nextJoinOrder++,_lastPong:Date.now()});
      /* Send full state to reconnecting peer */
      var fMsg={type:"fullState",units:S.units,graphics:S.graphics,layers:S.layers,packages:S.packages,activeLayerId:S.activeLayerId,sharedLayers:n.sharedLayers};
      conn.send(JSON.stringify(fMsg));
      n.status=n.conns.length+" peer(s)";renderFloatingPanel();
    });
    conn.on("data",function(data){try{var msg=JSON.parse(data);sanitizeNetMsg(msg);handleNetMsg(msg,conn.peer)}catch(e){}});
    conn.on("close",function(){var pid=conn.peer;n.conns=n.conns.filter(function(c){return c.conn!==conn});delete n.peerNames[pid];delete n.peerPermissions[pid];n.status=n.conns.length+" peer(s)";broadcastRoster();renderFloatingPanel()});
    conn.on("error",function(){var pid=conn.peer;n.conns=n.conns.filter(function(c){return c.conn!==conn});delete n.peerNames[pid];delete n.peerPermissions[pid];n.status=n.conns.length+" peer(s)";broadcastRoster();renderFloatingPanel()});
  });
  n.peer.on("error",function(e){
    n._migrating=false;n.mode="offline";n.status="Migration failed: "+e.type;
    updateNetDot("error");renderFloatingPanel();
  });
  /* Timeout fallback */
  setTimeout(function(){
    if(n._migrating){n._migrating=false;
      if(n.mode!=="hosting"){n.mode="offline";n.status="Migration timeout";updateNetDot("error");renderFloatingPanel()}}
  },15000);
}
/* ── Wargame System ── */
function wargameStart(){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  wg.active=true;wg.phase="planning";wg.turnNumber=1;wg.orders=[];wg.turnLog=[];
  wg.roles={};wg.layerRoles={};wg.myRole=null;
  /* Default: assign first peer as BLUFOR, rest as observer */
  var peerIds=Object.keys(n.peerNames);
  if(peerIds.length>=1)wg.roles[peerIds[0]]={role:"blufor",name:n.peerNames[peerIds[0]]};
  if(peerIds.length>=2)wg.roles[peerIds[1]]={role:"opfor",name:n.peerNames[peerIds[1]]};
  for(var i=2;i<peerIds.length;i++)wg.roles[peerIds[i]]={role:"observer",name:n.peerNames[peerIds[i]]};
  wargameBroadcastState();
  notify("Wargame started — Turn 1");renderFloatingPanel()}

function wargameEnd(){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  if(!confirm("End the wargame? All orders will be cleared."))return;
  wg.active=false;wg.phase="planning";wg.roles={};wg.layerRoles={};wg.orders=[];wg.turnNumber=1;wg.myRole=null;
  wargameBroadcastState();
  notify("Wargame ended");renderFloatingPanel()}

function wargameAdvance(){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  if(wg.phase==="planning"){
    /* Move to execution — lock the board for players */
    wg.phase="execution";
    wg.turnLog.push({turn:wg.turnNumber,phase:"execution",orders:wg.orders.map(function(o){return{...o}})});
    wargameBroadcastState();
    notify("\u2694\ufe0f Execution phase — board locked for players");
  }else{
    /* Advance to next turn — unlock, clear resolved orders */
    wg.orders=wg.orders.filter(function(o){return o.status==="pending"});
    wg.turnNumber++;
    wg.phase="planning";
    wargameBroadcastState();
    notify("\ud83d\udcdd Turn "+wg.turnNumber+" — Planning phase");
  }
  renderFloatingPanel()}

function wargameSetRole(peerId,role){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  wg.roles[peerId]={role:role,name:n.peerNames[peerId]||"Peer"};
  wargameBroadcastState();
  renderFloatingPanel()}

function wargameSetLayerRole(layerId,role){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  wg.layerRoles[layerId]=role;
  wargameBroadcastState();
  renderFloatingPanel()}

function wargameBroadcastState(){
  const n=S._net,wg=n.wargame;
  /* Send wargame state to each peer — filter orders by role */
  n.conns.forEach(function(c){
    var pRole=(wg.roles[c.peerId]&&wg.roles[c.peerId].role)||"observer";
    var peerOrders=wg.orders.filter(function(o){return o.role===pRole||pRole==="observer"});
    var peerState={type:"wargameState",active:wg.active,phase:wg.phase,turnNumber:wg.turnNumber,
      myRole:pRole,layerRoles:wg.layerRoles,orders:peerOrders,
      roles:wg.roles /* so peers can see who is who */};
    try{c.conn.send(JSON.stringify(peerState))}catch(e){}
  });
  requestRender()}

function wargameOrderDecide(orderId,approve){
  const n=S._net,wg=n.wargame;if(!n.isHost)return;
  var o=wg.orders.find(function(x){return x.id===orderId});
  if(!o)return;
  o.status=approve?"approved":"denied";
  if(approve&&o.type==="move"&&o.data.unitId&&o.data.destLat!=null){
    /* Execute move — move the unit to destination */
    var u=S.units.find(function(x){return x.id===o.data.unitId});
    if(u){u.lat=o.data.destLat;u.lon=o.data.destLon;netBroadcast({type:"unitEdit",unit:u})}
  }
  wargameBroadcastState();
  notify(approve?"Order approved":"Order denied");
  requestRender();renderFloatingPanel()}

/* Player-side order submission */
function wargameSubmitMove(){
  const n=S._net,wg=n.wargame;
  if(!S.selectedUnitId)return;
  var u=S.units.find(function(x){return x.id===S.selectedUnitId});
  if(!u)return;
  /* Enter move destination mode */
  S._wargameOrderPending={type:"move",unitId:u.id,unitName:u.name||u.designation||u.type};
  var mb=document.getElementById("mode-bar");mb.style.display="flex";mb.classList.add("open");
  mb.innerHTML='<span class="mode-info">Tap destination for '+escHtml(u.name||u.designation||u.type)+'</span><button class="btn danger" onclick="wargameCancelPendingOrder()">\u2715 Cancel</button><button class="btn done" onclick="wargameConfirmMoveOrder()">\u2713 Confirm</button>';
  notify("Tap the map to set move destination")}

function wargameConfirmMoveOrder(){
  const n=S._net,op=S._wargameOrderPending;
  if(!op||!op.destLat)return;
  var order={id:"ord_"+Date.now()+"_"+Math.random().toString(36).substr(2,4),
    peerId:n.peer?n.peer.id:"local",role:n.wargame.myRole||"blufor",
    type:"move",status:"pending",
    data:{unitId:op.unitId,description:"Move "+op.unitName,
      origLat:op.origLat,origLon:op.origLon,
      destLat:op.destLat,destLon:op.destLon}};
  n.wargame.orders.push(order);
  netBroadcast({type:"wargameOrder",order:order});
  S._wargameOrderPending=null;
  hideModeBar();
  notify("Move order submitted");renderFloatingPanel();requestRender()}

function wargameSubmitFire(){
  const n=S._net,wg=n.wargame;
  if(!S.selectedUnitId)return;
  var u=S.units.find(function(x){return x.id===S.selectedUnitId});
  if(!u)return;
  S._wargameOrderPending={type:"fire",unitId:u.id,unitName:u.name||u.designation||u.type};
  var mb=document.getElementById("mode-bar");mb.style.display="flex";mb.classList.add("open");
  mb.innerHTML='<span class="mode-info">Tap target for '+escHtml(u.name||u.designation||u.type)+'</span><button class="btn danger" onclick="wargameCancelPendingOrder()">\u2715 Cancel</button><button class="btn done" onclick="wargameConfirmFireOrder()">\u2713 Confirm</button>';
  notify("Tap the map to set fire target")}

function wargameConfirmFireOrder(){
  const n=S._net,op=S._wargameOrderPending;
  if(!op||!op.targetLat)return;
  var order={id:"ord_"+Date.now()+"_"+Math.random().toString(36).substr(2,4),
    peerId:n.peer?n.peer.id:"local",role:n.wargame.myRole||"blufor",
    type:"fire",status:"pending",
    data:{unitId:op.unitId,description:"Fire from "+op.unitName,
      originLat:op.origLat,originLon:op.origLon,
      targetLat:op.targetLat,targetLon:op.targetLon}};
  n.wargame.orders.push(order);
  netBroadcast({type:"wargameOrder",order:order});
  S._wargameOrderPending=null;
  hideModeBar();
  notify("Fire order submitted");renderFloatingPanel();requestRender()}

function wargameCancelPendingOrder(){
  S._wargameOrderPending=null;hideModeBar()}

function wargameCancelOrder(orderId){
  const n=S._net,wg=n.wargame;
  wg.orders=wg.orders.filter(function(o){return o.id!==orderId});
  netBroadcast({type:"wargameOrderCancel",orderId:orderId});
  renderFloatingPanel();requestRender()}

/* Visibility check: can current user see this layer? */
function wargameCanSeeLayer(layerId){
  const wg=S._net.wargame;
  if(!wg.active)return true;
  var lRole=wg.layerRoles[layerId]||"all";
  if(lRole==="all")return true;
  if(S._net.isHost)return true;/* GM sees everything */
  var myRole=wg.myRole||"observer";
  if(lRole==="gm")return false;
  return lRole===myRole}

function shouldBroadcastEdit(msg){
  const n=S._net;
  /* Host always broadcasts */
  if(n.isHost)return true;
  /* Non-edit messages always broadcast */
  const editTypes=["unitAdd","unitEdit","unitDelete","graphicAdd","graphicEdit","graphicDelete"];
  if(!editTypes.includes(msg.type))return true;
  /* Wargame execution lock — peers cannot edit during execution */
  if(n.wargame.active&&n.wargame.phase==="execution")return false;
  /* Check peer has edit permission from host */
  if(n.editRequestStatus!=="approved")return false;
  /* Check if the item's layer is editable */
  let layerId=null;
  if(msg.unit)layerId=msg.unit.layerId;
  else if(msg.graphic)layerId=msg.graphic.layerId;
  else if(msg.unitId){const u=S.units.find(x=>x.id===msg.unitId);if(u)layerId=u.layerId}
  else if(msg.graphicId){const g=S.graphics.find(x=>x.id===msg.graphicId);if(g)layerId=g.layerId}
  if(layerId){const sh=n.sharedLayers[layerId];if(!sh||!sh.editable)return false}
  return true}
function netBroadcast(msg){const n=S._net;if(n.mode==="offline")return;if(!shouldBroadcastEdit(msg))return;const str=JSON.stringify(msg);if(n.isHost){n.conns.forEach(c=>{try{c.conn.send(str)}catch(e){}})}else if(n.hostConn){try{n.hostConn.send(str)}catch(e){}}}
function netCreateRoom(fixedCode){
  const n=S._net;n.roomCode=fixedCode||Math.random().toString(36).substr(2,6).toUpperCase();
  n.peer=new Peer("staffmaps-"+n.roomCode,_peerOpts());
  n.peer.on("open",()=>{n.isHost=true;n.mode="hosting";n.status="Hosting";updateNetDot("connected");renderFloatingPanel()});
  n.peer.on("connection",conn=>{
    conn.on("open",()=>{n.conns.push({conn,peerId:conn.peer,joinOrder:n.nextJoinOrder++,_lastPong:Date.now()});/* Build fullState with only shared layers */
      var _fsLayers=[],_fsUnits=[],_fsGraphics=[],_fsPkgs=[];
      var _fsSharedIds=new Set();
      S.layers.forEach(function(l){var sh=n.sharedLayers[l.id];if(sh&&sh.visible){_fsLayers.push(l);_fsSharedIds.add(l.id)}});
      /* If nothing shared, send empty state — peer gets a blank map until host pushes */
      S.units.forEach(function(u){if(_fsSharedIds.has(u.layerId))_fsUnits.push(u)});
      S.graphics.forEach(function(g){if(_fsSharedIds.has(g.layerId))_fsGraphics.push(g)});
      S.packages.forEach(function(p){var pIds=p.layerIds.filter(function(id){return _fsSharedIds.has(id)});if(pIds.length)_fsPkgs.push({id:p.id,name:p.name,collapsed:p.collapsed,layerIds:pIds})});
      var fMsg={type:"fullState",units:_fsUnits,graphics:_fsGraphics,layers:_fsLayers,packages:_fsPkgs,activeLayerId:n.sharedEditLayer||S.activeLayerId,editMode:n.editMode,sharedLayers:n.sharedLayers,sharedEditLayer:n.sharedEditLayer};conn.send(JSON.stringify(fMsg));/* Send wargame state if active */if(n.wargame.active){setTimeout(function(){var pRole="observer";var wgMsg={type:"wargameState",active:true,phase:n.wargame.phase,turnNumber:n.wargame.turnNumber,myRole:pRole,layerRoles:n.wargame.layerRoles,orders:[],roles:n.wargame.roles};try{conn.send(JSON.stringify(wgMsg))}catch(e){}},100)}n.status=n.conns.length+" peer(s)";renderFloatingPanel()});
    conn.on("data",data=>{try{var msg=JSON.parse(data);sanitizeNetMsg(msg);handleNetMsg(msg,conn.peer)}catch(e){}});
    conn.on("close",()=>{const pid=conn.peer;n.conns=n.conns.filter(c=>c.conn!==conn);delete n.peerNames[pid];delete n.peerPermissions[pid];n.status=n.conns.length+" peer(s)";broadcastRoster();renderFloatingPanel()});
    conn.on("error",()=>{const pid=conn.peer;n.conns=n.conns.filter(c=>c.conn!==conn);delete n.peerNames[pid];delete n.peerPermissions[pid];n.status=n.conns.length+" peer(s)";broadcastRoster();renderFloatingPanel()})});
  n.peer.on("error",e=>{n.status="Error: "+e.type;updateNetDot("error");renderFloatingPanel()})}

function netJoinRoom(){
  const n=S._net,code=(document.getElementById("net-code")||{}).value||n.roomCode;if(!code)return;
  n.roomCode=code.toUpperCase();n.peer=new Peer(undefined,_peerOpts());
  n.peer.on("open",()=>{
    const conn=n.peer.connect("staffmaps-"+n.roomCode);n.hostConn=conn;
    conn.on("open",()=>{n.mode="connected";n.status="Connected";updateNetDot("connected");S._net._lastHostPing=Date.now();conn.send(JSON.stringify({type:"hello",name:n.peerName}));renderFloatingPanel()});
    conn.on("data",data=>{try{var msg=JSON.parse(data);sanitizeNetMsg(msg);handleNetMsg(msg,null)}catch(e){}});
    conn.on("close",()=>{n.hostConn=null;attemptHostMigration()})});
  n.peer.on("error",e=>{n.status="Error: "+e.type;updateNetDot("error");renderFloatingPanel()})}

function netLeave(){const n=S._net;if(n.peer)n.peer.destroy();n.peer=null;n.conns=[];n.hostConn=null;n.isHost=false;n.roomCode=null;n.mode="offline";n.status="";n.peerNames={};n.sharedLayers={};n.sharedEditLayer=null;n.editScope="local";n.peerPermissions={};n.editRequests=[];n.editRequestStatus=null;n.roomRoster=[];n.wargame={active:false,phase:"planning",roles:{},myRole:null,layerRoles:{},orders:[],turnNumber:1,turnLog:[]};S._wargameOrderPending=null;updateNetDot("");renderFloatingPanel();requestRender()}

var _manualPC=null,_manualPCs=[];
function netManualRole(role){var h=document.getElementById('net-manual-host'),p=document.getElementById('net-manual-peer'),hb=document.getElementById('mr-host'),pb=document.getElementById('mr-peer');if(h)h.style.display=role==='host'?'block':'none';if(p)p.style.display=role==='peer'?'block':'none';if(hb)hb.className='btn'+(role==='host'?' primary':'');if(pb)pb.className='btn'+(role==='peer'?' primary':'');}
function _manualIceConfig(){return{iceServers:[],iceCandidatePoolSize:10}}
function _encodeOffer(obj){var out={t:obj.sdp.type,s:(obj.sdp.sdp||'').split('\n').filter(function(l){return l.trim()&&l.indexOf('a=extmap')!==0&&l!=='a=msid-semantic: WMS'}).join('\n')};return btoa(unescape(encodeURIComponent(JSON.stringify(out))));}
function _decodeOffer(str){try{var raw=JSON.parse(decodeURIComponent(escape(atob(str))));if(raw.t&&raw.s)return{sdp:{type:raw.t,sdp:raw.s},candidates:[]};if(raw.sdp)return raw;}catch(e){}return null;}
function _showQR(text,cid){var el=document.getElementById(cid);if(!el||typeof QRCode==='undefined')return;el.innerHTML='';try{new QRCode(el,{text:text,width:180,height:180,colorDark:'#fff',colorLight:'#111',correctLevel:QRCode.CorrectLevel.M})}catch(e){}}
function _finishManualGather(pc,candidates,label,outId){var encoded=_encodeOffer({sdp:pc.localDescription,candidates:candidates});var el=document.getElementById(outId||'net-manual-out');if(el)el.value=encoded;if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(encoded).catch(function(){});else if(el){el.select();try{document.execCommand('copy')}catch(e){}}_showQR(encoded,'net-manual-qr');IO.notify(label+' ready ('+encoded.length+' chars) — copied');}
function netManualOffer(){var pc=new RTCPeerConnection(_manualIceConfig());_manualPC=pc;_manualPCs.push(pc);var dc=pc.createDataChannel('staffmaps');dc.onopen=function(){IO.notify('Connected!')};dc.onmessage=function(e){try{handleNetMsg(JSON.parse(e.data),'manual')}catch(err){}};var candidates=[],done=false;function finish(){if(done)return;done=true;_finishManualGather(pc,candidates,'Offer','net-manual-out')}pc.onicecandidate=function(e){if(!e.candidate){finish();return}candidates.push(e.candidate)};pc.onicegatheringstatechange=function(){if(pc.iceGatheringState==='complete')finish()};pc.createOffer().then(function(o){return pc.setLocalDescription(o)}).then(function(){setTimeout(finish,5000)}).catch(function(e){IO.notify('Offer error: '+e.message,'error')});IO.notify('Generating offer…');}
function netManualAnswer(){var inp=document.getElementById('net-manual-in');if(!inp||!inp.value.trim()){IO.notify('Paste offer first','error');return}var data=_decodeOffer(inp.value.trim());if(!data||!data.sdp){IO.notify('Invalid offer','error');return}if(_manualPC)_manualPC.close();_manualPC=new RTCPeerConnection(_manualIceConfig());_manualPC.ondatachannel=function(e){var ch=e.channel;ch.onopen=function(){IO.notify('Connected!')};ch.onmessage=function(ev){try{handleNetMsg(JSON.parse(ev.data),'manual')}catch(err){}}};var candidates=[],done=false;function finish(){if(done)return;done=true;_finishManualGather(_manualPC,candidates,'Answer','net-manual-out')}_manualPC.onicecandidate=function(e){if(!e.candidate){finish();return}candidates.push(e.candidate)};_manualPC.onicegatheringstatechange=function(){if(_manualPC.iceGatheringState==='complete')finish()};_manualPC.setRemoteDescription(data.sdp).then(function(){(data.candidates||[]).forEach(function(c){_manualPC.addIceCandidate(c).catch(function(){})});return _manualPC.createAnswer()}).then(function(a){return _manualPC.setLocalDescription(a)}).then(function(){setTimeout(finish,5000)}).catch(function(e){IO.notify('Answer error: '+e.message,'error')});IO.notify('Generating answer…');}
function netManualApply(){var inp=document.getElementById('net-manual-in2');if(!inp||!inp.value.trim()){IO.notify('Paste answer first','error');return}if(!_manualPC){IO.notify('Generate offer first','error');return}var data=_decodeOffer(inp.value.trim());if(!data||!data.sdp){IO.notify('Invalid answer','error');return}_manualPC.setRemoteDescription(data.sdp).then(function(){(data.candidates||[]).forEach(function(c){_manualPC.addIceCandidate(c).catch(function(){})});IO.notify('Applied — waiting for connection…')}).catch(function(e){IO.notify('Apply error: '+e.message,'error')});}
function netManualCopy(){var el=document.getElementById('net-manual-out');if(!el||!el.value){IO.notify('Nothing to copy','error');return}if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(el.value).then(function(){IO.notify('Copied!')}).catch(function(){el.select();document.execCommand('copy')});else{el.select();document.execCommand('copy');IO.notify('Copied!')}}
function netManualToggle(){var el=document.getElementById('net-manual');if(el)el.style.display=el.style.display==='none'?'block':'none';}
function netDiag(){var out=document.getElementById('net-diag-out');if(!out)return;
  out.innerHTML='<div style="color:#4a9eff">⏳ Running diagnostics…</div>';
  var results={peerjs:null,stun:null,turn:null,localNet:null,webrtc:null};
  var done=0,total=3;
  var finished=false;
  /* Hard timeout — never hang longer than 12 seconds */
  var hardTimeout=setTimeout(function(){if(finished)return;finished=true;
    if(!results.stun)results.stun='blocked';if(!results.turn&&S._turnServer&&S._turnServer.host)results.turn='blocked';else if(!results.turn)results.turn='skipped';if(!results.peerjs)results.peerjs='blocked';
    done=total;checkDone()},12000);
  function checkDone(){
    done++;if(done<total)return;
    if(finished)return;finished=true;clearTimeout(hardTimeout);
    /* Build recommendations */
    var h='<div style="margin-top:6px">';
    h+='<div style="font-weight:600;margin-bottom:6px;font-size:11px">Network Diagnostic Results</div>';
    /* WebRTC support */
    if(!results.webrtc){h+='<div style="color:#ff4444;margin-bottom:4px">❌ <b>WebRTC not supported</b> — Your browser cannot make P2P connections. Try Chrome, Edge, or Safari.</div>';out.innerHTML=h+'</div>';return}
    else h+='<div style="color:#40e060;margin-bottom:4px">✅ WebRTC supported</div>';
    /* STUN (internet reachability) */
    if(results.stun==='ok') h+='<div style="color:#40e060;margin-bottom:4px">✅ STUN reachable — Internet P2P available</div>';
    else if(results.stun==='partial') h+='<div style="color:#e0a030;margin-bottom:4px">⚠️ STUN partial — Local connections work, internet P2P may fail behind strict NAT</div>';
    else h+='<div style="color:#ff4444;margin-bottom:4px">❌ STUN blocked — Cannot reach Google STUN server</div>';
    /* TURN */
    if(S._turnServer&&S._turnServer.host){
      if(results.turn==='ok') h+='<div style="color:#40e060;margin-bottom:4px">✅ TURN relay available — Connections will work even behind strict firewalls</div>';
      else h+='<div style="color:#ff4444;margin-bottom:4px">❌ TURN relay failed — Check your TURN server settings (host: '+escHtml(S._turnServer.host)+')</div>';
    }else{
      if(results.stun!=='ok') h+='<div style="color:#e0a030;margin-bottom:4px">⚠️ No TURN server configured — Add one in Server Settings for firewall relay</div>';
    }
    /* PeerJS signaling */
    var _hasCS=S._signalServer&&S._signalServer.host&&S._signalServer.host.trim();
    if(results.peerjs==='ok') h+='<div style="color:#40e060;margin-bottom:4px">✅ Signal server reachable'+(_hasCS?' ('+escHtml(S._signalServer.host)+')':' (PeerJS Cloud)')+' — Room codes will work</div>';
    else if(_hasCS) {
      h+='<div style="color:#ff4444;margin-bottom:4px">❌ Custom signal server unreachable ('+escHtml(S._signalServer.host)+':'+((S._signalServer.port)||9000)+')</div>';
      if(results._cloudOk) h+='<div style="color:#40e060;margin-bottom:4px">✅ PeerJS Cloud reachable — Switch to Default Cloud in server settings, or fix custom server</div>';
      else h+='<div style="color:#ff4444;margin-bottom:4px">❌ PeerJS Cloud also unreachable</div>';
    }
    else h+='<div style="color:#ff4444;margin-bottom:4px">❌ Signal server unreachable (PeerJS Cloud)</div>';
    /* Recommendations */
    h+='<div style="border-top:1px solid #333;margin-top:8px;padding-top:8px;font-weight:600;font-size:11px">Recommendation</div>';
    var _sigWorks=results.peerjs==='ok'||results._cloudOk;
    if(_sigWorks&&(results.stun==='ok'||results.turn==='ok')){
      h+='<div style="color:#40e060;margin-top:4px">🟢 <b>Ready to connect.</b> Use Create Room / Join Room.';
      if(results.peerjs!=='ok'&&results._cloudOk) h+='<br><span style="font-size:10px;opacity:.8">Tip: Switch to Default Cloud in server settings for best results.</span>';
      h+='</div>';
    }else if(_sigWorks&&results.stun==='partial'){
      h+='<div style="color:#e0a030;margin-top:4px">🟡 <b>Room codes work, but P2P may fail</b> if both users are behind strict NAT/firewalls. Options:<br>';
      h+='&nbsp;&nbsp;1. Configure a TURN server in Server Settings<br>';
      h+='&nbsp;&nbsp;2. Use Manual Connect as fallback</div>';
    }else if(results.peerjs!=='ok'&&(results.stun==='ok'||results.stun==='partial')){
      h+='<div style="color:#e0a030;margin-top:4px">🟡 <b>Signal server blocked but WebRTC works.</b> Options:<br>';
      h+='&nbsp;&nbsp;1. Set up a Custom Signal Server on your local network<br>';
      h+='&nbsp;&nbsp;2. Use Manual Connect (copy/paste codes)</div>';
    }else{
      h+='<div style="color:#ff4444;margin-top:4px">🔴 <b>Network is heavily restricted.</b><br>';
      h+='&nbsp;&nbsp;→ Use <b>Manual Connect</b> below. Exchange offer/answer codes verbally or via text message.<br>';
      h+='&nbsp;&nbsp;→ Both devices must be able to reach each other (same WiFi or VPN).</div>';
    }
    h+='</div>';
    out.innerHTML=h;
  }
  /* Test 1: WebRTC support */
  results.webrtc=!!(window.RTCPeerConnection);if(!results.webrtc){done=total;checkDone();return}
  /* Test 2: STUN connectivity */
  try{
    var pc2=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    var iceTypes={};var stunDone=false;
    var stunTimeout=setTimeout(function(){if(stunDone)return;stunDone=true;pc2.close();
      if(iceTypes.srflx||iceTypes.relay)results.stun='ok';
      else if(iceTypes.host)results.stun='partial';
      else results.stun='blocked';
      checkDone()},6000);
    pc2.onicecandidate=function(e){if(!e||!e.candidate)return;var tp=e.candidate.type;if(tp)iceTypes[tp]=true;
      if(tp==='srflx'&&!stunDone){stunDone=true;clearTimeout(stunTimeout);pc2.close();results.stun='ok';checkDone()}};
    pc2.createDataChannel('diag');pc2.createOffer().then(function(o){return pc2.setLocalDescription(o)}).catch(function(){if(!stunDone){stunDone=true;results.stun='blocked';checkDone()}});
  }catch(e){results.stun='blocked';checkDone()}
  /* Test 3: TURN relay (only if configured) */
  if(S._turnServer&&S._turnServer.host){
    try{
      var pc3=new RTCPeerConnection({iceServers:[{urls:'turn:'+S._turnServer.host+':'+(S._turnServer.port||3478),username:S._turnServer.user||'staffmaps',credential:S._turnServer.pass||'staffmaps'}],iceTransportPolicy:'relay'});
      var turnDone=false;
      var turnTimeout=setTimeout(function(){if(turnDone)return;turnDone=true;pc3.close();results.turn='blocked';checkDone()},8000);
      pc3.onicecandidate=function(e){if(!e||!e.candidate)return;if(e.candidate.type==='relay'&&!turnDone){turnDone=true;clearTimeout(turnTimeout);pc3.close();results.turn='ok';checkDone()}};
      pc3.createDataChannel('diag');pc3.createOffer().then(function(o){return pc3.setLocalDescription(o)}).catch(function(){if(!turnDone){turnDone=true;results.turn='blocked';checkDone()}});
    }catch(e){results.turn='blocked';checkDone()}
  }else{results.turn='skipped';checkDone()}
  /* Test 4: PeerJS signaling server reachability */
  var _hasCustomSig=S._signalServer&&S._signalServer.host&&S._signalServer.host.trim();
  var sigHost,sigPort,sigSecure;
  if(_hasCustomSig){sigHost=S._signalServer.host.trim();sigPort=S._signalServer.port||9000;sigSecure=!!S._signalServer.secure}
  else{sigHost='0.peerjs.com';sigPort=443;sigSecure=true}
  var sigUrl=(sigSecure?'https://':'http://')+sigHost+':'+sigPort+'/peerjs/id';
  var sigTimer=setTimeout(function(){results.peerjs='blocked';checkDone()},6000);
  fetch(sigUrl,{method:'GET',mode:'cors'}).then(function(r){clearTimeout(sigTimer);results.peerjs=r.ok?'ok':'blocked';checkDone()}).catch(function(){
    clearTimeout(sigTimer);
    /* If custom server failed, also test default PeerJS cloud */
    if(_hasCustomSig){
      var fallTimer=setTimeout(function(){results.peerjs='blocked';results._cloudOk=false;checkDone()},5000);
      fetch('https://0.peerjs.com:443/peerjs/id',{method:'GET',mode:'cors'}).then(function(r2){clearTimeout(fallTimer);results.peerjs='blocked';results._cloudOk=r2.ok;checkDone()}).catch(function(){clearTimeout(fallTimer);results.peerjs='blocked';results._cloudOk=false;checkDone()});
    }else{results.peerjs='blocked';checkDone()}
  });
}

function handleNetMsg(msg,fromPeer){
  /* Host: validate & relay edit messages to other peers */
  if(S._net.isHost&&fromPeer){
    var _editTypes=["unitAdd","unitEdit","unitDelete","graphicAdd","graphicEdit","graphicDelete","graphicReorder"];
    if(_editTypes.indexOf(msg.type)>=0){
      /* Validate: check peer has edit permission */
      var _perm=S._net.peerPermissions[fromPeer];
      if(!_perm||!_perm.canEdit)return;
      /* Validate: during wargame execution, peers cannot edit */
      var _wg=S._net.wargame;
      if(_wg.active&&_wg.phase==="execution")return;
      /* Validate: peer can only edit layers matching their wargame role */
      if(_wg.active){
        var _pRole=(_wg.roles[fromPeer]&&_wg.roles[fromPeer].role)||"observer";
        var _lid=null;
        if(msg.unit)_lid=msg.unit.layerId;
        else if(msg.graphic)_lid=msg.graphic.layerId;
        else if(msg.unitId){var _fu=S.units.find(function(x){return x.id===msg.unitId});if(_fu)_lid=_fu.layerId}
        else if(msg.graphicId){var _fg=S.graphics.find(function(x){return x.id===msg.graphicId});if(_fg)_lid=_fg.layerId}
        if(_lid){var _lr=_wg.layerRoles[_lid]||"all";
          if(_lr!=="all"&&_lr!==_pRole)return}
      }
      /* Relay to all other peers */
      var _str=JSON.stringify(msg);
      S._net.conns.forEach(function(c){if(c.peerId!==fromPeer)try{c.conn.send(_str)}catch(e){}});
    }
  }
  if(msg.type==="fullState"){S.units=(msg.units||[]).map(u=>sanitizeUnit(u)).filter(Boolean);S.graphics=(msg.graphics||[]).map(g=>sanitizeGraphic(g)).filter(Boolean);S.layers=(msg.layers||S.layers).slice(0,50);S.layers.forEach(l=>{l.name=sanitizeStr(l.name,INPUT_LIMITS.layerName)});if(msg.packages)S.packages=msg.packages.slice(0,100);if(msg.activeLayerId)S.activeLayerId=msg.activeLayerId;S._net.editMode=msg.editMode||"observer";if(msg.sharedLayers)S._net.sharedLayers=msg.sharedLayers;if(msg.sharedEditLayer){S._net.sharedEditLayer=msg.sharedEditLayer;const el=S.layers.find(x=>x.id===msg.sharedEditLayer);if(el){setTimeout(()=>{if(confirm("Host is sharing '"+escHtml(el.name)+"' as primary edit layer. Switch to it and edit in room?")){S.activeLayerId=msg.sharedEditLayer;S._net.editScope="room";updateLayerIndicator();renderFloatingPanel()}},300)}}requestRender();updateLayerIndicator()}
  else if(msg.type==="sharedConfig"){
    const n=S._net;n.sharedLayers=msg.sharedLayers||{};n.sharedEditLayer=msg.sharedEditLayer||null;n.editMode=msg.editMode||"observer";
    /* Merge shared layers — add/update layers that host is sharing */
    if(msg.layers)msg.layers.forEach(l=>{const existing=S.layers.find(x=>x.id===l.id);if(existing){Object.assign(existing,{name:l.name,visible:l.visible})}else{S.layers.push({...l})}});
    /* Merge shared units */
    if(msg.units)msg.units.forEach(u=>{const idx=S.units.findIndex(x=>x.id===u.id);if(idx>=0)S.units[idx]=u;else S.units.push(u)});
    /* Merge shared graphics */
    if(msg.graphics)msg.graphics.forEach(g=>{const idx=S.graphics.findIndex(x=>x.id===g.id);if(idx>=0)S.graphics[idx]=g;else S.graphics.push(g)});
    /* Prompt user to switch to shared edit layer */
    if(n.sharedEditLayer){
      const el=S.layers.find(x=>x.id===n.sharedEditLayer);
      if(el&&S.activeLayerId!==n.sharedEditLayer){
        if(confirm("Host is sharing '"+escHtml(el.name)+"' for editing. Switch to it?")){S.activeLayerId=n.sharedEditLayer;updateLayerIndicator()}
      }
    }
    requestRender();renderFloatingPanel();notify("Received shared layers")}
  else if(msg.type==="roster"){
    /* Peer receives room roster from host */
    S._net.roomRoster=msg.roster||[];
    if(msg.roomCode)S._net.roomCode=msg.roomCode;
    /* Find our own joinOrder for host migration priority */
    var myPeerId=S._net.peer?S._net.peer.id:null;
    var myEntry=msg.roster.find(function(r){return r.peerId===myPeerId});
    if(myEntry)S._net._myJoinOrder=myEntry.joinOrder;
    renderFloatingPanel()}
  else if(msg.type==="editRequest"){
    /* Host receives edit request from peer */
    const n=S._net;n.editRequests.push({peerId:fromPeer,name:msg.name||"Peer",ts:Date.now(),status:"pending"});
    notify((msg.name||"Peer")+" requests edit access");
    renderFloatingPanel()}
  else if(msg.type==="editRequestResult"){
    /* Peer receives response from host */
    S._net.editRequestStatus=msg.approved?"approved":"denied";
    if(msg.approved)S._net.editScope="room";
    notify(msg.approved?"Edit access granted":"Edit access denied",msg.approved?undefined:"error");
    renderFloatingPanel()}
  else if(msg.type==="permissionUpdate"){
    /* Peer receives permission change from host */
    S._net.editRequestStatus=msg.canEdit?"approved":null;
    if(msg.canEdit)S._net.editScope="room";
    notify(msg.canEdit?"Edit access granted":"Edit access revoked");
    renderFloatingPanel()}
  else if(msg.type==="ping"){
    /* Peer receives ping from host — respond with pong */
    S._net._lastHostPing=Date.now();
    if(S._net.hostConn)try{S._net.hostConn.send(JSON.stringify({type:"pong"}))}catch(e){}}
  else if(msg.type==="pong"){
    /* Host receives pong from peer — update last seen */
    if(fromPeer){var _pc=S._net.conns.find(function(c){return c.peerId===fromPeer||c.conn.peer===fromPeer});
    if(_pc){_pc._lastPong=Date.now();_pc._dead=false}}}
  else if(msg.type==="hello"){S._net.peerNames[fromPeer]=sanitizeStr(msg.name||"Peer",INPUT_LIMITS.callsign);
    /* Assign default permission on join */
    if(S._net.isHost){
      S._net.peerPermissions[fromPeer]={canEdit:S._net.defaultJoinMode!=="view"};
      const c=S._net.conns.find(x=>x.peerId===fromPeer);
      if(c)try{c.conn.send(JSON.stringify({type:"permissionUpdate",canEdit:S._net.peerPermissions[fromPeer].canEdit}))}catch(e){}
      broadcastRoster();
    }
    renderFloatingPanel()}
  else if(msg.type==="unitAdd"){if(msg.unit&&sanitizeUnit(msg.unit)&&!S.units.find(u=>u.id===msg.unit.id))S.units.push(msg.unit);requestRender()}
  else if(msg.type==="unitEdit"){if(msg.unit&&sanitizeUnit(msg.unit)){const idx=S.units.findIndex(u=>u.id===msg.unit.id);if(idx>=0)Object.assign(S.units[idx],msg.unit);else S.units.push(msg.unit)}requestRender()}
  else if(msg.type==="unitDelete"){S.units=S.units.filter(u=>u.id!==msg.unitId);requestRender()}
  else if(msg.type==="graphicAdd"){if(msg.graphic&&sanitizeGraphic(msg.graphic)&&!S.graphics.find(g=>g.id===msg.graphic.id))S.graphics.push(msg.graphic);requestRender()}
  else if(msg.type==="graphicEdit"){if(msg.graphic&&sanitizeGraphic(msg.graphic)){const idx=S.graphics.findIndex(g=>g.id===msg.graphic.id);if(idx>=0)S.graphics[idx]=msg.graphic}requestRender()}
  else if(msg.type==="graphicDelete"){S.graphics=S.graphics.filter(g=>g.id!==msg.graphicId);requestRender()}
  else if(msg.type==="graphicReorder"&&msg.order){var _om={};msg.order.forEach(function(id,i){_om[id]=i});S.graphics.sort(function(a,b){return(_om[a.id]||9999)-(_om[b.id]||9999)});requestRender()}
  else if(msg.type==="editModeChange"){S._net.editMode=msg.editMode;renderFloatingPanel()}
  else if(msg.type==="chat"){
    S._net.chatMessages.push({from:fromPeer,fromName:msg.fromName,to:msg.to,text:msg.text,ts:Date.now()});
    if(S._activePanel!=="chat")S._net.unreadCount++;
    updateChatBadge();
    if(S._activePanel==="chat")renderFloatingPanel();
    if(S._net.isHost){
      if(msg.to==="room"){
        /* Room message — relay to all other peers */
        S._net.conns.forEach(function(c){if(c.peerId!==fromPeer)try{c.conn.send(JSON.stringify(msg))}catch(e){}});
      }else if(msg.to!=="dm_host"){
        /* DM to a specific peer — forward it */
        var _dc=S._net.conns.find(function(c){return c.peerId===msg.to});
        if(_dc)try{_dc.conn.send(JSON.stringify(msg))}catch(e){}
      }
      /* If msg.to==="dm_host", it's a DM to the host — already stored, no relay needed */
    }
    /* Auto-scroll */
    setTimeout(function(){var el=document.getElementById("chat-messages");if(el)el.scrollTop=el.scrollHeight},50);
  }
  /* Wargame messages */
  else if(msg.type==="wargameState"){
    /* Peer receives wargame state from host */
    var wg=S._net.wargame;var wasActive=wg.active;
    wg.active=msg.active;wg.phase=msg.phase;wg.turnNumber=msg.turnNumber;
    wg.myRole=msg.myRole;wg.layerRoles=msg.layerRoles||{};
    wg.orders=msg.orders||[];wg.roles=msg.roles||{};
    if(!wasActive&&wg.active)notify("Wargame started! You are "+(wg.myRole==="blufor"?"BLUFOR":wg.myRole==="opfor"?"OPFOR":"Observer"));
    else if(wasActive&&!wg.active)notify("Wargame ended");
    requestRender();renderFloatingPanel()}
  else if(msg.type==="wargameOrder"){
    /* Host receives order from player */
    if(S._net.isHost){var wg2=S._net.wargame;if(!wg2.active)return;
      /* Set the role from the peer's assigned role */
      var pRole=(wg2.roles[fromPeer]&&wg2.roles[fromPeer].role)||"observer";
      msg.order.role=pRole;msg.order.peerId=fromPeer;
      wg2.orders.push(msg.order);
      notify("New order from "+(S._net.peerNames[fromPeer]||"Peer"));
      requestRender();renderFloatingPanel()}}
  else if(msg.type==="wargameOrderCancel"){
    if(S._net.isHost){var wg3=S._net.wargame;
      wg3.orders=wg3.orders.filter(function(o){return o.id!==msg.orderId});
      requestRender();renderFloatingPanel()}}
}
function updateNetDot(state){const dot=document.querySelector(".topbar-dot");if(dot)dot.className="topbar-dot"+(state?" "+state:"");const cb=document.getElementById("sb-comms");if(cb){cb.classList.remove("conn-blue","conn-green");if(S._net.mode==="hosting")cb.classList.add("conn-green");else if(S._net.mode==="connected")cb.classList.add("conn-blue")}}

// ─── FILE I/O ────────────────────────────
function dlBlob(blob,name){
  /* iOS PWA: blob downloads don't work in standalone mode, use Web Share API */
  var isStandalone=window.navigator.standalone||window.matchMedia("(display-mode:standalone)").matches;
  if(isStandalone&&navigator.canShare&&navigator.canShare({files:[new File([blob],name)]})){
    navigator.share({files:[new File([blob],name,{type:blob.type})]}).catch(function(){});return}
  var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=name;document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(a.href)},100)}
function _u8ToB64(u8){var CHUNK=0x8000;var parts=[];for(var i=0;i<u8.length;i+=CHUNK){parts.push(String.fromCharCode.apply(null,u8.subarray(i,Math.min(i+CHUNK,u8.length))))}return btoa(parts.join(""))}
const IO={
  isNative(){return!!window.nativeBridge},
  notify(msg,type){notify(msg,type)},
  projectSave(){
    const data={version:"3.0",app:"StaffMaps",timestamp:new Date().toISOString(),map:{lat:S.lat,lon:S.lon,zoom:S.zoom,tileSource:S.tileSource},units:S.units,graphics:S.graphics,layers:S.layers,packages:S.packages};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    dlBlob(blob,"staffmaps-"+new Date().toISOString().slice(0,10)+".tacmap");IO.notify("Project saved")},
  projectLoad(text){
    try{const data=JSON.parse(text);if(data.units)S.units=data.units.slice(0,2000).map(u=>sanitizeUnit(u)).filter(Boolean);if(data.graphics)S.graphics=data.graphics.slice(0,1000).map(g=>sanitizeGraphic(g)).filter(Boolean);if(data.layers){S.layers=data.layers.slice(0,50);S.layers.forEach(l=>{l.name=sanitizeStr(l.name,INPUT_LIMITS.layerName)})}if(data.packages)S.packages=data.packages.slice(0,100);if(data.map){S.lat=data.map.lat;S.lon=data.map.lon;S.zoom=data.map.zoom;if(data.map.tileSource)S.tileSource=data.map.tileSource}requestRender();updateLayerIndicator();IO.notify("Project loaded: "+S.units.length+" units")}catch(e){IO.notify("Load error: "+e.message,"error")}},
  requestImport(){
    if(IO.isNative()){window.nativeBridge.requestImport();return}
    const inp=document.createElement("input");inp.type="file";inp.accept=".tacmap,.geojson,.kml,.kmz,.milx,.milxly,.milxlyz,.json,application/vnd.google-earth.kmz,application/vnd.google-earth.kml+xml,application/geo+json,application/json,application/octet-stream";inp.style.cssText="position:fixed;top:-9999px;left:-9999px;opacity:0";inp.onchange=e=>{const f=e.target.files[0];if(inp.parentNode)inp.parentNode.removeChild(inp);if(!f)return;const ext=f.name.split(".").pop().toLowerCase();if(ext==="kmz"||ext==="milxlyz"){f.arrayBuffer().then(buf=>{if(ext==="milxlyz")IO.importMilXZ(buf);else IO.importKMZ(buf)}).catch(e=>IO.notify("Import error: "+e.message,"error"));return}const reader=new FileReader();reader.onload=ev=>{if(ext==="tacmap"||ext==="json")IO.projectLoad(ev.target.result);else if(ext==="geojson")IO.importGeoJSON(ev.target.result);else if(ext==="kml")IO.importKML(ev.target.result);else if(ext==="milx"||ext==="milxly")IO.importMilX(ev.target.result);else IO.notify("Unsupported file type","error")};reader.readAsText(f)};document.body.appendChild(inp);inp.click()},
  importGeoJSON(text){try{const fc=JSON.parse(text);let errors=0;const importLayerId="l"+Date.now();S.layers.push({id:importLayerId,name:"Import: GeoJSON",visible:true,hasErrors:false});S.activeLayerId=importLayerId;if(fc.features)fc.features.slice(0,2000).forEach(f=>{if(f.geometry&&f.geometry.type==="Point"){const[lon,lat]=f.geometry.coordinates;const p=f.properties||{};if(isNaN(lat)||isNaN(lon)){errors++;return}const nu={id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat,lon,type:p.type||"infantry",affiliation:p.affiliation||"friendly",echelon:p.echelon||null,designation:sanitizeStr(p.designation||p.name||"",INPUT_LIMITS.designation),modifiers:[],isHQ:false,layerId:importLayerId,rings:[],equipment:{}};if(sanitizeUnit(nu))S.units.push(nu)}else{errors++}});if(errors>0){const il=S.layers.find(x=>x.id===importLayerId);if(il)il.hasErrors=true}requestRender();updateLayerIndicator();renderFloatingPanel();IO.notify("Imported "+(fc.features?Math.min(fc.features.length,2000)-errors:0)+" features"+(errors?" ("+errors+" skipped)":""))}catch(e){IO.notify("GeoJSON error: "+e.message,"error")}},
  importMilX(text){
    /* MilX / map.army format (.milxly uncompressed, .milxlyz = ZIP of .milxly)
       Real structure from map.army V3.1:
         <MilXDocument_Layer>
           <MilXLayer>
             <name>Layer Name</name>
             <GraphicList>
               <MilXGraphic>
                 <MssStringXML>&lt;Symbol ID="SHGPUCIL-------"/&gt;</MssStringXML>
                 <PointList>
                   <Point><X>lon</X><Y>lat</Y></Point>  (WGS84, X=lon Y=lat)
                 </PointList>
               </MilXGraphic>
             </GraphicList>
             <CoordSystemType>WGS84</CoordSystemType>
           </MilXLayer>
         </MilXDocument_Layer>
       SIDC char[1]: F/G=friendly H/J/K=hostile N=neutral U/P/W=unknown
       Single-point graphics = unit symbols
       Multi-point graphics = tactical graphics (lines, areas) */
    try{
      const parser=new DOMParser(),doc=parser.parseFromString(text,"text/xml");
      if(doc.querySelector("parsererror"))throw new Error("Invalid MilX XML");
      function getDirectText(el,tag){
        /* Only direct children, not deep descendants */
        for(var i=0;i<el.children.length;i++){if(el.children[i].tagName===tag)return el.children[i].textContent.trim()}return""
      }
      function extractSIDC(mssXml){
        /* MssStringXML contains HTML-escaped XML like: <Symbol ID="SHGPUCIL-------"/> */
        if(!mssXml)return"";
        var m=mssXml.match(/ID=["']([^"']+)["']/);
        return m?m[1]:"";
      }
      function sidcToAff(sidc){
        if(!sidc||sidc.length<2)return"friendly";
        var ch=(sidc[1]||"").toUpperCase();
        if(ch==="H"||ch==="J"||ch==="K")return"hostile";
        if(ch==="N")return"neutral";
        if(ch==="U"||ch==="P"||ch==="W")return"unknown";
        return"friendly";
      }
      function sidcToType(sidc){
        /* Letter SIDC 2525C: pos 0=scheme, 1=affiliation, 2=battle dim, 3=status, 4-9=function ID */
        if(!sidc)return"infantry";
        if(sidc[0]==="G"||sidc[0]==="g")return"_tacgraphic";
        var fn=(sidc.substring(4,10)||"").toUpperCase().replace(/-/g,"");
        var tbl={
          /* Infantry */
          UCIL:"infantry",UCIN:"infantry",UCI:"infantry",UC:"infantry",
          UCIA:"infantry",UCIB:"infantry",
          /* Mech / Motorized Infantry */
          UCIZ:"mechanized_infantry",UCIM:"mechanized_infantry",
          UCIS:"armored_wheeled",
          UCIR:"armored_recon",UCIC:"cavalry",
          /* Naval Infantry / Marines */
          UCIZ:"mechanized_infantry",UCDM:"naval_infantry",
          /* Armor */
          UA:"armor",UAUL:"armor",UAC:"armor",UCD:"armor",
          UAUW:"armored_wheeled",UAUR:"armored_recon",UAR:"armored_recon",
          /* Aviation */
          UDAF:"attack_aviation",UDA:"attack_aviation",
          UDAR:"recon_aviation",UDM:"medevac_aviation",
          UD:"aviation",
          /* UAV / UAS */
          UCDMR:"uav",UCDR:"uav",MFQ:"uav",MFU:"uav",
          /* Engineer */
          UE:"engineer",UEB:"bridging",
          /* Artillery & Fire Support */
          UFAA:"artillery",UFA:"artillery",UF:"artillery",
          UFBA:"mechanized_artillery",
          UFCA:"rocket_artillery",UFC:"mortar",
          UFB:"air_defense",UFDB:"air_defense",
          UFD:"anti_armor",
          /* SAM */
          UFE:"sam",UFED:"sam",
          /* Command & Signal */
          USHQ:"headquarters",
          USC:"signal",USM:"signal",
          USE:"electronic_warfare",
          USIA:"military_intelligence",USI:"military_intelligence",
          /* Logistics */
          US:"sustainment",USS:"supply",USX:"maintenance",
          UST:"transportation",
          UH:"medical",UHS:"medical",
          /* Ordnance */
          USO:"ordnance",
          /* Special */
          UCFA:"special_forces",UCF:"special_forces",
          UCFR:"ranger",
          UCFCA:"civil_affairs",
          UCFP:"psyop"
        };
        for(var l=6;l>=2;l--){var k=fn.substring(0,l);if(tbl[k])return tbl[k]}
        return"infantry";
      }
      function sidcToEchelon(sidc){
        /* Echelon at position 11 in 15-char letter SIDC */
        if(!sidc||sidc.length<12)return null;
        var ch=sidc[11].toUpperCase();
        var map={A:"team",B:"squad",C:"section",D:"platoon",E:"company",
                 F:"battalion",G:"regiment",H:"brigade",I:"division",J:"corps",K:"army"};
        return map[ch]||null;
      }
      /* Color mapping for tactical graphics affiliation */
      var TACGFX_COLORS={H:"#ff4444",J:"#ff4444",K:"#ff4444",N:"#00cc00",F:"#4a9eff",G:"#4a9eff",U:"#ffff00",P:"#ffff00"};
      function sidcToColor(sidc){
        if(!sidc)return"#f44";
        return TACGFX_COLORS[(sidc[1]||"").toUpperCase()]||"#f44";
      }
      var mlayers=doc.getElementsByTagName("MilXLayer");
      if(mlayers.length===0)throw new Error("No MilXLayer elements found");
      var count=0,errors=0,importedLayerIds=[],pkgLayerIds=[];
      var docName=getDirectText(doc.documentElement,"n")||"MilX Import";
      for(var li=0;li<mlayers.length;li++){
        var layer=mlayers[li];
        var lname=getDirectText(layer,"n")||("Layer "+(li+1));
        var layerId="l"+Date.now()+Math.random().toString(36).substr(2,4);
        S.layers.push({id:layerId,name:sanitizeStr(lname,INPUT_LIMITS.layerName||64),visible:true,hasErrors:false,collapsed:true});
        var graphics=layer.getElementsByTagName("MilXGraphic");
        var layerImported=0,layerErrors=0;
        for(var gi=0;gi<graphics.length;gi++){
          var gfx=graphics[gi];
          var mssRaw=getDirectText(gfx,"MssStringXML");
          var sidc=extractSIDC(mssRaw);
          /* Collect points */
          var ptEls=gfx.querySelectorAll("PointList > Point");
          if(ptEls.length===0){layerErrors++;errors++;continue}
          var points=[];
          for(var pi=0;pi<ptEls.length;pi++){
            var xe=ptEls[pi].querySelector("X"),ye=ptEls[pi].querySelector("Y");
            if(!xe||!ye){continue}
            var lon=parseFloat(xe.textContent),lat=parseFloat(ye.textContent);
            if(isNaN(lat)||isNaN(lon)){continue}
            points.push({lat,lon});
          }
          if(points.length===0){layerErrors++;errors++;continue}
          var type=sidcToType(sidc);
          var aff=sidcToAff(sidc);
          if(type==="_tacgraphic"||points.length>1){
            /* Multi-point or tactical graphic symbol — import as graphic */
            var tool=points.length===1?"circle":points.length===2?"line":"polygon";
            /* Refine tool by SIDC category */
            if(sidc&&sidc[0]==="G"){
              var cat=(sidc[2]||"").toUpperCase();
              /* T=task, M=mobility/obstacle, F=fire support, O=other */
              if(points.length===2)tool="line";
              else if(points.length>=3)tool="polygon";
              else tool="circle";
            }
            var col=sidcToColor(sidc);
            var g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),
              tool,points,color:col,lineWidth:2,lineStyle:"solid",
              overlayType:"none",fill:tool==="polygon",fillColor:col,fillOpacity:0.15,
              label:"",layerId,arrowSize:1,rotation:0};
            S.graphics.push(g);count++;layerImported++;
          }else{
            /* Single-point unit symbol */
            var nu={id:"u"+Date.now()+Math.random().toString(36).substr(2,4),
              lat:points[0].lat,lon:points[0].lon,
              type,affiliation:aff,
              echelon:sidcToEchelon(sidc),
              designation:sanitizeStr("",INPUT_LIMITS.designation||32),
              modifiers:[],isHQ:false,layerId,rings:[],equipment:{},sidc};
            if(sanitizeUnit(nu)){S.units.push(nu);count++;layerImported++}
            else{layerErrors++;errors++}
          }
        }
        if(layerImported>0){
          importedLayerIds.push(layerId);pkgLayerIds.push(layerId);
          if(layerErrors>0){var el=S.layers.find(x=>x.id===layerId);if(el)el.hasErrors=true}
        }else{S.layers=S.layers.filter(l=>l.id!==layerId)}
      }
      if(pkgLayerIds.length>1){
        S.packages.push({id:"pkg"+Date.now(),name:docName,collapsed:false,layerIds:pkgLayerIds});
      }
      if(importedLayerIds.length>0)S.activeLayerId=importedLayerIds[importedLayerIds.length-1];
      requestRender();updateLayerIndicator();renderFloatingPanel();
      IO.notify("Imported "+count+" MilX objects"+(errors?" ("+errors+" skipped)":""))
    }catch(e){IO.notify("MilX error: "+e.message,"error")}},
  importMilXZ(buf){
    /* Decompress .milxlyz (ZIP) then call importMilX on the inner .milxly XML */
    try{
      var JSZip=window.JSZip;
      if(typeof JSZip==="undefined"){
        /* Inline ZIP reader using browser's DecompressionStream if available, else fflate */
        IO._unzipFirst(buf,function(xmlText){IO.importMilX(xmlText)});return;
      }
      JSZip.loadAsync(buf).then(function(zip){
        var entries=Object.keys(zip.files).filter(n=>n.endsWith(".milxly"));
        if(!entries.length){IO.notify("No .milxly in archive","error");return}
        zip.files[entries[0]].async("string").then(function(txt){IO.importMilX(txt)});
      }).catch(function(e){IO.notify("MilX zip error: "+e.message,"error")});
    }catch(e){IO.notify("MilXZ error: "+e.message,"error")}},
  _unzipFirst(buf,cb){
    /* Use fflate (bundled in app) or fall back to manual ZIP parse */
    if(typeof fflate!=="undefined"){
      try{
        var u=new fflate.Unzip();var found=false;
        u.register(fflate.UnzipInflate);
        u.onfile=function(f){
          if(!found&&f.name.endsWith(".milxly")){found=true;var chunks=[];
            f.ondata=function(err,chunk,final){if(!err)chunks.push(chunk);if(final){var merged=new Uint8Array(chunks.reduce((s,c)=>s+c.length,0));var off=0;chunks.forEach(c=>{merged.set(c,off);off+=c.length});cb(new TextDecoder().decode(merged))}};f.start()}};
        u.push(new Uint8Array(buf),true);return;
      }catch(e){}
    }
    /* Manual PKZIP local file header parse — works for stored/deflate entries */
    try{
      var dv=new DataView(buf),i=0;
      while(i<buf.byteLength-30){
        if(dv.getUint32(i,true)!==0x04034b50){i++;continue}
        var flags=dv.getUint16(i+6,true);
        var comp=dv.getUint16(i+8,true);
        var csize=dv.getUint32(i+18,true);
        var usize=dv.getUint32(i+22,true);
        var fnlen=dv.getUint16(i+26,true);
        var exlen=dv.getUint16(i+28,true);
        var fname=new TextDecoder().decode(new Uint8Array(buf,i+30,fnlen));
        var dataStart=i+30+fnlen+exlen;
        if(fname.endsWith(".milxly")){
          if(comp===0){/* stored */
            cb(new TextDecoder().decode(new Uint8Array(buf,dataStart,usize)));return;
          }else if(comp===8){/* deflate */
            var raw=new Uint8Array(buf,dataStart,csize);
            if(typeof DecompressionStream!=="undefined"){
              var ds=new DecompressionStream("deflate-raw");
              var writer=ds.writable.getWriter();
              var reader=ds.readable.getReader();
              var chunks=[];
              function pump(){reader.read().then(function(r){if(r.done){var m=new Uint8Array(chunks.reduce((s,c)=>s+c.length,0));var off=0;chunks.forEach(c=>{m.set(c,off);off+=c.length});cb(new TextDecoder().decode(m))}else{chunks.push(r.value);pump()}})}
              pump();writer.write(raw);writer.close();return;
            }
          }
        }
        i=dataStart+Math.max(csize,usize||0)||i+1;
      }
      IO.notify("Could not extract .milxly from archive","error");
    }catch(e){IO.notify("ZIP parse error: "+e.message,"error")}},
  importKML(text,embeddedFiles){try{const parser=new DOMParser(),doc=parser.parseFromString(text,"text/xml");
    let count=0,errors=0;const _embeddedFiles=embeddedFiles||{};
    /* Affiliation detection from name, description, or style */
    /* Resolve a KML styleUrl to find the actual Style element */
    function resolveStyle(pm){
      var s=pm.querySelector("Style");if(s)return s;
      var su=(pm.getElementsByTagName("styleUrl")[0]||{}).textContent||"";if(!su)return null;
      var sid=su.replace(/^#/,"");
      var styles=doc.getElementsByTagName("Style");
      for(var i=0;i<styles.length;i++){if(styles[i].getAttribute("id")===sid)return styles[i]}
      var maps=doc.getElementsByTagName("StyleMap");
      for(var i=0;i<maps.length;i++){if(maps[i].getAttribute("id")===sid){
        var pairs=maps[i].getElementsByTagName("Pair");
        for(var j=0;j<pairs.length;j++){var key=(pairs[j].getElementsByTagName("key")[0]||{}).textContent||"";
          if(key==="normal"){var psu=(pairs[j].getElementsByTagName("styleUrl")[0]||{}).textContent||"";var psid=psu.replace(/^#/,"");
            for(var k=0;k<styles.length;k++){if(styles[k].getAttribute("id")===psid)return styles[k]}}}}}
      return null}
    function extractKmlColor(styleEl,types){
      if(!styleEl)return null;
      for(var t=0;t<types.length;t++){var els=styleEl.getElementsByTagName(types[t]);if(!els.length)continue;
        var ce=els[0].getElementsByTagName("color")[0];if(!ce)continue;var kc=ce.textContent.trim();
        if(kc.length===8){var r=parseInt(kc.substr(6,2),16),g=parseInt(kc.substr(4,2),16),b=parseInt(kc.substr(2,2),16),a=parseInt(kc.substr(0,2),16);
          if(!isNaN(r)&&!isNaN(g)&&!isNaN(b))return{r:r,g:g,b:b,a:a,hex:"#"+("0"+r.toString(16)).slice(-2)+("0"+g.toString(16)).slice(-2)+("0"+b.toString(16)).slice(-2)}}}
      return null}
    function extractKmlLineWidth(s){if(!s)return null;var ls=s.getElementsByTagName("LineStyle");if(!ls.length)return null;var w=ls[0].getElementsByTagName("width")[0];if(!w)return null;var v=parseFloat(w.textContent);return(!isNaN(v)&&v>0)?v:null}
    function extractKmlFillOpacity(s){if(!s)return null;var ps=s.getElementsByTagName("PolyStyle");if(!ps.length)return null;var ce=ps[0].getElementsByTagName("color")[0];if(!ce)return null;var kc=ce.textContent.trim();if(kc.length!==8)return null;var a=parseInt(kc.substr(0,2),16);return isNaN(a)?null:a/255}
    function resolveIconHref(pm){var style=resolveStyle(pm);if(!style)return null;var is=style.getElementsByTagName("IconStyle");if(!is.length)return null;var icon=is[0].getElementsByTagName("Icon");if(!icon.length)return null;var href=icon[0].getElementsByTagName("href");if(!href.length)return null;var h=href[0].textContent.trim();if(!h||/maps\.google\.com|earth\.google\.com/i.test(h))return null;if(_embeddedFiles[h])return _embeddedFiles[h];var bn=h.split("/").pop();for(var k in _embeddedFiles){if(k.split("/").pop()===bn)return _embeddedFiles[k]}return null}
    function parseCot(descText){
      if(!descText)return null;
      /* Match CoT codes in WinTAK format: COT:</b> a-h-G-U-C-I-Z/h-g-i-g-o  OR  plain: COT: a-h-G-U-C-I-Z */
      var m=descText.match(/COT:<\/b>\s*([a-zA-Z\-\/]+)/)||descText.match(/\bCOT:\s*([a-zA-Z\-\/]+)/);
      if(!m)return null;
      var cot=m[1],mainPart=cot.split("/")[0],segs=mainPart.split("-");
      var result={affiliation:null,type:null,raw:cot};
      var affMap={f:"friendly",h:"hostile",n:"neutral",u:"unknown",j:"hostile",k:"hostile",s:"unknown"};
      if(segs.length>=2)result.affiliation=affMap[segs[1]]||null;
      var funcCode=null;if(segs.length>=5&&segs[2]==="G"&&(segs[3]==="U"||segs[3]==="E"))funcCode=segs.slice(4).join("-");
      if(!funcCode)return result;
      var cotMap={
        /* Combat Arms */
        "C-A":"armor","C-A-T":"armor","C-A-W":"armor","C-A-A":"armor","C-A-A-A-W":"anti_armor",
        "C-D":"air_defense","C-D-C":"air_defense","C-D-G":"air_defense","C-D-S":"short_range_air_defense",
        "C-D-M":"sam","C-D-M-L":"sam","C-D-M-H":"sam","C-D-M-S":"sam",
        "C-E":"engineer","C-E-C":"engineer","C-E-C-S":"engineer",
        "C-F":"artillery","C-F-H":"artillery","C-F-H-L":"artillery","C-F-H-M":"artillery","C-F-H-H":"artillery",
        "C-F-M":"mortar","C-F-M-S":"mortar","C-F-M-W":"mortar","C-F-M-L":"mortar",
        "C-F-R":"rocket_artillery","C-F-R-S":"rocket_artillery","C-F-R-L":"rocket_artillery",
        "C-I":"infantry","C-I-A":"infantry","C-I-L":"infantry",
        "C-I-M":"mechanized_infantry","C-I-Z":"mechanized_infantry",
        "C-I-d":"cavalry","C-I-r":"infantry",
        "C-R":"cavalry","C-R-A":"cavalry","C-R-C":"cavalry","C-R-S":"armored_recon",
        "C-S":"special_forces","C-S-F":"special_forces","C-S-R":"ranger",
        "C-B":"chemical",
        /* Combat Support */
        "C-A-T-W":"aviation","C-A-T-W-U":"uav","C-A-A":"attack_aviation","C-A-R":"recon_aviation",
        /* Combat Service Support */
        "U-S":"signal","U-S-M":"maintenance","U-S-S":"supply",
        "U-M":"medical","U-M-R-W":"medevac_aviation",
        "U-E":"engineer","U-L":"sustainment","U-O":"ordnance","U-T":"transportation",
        "U-I":"military_intelligence","U-P-M":"military_police","U-P-S":"psyop","U-C-A":"civil_affairs",
        /* Electronic Warfare / Sensor */
        "S-R":"electronic_warfare","S-E":"electronic_warfare",
        /* Installations & Facilities */
        "I-H":"headquarters","I-S":"supply"
      };
      var parts=funcCode.split("-");for(var len=parts.length;len>=1;len--){var tc=parts.slice(0,len).join("-");if(cotMap[tc]){result.type=cotMap[tc];break}}
      return result}
    function detectAff(pm,folderName){
      var txt=((pm.getElementsByTagName("name")[0]||{}).textContent||"")+" "+((pm.getElementsByTagName("description")[0]||{}).textContent||"")+" "+(folderName||"");
      var anc=pm.parentElement;while(anc){if(anc.tagName==="Folder"||anc.tagName==="Document"){var an=null;for(var ac=0;ac<anc.children.length;ac++){if(anc.children[ac].tagName==="name"){an=anc.children[ac].textContent;break}}if(an)txt+=" "+an}anc=anc.parentElement}
      var h2m=txt.match(/<h2>\s*(Hostile|Friendly|Neutral|Unknown)\s*\\/i);
      if(h2m){var a=h2m[1].toLowerCase();return a==="hostile"?"hostile":a==="friendly"?"friendly":a==="neutral"?"neutral":"unknown"}
      var lower=txt.toLowerCase();
      if(/hostile|enemy|\ben\s*forces?\b|opfor|threat|irregular\s*forces|paramilitary|insurgent|militia|communist/i.test(lower))return"hostile";
      if(/neutral|civilian/i.test(lower))return"neutral";
      if(/unknown|pending/i.test(lower))return"unknown";
      var su=(pm.getElementsByTagName("styleUrl")[0]||{}).textContent||"";
      if(/red|hostile|enemy/i.test(su))return"hostile";if(/blue|friendly/i.test(su))return"friendly";
      var style=resolveStyle(pm);var col=extractKmlColor(style,["IconStyle","LineStyle","PolyStyle"]);
      if(col){if(col.r>180&&col.g<100&&col.b<100)return"hostile";if(col.b>180&&col.r<100)return"friendly";if(col.g>180&&col.r<100&&col.b<100)return"neutral";if(col.r>180&&col.g>180&&col.b<100)return"unknown"}
      return"friendly";
    }
    /* Parse unit text for structured fields: type, echelon, designation, parentUnit */
    function parseUnitText(raw){
      const result={type:"infantry",echelon:null,designation:"",parentUnit:"",higherUnit:"",isHQ:false,importNotes:"",parsed:[]};
      if(!raw)return result;
      const orig=raw.trim();
      /* Echelon patterns — order matters (longer first) */
      const echMap=[
        [/\bARMY\s*GP?\b/,"army_group"],[/\bTHEATER\b/,"theater"],[/\bCORPS\b/,"corps"],
        [/\bDIV\b/,"division"],[/\bBDE\b/,"brigade"],[/\bREGT?\b/,"regiment"],[/\bGP\b/,"regiment"],
        [/\bBN\b/,"battalion"],[/\bSQDN\b/,"battalion"],[/\bCO\b/,"company"],[/\bTRP\b/,"company"],[/\bBTRY\b/,"company"],
        [/\bPLT\b/,"platoon"],[/\bSEC(?:T)?\b/,"section"],[/\bSQD\b/,"squad"],[/\bTM\b/,"team"]
      ];
      /* Unit type patterns */
      const typeMap=[
        [/\bRECON\b/,"cavalry"],[/\bCAV\b/,"cavalry"],[/\bSCOUT\b/,"cavalry"],
        [/\bINF\b/,"infantry"],[/\bRIFLE\b/,"infantry"],
        [/\bMECH\s*INF\b/,"mechanized_infantry"],[/\bMECH\b/,"mechanized_infantry"],[/\bMECHANIZED\b/,"mechanized_infantry"],
        [/\bAR(?:MOR)?\b/,"armor"],[/\bTANK\b/,"armor"],
        [/\bFA\b/,"artillery"],[/\bARTY\b/,"artillery"],[/\bART(?:ILLERY)?\b/,"artillery"],
        [/\bMORTAR\b/,"mortar"],[/\bMTR\b/,"mortar"],
        [/\bADA\b/,"air_defense"],[/\bAIR\s*DEF/,"air_defense"],
        [/\bSAM\b/,"sam"],[/\bSURFACE.{0,3}AIR.{0,3}MIS/i,"sam"],[/\bPATRIOT\b/i,"sam"],[/\bSTINGER\b/i,"sam"],[/\bAVENGER\b/i,"sam"],
        [/\bAVN\b/,"aviation"],[/\bATK\s*AVN\b/,"attack_aviation"],
        [/\bENG\b/,"engineer"],[/\bENGINEER\b/,"engineer"],
        [/\bSIG\b/,"signal"],[/\bSIGNAL\b/,"signal"],
        [/\bMI\b/,"military_intelligence"],[/\bINTEL\b/,"military_intelligence"],
        [/\bEW\b/,"electronic_warfare"],
        [/\bMED\b/,"medical"],[/\bMEDEVAC\b/,"medevac_aviation"],
        [/\bSUST\b/,"sustainment"],[/\bCSS\b/,"sustainment"],[/\bBSB\b/,"sustainment"],
        [/\bMNT\b/,"maintenance"],[/\bMAINT\b/,"maintenance"],
        [/\bTRANS\b/,"transportation"],
        [/\bSPLY\b/,"supply"],[/\bSUPPLY\b/,"supply"],
        [/\bORD\b/,"ordnance"],
        [/\bSF\b/,"special_forces"],[/\bRGR\b/,"ranger"],[/\bRANGER\b/,"ranger"],
        [/\bCA\b/,"civil_affairs"],[/\bPSYOP\b/,"psyop"],
        [/\bHQ\b/,"headquarters"],[/\bHHC\b/,"headquarters"]
      ];
      /* Helper: strip noise words like PRES, RES, RESERVE */
      function clean(s){return s.replace(/\b(PRES\w*|RES|RESERVE)\b/gi,"").replace(/\s+/g," ").trim()}
      /* Split on commas — each segment is a level of hierarchy */
      const segments=orig.split(/[,;]/).map(s=>s.trim()).filter(s=>s);
      /* Segment 0: the unit itself */
      if(segments.length>=1){
        const seg0=segments[0].toUpperCase();
        /* HQ detection across entire string */
        if(/\bHQ\b|\bHHC\b|\bHHB\b|\bHHT\b/i.test(orig)){result.isHQ=true}
        /* Unit type — scan first segment, then full string */
        for(const[rx,tid]of typeMap){if(rx.test(seg0)){result.type=tid;break}}
        /* Echelon — from first segment only */
        for(const[rx,eid]of echMap){if(rx.test(seg0)){result.echelon=eid;break}}
        /* Designation number from first segment */
        const dashNum=seg0.match(/([A-Z]\/)?(\d+[\-\/]\d+)/);
        if(dashNum){result.designation=dashNum[0]}
        else{const num=seg0.match(/\b(\d+)\b/);if(num)result.designation=num[1]}
      }
      /* Segment 1: immediate parent (e.g. "3 CO") — keep as full string */
      if(segments.length>=2){
        result.parentUnit=clean(segments[1]);
      }
      /* Segment 2+: grandparent / higher (e.g. "3 MECH PRES BN") */
      if(segments.length>=3){
        result.higherUnit=segments.slice(2).map(s=>clean(s)).filter(s=>s).join(", ");
      }
      /* If no type found in seg0, try segment 1 (parent) for type context */
      if(result.type==="infantry"&&segments.length>=2){
        const seg1=segments[1].toUpperCase();
        for(const[rx,tid]of typeMap){if(rx.test(seg1)){result.type=tid;break}}
      }
      /* Build import notes */
      result.importNotes="Original: "+orig;
      return result;
    }
    function _pcr(ce){if(!ce)return null;var ct=ce.textContent.trim().split(/\s+/).filter(s=>s),gp=[];ct.forEach(function(c){var p=c.split(",");if(p.length>=2){var lo=parseFloat(p[0]),la=parseFloat(p[1]);if(!isNaN(la)&&!isNaN(lo))gp.push({lat:la,lon:lo})}});if(gp.length<2)return null;if(gp.length>=3){var f=gp[0],l=gp[gp.length-1];if(Math.abs(f.lat-l.lat)<1e-8&&Math.abs(f.lon-l.lon)<1e-8)gp.pop()}return gp}
    function _bgo(pm,lid,rn,rd,st,pts,isPoly){
      var gc="#000000",lc=extractKmlColor(st,["LineStyle"]);if(lc)gc=lc.hex;else{var pc=extractKmlColor(st,["PolyStyle","IconStyle"]);if(pc)gc=pc.hex}
      var glw=extractKmlLineWidth(st)||2,sf=isPoly,gfc=gc,gfo=0.15;
      if(st){var ps=st.getElementsByTagName("PolyStyle");if(ps.length>0){var ft=ps[0].getElementsByTagName("fill")[0];if(ft&&(ft.textContent.trim()==="false"||ft.textContent.trim()==="0"))sf=false;var fc=extractKmlColor(st,["PolyStyle"]);if(fc){gfc=fc.hex;if(fc.a===0)sf=false;var ko=extractKmlFillOpacity(st);if(ko!==null&&ko>0)gfo=Math.min(ko,0.8)}}}
      var _smEd={};pm.querySelectorAll("ExtendedData > Data").forEach(function(d){var k=d.getAttribute("name");var v=(d.querySelector("value")||{}).textContent||"";if(k&&k.startsWith("sm:"))_smEd[k.slice(3)]=v});var ln=(rn+" "+rd).toLowerCase(),ot=_smEd.overlayType||"none",gt=_smEd.tool||(isPoly?"polygon":"line");
      if(/\bao\b|area\s*of\s*op|area\s*of\s*interest/i.test(ln)){ot="none";gt="polygon"}
      else if(/\bpl\b|phase\s*line/i.test(ln)){ot="pl";gt="line"}else if(/\bld\b|line\s*of\s*dep/i.test(ln)){ot="ld";gt="line"}
      else if(/\bboundary\b/i.test(ln)){ot="boundary";gt="line"}else if(/\baa\b|assembly\s*area/i.test(ln)){ot="aa";gt="rectangle"}
      else if(/\baxis\b|avenue.*approach/i.test(ln)){ot="axis";gt="line"}else if(/\broute\b|msr\b|asr\b/i.test(ln)){ot="route";gt="line"}
      return{_isGraphic:true,id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:gt,points:pts,color:gc,lineWidth:glw,lineStyle:_smEd.lineStyle||'solid',overlayType:ot,fill:sf,fillColor:gfc,fillOpacity:gfo,label:rn&&!/^Untitled (Polygon|Path|Linestring|Placemark|Line)$/i.test(rn)?rn:"",layerId:lid,labelOffset:null,echelon:ot==="boundary"?"brigade":null,unitAbove:"",unitBelow:""}}
    function buildUnit(pm,layerId,folderName){
      const coords=pm.getElementsByTagName("coordinates")[0];if(!coords)return null;
      const nameEl=pm.getElementsByTagName("name")[0],descEl=pm.getElementsByTagName("description")[0];
      const rawName=nameEl?nameEl.textContent:"",rawDesc=descEl?descEl.textContent:"";
      var smData={};pm.querySelectorAll("ExtendedData > Data").forEach(function(d){var k=d.getAttribute("name");var v=(d.querySelector("value")||{}).textContent||"";if(k&&k.startsWith("sm:"))smData[k.slice(3)]=v});
      if(smData.type){var smMods=[];try{smMods=JSON.parse(smData.modifiers||"[]")}catch(e){}
        var _smIcon=resolveIconHref(pm);
        return{id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat:parseFloat(coords.textContent.split(",")[1]),lon:parseFloat(coords.textContent.split(",")[0]),type:smData.type||"infantry",affiliation:smData.affiliation||"friendly",echelon:smData.echelon||null,designation:sanitizeStr(rawName,INPUT_LIMITS.designation),parentUnit:sanitizeStr(smData.parentUnit||"",INPUT_LIMITS.parentUnit||32),higherUnit:sanitizeStr(smData.higherUnit||"",INPUT_LIMITS.parentUnit||32),isHQ:smData.isHQ==="true",modifiers:smMods,layerId,rings:[],equipment:{},customIcon:_smIcon||null,useCustomIcon:!!_smIcon,importNotes:"",originalName:rawName,_useStructuredLabel:!_smIcon};}
      const aff=detectAff(pm,folderName);
      const mg=pm.getElementsByTagName("MultiGeometry")[0];
      if(mg){var st=resolveStyle(pm),ap=mg.getElementsByTagName("Polygon"),al=mg.getElementsByTagName("LineString");
        if(ap.length>100){var bp=null,bl=0;for(var bi=0;bi<Math.min(ap.length,20);bi++){var bc=ap[bi].getElementsByTagName("coordinates")[0],bpts=_pcr(bc);if(bpts&&bpts.length>bl){bp=bpts;bl=bpts.length}}return bp?_bgo(pm,layerId,rawName,rawDesc,st,bp,true):null}
        var res=[];for(var mi=0;mi<ap.length;mi++){var sc=ap[mi].getElementsByTagName("coordinates")[0],sp=_pcr(sc);if(sp&&sp.length>=2)res.push(_bgo(pm,layerId,mi===0?rawName:"",rawDesc,st,sp,true))}
        for(var mj=0;mj<al.length;mj++){var sc2=al[mj].getElementsByTagName("coordinates")[0],sp2=_pcr(sc2);if(sp2&&sp2.length>=2)res.push(_bgo(pm,layerId,mj===0&&!ap.length?rawName:"",rawDesc,st,sp2,false))}
        return res.length?res:null}
      const polyEl=pm.getElementsByTagName("Polygon")[0],lineEl=pm.getElementsByTagName("LineString")[0];
      if(polyEl||lineEl){var ce=polyEl?polyEl.getElementsByTagName("coordinates")[0]:lineEl.getElementsByTagName("coordinates")[0];var gp=_pcr(ce);if(!gp)return null;return _bgo(pm,layerId,rawName,rawDesc,resolveStyle(pm),gp,!!polyEl)}
      const parts=coords.textContent.trim().split(",");if(parts.length<2)return null;
      const lon=parseFloat(parts[0]),lat=parseFloat(parts[1]);if(isNaN(lat)||isNaN(lon))return null;
      const hasName=!!rawName,parseSource=rawName||rawDesc.replace(/<[^>]*>/g,"").trim();
      /* Detect location/waypoint placemarks — not military units */
      const combinedText=(rawName+" "+rawDesc).toLowerCase();
      const isWaypoint=/\blocation\b|\bhlz\b|\becc\b|\blz\b|\bdz\b|\bprimary\b.*\blocation\b|\bwaypoint\b|\brally\s*point\b|\bcheckpoint\b|\bcp\s*\d/i.test(combinedText);
      if(isWaypoint){
        const iconDataUrl=resolveIconHref(pm);
        const label=rawName||rawDesc.replace(/<[^>]*>/g,"").trim().substring(0,40);
        return{id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat,lon,type:"waypoint",affiliation:aff,displayMode:"pin",pinColor:aff==="hostile"?"#ff4444":"#4a9eff",
          designation:"",echelon:null,modifiers:[],isHQ:false,layerId,rings:[],equipment:{},
          customIcon:iconDataUrl||null,showCoords:false,
          importNotes:"Original: "+label+"\n"+parseSource+(rawDesc?"\nDescription: "+rawDesc.replace(/<[^>]*>/g,"").trim():"")+(folderName?"\nSource folder: "+folderName:""),originalName:rawName}}
      const parsed=parseUnitText(parseSource);
      if(!hasName){parsed.parentUnit="";parsed.higherUnit="";parsed.designation=""}
      var finalAff=aff;const cotResult=parseCot(rawDesc);
      if(cotResult){if(cotResult.type)parsed.type=cotResult.type;if(cotResult.affiliation)finalAff=cotResult.affiliation}
      const notes=parsed.importNotes+(cotResult?" | CoT: "+cotResult.raw:"")+(rawDesc?"\nDescription: "+rawDesc.replace(/<[^>]*>/g,"").trim():"")+(folderName?"\nSource folder: "+folderName:"");
      const iconDataUrl=resolveIconHref(pm);
      /* Skip label-only point placemarks (no name, has icon — typically a rendered label from another app) */
      if(!rawName&&!rawDesc){
        if(iconDataUrl)return null;
        var _chkSt=resolveStyle(pm);if(_chkSt){var _chkIs=_chkSt.getElementsByTagName("IconStyle");if(_chkIs.length){var _chkIc=_chkIs[0].getElementsByTagName("Icon");if(_chkIc.length){var _chkHr=_chkIc[0].getElementsByTagName("href");if(_chkHr.length){var _hr=_chkHr[0].textContent.trim();if(_hr&&!/maps\.google\.com|earth\.google\.com/i.test(_hr))return null}}}}
      }
      return{id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat,lon,
        type:iconDataUrl&&parsed.type==="infantry"?"waypoint":parsed.type,affiliation:finalAff,echelon:parsed.echelon,
        designation:parsed.designation,parentUnit:parsed.parentUnit,higherUnit:parsed.higherUnit||"",
        modifiers:[],isHQ:parsed.isHQ,layerId,rings:[],equipment:{},customIcon:iconDataUrl||null,useCustomIcon:!!iconDataUrl,
        importNotes:notes,originalName:rawName,_useStructuredLabel:!iconDataUrl};
    }
    /* Parse Folders — uses querySelectorAll to find folders at any depth.
       Only processes direct placemarks per folder (no duplicates).
       Parent folders become packages, leaf folders become layers. */
    const defaultLayerId="l"+Date.now();
    let usedDefault=false;
    const importedLayerIds=[];
    const topDoc=doc.querySelector("Document")||doc.documentElement;
    
    var allFolders=doc.querySelectorAll("Folder");
    function getDirectChildren(el,tag){var r=[];for(var i=0;i<el.children.length;i++){if(el.children[i].tagName===tag)r.push(el.children[i])}return r}
    function getFolderName(f){for(var i=0;i<f.children.length;i++){if(f.children[i].tagName==="name")return f.children[i].textContent}return""}
    
    var processedFolders=new Map();
    allFolders.forEach(function(folder){
      var directPms=getDirectChildren(folder,"Placemark");
      if(directPms.length===0)return;
      var fname=getFolderName(folder)||"Unnamed";
      var layerId="l"+Date.now()+Math.random().toString(36).substr(2,4);
      S.layers.push({id:layerId,name:fname,visible:true,hasErrors:false,collapsed:true});
      var imported=0,ferr=0;
      directPms.forEach(function(pm){
        var u=buildUnit(pm,layerId,fname);
        if(u){if(Array.isArray(u)){u.forEach(function(g){delete g._isGraphic;S.graphics.push(g);count++});imported+=u.length}else if(u._isGraphic){delete u._isGraphic;S.graphics.push(u);count++;imported++}else{S.units.push(u);count++;imported++}}else{ferr++;errors++}
      });
      if(imported>0){
        importedLayerIds.push(layerId);
        processedFolders.set(folder,{layerId:layerId,name:fname});
        if(ferr>0){var el=S.layers.find(function(l){return l.id===layerId});if(el)el.hasErrors=true}
      }else{
        S.layers=S.layers.filter(function(l){return l.id!==layerId});
      }
    });
    
    /* Build packages from parent folder structure */
    var topLevelPackages=new Map();
    processedFolders.forEach(function(info,folder){
      var parent=folder.parentElement;
      var groupFolder=null;
      while(parent){
        if(parent===topDoc||parent.tagName==="kml"||parent===doc.documentElement)break;
        if(parent.tagName==="Folder"){groupFolder=parent}
        parent=parent.parentElement;
      }
      if(groupFolder&&groupFolder!==folder){
        if(!topLevelPackages.has(groupFolder)){
          topLevelPackages.set(groupFolder,{name:getFolderName(groupFolder)||"Imported",layerIds:[]});
        }
        topLevelPackages.get(groupFolder).layerIds.push(info.layerId);
      }
    });
    topLevelPackages.forEach(function(pkg){
      if(pkg.layerIds.length>1){
        S.packages.push({id:"pkg"+Date.now()+Math.random().toString(36).substr(2,4),name:pkg.name,collapsed:true,layerIds:pkg.layerIds});
      }
    });
    
    /* Top-level placemarks not in any folder */
    var topPms=getDirectChildren(topDoc,"Placemark");
    var topErrors=0;
    topPms.forEach(function(pm){
      if(!usedDefault){S.layers.push({id:defaultLayerId,name:"Import: KML",visible:true,hasErrors:false,collapsed:true});usedDefault=true;importedLayerIds.push(defaultLayerId);S.activeLayerId=defaultLayerId}
      var tu=buildUnit(pm,defaultLayerId,"");
      if(tu){if(Array.isArray(tu)){tu.forEach(function(g){delete g._isGraphic;S.graphics.push(g);count++})}else if(tu._isGraphic){delete tu._isGraphic;S.graphics.push(tu);count++}else{S.units.push(tu);count++}}else{topErrors++;errors++}
    });
    if(usedDefault&&topErrors>0){var tl=S.layers.find(function(x){return x.id===defaultLayerId});if(tl)tl.hasErrors=true}
    
    var standaloneLayers=importedLayerIds.filter(function(lid){
      var inPkg=false;S.packages.forEach(function(p){if(p.layerIds.indexOf(lid)>=0)inPkg=true});return!inPkg;
    });
    /* Don't auto-wrap standalone layers into a package — they're already named from their folder */
    if(importedLayerIds.length>0)S.activeLayerId=importedLayerIds[importedLayerIds.length-1];
    requestRender();updateLayerIndicator();renderFloatingPanel();
    IO.notify("Imported "+count+" placemarks"+(errors?" ("+errors+" skipped)":""))
  }catch(e){IO.notify("KML error: "+e.message,"error")}},
  openExportPanel(){
    /* Build modal with layer/package selection + format choice */
    var backdrop=document.createElement("div");backdrop.className="export-modal-backdrop";
    var pkgLayerIds=new Set();S.packages.forEach(p=>p.layerIds.forEach(id=>pkgLayerIds.add(id)));
    var standaloneLayers=S.layers.filter(l=>!pkgLayerIds.has(l.id));
    var selLayers=new Set(S.layers.map(l=>l.id));/* all selected by default */
    var fmt="kmz";
    function countForLayer(lid){return S.units.filter(u=>u.layerId===lid).length+S.graphics.filter(g=>g.layerId===lid).length}
    function render(){
      var h='<div class="export-modal"><div class="export-modal-header"><span>Export</span><button class="btn" onclick="this.closest(\'.export-modal-backdrop\').remove()" style="padding:2px 8px;font-size:14px">✕</button></div>';
      h+='<div class="export-modal-body">';
      h+='<div class="export-pkg-header">Format</div>';
      h+='<div style="display:flex;gap:6px;margin-bottom:12px">';
      ["kmz","kml","geojson","tacmap"].forEach(function(f){
        h+='<button class="btn'+(fmt===f?" primary":"")+'" onclick="(_fmt=this.dataset.fmt,fmt=_fmt,rerender())" data-fmt="'+f+'" style="flex:1;font-size:10px">'+f.toUpperCase()+'</button>';
      });
      h+='</div>';
      h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
      h+='<div class="export-pkg-header" style="margin:0">Layers &amp; Packages</div>';
      h+='<div style="display:flex;gap:8px"><span style="font-size:10px;cursor:pointer;opacity:.6" onclick="allLayers(true)">All</span><span style="font-size:10px;cursor:pointer;opacity:.6" onclick="allLayers(false)">None</span></div></div>';
      /* Packages */
      S.packages.forEach(function(pkg){
        var pkgLayers=pkg.layerIds.map(id=>S.layers.find(l=>l.id===id)).filter(Boolean);
        var pkgCount=pkgLayers.reduce((s,l)=>s+countForLayer(l.id),0);
        var allSel=pkgLayers.every(l=>selLayers.has(l.id));
        h+='<div style="border:1px solid var(--border);border-radius:6px;margin-bottom:6px;overflow:hidden">';
        h+='<label class="export-check-row" style="padding:6px 8px;background:rgba(255,255,255,.03)">';
        h+='<input type="checkbox"'+(allSel?" checked":"")+' onchange="togglePkg(\''+pkg.id+'\',this.checked)">';
        h+='<span style="font-weight:600;flex:1">📦 '+escHtml(pkg.name)+'</span>';
        h+='<span style="opacity:.4;font-size:10px">('+pkgCount+')</span></label>';
        pkgLayers.forEach(function(l){
          h+='<label class="export-check-row" style="padding:4px 8px 4px 24px">';
          h+='<input type="checkbox"'+(selLayers.has(l.id)?" checked":"")+' onchange="toggleLayer(\''+l.id+'\',this.checked)">';
          h+='<span style="flex:1">'+escHtml(l.name)+'</span>';
          h+='<span style="opacity:.4;font-size:10px">('+countForLayer(l.id)+')</span></label>';
        });
        h+='</div>';
      });
      /* Standalone layers */
      if(standaloneLayers.length){
        if(S.packages.length)h+='<div class="export-pkg-header">Standalone Layers</div>';
        standaloneLayers.forEach(function(l){
          h+='<label class="export-check-row">';
          h+='<input type="checkbox"'+(selLayers.has(l.id)?" checked":"")+' onchange="toggleLayer(\''+l.id+'\',this.checked)">';
          h+='<span style="flex:1">'+escHtml(l.name)+'</span>';
          h+='<span style="opacity:.4;font-size:10px">('+countForLayer(l.id)+')</span></label>';
        });
      }
      h+='</div>';/* end body */
      var selCount=S.units.filter(u=>selLayers.has(u.layerId)).length+S.graphics.filter(g=>selLayers.has(g.layerId)).length;
      h+='<div class="export-modal-footer">';
      h+='<span style="font-size:10px;opacity:.5;align-self:center">'+selCount+' features</span>';
      h+='<button class="btn" onclick="this.closest(\'.export-modal-backdrop\').remove()">Cancel</button>';
      h+='<button class="btn primary" onclick="doExport()">Export '+fmt.toUpperCase()+'</button>';
      h+='</div></div>';
      backdrop.innerHTML=h;
    }
    function rerender(){render()}
    function toggleLayer(id,on){if(on)selLayers.add(id);else selLayers.delete(id);render()}
    function togglePkg(pkgId,on){var pkg=S.packages.find(x=>x.id===pkgId);if(!pkg)return;pkg.layerIds.forEach(id=>on?selLayers.add(id):selLayers.delete(id));render()}
    function allLayers(on){S.layers.forEach(l=>on?selLayers.add(l.id):selLayers.delete(l.id));render()}
    function doExport(){
      var selectedLayerIds=new Set(selLayers);
      backdrop.remove();
      if(fmt==="kmz")IO.exportKMZ(selectedLayerIds,S.packages,pkgLayerIds);
      else if(fmt==="kml")IO.exportKML(selectedLayerIds,S.packages,pkgLayerIds);
      else if(fmt==="geojson")IO.exportGeoJSON(selectedLayerIds);
      else if(fmt==="tacmap")IO.exportTacmap(selectedLayerIds,S.packages,pkgLayerIds);
    }
    /* Expose helpers to onclick scope via backdrop */
    backdrop.toggleLayer=toggleLayer;backdrop.togglePkg=togglePkg;backdrop.allLayers=allLayers;backdrop.doExport=doExport;backdrop.rerender=rerender;
    /* Make onclick functions work in global scope temporarily */
    window._exportBackdrop=backdrop;
    window.toggleLayer=(id,on)=>{backdrop.toggleLayer(id,on)};
    window.togglePkg=(id,on)=>{backdrop.togglePkg(id,on)};
    window.allLayers=(on)=>{backdrop.allLayers(on)};
    window.doExport=()=>{backdrop.doExport()};
    window.rerender=()=>{fmt=backdrop._fmt||fmt;backdrop.rerender()};
    render();
    document.body.appendChild(backdrop);
  },
  exportGeoJSON(selectedLayerIds){
    var layerIds=selectedLayerIds||new Set(S.layers.map(l=>l.id));
    const features=[];
    S.units.filter(u=>layerIds.has(u.layerId)).forEach(u=>features.push({type:"Feature",geometry:{type:"Point",coordinates:[u.lon,u.lat]},properties:{type:u.type,affiliation:u.affiliation,echelon:u.echelon,designation:u.designation,modifiers:u.modifiers,layerId:u.layerId}}));
    S.graphics.filter(g=>layerIds.has(g.layerId)).forEach(g=>{if(!g.points||g.points.length<1)return;
      if(g.tool==="circle"&&g.points.length>=2){features.push({type:"Feature",geometry:{type:"Point",coordinates:[g.points[0].lon,g.points[0].lat]},properties:{tool:g.tool,label:g.label||"",color:g.color,layerId:g.layerId}})}
      else if(g.points.length>=2){var coords=g.points.map(p=>[p.lon,p.lat]);var isP=g.tool==="polygon"||g.tool==="rectangle";
        if(isP&&coords.length>=3){coords.push(coords[0]);features.push({type:"Feature",geometry:{type:"Polygon",coordinates:[coords]},properties:{tool:g.tool,label:g.label||"",color:g.color,overlayType:g.overlayType||"",layerId:g.layerId}})}
        else{features.push({type:"Feature",geometry:{type:"LineString",coordinates:coords},properties:{tool:g.tool,label:g.label||"",color:g.color,overlayType:g.overlayType||"",layerId:g.layerId}})}}});
    const fc={type:"FeatureCollection",features};const blob=new Blob([JSON.stringify(fc,null,2)],{type:"application/json"});dlBlob(blob,"staffmaps-export.geojson");IO.notify("Exported "+features.length+" features as GeoJSON")},
  exportTacmap(selectedLayerIds,packages,pkgLayerIds){
    var layerIds=selectedLayerIds||new Set(S.layers.map(l=>l.id));
    var exportLayers=S.layers.filter(l=>layerIds.has(l.id));
    var exportPkgs=packages?packages.map(p=>({...p,layerIds:p.layerIds.filter(id=>layerIds.has(id))})).filter(p=>p.layerIds.length>0):[];
    var exportUnits=S.units.filter(u=>layerIds.has(u.layerId));
    var exportGraphics=S.graphics.filter(g=>layerIds.has(g.layerId));
    const data={version:"3.0",app:"StaffMaps",timestamp:new Date().toISOString(),map:{lat:S.lat,lon:S.lon,zoom:S.zoom,tileSource:S.tileSource},units:exportUnits,graphics:exportGraphics,layers:exportLayers,packages:exportPkgs};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    dlBlob(blob,"staffmaps-export-"+new Date().toISOString().slice(0,10)+".tacmap");IO.notify("Exported "+(exportUnits.length+exportGraphics.length)+" features as .tacmap")},
  importKMZ(buf){
    try{
      const dv=new DataView(buf);let off=0;let kmlText=null;const embeddedFiles={};const pendingDeflates=[];
      while(off<buf.byteLength-4){
        const sig=dv.getUint32(off,true);if(sig!==0x04034b50)break;
        const comp=dv.getUint16(off+8,true),cSize=dv.getUint32(off+18,true),uSize=dv.getUint32(off+22,true);
        const fnLen=dv.getUint16(off+26,true),exLen=dv.getUint16(off+28,true);
        const fn=new TextDecoder().decode(new Uint8Array(buf,off+30,fnLen));
        const dataOff=off+30+fnLen+exLen;const raw=new Uint8Array(new Uint8Array(buf,dataOff,cSize));const fnL=fn.toLowerCase();
        if(fnL.endsWith(".kml")){if(comp===0)kmlText=new TextDecoder().decode(raw);else if(comp===8)pendingDeflates.push({fn,raw:new Uint8Array(raw),isKml:true})}
        else if(/\.(png|jpg|jpeg|gif|bmp|svg)$/i.test(fnL)){
          const ext=fnL.split(".").pop(),mm={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",bmp:"image/bmp",svg:"image/svg+xml"},mime=mm[ext]||"image/png";
          if(comp===0){var _cp=new Uint8Array(cSize);_cp.set(new Uint8Array(buf,dataOff,cSize));var _b64=_u8ToB64(_cp);embeddedFiles[fn]=`data:${mime};base64,${_b64}`}
          else if(comp===8)pendingDeflates.push({fn,raw:new Uint8Array(raw),isKml:false,mime})}
        off=dataOff+(cSize||uSize)}
      if(pendingDeflates.length>0){let done=0;const tot=pendingDeflates.length;
        pendingDeflates.forEach(ent=>{const ds=new DecompressionStream("deflate-raw"),wr=ds.writable.getWriter();wr.write(ent.raw);wr.close();
          const rd=ds.readable.getReader(),ch=[];
          const pump=()=>rd.read().then(({done:d,value:v})=>{if(d){const fl=new Uint8Array(ch.reduce((a,c)=>a+c.length,0));let p=0;ch.forEach(c=>{fl.set(c,p);p+=c.length});
            if(ent.isKml)kmlText=new TextDecoder().decode(fl);else{var _b64d=_u8ToB64(fl);embeddedFiles[ent.fn]=`data:${ent.mime};base64,${_b64d}`}
            done++;if(done===tot){if(kmlText)IO.importKML(kmlText,embeddedFiles);else IO.notify("No .kml in KMZ","error")}return}ch.push(v);return pump()});pump()});return}
      if(kmlText)IO.importKML(kmlText,embeddedFiles);else IO.notify("No .kml file found in KMZ","error");
    }catch(e){IO.notify("KMZ error: "+e.message,"error")}
  },
  exportKMZ(selectedLayerIds,packages,pkgLayerIds){
    var layerIds=selectedLayerIds||new Set(S.layers.map(l=>l.id));
    var esc=function(s){return(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};
    var hexToKml=function(hex,alpha){hex=(hex||"#ff4444").replace("#","");var r=hex.substring(0,2),g2=hex.substring(2,4),b=hex.substring(4,6);var a=alpha!==undefined?Math.round(alpha*255).toString(16).padStart(2,"0"):"ff";return a+b+g2+r};
    function rectToCoords(g){var p0=g.points[0],p1=g.points[1];return[p0.lon+","+p0.lat+",0",p1.lon+","+p0.lat+",0",p1.lon+","+p1.lat+",0",p0.lon+","+p1.lat+",0",p0.lon+","+p0.lat+",0"].join(" ")}
    function circleToCoords(g){var c=g.points[0],e=g.points[1];var R=Math.sqrt(Math.pow((e.lat-c.lat),2)+Math.pow((e.lon-c.lon)*Math.cos(c.lat*Math.PI/180),2));var pts=[];for(var i=0;i<=64;i++){var a=Math.PI*2*i/64;pts.push((c.lon+R*Math.sin(a)/Math.cos(c.lat*Math.PI/180))+","+( c.lat+R*Math.cos(a))+",0")}return pts.join(" ")}
    var iconFiles={};var iconIdx=0;var styleBlock="";
    S.units.filter(u=>layerIds.has(u.layerId)).forEach(function(u){
      var styleId="u_"+(u.id||"").replace(/[^a-zA-Z0-9]/g,"");
      styleBlock+='<Style id="'+styleId+'">';
      if(u.customIcon&&u.useCustomIcon!==false){var iconFn="images/icon_"+(iconIdx++)+".png";iconFiles[iconFn]=u.customIcon;styleBlock+='<IconStyle><scale>'+(u.iconScale||1)+'</scale><Icon><href>'+iconFn+'</href></Icon></IconStyle>';}
      else{/* Render military symbol to canvas PNG for KMZ */var _ic=document.createElement("canvas");_ic.width=256;_ic.height=256;var _ix=_ic.getContext("2d");_ix.clearRect(0,0,256,256);drawUnitIcon(_ix,u,128,128,220);var iconFn="images/icon_"+(iconIdx++)+".png";iconFiles[iconFn]=_ic.toDataURL("image/png");styleBlock+='<IconStyle><scale>'+(u.iconScale||1)+'</scale><Icon><href>'+iconFn+'</href></Icon><hotSpot x="0.5" y="0.5" xunits="fraction" yunits="fraction"/></IconStyle>';}
      styleBlock+='<LabelStyle><scale>1</scale></LabelStyle></Style>\n';
    });
    S.graphics.filter(g=>layerIds.has(g.layerId)&&g.points&&g.points.length>=2).forEach(function(g){
      var styleId="g_"+(g.id||"").replace(/[^a-zA-Z0-9]/g,"");
      var lineCol=hexToKml(g.color||"#ff4444",g.opacity!=null?g.opacity:1);var isP=g.tool==="polygon"||g.tool==="rectangle"||g.tool==="circle";
      styleBlock+='<Style id="'+styleId+'"><LineStyle><color>'+lineCol+'</color><width>'+(g.lineWidth||2)+'</width></LineStyle>';
      if(isP&&g.fill){var fillOp=g.fillOpacity!=null?g.fillOpacity:0.35;styleBlock+='<PolyStyle><color>'+hexToKml(g.fillColor||g.color||"#ff4444",fillOp)+'</color></PolyStyle>';}
      else if(isP){styleBlock+='<PolyStyle><fill>0</fill></PolyStyle>';}
      styleBlock+='</Style>\n';
    });
    /* === CoT type mapping for WinTAK-compatible KMZ export === */
    var AFF_COT={friendly:"f",hostile:"h",neutral:"n",unknown:"u"};
    var TYPE_COT={
      infantry:"G-U-C-I",mechanized_infantry:"G-U-C-I-Z",ifv:"G-U-C-I-Z",naval_infantry:"G-U-C-I",
      armor:"G-U-C-A",armored_wheeled:"G-U-C-A-W",cavalry:"G-U-C-R",armored_recon:"G-U-C-R-S",
      artillery:"G-U-C-F",mechanized_artillery:"G-U-C-F-M",rocket_artillery:"G-U-C-F-R",
      mortar:"G-U-C-F-M-S",air_defense:"G-U-C-D",short_range_air_defense:"G-U-C-D-S",anti_armor:"G-U-C-A-A-A-W",
      sam:"G-U-C-D-M",magtf:"G-U-C-I",
      engineer:"G-U-C-E",bridging:"G-U-C-E-C",
      headquarters:"G-U-C-A",signal:"G-U-U-S",military_intelligence:"G-U-U-I",electronic_warfare:"G-U-U-E",cyber:"G-U-U-E",
      sustainment:"G-U-U-L",medical:"G-U-U-M",maintenance:"G-U-U-S-M",transportation:"G-U-U-T",supply:"G-U-U-S-S",ordnance:"G-U-U-O",
      aviation:"G-U-C-A-T-W",attack_aviation:"G-U-C-A-A",recon_aviation:"G-U-C-A-R",medevac_aviation:"G-U-U-M-R-W",uav:"G-U-C-A-T-W-U",
      special_forces:"G-U-C-S",ranger:"G-U-C-S",civil_affairs:"G-U-U-C-A",psyop:"G-U-U-P-S",
      chemical:"G-U-C-B",military_police:"G-U-U-P-M",waypoint:"G-U-C-I"
    };
    var ECH_SHORT={team:"TM",squad:"SQD",section:"SECT",platoon:"PLT",company:"CO",battery:"BTRY",troop:"TRP",battalion:"BN",squadron:"SQDN",regiment:"REGT",brigade:"BDE",division:"DIV",corps:"CORPS",army:"ARMY",army_group:"AG",theater:"THEATER",command:"CMD"};
    function _callsign(u){var p=[];if(u.designation)p.push(u.designation);var el=ECH_SHORT[u.echelon];if(el)p.push(el);p.push(TYPE_LABELS[u.type]||u.type);if(u.parentUnit)p.push(u.parentUnit);return p.join(" ")}
    function _cotType(u){var a=AFF_COT[u.affiliation||"friendly"]||"f";var t=TYPE_COT[u.type]||"G-U-C-I";return"a-"+a+"-"+t}
    function _takDesc(u){
      var aL=(u.affiliation||"friendly").charAt(0).toUpperCase()+(u.affiliation||"friendly").slice(1);
      var cs=_callsign(u);var cot=_cotType(u)+"/h-g-i-g-o";
      var d='<h2>'+esc(aL)+'\\'+esc(cs)+'</h2>';
      d+='<b>COT:</b> '+esc(cot)+'<br/>';
      d+='<b>Type:</b> '+esc(TYPE_LABELS[u.type]||u.type)+'<br/>';
      if(u.echelon){var _e=ECHELONS.find(function(x){return x.id===u.echelon});if(_e)d+='<b>Echelon:</b> '+esc(_e.label)+'<br/>'}
      if(u.parentUnit)d+='<b>Parent:</b> '+esc(u.parentUnit)+'<br/>';
      if(u.higherUnit)d+='<b>Higher:</b> '+esc(u.higherUnit)+'<br/>';
      if(u.isHQ)d+='<b>HQ:</b> Yes<br/>';
      d+='<b>Source:</b> StaffMaps';return d}
    function placemarkUnit(u){var cs=_callsign(u);var nm=esc(cs);var sid="u_"+(u.id||"").replace(/[^a-zA-Z0-9]/g,"");
      var desc='<description><![CDATA['+_takDesc(u)+']]></description>';
      var ext='<ExtendedData><Data name="sm:type"><value>'+esc(u.type||'')+'</value></Data><Data name="sm:affiliation"><value>'+esc(u.affiliation||'friendly')+'</value></Data><Data name="sm:echelon"><value>'+esc(u.echelon||'')+'</value></Data><Data name="sm:higherUnit"><value>'+esc(u.higherUnit||'')+'</value></Data><Data name="sm:parentUnit"><value>'+esc(u.parentUnit||'')+'</value></Data><Data name="sm:isHQ"><value>'+(u.isHQ?'true':'false')+'</value></Data><Data name="sm:modifiers"><value>'+esc(JSON.stringify(u.modifiers||[]))+'</value></Data><Data name="sm:label"><value>'+nm+'</value></Data></ExtendedData>';
      return'<Placemark><name>'+nm+'</name><styleUrl>#'+sid+'</styleUrl>'+desc+ext+'<Point><coordinates>'+u.lon+','+u.lat+',0</coordinates></Point></Placemark>\n'}

    function placemarkGfx(g){
      var nm=esc(g.label||"");
      var sid="g_"+(g.id||"").replace(/[^a-zA-Z0-9]/g,"");
      var gExt='<ExtendedData><Data name="sm:lineStyle"><value>'+(g.lineStyle||'solid')+'</value></Data><Data name="sm:tool"><value>'+(g.tool||'line')+'</value></Data><Data name="sm:overlayType"><value>'+(g.overlayType||'none')+'</value></Data><Data name="sm:label"><value>'+esc(g.label||'')+'</value></Data></ExtendedData>';
      var h='<Placemark><name>'+nm+'</name><styleUrl>#'+sid+'</styleUrl>'+gExt;
      if(g.tool==="rectangle"&&g.points.length===2){h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+rectToCoords(g)+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else if(g.tool==="circle"&&g.points.length>=2){h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+circleToCoords(g)+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else if(g.tool==="polygon"){var c=g.points.map(p=>p.lon+","+p.lat+",0").join(" ");h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+c+" "+g.points[0].lon+","+g.points[0].lat+',0</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else{var c=g.points.map(p=>p.lon+","+p.lat+",0").join(" ");h+='<LineString><tessellate>1</tessellate><coordinates>'+c+'</coordinates></LineString>';}
      return h+'</Placemark>\n';
    }
    function layerFolder(l){
      var h='<Folder><name>'+esc(l.name)+'</name>\n';
      S.units.filter(u=>u.layerId===l.id).forEach(u=>{h+=placemarkUnit(u)});
      S.graphics.filter(g=>g.layerId===l.id&&g.points&&g.points.length>=2).forEach(g=>{h+=placemarkGfx(g)});
      return h+'</Folder>\n';
    }
    var _pkgLayerIds=pkgLayerIds||new Set();
    var kml='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>\n<name>StaffMaps Export</name>\n'+styleBlock;
    (packages||[]).forEach(function(pkg){
      var pkgLayers=pkg.layerIds.map(id=>S.layers.find(l=>l.id===id)).filter(l=>l&&layerIds.has(l.id));
      if(!pkgLayers.length)return;
      kml+='<Folder><name>'+esc(pkg.name)+'</name>\n';
      pkgLayers.forEach(l=>{kml+=layerFolder(l)});
      kml+='</Folder>\n';
    });
    S.layers.filter(l=>layerIds.has(l.id)&&!_pkgLayerIds.has(l.id)).forEach(l=>{kml+=layerFolder(l)});
    kml+='</Document></kml>';
    var files=[{name:"doc.kml",data:new TextEncoder().encode(kml)}];
    Object.keys(iconFiles).forEach(function(fn){var dataUrl=iconFiles[fn];if(typeof dataUrl==="string"&&dataUrl.startsWith("data:")){var b64=dataUrl.split(",")[1];if(!b64)return;var bin=atob(b64);var arr=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);files.push({name:fn,data:arr})}});
    function crc32(data){let c=0xFFFFFFFF;for(let i=0;i<data.length;i++){c^=data[i];for(let j=0;j<8;j++)c=(c>>>1)^(c&1?0xEDB88320:0)}return(c^0xFFFFFFFF)>>>0}
    var localParts=[],cdParts=[],offset=0;
    files.forEach(function(f){var fnBytes=new TextEncoder().encode(f.name);var crc=crc32(f.data);var lh=new Uint8Array(30+fnBytes.length);var lv=new DataView(lh.buffer);lv.setUint32(0,0x04034b50,true);lv.setUint16(4,20,true);lv.setUint16(8,0,true);lv.setUint32(14,crc,true);lv.setUint32(18,f.data.length,true);lv.setUint32(22,f.data.length,true);lv.setUint16(26,fnBytes.length,true);lh.set(fnBytes,30);localParts.push(lh,f.data);var cd=new Uint8Array(46+fnBytes.length);var cv=new DataView(cd.buffer);cv.setUint32(0,0x02014b50,true);cv.setUint16(4,20,true);cv.setUint16(6,20,true);cv.setUint32(16,crc,true);cv.setUint32(20,f.data.length,true);cv.setUint32(24,f.data.length,true);cv.setUint16(28,fnBytes.length,true);cv.setUint32(42,offset,true);cd.set(fnBytes,46);cdParts.push(cd);offset+=lh.length+f.data.length});
    var cdOffset=offset;var cdSize=0;cdParts.forEach(function(c){cdSize+=c.length});
    var eocd=new Uint8Array(22);var ev=new DataView(eocd.buffer);ev.setUint32(0,0x06054b50,true);ev.setUint16(8,files.length,true);ev.setUint16(10,files.length,true);ev.setUint32(12,cdSize,true);ev.setUint32(16,cdOffset,true);
    var zip=new Uint8Array(offset+cdSize+22);var pos=0;localParts.forEach(function(p){zip.set(p,pos);pos+=p.length});cdParts.forEach(function(p){zip.set(p,pos);pos+=p.length});zip.set(eocd,pos);
    var total=S.units.filter(u=>layerIds.has(u.layerId)).length+S.graphics.filter(g=>layerIds.has(g.layerId)).length;
    var blob=new Blob([zip],{type:"application/vnd.google-earth.kmz"});dlBlob(blob,"staffmaps-export.kmz");IO.notify("Exported "+total+" features as KMZ")
  },
  exportKML(selectedLayerIds,packages,pkgLayerIds){
    var layerIds=selectedLayerIds||new Set(S.layers.map(l=>l.id));
    var esc=function(s){return(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};
    var hexToKml=function(hex,alpha){hex=(hex||"#ff4444").replace("#","");var r=hex.substring(0,2),g2=hex.substring(2,4),b=hex.substring(4,6);var a=alpha!==undefined?Math.round(alpha*255).toString(16).padStart(2,"0"):"ff";return a+b+g2+r};
    function rectToCoords(g){var p0=g.points[0],p1=g.points[1];return[p0.lon+","+p0.lat+",0",p1.lon+","+p0.lat+",0",p1.lon+","+p1.lat+",0",p0.lon+","+p1.lat+",0",p0.lon+","+p0.lat+",0"].join(" ")}
    function circleToCoords(g){var c=g.points[0],e=g.points[1];var R=Math.sqrt(Math.pow((e.lat-c.lat),2)+Math.pow((e.lon-c.lon)*Math.cos(c.lat*Math.PI/180),2));var pts=[];for(var i=0;i<=64;i++){var a=Math.PI*2*i/64;pts.push((c.lon+R*Math.sin(a)/Math.cos(c.lat*Math.PI/180))+","+(c.lat+R*Math.cos(a))+",0")}return pts.join(" ")}
    /* CoT helpers (same as KMZ export) for WinTAK round-trip */
    var AFF_COT={friendly:"f",hostile:"h",neutral:"n",unknown:"u"};
    var TYPE_COT={
      infantry:"G-U-C-I",mechanized_infantry:"G-U-C-I-Z",ifv:"G-U-C-I-Z",naval_infantry:"G-U-C-I",
      armor:"G-U-C-A",armored_wheeled:"G-U-C-A-W",cavalry:"G-U-C-R",armored_recon:"G-U-C-R-S",
      artillery:"G-U-C-F",mechanized_artillery:"G-U-C-F-M",rocket_artillery:"G-U-C-F-R",
      mortar:"G-U-C-F-M-S",air_defense:"G-U-C-D",short_range_air_defense:"G-U-C-D-S",anti_armor:"G-U-C-A-A-A-W",
      sam:"G-U-C-D-M",magtf:"G-U-C-I",
      engineer:"G-U-C-E",bridging:"G-U-C-E-C",
      headquarters:"G-U-C-A",signal:"G-U-U-S",military_intelligence:"G-U-U-I",electronic_warfare:"G-U-U-E",cyber:"G-U-U-E",
      sustainment:"G-U-U-L",medical:"G-U-U-M",maintenance:"G-U-U-S-M",transportation:"G-U-U-T",supply:"G-U-U-S-S",ordnance:"G-U-U-O",
      aviation:"G-U-C-A-T-W",attack_aviation:"G-U-C-A-A",recon_aviation:"G-U-C-A-R",medevac_aviation:"G-U-U-M-R-W",uav:"G-U-C-A-T-W-U",
      special_forces:"G-U-C-S",ranger:"G-U-C-S",civil_affairs:"G-U-U-C-A",psyop:"G-U-U-P-S",
      chemical:"G-U-C-B",military_police:"G-U-U-P-M",waypoint:"G-U-C-I"
    };
    var ECH_SHORT={team:"TM",squad:"SQD",section:"SECT",platoon:"PLT",company:"CO",battery:"BTRY",troop:"TRP",battalion:"BN",squadron:"SQDN",regiment:"REGT",brigade:"BDE",division:"DIV",corps:"CORPS",army:"ARMY",army_group:"AG",theater:"THEATER",command:"CMD"};
    function _callsign(u){var p=[];if(u.designation)p.push(u.designation);var el=ECH_SHORT[u.echelon];if(el)p.push(el);p.push(TYPE_LABELS[u.type]||u.type);if(u.parentUnit)p.push(u.parentUnit);return p.join(" ")}
    function _cotType(u){var a=AFF_COT[u.affiliation||"friendly"]||"f";var t=TYPE_COT[u.type]||"G-U-C-I";return"a-"+a+"-"+t}
    function _takDesc(u){
      var aL=(u.affiliation||"friendly").charAt(0).toUpperCase()+(u.affiliation||"friendly").slice(1);
      var cs=_callsign(u);var cot=_cotType(u)+"/h-g-i-g-o";
      var d='<h2>'+esc(aL)+'\\'+esc(cs)+'</h2>';
      d+='<b>COT:</b> '+esc(cot)+'<br/>';
      d+='<b>Type:</b> '+esc(TYPE_LABELS[u.type]||u.type)+'<br/>';
      if(u.echelon){var _e=ECHELONS.find(function(x){return x.id===u.echelon});if(_e)d+='<b>Echelon:</b> '+esc(_e.label)+'<br/>'}
      if(u.parentUnit)d+='<b>Parent:</b> '+esc(u.parentUnit)+'<br/>';
      if(u.higherUnit)d+='<b>Higher:</b> '+esc(u.higherUnit)+'<br/>';
      if(u.isHQ)d+='<b>HQ:</b> Yes<br/>';
      d+='<b>Source:</b> StaffMaps';return d}
    function placemarkUnit(u){var cs=_callsign(u);var nm=esc(cs);var aff=u.affiliation||"friendly";var col=aff==="hostile"?"ff0000ff":aff==="neutral"?"ff00ff00":"ffff8800";
      var desc='<description><![CDATA['+_takDesc(u)+']]></description>';
      var ext='<ExtendedData><Data name="sm:type"><value>'+esc(u.type||'')+'</value></Data><Data name="sm:affiliation"><value>'+esc(u.affiliation||'friendly')+'</value></Data><Data name="sm:echelon"><value>'+esc(u.echelon||'')+'</value></Data><Data name="sm:higherUnit"><value>'+esc(u.higherUnit||'')+'</value></Data><Data name="sm:parentUnit"><value>'+esc(u.parentUnit||'')+'</value></Data><Data name="sm:isHQ"><value>'+(u.isHQ?'true':'false')+'</value></Data><Data name="sm:modifiers"><value>'+esc(JSON.stringify(u.modifiers||[]))+'</value></Data></ExtendedData>';
      return'<Placemark><name>'+nm+'</name><Style><IconStyle><scale>'+(u.iconScale||1)+'</scale><Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon><color>'+col+'</color></IconStyle></Style>'+desc+ext+'<Point><coordinates>'+u.lon+','+u.lat+',0</coordinates></Point></Placemark>\n'}

    function placemarkGfx(g){
      var nm=esc(g.label||"");
      var lineCol=hexToKml(g.color||"#ff4444",g.opacity!=null?g.opacity:1);var isP=g.tool==="polygon"||g.tool==="rectangle"||g.tool==="circle";
      var gExt='<ExtendedData><Data name="sm:lineStyle"><value>'+(g.lineStyle||'solid')+'</value></Data><Data name="sm:tool"><value>'+(g.tool||'line')+'</value></Data><Data name="sm:overlayType"><value>'+(g.overlayType||'none')+'</value></Data><Data name="sm:label"><value>'+esc(g.label||'')+'</value></Data></ExtendedData>';
      var h='<Placemark><name>'+nm+'</name><Style><LineStyle><color>'+lineCol+'</color><width>'+(g.lineWidth||2)+'</width></LineStyle>';
      if(isP&&g.fill){var fillOp=g.fillOpacity!=null?g.fillOpacity:0.35;h+='<PolyStyle><color>'+hexToKml(g.fillColor||g.color||"#ff4444",fillOp)+'</color></PolyStyle>';}
      else if(isP){h+='<PolyStyle><fill>0</fill></PolyStyle>';}
      h+='</Style>';
      if(g.tool==="rectangle"&&g.points.length===2){h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+rectToCoords(g)+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else if(g.tool==="circle"&&g.points.length>=2){h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+circleToCoords(g)+'</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else if(g.tool==="polygon"){var c=g.points.map(p=>p.lon+","+p.lat+",0").join(" ");h+='<Polygon><outerBoundaryIs><LinearRing><coordinates>'+c+" "+g.points[0].lon+","+g.points[0].lat+',0</coordinates></LinearRing></outerBoundaryIs></Polygon>';}
      else{var c=g.points.map(p=>p.lon+","+p.lat+",0").join(" ");h+='<LineString><tessellate>1</tessellate><coordinates>'+c+'</coordinates></LineString>';}
      return h+'</Placemark>\n';
    }
    function layerFolder(l){
      var h='<Folder><name>'+esc(l.name)+'</name>\n';
      S.units.filter(u=>u.layerId===l.id).forEach(u=>{h+=placemarkUnit(u)});
      S.graphics.filter(g=>g.layerId===l.id&&g.points&&g.points.length>=2).forEach(g=>{h+=placemarkGfx(g)});
      return h+'</Folder>\n';
    }
    var _pkgLayerIds=pkgLayerIds||new Set();
    var kml='<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>\n<name>StaffMaps Export</name>\n';
    (packages||[]).forEach(function(pkg){
      var pkgLayers=pkg.layerIds.map(id=>S.layers.find(l=>l.id===id)).filter(l=>l&&layerIds.has(l.id));
      if(!pkgLayers.length)return;
      kml+='<Folder><name>'+esc(pkg.name)+'</name>\n';
      pkgLayers.forEach(l=>{kml+=layerFolder(l)});
      kml+='</Folder>\n';
    });
    S.layers.filter(l=>layerIds.has(l.id)&&!_pkgLayerIds.has(l.id)).forEach(l=>{kml+=layerFolder(l)});
    kml+='</Document></kml>';
    var total=S.units.filter(u=>layerIds.has(u.layerId)).length+S.graphics.filter(g=>layerIds.has(g.layerId)).length;
    var blob=new Blob([kml],{type:"application/vnd.google-earth.kml+xml"});dlBlob(blob,"staffmaps-export.kml");IO.notify("Exported "+total+" features as KML")
  },
  autosave(){try{localStorage.setItem("staffmaps_autosave",JSON.stringify({v:"4.5",units:S.units,graphics:S.graphics,layers:S.layers,packages:S.packages,lat:S.lat,lon:S.lon,zoom:S.zoom,tileSource:S.tileSource,gridColor:S.gridColor,gridOpacity:S.gridOpacity,showLabels:S.showLabels,persistentRoom:S._net.persistentRoom,sharedLayers:S._net.sharedLayers,sharedEditLayer:S._net.sharedEditLayer}))}catch(e){}},
  autorestore(){try{const d=localStorage.getItem("staffmaps_autosave");if(d){const s=JSON.parse(d);if(!s.v||s.v<"4.5"){localStorage.removeItem("staffmaps_autosave");return false}if(s.units&&s.units.length){S.units=s.units.slice(0,2000).map(u=>sanitizeUnit(u)).filter(Boolean);S.graphics=(s.graphics||[]).slice(0,1000).map(g=>sanitizeGraphic(g)).filter(Boolean);S.layers=(s.layers||S.layers).slice(0,50);S.layers.forEach(l=>{l.name=sanitizeStr(l.name,INPUT_LIMITS.layerName)});S.packages=s.packages||[];S.lat=s.lat||S.lat;S.lon=s.lon||S.lon;S.zoom=s.zoom||S.zoom;S.tileSource=s.tileSource||S.tileSource;S.gridColor=s.gridColor||S.gridColor;S.gridOpacity=s.gridOpacity!==undefined?s.gridOpacity:S.gridOpacity;if(s.showLabels!==undefined)S.showLabels=s.showLabels;if(s.persistentRoom)S._net.persistentRoom=s.persistentRoom;if(s.sharedLayers)S._net.sharedLayers=s.sharedLayers;if(s.sharedEditLayer)S._net.sharedEditLayer=s.sharedEditLayer;return true}}}catch(e){}return false},
  autosaveClear(){localStorage.removeItem("staffmaps_autosave")},
};

// ─── KEYBOARD SHORTCUTS ──────────────────
function onKeyDown(e){
  var ae=document.activeElement;
  if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.tagName==="TEXTAREA")return;
  if(ae&&(ae.tagName==="INPUT"||ae.tagName==="SELECT"||ae.tagName==="TEXTAREA"))return;
  /* Map tool shortcuts */
  if(!e.ctrlKey&&!e.altKey){
    if(e.key==="p"||e.key==="P"){e.preventDefault();activateMapTool(S._mapTool==="pin"?null:"pin");return}
    if(e.key==="m"||e.key==="M"){e.preventDefault();activateMapTool(S._mapTool==="distance"?null:"distance");return}
    if(e.key.toLowerCase()==="a"&&!S._drawMode&&!S._placementMode&&!S.selectedUnitId&&!S.selectedGraphicId){e.preventDefault();activateMapTool(S._mapTool==="area"?null:"area");return}
  }
  /* Map tool Enter/Backspace/Escape */
  if(S._mapTool==="distance"||S._mapTool==="area"){
    const pts=S._mapTool==="distance"?S._measurePoints:S._measureArea;
    if(e.key==="Enter"&&pts.length>=2){e.preventDefault();S._mapTool=null;hideModeBar();canvas.style.cursor="";requestRender();renderFloatingPanel();return}
    if(e.key==="Backspace"){e.preventDefault();if(pts.length)pts.pop();else{S._mapTool=null;hideModeBar();canvas.style.cursor=""}updateModeBar();requestRender();return}
    if(e.key==="Escape"){e.preventDefault();S._mapTool=null;hideModeBar();canvas.style.cursor="";requestRender();renderFloatingPanel();return}
  }
  if(S._mapTool&&e.key==="Escape"){e.preventDefault();S._mapTool=null;_freehandActive=false;_freehandPoints=[];hideModeBar();canvas.style.cursor="";requestRender();return}
  if(e.ctrlKey&&e.key==="s"){e.preventDefault();IO.projectSave()}
  else if(e.ctrlKey&&e.key==="o"){e.preventDefault();IO.requestImport()}
  else if(e.ctrlKey&&e.key==="z"){e.preventDefault();undo()}
  else if(e.ctrlKey&&e.key==="c"){e.preventDefault();copySelected()}
  else if(e.ctrlKey&&e.key==="v"){e.preventDefault();pasteClipboard()}
  else if(e.key==="Enter"){if(S._drawMode&&S._drawMode.points.length>=getMinPoints(S._drawMode.tool)){e.preventDefault();finishDrawing()}}
  else if(e.key==="Backspace"){e.preventDefault();if(S._drawMode){if(S._drawMode.points.length)undoDrawPoint();else cancelDrawing()}else if(S.selectedUnitId)deleteUnit(S.selectedUnitId);else if(S.selectedGraphicId)deleteGraphic(S.selectedGraphicId)}
  else if(e.key==="Delete"){e.preventDefault();if(S._drawMode){cancelDrawing()}else if(S.selectedUnitId)deleteUnit(S.selectedUnitId);else if(S.selectedGraphicId)deleteGraphic(S.selectedGraphicId)}
  else if(e.key==="Escape"){if(S._drawMode){if(S._drawMode.points.length)undoDrawPoint();else cancelDrawing()}else if(S._placementMode){S._placementMode=null;hideModeBar()}else{deselectAll()}}
  /* Arrow keys pan, +/- zoom */
  var panAmt=0.1/Math.pow(2,S.zoom-12);
  var _panTarget=null;
  function animatePan(targetLat,targetLon){var steps=8,step=0;var startLat=S.lat,startLon=S.lon;function tick(){step++;var t=step/steps;t=t<0.5?2*t*t:(1-Math.pow(-2*t+2,2)/2);S.lat=startLat+(targetLat-startLat)*t;S.lon=startLon+(targetLon-startLon)*t;requestRender();if(step<steps)requestAnimationFrame(tick)}tick()}
  if(e.key==="ArrowUp"){e.preventDefault();animatePan(Math.min(85,S.lat+panAmt),S.lon)}
  else if(e.key==="ArrowDown"){e.preventDefault();animatePan(Math.max(-85,S.lat-panAmt),S.lon)}
  else if(e.key==="ArrowLeft"){e.preventDefault();animatePan(S.lat,S.lon-panAmt)}
  else if(e.key==="ArrowRight"){e.preventDefault();animatePan(S.lat,S.lon+panAmt)}
  else if(e.key==="="||e.key==="+"){e.preventDefault();var zTarget=Math.min(20,S.zoom+0.5);var zStart=S.zoom,zStep=0;(function zt(){zStep++;var t=zStep/8;t=t<0.5?2*t*t:(1-Math.pow(-2*t+2,2)/2);S.zoom=zStart+(zTarget-zStart)*t;requestRender();if(zStep<8)requestAnimationFrame(zt)})()}
  else if(e.key==="-"||e.key==="_"){e.preventDefault();var zTarget2=Math.max(2,S.zoom-0.5);var zStart2=S.zoom,zStep2=0;(function zt2(){zStep2++;var t=zStep2/8;t=t<0.5?2*t*t:(1-Math.pow(-2*t+2,2)/2);S.zoom=zStart2+(zTarget2-zStart2)*t;requestRender();if(zStep2<8)requestAnimationFrame(zt2)})()}
}

// ─── INIT ────────────────────────────────

// Signal server config
function _peerOpts(){
  var ss=S._signalServer;
  if(!ss||!ss.host)return{debug:0};
  var iceServers=[{urls:"stun:stun.l.google.com:19302"}];
  if(S._turnServer&&S._turnServer.host){
    iceServers.push({urls:"turn:"+S._turnServer.host+":"+(S._turnServer.port||3478),username:S._turnServer.user||"staffmaps",credential:S._turnServer.pass||"staffmaps"});
  }
  return{debug:0,host:ss.host,port:ss.port||9000,path:"/peerjs",secure:!!ss.secure,config:{iceServers:iceServers}};
}
// Global toggle handlers for comms panel
window.toggleCustomServer=function(cb){
  if(cb.checked){S._signalServer={host:"",port:9000,secure:false}}else{S._signalServer=null}
  localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer));renderFloatingPanel();
};
window.toggleSSL=function(cb){
  if(!S._signalServer)S._signalServer={};S._signalServer.secure=cb.checked;
  localStorage.setItem("sm_signalServer",JSON.stringify(S._signalServer));
};
window.togglePersistRoom=function(cb){
  if(cb.checked){S._net.persistentRoom=S._net.roomCode;IO.autosave();IO.notify("Room "+S._net.roomCode+" will auto-host on next load","success")}
  else{S._net.persistentRoom=null;IO.autosave();IO.notify("Persistent room cleared")}
  renderFloatingPanel();
};

function init(){
  document.getElementById("app").innerHTML=`
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-dot"></div>
        <span class="topbar-title">STAFFMAPS</span><span style="font-size:9px;opacity:0.4;margin-left:4px">v15.8</span>
        <button class="btn" id="file-btn" style="padding:4px 10px;font-size:11px;margin-left:4px;min-height:32px">\u2630 FILE</button>
        <div class="file-menu" id="file-menu"></div>
        <button class="btn" id="undo-btn" style="padding:2px 6px;opacity:0.3;pointer-events:none" title="Undo" onclick="undo()">\u21a9</button>
      </div>
      <span class="topbar-coords" id="coords"></span>
    </div>
    <div class="main">
      <canvas id="mapCanvas"></canvas>
      <div class="icon-stack">
        <button class="stack-btn" id="sb-settings" title="Settings" onclick="togglePanel('settings')"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
        <button class="stack-btn" id="sb-comms" title="Comms" onclick="togglePanel('comms')"><svg viewBox="0 0 24 24"><path d="M5 12.55a11 11 0 0114.08 0"/><path d="M1.42 9a16 16 0 0121.16 0"/><path d="M8.53 16.11a6 6 0 016.95 0"/><circle cx="12" cy="20" r="1" fill="currentColor"/></svg></button>
        <button class="stack-btn" id="sb-chat" title="Chat" style="display:none" onclick="togglePanel('chat')"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>
        <button class="stack-btn" id="sb-layers" title="Layers" onclick="togglePanel('layers')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></button>
        <button class="stack-btn" id="sb-addunit" title="Add Unit / Draw" onclick="togglePanel('addunit')"><svg viewBox="0 0 24 24"><defs><mask id="pm"><rect width="24" height="24" fill="white"/><circle cx="19" cy="17" r="5.5" fill="black"/></mask></defs><g mask="url(#pm)"><rect x="2" y="4" width="15" height="11" rx="1" fill="none"/><line x1="2" y1="4" x2="17" y2="15"/><line x1="17" y1="4" x2="2" y2="15"/></g><line x1="19" y1="13.5" x2="19" y2="20.5"/><line x1="15.5" y1="17" x2="22.5" y2="17"/></svg></button>
        <button class="stack-btn" id="sb-maptools" title="Map Tools" onclick="togglePanel('maptools')"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="currentColor"/></svg></button>
        <button class="stack-btn" id="sb-ipb" title="IPB Wizard" onclick="togglePanel('ipb')"><svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 12l2 2 4-4"/></svg></button>
      </div>
      <div class="float-panel" id="float-panel">
        <div class="fp-header"><span class="fp-title" id="fp-title"></span><button class="btn" id="fp-close" style="width:32px;height:32px;min-height:32px;padding:0;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0">\u2715</button></div>
        <div class="fp-body" id="fp-body"></div>
      </div>
      <div class="editor-overlay" id="editor" style="display:none"></div>
      <div class="mode-bar" id="mode-bar" style="display:none"></div>
      <div class="zoom-ctrl"><button class="stack-btn" id="sb-panlock" title="Pan Only Mode (lock editing)" onclick="togglePanLock()" style="margin-bottom:4px"><svg viewBox="0 0 24 24"><path d="M5 9h14l1 12H4L5 9z"/><path d="M8 9V6a4 4 0 018 0v3"/></svg></button><button class="btn" id="zoom-in">+</button><button class="btn" id="zoom-out">\u2212</button></div>
      <div class="layer-indicator"><div class="dot" style="background:#4a9eff"></div>Default</div>
    </div>`;

  canvas=document.getElementById("mapCanvas");ctx=canvas.getContext("2d");

  // Resize
  function resize(){const d=devicePixelRatio||1,r=canvas.parentElement.getBoundingClientRect();canvas.style.width=r.width+"px";canvas.style.height=r.height+"px";canvas.width=r.width*d;canvas.height=r.height*d;detectLayout();requestRender()}
  window.addEventListener("resize",function(){_canvasRect=null;resize()});resize();
  // Apply saved UI scale
  document.documentElement.style.setProperty("--ui-scale",S.uiScale);

  // Pointer events
  canvas.addEventListener("pointerdown",onPointerDown);
  canvas.addEventListener("pointermove",onPointerMove,{passive:false});
  canvas.addEventListener("pointerup",onPointerUp);
  canvas.addEventListener("pointercancel",onPointerUp);
  document.addEventListener("pointerup",onPointerUp);
  document.addEventListener("pointercancel",onPointerUp);
  canvas.addEventListener("wheel",onWheel,{passive:false});
  /* iOS: prevent rubber-band bounce and double-tap zoom */
  canvas.addEventListener("touchmove",e=>e.preventDefault(),{passive:false});
  canvas.addEventListener("touchstart",e=>{if(e.touches.length>1)e.preventDefault()},{passive:false});
  canvas.addEventListener("contextmenu",onContextMenu);
  canvas.addEventListener("dblclick",onDblClick);
  document.addEventListener("keydown",onKeyDown);

  // Stack buttons — use inline onclick
  document.getElementById("fp-close").addEventListener("click",()=>{S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"))});

  // File menu
  document.getElementById("file-btn").addEventListener("click",toggleFileMenu);
  document.addEventListener("pointerdown",e=>{if(_fileMenuOpen&&!e.target.closest(".file-menu")&&!e.target.closest("#file-btn"))closeFileMenu()});

  // Zoom
  document.getElementById("zoom-in").addEventListener("click",()=>{smoothZoom(Math.min(19,S.zoom+1),null)});
  document.getElementById("zoom-out").addEventListener("click",()=>{smoothZoom(Math.max(2,S.zoom-1),null)});


  // Outside click dismiss
  document.addEventListener("pointerdown",e=>{if(S._activePanel&&!e.target.closest(".float-panel")&&!e.target.closest(".stack-btn")&&!e.target.closest(".icon-stack")){/* keep panel */}});

  // Theme
  document.body.setAttribute("data-theme",S.theme);
  document.documentElement.style.background=S.theme==="light"?"#e8e8e8":"#1a1a2e";

  // Restore signal server config
  try{var _sss=localStorage.getItem("sm_signalServer");if(_sss)S._signalServer=JSON.parse(_sss)}catch(e){}
  try{var _sts=localStorage.getItem("sm_turnServer");if(_sts)S._turnServer=JSON.parse(_sts)}catch(e){}

  // Autorestore
  if(IO.autorestore()){requestRender();updateLayerIndicator();notify("Restored autosave");
    if(S._net.persistentRoom&&S._net.mode==="offline"){setTimeout(function(){netCreateRoom(S._net.persistentRoom)},1500)}
  }

  // Autosave timer
  setInterval(()=>IO.autosave(),30000);
  window.addEventListener("beforeunload",()=>IO.autosave());
  /* iOS: beforeunload is unreliable — use pagehide and visibilitychange */
  window.addEventListener("pagehide",()=>IO.autosave());
  document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden")IO.autosave()});

  // Drag and drop import
  document.addEventListener("dragover",e=>e.preventDefault());
  document.addEventListener("drop",e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(!f)return;const ext=f.name.split(".").pop().toLowerCase();if(ext==="kmz"){f.arrayBuffer().then(buf=>IO.importKMZ(buf)).catch(err=>IO.notify("KMZ read error","error"));return}const reader=new FileReader();reader.onload=ev=>{if(ext==="tacmap"||ext==="json")IO.projectLoad(ev.target.result);else if(ext==="geojson")IO.importGeoJSON(ev.target.result);else if(ext==="kml")IO.importKML(ev.target.result)};reader.readAsText(f)});

  // iOS viewport handling — keyboard, address bar, safe areas
  function updateViewport(){
    const vv=window.visualViewport;
    const vh=vv?vv.height:window.innerHeight;
    const voffset=vv?vv.offsetTop:0;
    document.documentElement.style.setProperty("--app-h",vh+"px");
    document.documentElement.style.setProperty("--vp-offset",(voffset||0)+"px");
    /* Do NOT set html/body height — let them fill the full screen including safe areas.
       --app-h is only used for overlay max-height calculations. */
    resize();
  }
  _canvasRect=null;
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize",updateViewport);
    window.visualViewport.addEventListener("scroll",()=>{window.scrollTo(0,0)});
  }

  
  // Scroll focused input into view when iOS keyboard opens
  document.addEventListener("focusin",function(e){
    var t=e.target;
    if(!t||!t.closest||!t.closest(".float-panel,.editor-overlay"))return;
    if(t.tagName!=="INPUT"&&t.tagName!=="TEXTAREA"&&t.tagName!=="SELECT")return;
    setTimeout(function(){
      t.scrollIntoView({block:"center",behavior:"smooth"});
    },300);
  });

  // Show chat button when connected
  setInterval(()=>{const chatBtn=document.getElementById("sb-chat");if(chatBtn)chatBtn.style.display=S._net.mode!=="offline"?"":"none"},1000);

  // Service worker
  if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js").catch(()=>{})}
  console.log("STAFFMAPS init complete, units:",S.units.length,"graphics:",S.graphics.length);
}

document.addEventListener("DOMContentLoaded",init);
window.onerror=function(msg,url,line,col,err){document.title="ERR:"+line+":"+msg;console.error("STAFFMAPS ERROR at line",line,":",msg)};


</script>
</body>
</html>
