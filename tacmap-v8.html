<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ScheffMap">
<meta name="theme-color" content="#1a1a1a">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">
<title>ScheffMap — Tactical Map Engine</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
:root{--bg:#1a1a1a;--fg:#e0e0e0;--accent:#4a9eff;--accent2:#ffd700;--panel-bg:rgba(26,26,26,0.95);--btn-bg:rgba(255,255,255,0.1);--btn-hover:rgba(255,255,255,0.2);--border:rgba(255,255,255,0.15);--danger:#ff4444;--success:#44cc44;--warning:#ffaa00;--safe-top:env(safe-area-inset-top,0px);--safe-right:env(safe-area-inset-right,0px);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-left:env(safe-area-inset-left,0px);--font:'SF Mono','Fira Code',Consolas,Monaco,monospace}
[data-theme="light"]{--bg:#f0f0f0;--fg:#222;--panel-bg:rgba(240,240,240,0.95);--btn-bg:rgba(0,0,0,0.08);--btn-hover:rgba(0,0,0,0.15);--border:rgba(0,0,0,0.15)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;overscroll-behavior:none;font-family:var(--font);background:var(--bg);color:var(--fg);touch-action:none}
#app{width:100%;height:100%;display:flex;flex-direction:column}
.topbar{height:32px;padding:0 8px;padding-top:var(--safe-top);padding-left:calc(8px + var(--safe-left));padding-right:calc(8px + var(--safe-right));display:flex;align-items:center;justify-content:space-between;background:var(--panel-bg);border-bottom:1px solid var(--border);z-index:100;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);flex-shrink:0;position:relative}
.topbar-left{display:flex;align-items:center;gap:6px}.topbar-dot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}.topbar-dot.connected{background:var(--success);box-shadow:0 0 4px var(--success)}.topbar-dot.connecting{background:var(--warning)}.topbar-dot.error{background:var(--danger)}
.topbar-title{font-size:13px;font-weight:700;letter-spacing:2px}.topbar-right{display:flex;align-items:center;gap:6px}.topbar-coords{font-size:10px;opacity:0.7;white-space:nowrap}
.btn{background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:4px;font-family:var(--font);font-size:11px;cursor:pointer;padding:4px 8px;touch-action:manipulation;transition:background .15s}.btn:hover{background:var(--btn-hover)}.btn:active{background:rgba(255,255,255,.25)}.btn.danger{border-color:var(--danger);color:var(--danger)}.btn.primary{border-color:var(--accent);color:var(--accent)}
.main{flex:1;position:relative;overflow:hidden}.main canvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none}
.icon-stack{position:absolute;top:calc(8px + var(--safe-top));right:calc(8px + var(--safe-right));display:flex;flex-direction:column;gap:4px;z-index:50}
.stack-btn{width:44px;height:44px;border-radius:8px;border:1px solid var(--border);background:var(--panel-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation;position:relative;transition:background .15s}.stack-btn:hover{background:var(--btn-hover)}.stack-btn.active{border-color:var(--accent);background:rgba(74,158,255,.15)}.stack-btn.pulse-blue svg{animation:commsPulseBlue 2s infinite}.stack-btn.pulse-green svg{animation:commsPulseGreen 2s infinite}@keyframes commsPulseBlue{0%,100%{stroke:var(--fg)}50%{stroke:#4a9eff;filter:drop-shadow(0 0 4px #4a9eff)}}@keyframes commsPulseGreen{0%,100%{stroke:var(--fg)}50%{stroke:#44cc44;filter:drop-shadow(0 0 4px #44cc44)}}.stack-btn svg{width:20px;height:20px;stroke:var(--fg);stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round}.stack-btn .badge{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:var(--danger);color:#fff;font-size:9px;display:flex;align-items:center;justify-content:center;padding:0 3px;font-weight:700}
.float-panel{position:absolute;top:calc(8px + var(--safe-top));right:calc(56px + var(--safe-right));width:320px;max-height:calc(100% - 16px - var(--safe-top) - var(--safe-bottom));background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:45;display:none;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:slideIn .2s ease-out}.float-panel.open{display:flex}
@keyframes slideIn{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
.fp-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0}.fp-title{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.fp-body{overflow-y:auto;padding:8px 10px;flex:1;-webkit-overflow-scrolling:touch}.fp-body label{display:block;font-size:10px;opacity:.6;margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}.fp-body select,.fp-body input[type="text"],.fp-body input[type="number"],.fp-body input[type="password"]{width:100%;background:var(--btn-bg);color:var(--fg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:var(--font);font-size:11px;margin-bottom:8px;-webkit-appearance:none;appearance:none}.fp-body select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}.fp-body select option{background:#222;color:#e0e0e0}.fp-body input[type="range"]{width:100%;margin-bottom:8px}.fp-body .section{margin-bottom:12px}.fp-body .section-title{font-size:11px;font-weight:700;margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}.fp-body .row{display:flex;gap:4px;margin-bottom:4px}.fp-body .row .btn{flex:1}.fp-body .toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}.fp-body .toggle-row span{font-size:11px}
.editor-overlay{position:absolute;bottom:0;left:0;right:0;max-height:50vh;min-height:180px;background:var(--panel-bg);border-top:1px solid var(--border);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:60;display:none;flex-direction:column;animation:slideUp .2s ease-out}.editor-overlay.open{display:flex}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.editor-grip{height:20px;display:flex;align-items:center;justify-content:center;cursor:ns-resize;flex-shrink:0}.editor-grip::after{content:'';width:40px;height:4px;border-radius:2px;background:rgba(255,255,255,.2)}
.editor-header{display:flex;align-items:center;justify-content:space-between;padding:0 10px 6px;border-bottom:1px solid var(--border);flex-shrink:0}.editor-tabs{display:flex;gap:2px}
.editor-tab{padding:4px 10px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;border-radius:4px 4px 0 0;background:transparent;color:var(--fg);opacity:.5;border:none;font-family:var(--font);touch-action:manipulation}.editor-tab.active{opacity:1;background:var(--btn-bg)}.editor-actions{display:flex;gap:4px}
.editor-body{overflow-y:auto;padding:8px 10px;padding-bottom:calc(8px + var(--safe-bottom));flex:1;-webkit-overflow-scrolling:touch}
.icon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(52px,1fr));gap:3px;margin-bottom:8px}.icon-cell{aspect-ratio:1;border:1px solid var(--border);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;background:var(--btn-bg);touch-action:manipulation;transition:border-color .15s,background .15s}.icon-cell:hover{border-color:#fff;background:rgba(255,255,255,.12)}.icon-cell.selected{border-color:#ffd700;border-width:2px;background:rgba(255,215,0,.2);box-shadow:0 0 6px rgba(255,215,0,.4)}.icon-cell canvas{width:100%;height:100%}.icon-cell .tooltip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:2px 6px;border-radius:3px;font-size:9px;white-space:nowrap;pointer-events:none;display:none;z-index:999}.icon-cell:hover .tooltip{display:block}
.color-swatches{display:flex;gap:6px;margin:4px 0 8px}.swatch{width:28px;height:28px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:border-color .15s,transform .1s}.swatch:hover{transform:scale(1.15)}.swatch.active{border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.5)}
.cat-header{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;padding:4px 0;margin-top:6px;cursor:pointer;display:flex;align-items:center;gap:4px;opacity:.7}.cat-header::before{content:'\25b8';font-size:8px;transition:transform .15s}.cat-header.open::before{transform:rotate(90deg)}
.mode-bar{position:absolute;bottom:calc(12px + var(--safe-bottom));left:50%;transform:translateX(-50%);background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:6px 10px;display:none;align-items:center;gap:8px;z-index:55;white-space:nowrap;box-shadow:0 2px 12px rgba(0,0,0,.4)}.mode-bar.open{display:flex}.mode-info{font-size:11px;opacity:.8}.mode-bar .btn{min-width:44px;min-height:36px;font-size:14px}.mode-bar .btn.done{border-color:var(--accent2);color:var(--accent2)}.mode-bar .btn.done.ready{animation:goldPulse 1.5s infinite}@keyframes goldPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px var(--accent2)}}
.zoom-ctrl{position:absolute;bottom:calc(12px + var(--safe-bottom));right:calc(8px + var(--safe-right));display:flex;flex-direction:column;gap:2px;z-index:50}.zoom-ctrl .btn{width:44px;height:44px;font-size:18px;font-weight:700;border-radius:6px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center}
.layer-indicator{position:absolute;bottom:calc(8px + var(--safe-bottom));left:calc(8px + var(--safe-left));display:flex;align-items:center;gap:4px;font-size:10px;opacity:.6;z-index:50}.layer-indicator .dot{width:8px;height:8px;border-radius:50%}
.file-menu{position:absolute;top:100%;left:0;min-width:220px;background:var(--panel-bg);border:1px solid var(--border);border-radius:6px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:110;display:none;padding:4px 0}.file-menu.open{display:block}.file-menu .fm-section{padding:2px 8px;font-size:9px;text-transform:uppercase;letter-spacing:1px;opacity:.4;margin-top:4px}.file-menu .fm-item{padding:6px 12px;font-size:11px;cursor:pointer;display:flex;align-items:center;gap:6px;touch-action:manipulation}.file-menu .fm-item:hover{background:var(--btn-hover)}.file-menu .fm-item.disabled{opacity:.3;pointer-events:none}.file-menu .fm-divider{height:1px;background:var(--border);margin:2px 0}.file-menu .fm-status{padding:4px 12px;font-size:9px;opacity:.4}
.toast{position:fixed;top:40px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 16px;border-radius:6px;font-size:12px;font-family:var(--font);z-index:9999;border:1px solid var(--accent);animation:toastIn .3s ease-out;box-shadow:0 4px 12px rgba(0,0,0,.4)}.toast.error{border-color:var(--danger)}@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.color-swatches{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px}.color-swatch{width:22px;height:22px;border-radius:3px;cursor:pointer;border:2px solid transparent;touch-action:manipulation}.color-swatch.selected{border-color:#fff;box-shadow:0 0 4px rgba(255,255,255,.5)}
.switch{position:relative;width:36px;height:20px;flex-shrink:0}.switch input{opacity:0;width:0;height:0}.switch .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--btn-bg);border:1px solid var(--border);border-radius:10px;transition:.2s}.switch .slider::before{content:'';position:absolute;height:14px;width:14px;left:2px;bottom:2px;background:var(--fg);border-radius:50%;transition:.2s}.switch input:checked+.slider{background:var(--accent);border-color:var(--accent)}.switch input:checked+.slider::before{transform:translateX(16px)}
.layer-item{display:flex;align-items:center;gap:4px;padding:4px;border-radius:4px;margin-bottom:2px;cursor:pointer;font-size:11px}.layer-item:hover{background:var(--btn-hover)}.layer-item.active{background:rgba(74,158,255,.1);border-left:2px solid var(--accent)}.layer-item .layer-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}.layer-item .layer-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.layer-item .layer-eye{opacity:.5;cursor:pointer;font-size:12px}.layer-item .layer-eye.visible{opacity:1}
.preview-wrap{display:flex;justify-content:center;margin-bottom:8px}.preview-wrap canvas{border:1px solid var(--border);border-radius:4px;background:rgba(0,0,0,.3)}
@media(max-width:500px){.float-panel{right:0;left:0;width:auto;max-height:55vh;top:auto;bottom:0;border-radius:12px 12px 0 0;padding-bottom:var(--safe-bottom)}.editor-overlay{max-height:45vh}}
@media(min-width:501px) and (max-width:900px){.float-panel{width:300px}}
@media(max-height:500px){.icon-stack{flex-direction:row;top:auto;bottom:calc(4px + var(--safe-bottom));right:auto;left:50%;transform:translateX(-50%)}.stack-btn{width:38px;height:38px}.float-panel{right:auto;left:calc(4px + var(--safe-left));top:calc(32px + var(--safe-top));max-height:calc(100% - 80px);width:280px}.zoom-ctrl{flex-direction:row;bottom:auto;top:calc(36px + var(--safe-top))}.topbar{height:24px}}

</style>
</head>
<body>
<div id="app"></div>
<script>
"use strict";

// === part_01_constants.js ===

const SVG_W=120,SVG_H=140,CX=60,CY=62,FRAME_W=70,FRAME_H=50,U=10,DEG=Math.PI/180,TILE_SIZE=256,MAX_UNDO=30;
const TILE_SOURCES={osm:{name:"OpenStreetMap",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:19},esri_sat:{name:"ESRI Satellite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:19},esri_topo:{name:"ESRI Topo",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",maxZoom:19},opentopo:{name:"OpenTopo",url:"https://tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17},usgs_topo:{name:"USGS Topo",url:"https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}",maxZoom:16},stamen:{name:"Stamen Terrain",url:"https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.png",maxZoom:18}};
const AFFILIATIONS={friendly:{color:"#0055FF",fill:"#C5DFFF",shape:"rect",label:"Friendly"},hostile:{color:"#FF0000",fill:"#F88080",shape:"diamond",label:"Hostile"},neutral:{color:"#00AA00",fill:"#C5FFC5",shape:"square",label:"Neutral"},unknown:{color:"#DDAA00",fill:"#FFFAC5",shape:"quatrefoil",label:"Unknown"}};
const UNIT_CATEGORIES=[{name:"Infantry, Tanks & Artillery",types:[{id:"infantry",label:"Infantry"},{id:"mechanized_infantry",label:"Mech Infantry"},{id:"armor",label:"Armor"},{id:"cavalry",label:"Cavalry"},{id:"armored_recon",label:"Armored Recon"},{id:"artillery",label:"Artillery"},{id:"mechanized_artillery",label:"Mech Artillery"},{id:"rocket_artillery",label:"Rocket Arty"},{id:"mortar",label:"Mortar"},{id:"air_defense",label:"Air Defense"},{id:"anti_armor",label:"Anti-Armor"}]},{name:"Aviation & Air Defense",types:[{id:"aviation",label:"Aviation"},{id:"attack_aviation",label:"Attack Aviation"},{id:"recon_aviation",label:"Recon Aviation"},{id:"medevac_aviation",label:"MEDEVAC"},{id:"uav",label:"UAV"}]},{name:"Engineer",types:[{id:"engineer",label:"Engineer"},{id:"bridging",label:"Bridging"}]},{name:"Command, Signal & EW",types:[{id:"headquarters",label:"HQ"},{id:"signal",label:"Signal"},{id:"military_intelligence",label:"MI"},{id:"electronic_warfare",label:"EW"},{id:"cyber",label:"Cyber"}]},{name:"Logistics & Medical",types:[{id:"sustainment",label:"Sustainment"},{id:"medical",label:"Medical"},{id:"maintenance",label:"Maintenance"},{id:"transportation",label:"Transport"},{id:"supply",label:"Supply"},{id:"ordnance",label:"Ordnance"}]},{name:"Special Forces",types:[{id:"special_forces",label:"SF"},{id:"ranger",label:"Ranger"},{id:"civil_affairs",label:"Civil Affairs"},{id:"psyop",label:"PSYOP"}]}];
const ECHELONS=[{id:"team",label:"Team",mark:"dot1"},{id:"squad",label:"Squad",mark:"dot2"},{id:"section",label:"Section",mark:"dot3"},{id:"platoon",label:"Platoon",mark:"bar1"},{id:"company",label:"Company",mark:"bar1l"},{id:"battalion",label:"Battalion",mark:"bar2"},{id:"regiment",label:"Regt/Group",mark:"bar3"},{id:"brigade",label:"Brigade",mark:"bar1x"},{id:"division",label:"Division",mark:"xx"},{id:"corps",label:"Corps",mark:"xxx"},{id:"army",label:"Army",mark:"xxxx"},{id:"army_group",label:"Army Group",mark:"xxxxx"},{id:"theater",label:"Theater",mark:"xxxxxx"}];
const MODIFIERS=[{id:"reinforced",label:"+",symbol:"+"},{id:"reduced",label:"\u2212",symbol:"\u2212"},{id:"airborne",label:"Airborne",symbol:"\u2297"},{id:"air_assault",label:"Air Assault",symbol:"\u2298"},{id:"mountain",label:"Mountain",symbol:"\u25b2"},{id:"arctic",label:"Arctic",symbol:"\u2744"},{id:"amphibious",label:"Amphibious",symbol:"\u2248"},{id:"light",label:"Light",symbol:"L"},{id:"heavy",label:"Heavy",symbol:"H"},{id:"motorized",label:"Motorized",symbol:"\u2299"},{id:"mechanized",label:"Mechanized",symbol:"\u229b"},{id:"wheeled",label:"Wheeled",symbol:"W"}];
const EQUIPMENT_DEFAULTS={infantry:{vehicle:"HMMWV",crew:9,weapon:"M4/M249",maxRange:3600},mechanized_infantry:{vehicle:"M2 Bradley",crew:9,weapon:"25mm/TOW",maxRange:3750,sensorRange:4000},armor:{vehicle:"M1A2 Abrams",crew:4,weapon:"120mm",maxRange:4000,sensorRange:5000,speed:67},cavalry:{vehicle:"M3 Bradley",crew:5,weapon:"25mm/TOW",maxRange:3750,sensorRange:6000},artillery:{vehicle:"M777",crew:8,weapon:"155mm",maxRange:30000},mechanized_artillery:{vehicle:"M109A7",crew:4,weapon:"155mm",maxRange:30000,speed:56},rocket_artillery:{vehicle:"M270 MLRS",crew:3,weapon:"MLRS",maxRange:70000},mortar:{vehicle:"M1129",crew:4,weapon:"120mm Mortar",maxRange:7200},air_defense:{vehicle:"M-SHORAD",crew:3,weapon:"Stinger/30mm",maxRange:8000,sensorRange:15000},anti_armor:{vehicle:"HMMWV",crew:4,weapon:"Javelin/TOW",maxRange:4750},aviation:{vehicle:"UH-60",crew:4,speed:294},attack_aviation:{vehicle:"AH-64D",crew:2,weapon:"Hellfire/30mm",maxRange:8000,sensorRange:12000,speed:293},uav:{vehicle:"MQ-1C Gray Eagle",sensorRange:25000,speed:280},engineer:{vehicle:"M9 ACE",crew:1},special_forces:{crew:12,weapon:"Various"},ranger:{crew:12,weapon:"Various"}};
const GRAPHIC_COLORS=["#ff4444","#4a9eff","#44cc44","#ffd700","#ff8800","#ffffff","#000000","#00ffff","#ff00ff","#8b4513"];
const OVERLAY_TYPES=[{id:"none",label:"Basic"},{id:"pl",label:"Phase Line"},{id:"boundary",label:"Boundary"},{id:"obj",label:"Objective"},{id:"aa",label:"Assembly Area"},{id:"axis",label:"Axis of Advance"},{id:"route",label:"Route"}];


// === part_02_state_coords.js ===

let canvas,ctx;const tileCache=new Map();let _renderQueued=false,_fileMenuOpen=false;
const S={lat:38.8977,lon:-77.0365,zoom:12,tileSource:"osm",theme:"dark",showGrid:true,gridOpacity:0.5,gridColor:"#00ff00",gridMode:"mgrs",gridSpacing:"auto",coordDisplay:"mgrs",units:[],graphics:[],layers:[{id:"default",name:"Default",color:"#4a9eff",visible:true}],activeLayerId:"default",selectedUnitId:null,selectedGraphicId:null,editorTab:"icon",editorPinned:false,_activePanel:null,_drawMode:null,_placementMode:null,_isPanning:false,_panStart:null,_lastPointerType:"mouse",_activePointers:new Map(),_pinchStartDist:null,_pinchStartZoom:null,_layout:"desktop",_isLandscape:false,undoStack:[],_net:{peer:null,conns:[],isHost:false,roomCode:null,hostConn:null,mode:"offline",editMode:"observer",joinOrder:0,nextJoinOrder:1,peerName:localStorage.getItem("scheffmap_callsign")||"",peerNames:{},status:"",encEnabled:false,encKey:null,passphrase:"",chatMessages:[],unreadCount:0,chatTarget:"room"},_overrides:JSON.parse(localStorage.getItem("tacmap-overrides")||'{}')};

function latlonToPixel(lat,lon,zoom){const s=Math.pow(2,zoom)*TILE_SIZE;return{x:((lon+180)/360)*s,y:(0.5-Math.log((1+Math.sin(lat*DEG))/(1-Math.sin(lat*DEG)))/(4*Math.PI))*s}}
function pixelToLatlon(px,py,zoom){const s=Math.pow(2,zoom)*TILE_SIZE,n=Math.PI-2*Math.PI*py/s;return{lat:(180/Math.PI)*Math.atan(.5*(Math.exp(n)-Math.exp(-n))),lon:(px/s)*360-180}}
function worldToScreen(wx,wy){const d=devicePixelRatio||1,c=latlonToPixel(S.lat,S.lon,S.zoom);return{x:(wx-c.x)*d+canvas.width/2,y:(wy-c.y)*d+canvas.height/2}}
function screenToWorld(sx,sy){const d=devicePixelRatio||1,c=latlonToPixel(S.lat,S.lon,S.zoom);return{x:(sx-canvas.width/2)/d+c.x,y:(sy-canvas.height/2)/d+c.y}}
function screenToLatlon(sx,sy){const d=devicePixelRatio||1,w=screenToWorld(sx*d,sy*d);return pixelToLatlon(w.x,w.y,S.zoom)}
function latlonToScreen(lat,lon){const p=latlonToPixel(lat,lon,S.zoom),s=worldToScreen(p.x,p.y),d=devicePixelRatio||1;return{x:s.x/d,y:s.y/d}}
function latlonToUTM(lat,lon){const z=Math.floor((lon+180)/6)+1,lo=(z-1)*6-180+3,a=6378137,ff=1/298.257223563,e2=2*ff-ff*ff,ep2=e2/(1-e2),k0=.9996,lr=lat*DEG,lonR=lon*DEG,l0=lo*DEG,N=a/Math.sqrt(1-e2*Math.sin(lr)*Math.sin(lr)),T=Math.tan(lr)**2,C=ep2*Math.cos(lr)**2,A=Math.cos(lr)*(lonR-l0),M=a*((1-e2/4-3*e2**2/64-5*e2**3/256)*lr-(3*e2/8+3*e2**2/32+45*e2**3/1024)*Math.sin(2*lr)+(15*e2**2/256+45*e2**3/1024)*Math.sin(4*lr)-(35*e2**3/3072)*Math.sin(6*lr));let e=k0*N*(A+(1-T+C)*A**3/6+(5-18*T+T**2+72*C-58*ep2)*A**5/120)+500000,n=k0*(M+N*Math.tan(lr)*(A**2/2+(5-T+9*C+4*C**2)*A**4/24+(61-58*T+T**2+600*C-330*ep2)*A**6/720));if(lat<0)n+=10000000;return{zone:z,easting:e,northing:n,letter:"CDEFGHJKLMNPQRSTUVWX"[lat<-80||lat>84?-1:Math.floor((lat+80)/8)]||"Z"}}
function UTMToLatlon(zone,easting,northing,northern){const a=6378137,ff=1/298.257223563,e2=2*ff-ff*ff,ep2=e2/(1-e2),e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2)),k0=.9996,x=easting-500000,y=northern?northing:northing-10000000,M=y/k0,mu=M/(a*(1-e2/4-3*e2**2/64-5*e2**3/256)),p1=mu+(3*e1/2-27*e1**3/32)*Math.sin(2*mu)+(21*e1**2/16-55*e1**4/32)*Math.sin(4*mu)+(151*e1**3/96)*Math.sin(6*mu),N1=a/Math.sqrt(1-e2*Math.sin(p1)**2),T1=Math.tan(p1)**2,C1=ep2*Math.cos(p1)**2,R1=a*(1-e2)/(1-e2*Math.sin(p1)**2)**1.5,D=x/(N1*k0);return{lat:(p1-(N1*Math.tan(p1)/R1)*(D**2/2-(5+3*T1+10*C1-4*C1**2-9*ep2)*D**4/24+(61+90*T1+298*C1+45*T1**2-252*ep2-3*C1**2)*D**6/720))/DEG,lon:(D-(1+2*T1+C1)*D**3/6+(5-2*C1+28*T1-3*C1**2+8*ep2+24*T1**2)*D**5/120)/Math.cos(p1)/DEG+(zone-1)*6-180+3}}
function toMGRS(lat,lon){try{const u=latlonToUTM(lat,lon),s=(u.zone-1)%6,cL="ABCDEFGHJKLMNPQRSTUVWXYZ",rL=s%2===0?"ABCDEFGHJKLMNPQRSTUV":"FGHJKLMNPQRSTUVABCDE",c=Math.floor(u.easting/1e5),r=Math.floor(u.northing%2e6/1e5);return`${u.zone}${u.letter} ${cL[(c-1+s*8)%24]||"?"}${rL[r%20]||"?"} ${String(Math.floor(u.easting%1e5)).padStart(5,"0")} ${String(Math.floor(u.northing%1e5)).padStart(5,"0")}`}catch(e){return"---"}}
function metersToPixels(m,lat,zoom){return m/((Math.cos(lat*DEG)*2*Math.PI*6378137)/(Math.pow(2,zoom)*TILE_SIZE))}


// === part_03_render.js ===

function requestRender(){if(_renderQueued)return;_renderQueued=true;requestAnimationFrame(()=>{_renderQueued=false;render()})}
function render(){if(!canvas||!ctx)return;const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;ctx.clearRect(0,0,W,H);ctx.fillStyle=S.theme==="dark"?"#1a1a2e":"#e8e8e8";ctx.fillRect(0,0,W,H);drawTiles();if(S.showGrid)drawGrid();drawGraphics();drawUnits();drawDrawPreview()}
function drawTiles(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height,src=TILE_SOURCES[S.tileSource];if(!src)return;const z=Math.floor(S.zoom),mt=1<<z,cen=latlonToPixel(S.lat,S.lon,S.zoom),sc=Math.pow(2,S.zoom-z),tss=TILE_SIZE*sc*d;for(let tx=Math.floor((cen.x-W/(2*d))/TILE_SIZE/sc);tx<=Math.ceil((cen.x+W/(2*d))/TILE_SIZE/sc);tx++)for(let ty=Math.floor((cen.y-H/(2*d))/TILE_SIZE/sc);ty<=Math.ceil((cen.y+H/(2*d))/TILE_SIZE/sc);ty++){if(ty<0||ty>=mt)continue;const wx=((tx%mt)+mt)%mt,dx=(tx*TILE_SIZE*sc-cen.x)*d+W/2,dy=(ty*TILE_SIZE*sc-cen.y)*d+H/2,key=`${S.tileSource}/${z}/${wx}/${ty}`;let t=tileCache.get(key);if(!t){t={img:new Image(),loaded:false};t.img.crossOrigin="anonymous";t.img.onload=()=>{t.loaded=true;requestRender()};t.img.onerror=()=>{t.error=true};t.img.src=src.url.replace("{z}",z).replace("{x}",wx).replace("{y}",ty);tileCache.set(key,t);if(tileCache.size>2000)tileCache.delete(tileCache.keys().next().value)}if(t.loaded)ctx.drawImage(t.img,dx,dy,tss+1,tss+1)}}
function drawGrid(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;if(S.gridMode==="latlon"){drawLLGrid();return}ctx.save();ctx.globalAlpha=S.gridOpacity;ctx.strokeStyle=S.gridColor;ctx.fillStyle=S.gridColor;ctx.font=`${10*d}px ${getComputedStyle(document.body).fontFamily}`;let sp=S.gridSpacing==="auto"?(S.zoom<7?1e5:S.zoom<10?1e5:S.zoom<12?1e4:S.zoom<15?1e3:100):parseInt(S.gridSpacing);const tl=screenToLatlon(0,0),br=screenToLatlon(W/d,H/d),latMin=Math.max(br.lat,-80),latMax=Math.min(tl.lat,84),lonMin=tl.lon,lonMax=br.lon;const zMin=Math.max(1,Math.floor((lonMin+180)/6)+1),zMax=Math.min(60,Math.floor((lonMax+180)/6)+1);/* GZD labels at low zoom */if(S.zoom<7){const L="CDEFGHJKLMNPQRSTUVWX";for(let zone=zMin;zone<=zMax;zone++){const zL0=(zone-1)*6-180,zL1=zone*6-180;/* zone boundary lines */const spT=latlonToScreen(latMax,zL0),spB=latlonToScreen(latMin,zL0);ctx.beginPath();ctx.moveTo(spT.x*d,spT.y*d);ctx.lineTo(spB.x*d,spB.y*d);ctx.lineWidth=1.5*d;ctx.stroke();/* lat band boundaries */for(let i=0;i<=L.length;i++){const bL=-80+i*8;if(bL<latMin-2||bL>latMax+2)continue;const spA=latlonToScreen(bL,Math.max(lonMin,zL0)),spB2=latlonToScreen(bL,Math.min(lonMax,zL1));ctx.beginPath();ctx.moveTo(spA.x*d,spA.y*d);ctx.lineTo(spB2.x*d,spB2.y*d);ctx.lineWidth=1*d;ctx.stroke()}/* GZD labels only at z5+ */if(S.zoom>=5){for(let i=0;i<L.length;i++){const bL=-80+i*8+4;if(bL<latMin-4||bL>latMax+4)continue;const ss=latlonToScreen(bL,(zL0+zL1)/2);ctx.globalAlpha=Math.min(S.gridOpacity,.8);ctx.font=`bold ${Math.min(16,10+S.zoom)*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(`${zone}${L[i]}`,ss.x*d,ss.y*d);ctx.globalAlpha=S.gridOpacity}}}ctx.restore();return}/* UTM grid lines — only when zoomed in enough, cap at 12 visible zones */const maxZones=Math.min(zMax,zMin+11);for(let zone=zMin;zone<=maxZones;zone++){const zL0=(zone-1)*6-180,zL1=zone*6-180,cL0=Math.max(lonMin,zL0+.01),cL1=Math.min(lonMax,zL1-.01),mLat=(latMin+latMax)/2;let uMin,uMax;try{uMin=latlonToUTM(mLat,cL0);uMax=latlonToUTM(mLat,cL1)}catch(e){continue}const eMin=Math.floor(uMin.easting/sp)*sp,eMax=Math.ceil(uMax.easting/sp)*sp,nMU=latlonToUTM(latMin,(cL0+cL1)/2),nXU=latlonToUTM(latMax,(cL0+cL1)/2),nMin=Math.floor(nMU.northing/sp)*sp,nMax=Math.ceil(nXU.northing/sp)*sp,nor=mLat>=0;ctx.lineWidth=sp>=1e5?2*d:sp>=1e4?1.5*d:d;for(let e=eMin;e<=eMax;e+=sp){if(e<1e5||e>9e5)continue;ctx.beginPath();let f=true;for(let lat=latMin;lat<=latMax;lat+=Math.max(.5,(latMax-latMin)/40)){try{const ll=UTMToLatlon(zone,e,latlonToUTM(lat,(zL0+zL1)/2).northing,nor),ss=latlonToScreen(ll.lat,ll.lon);f?(ctx.moveTo(ss.x*d,ss.y*d),f=false):ctx.lineTo(ss.x*d,ss.y*d)}catch(ex){}}ctx.stroke()}for(let n=nMin;n<=nMax;n+=sp){ctx.beginPath();let f=true;for(let e=eMin;e<=eMax;e+=Math.max(sp/4,1e3)){if(e<1e5||e>9e5)continue;try{const ll=UTMToLatlon(zone,e,n,nor),ss=latlonToScreen(ll.lat,ll.lon);f?(ctx.moveTo(ss.x*d,ss.y*d),f=false):ctx.lineTo(ss.x*d,ss.y*d)}catch(ex){}}ctx.stroke()}if(S.zoom<9){const L="CDEFGHJKLMNPQRSTUVWX";for(let i=0;i<L.length;i++){const bL=-80+i*8+4;if(bL<latMin-4||bL>latMax+4)continue;const ss=latlonToScreen(bL,(zL0+zL1)/2);ctx.globalAlpha=Math.min(S.gridOpacity,.7);ctx.font=`bold ${14*d}px ${getComputedStyle(document.body).fontFamily}`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(`${zone}${L[i]}`,ss.x*d,ss.y*d);ctx.globalAlpha=S.gridOpacity;ctx.font=`${10*d}px ${getComputedStyle(document.body).fontFamily}`}}}ctx.restore()}
function drawLLGrid(){const d=devicePixelRatio||1,W=canvas.width,H=canvas.height;ctx.save();ctx.globalAlpha=S.gridOpacity;ctx.strokeStyle=S.gridColor;ctx.fillStyle=S.gridColor;ctx.lineWidth=d;ctx.font=`${9*d}px ${getComputedStyle(document.body).fontFamily}`;const tl=screenToLatlon(0,0),br=screenToLatlon(W/d,H/d),st=S.zoom<4?10:S.zoom<7?5:S.zoom<10?1:S.zoom<13?.1:.01;for(let lat=Math.floor(br.lat/st)*st;lat<=Math.ceil(tl.lat/st)*st;lat+=st){const a=latlonToScreen(lat,tl.lon),b=latlonToScreen(lat,br.lon);ctx.beginPath();ctx.moveTo(a.x*d,a.y*d);ctx.lineTo(b.x*d,b.y*d);ctx.stroke();ctx.fillText(`${lat.toFixed(st<1?2:0)}\u00b0`,4*d,a.y*d-3*d)}for(let lon=Math.floor(tl.lon/st)*st;lon<=Math.ceil(br.lon/st)*st;lon+=st){const a=latlonToScreen(tl.lat,lon),b=latlonToScreen(br.lat,lon);ctx.beginPath();ctx.moveTo(a.x*d,a.y*d);ctx.lineTo(b.x*d,b.y*d);ctx.stroke();ctx.fillText(`${lon.toFixed(st<1?2:0)}\u00b0`,a.x*d+3*d,14*d)}ctx.restore()}


// === part_04_units.js ===

function drawUnitIcon(c2,u,cx,cy,sz){const sc=sz/SVG_W;c2.save();c2.translate(cx-sz/2,cy-sz/2);c2.scale(sc,sc);const a=AFFILIATIONS[u.affiliation||"friendly"],col=a.color,sw=3,hw=FRAME_W/2,hh=FRAME_H/2,B=CY+hh;if(u.isHQ){c2.beginPath();c2.moveTo(CX,B);c2.lineTo(CX,SVG_H-U*.5);c2.strokeStyle="#000";c2.lineWidth=sw;c2.stroke()}c2.fillStyle=a.fill;c2.strokeStyle=col;c2.lineWidth=sw;switch(a.shape){case"rect":c2.beginPath();c2.rect(CX-hw,CY-hh,FRAME_W,FRAME_H);c2.fill();c2.stroke();break;case"diamond":{const dx=hw+U*.6,dy=hh+U*.6;c2.beginPath();c2.moveTo(CX,CY-dy);c2.lineTo(CX+dx,CY);c2.lineTo(CX,CY+dy);c2.lineTo(CX-dx,CY);c2.closePath();c2.fill();c2.stroke();break}case"square":{const sq=Math.max(hw,hh)+U*.2;c2.beginPath();c2.rect(CX-sq,CY-sq,sq*2,sq*2);c2.fill();c2.stroke();break}case"quatrefoil":{const r=hh*.55;c2.beginPath();c2.moveTo(CX,CY-hh-U*.3);c2.bezierCurveTo(CX+r,CY-hh-U*.3,CX+hw+U*.3,CY-r,CX+hw+U*.3,CY);c2.bezierCurveTo(CX+hw+U*.3,CY+r,CX+r,CY+hh+U*.3,CX,CY+hh+U*.3);c2.bezierCurveTo(CX-r,CY+hh+U*.3,CX-hw-U*.3,CY+r,CX-hw-U*.3,CY);c2.bezierCurveTo(CX-hw-U*.3,CY-r,CX-r,CY-hh-U*.3,CX,CY-hh-U*.3);c2.closePath();c2.fill();c2.stroke();break}}c2.strokeStyle="#000";c2.fillStyle="#000";c2.lineWidth=2.5;drawTS(c2,u.type,CX,CY,hw*.7);if(u.echelon)drawEch(c2,u.echelon,u.affiliation);if(u.modifiers&&u.modifiers.length)drawMods(c2,u.modifiers);if(u.designation){c2.fillStyle="#000";c2.font=`bold ${U*1.1}px sans-serif`;c2.textAlign="center";c2.textBaseline="top";c2.fillText(u.designation,CX,B+U*.5)}c2.restore()}
function drawTS(c2,t,cx,cy,r){switch(t){case"infantry":c2.beginPath();c2.moveTo(cx-r,cy-r*.6);c2.lineTo(cx+r,cy+r*.6);c2.moveTo(cx+r,cy-r*.6);c2.lineTo(cx-r,cy+r*.6);c2.stroke();break;case"mechanized_infantry":c2.beginPath();c2.moveTo(cx-r,cy-r*.6);c2.lineTo(cx+r,cy+r*.6);c2.moveTo(cx+r,cy-r*.6);c2.lineTo(cx-r,cy+r*.6);c2.stroke();c2.beginPath();c2.ellipse(cx,cy+r*.9,r*.5,r*.25,0,0,Math.PI*2);c2.stroke();break;case"armor":c2.beginPath();c2.ellipse(cx,cy,r*.85,r*.55,0,0,Math.PI*2);c2.stroke();c2.beginPath();c2.moveTo(cx-r*.6,cy+r*.4);c2.lineTo(cx+r*.6,cy-r*.4);c2.stroke();break;case"cavalry":c2.beginPath();c2.moveTo(cx-r,cy+r*.5);c2.lineTo(cx+r,cy-r*.5);c2.stroke();break;case"armored_recon":c2.beginPath();c2.moveTo(cx-r,cy+r*.5);c2.lineTo(cx+r,cy-r*.5);c2.stroke();c2.beginPath();c2.ellipse(cx,cy,r*.5,r*.35,0,0,Math.PI*2);c2.stroke();break;case"artillery":c2.beginPath();c2.arc(cx,cy,r*.2,0,Math.PI*2);c2.fill();break;case"mechanized_artillery":c2.beginPath();c2.arc(cx,cy,r*.2,0,Math.PI*2);c2.fill();c2.beginPath();c2.ellipse(cx,cy+r*.9,r*.5,r*.25,0,0,Math.PI*2);c2.stroke();break;case"rocket_artillery":for(let i=-1;i<=1;i++){c2.beginPath();c2.arc(cx,cy+i*r*.4,r*.18,0,Math.PI*2);c2.fill()}break;case"mortar":c2.beginPath();c2.arc(cx,cy+r*.2,r*.2,0,Math.PI*2);c2.fill();c2.beginPath();c2.moveTo(cx,cy-r*.7);c2.lineTo(cx,cy+r*.2);c2.moveTo(cx-r*.4,cy-r*.1);c2.lineTo(cx+r*.4,cy-r*.1);c2.stroke();break;case"air_defense":c2.beginPath();c2.moveTo(cx-r*.6,cy+r*.4);c2.lineTo(cx,cy-r*.5);c2.lineTo(cx+r*.6,cy+r*.4);c2.stroke();c2.beginPath();c2.ellipse(cx,cy+r*.55,r*.5,r*.2,0,0,Math.PI*2);c2.stroke();break;case"anti_armor":c2.beginPath();c2.moveTo(cx-r*.6,cy-r*.3);c2.lineTo(cx,cy+r*.4);c2.lineTo(cx+r*.6,cy-r*.3);c2.stroke();break;case"aviation":c2.beginPath();c2.moveTo(cx-r,cy);c2.lineTo(cx+r,cy);c2.stroke();c2.beginPath();c2.arc(cx,cy,r*.15,0,Math.PI*2);c2.fill();break;case"attack_aviation":c2.beginPath();c2.moveTo(cx-r,cy);c2.lineTo(cx+r,cy);c2.stroke();c2.beginPath();c2.arc(cx,cy,r*.15,0,Math.PI*2);c2.fill();c2.beginPath();c2.moveTo(cx-r*.5,cy-r*.5);c2.lineTo(cx+r*.5,cy+r*.5);c2.moveTo(cx+r*.5,cy-r*.5);c2.lineTo(cx-r*.5,cy+r*.5);c2.stroke();break;case"recon_aviation":c2.beginPath();c2.moveTo(cx-r,cy);c2.lineTo(cx+r,cy);c2.stroke();c2.beginPath();c2.arc(cx,cy,r*.15,0,Math.PI*2);c2.fill();c2.beginPath();c2.moveTo(cx-r*.4,cy+r*.5);c2.lineTo(cx+r*.4,cy-r*.5);c2.stroke();break;case"medevac_aviation":c2.beginPath();c2.moveTo(cx-r,cy);c2.lineTo(cx+r,cy);c2.stroke();c2.beginPath();c2.moveTo(cx,cy-r*.4);c2.lineTo(cx,cy+r*.4);c2.moveTo(cx-r*.3,cy);c2.lineTo(cx+r*.3,cy);c2.stroke();break;case"uav":c2.beginPath();c2.moveTo(cx-r*.7,cy+r*.2);c2.lineTo(cx,cy-r*.4);c2.lineTo(cx+r*.7,cy+r*.2);c2.stroke();break;case"engineer":c2.save();c2.lineWidth=3;c2.beginPath();c2.moveTo(cx-r*.5,cy+r*.6);c2.lineTo(cx-r*.5,cy-r*.2);c2.lineTo(cx+r*.5,cy-r*.2);c2.lineTo(cx+r*.5,cy+r*.6);c2.stroke();c2.restore();break;case"bridging":c2.beginPath();c2.moveTo(cx-r*.7,cy+r*.3);c2.lineTo(cx-r*.3,cy-r*.3);c2.lineTo(cx+r*.3,cy-r*.3);c2.lineTo(cx+r*.7,cy+r*.3);c2.stroke();break;case"headquarters":c2.font=`bold ${r*1.2}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("HQ",cx,cy);break;case"signal":c2.beginPath();c2.moveTo(cx-r*.2,cy-r*.6);c2.lineTo(cx+r*.2,cy-r*.1);c2.lineTo(cx-r*.1,cy-r*.1);c2.lineTo(cx+r*.3,cy+r*.6);c2.stroke();break;case"military_intelligence":c2.font=`bold ${r*1.2}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("MI",cx,cy);break;case"electronic_warfare":c2.beginPath();c2.moveTo(cx-r*.4,cy-r*.4);c2.lineTo(cx+r*.4,cy-r*.4);c2.lineTo(cx-r*.4,cy+r*.4);c2.lineTo(cx+r*.4,cy+r*.4);c2.stroke();break;case"cyber":c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("CY",cx,cy);break;case"sustainment":c2.beginPath();c2.arc(cx,cy,r*.5,0,Math.PI*2);c2.stroke();c2.beginPath();c2.moveTo(cx,cy-r*.5);c2.lineTo(cx,cy+r*.5);c2.stroke();break;case"medical":c2.lineWidth=3;c2.beginPath();c2.moveTo(cx,cy-r*.5);c2.lineTo(cx,cy+r*.5);c2.stroke();c2.beginPath();c2.moveTo(cx-r*.5,cy);c2.lineTo(cx+r*.5,cy);c2.stroke();break;case"maintenance":c2.beginPath();c2.moveTo(cx-r*.6,cy+r*.4);c2.lineTo(cx+r*.6,cy-r*.4);c2.stroke();c2.beginPath();c2.arc(cx-r*.5,cy+r*.3,r*.2,0,Math.PI*2);c2.stroke();break;case"transportation":c2.beginPath();c2.arc(cx,cy,r*.4,0,Math.PI*2);c2.stroke();c2.beginPath();c2.moveTo(cx,cy-r*.4);c2.lineTo(cx,cy+r*.4);c2.moveTo(cx-r*.4,cy);c2.lineTo(cx+r*.4,cy);c2.stroke();break;case"supply":c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("S",cx,cy);break;case"ordnance":c2.beginPath();c2.moveTo(cx,cy-r*.5);c2.quadraticCurveTo(cx+r*.4,cy,cx,cy+r*.5);c2.quadraticCurveTo(cx-r*.4,cy,cx,cy-r*.5);c2.fill();break;case"special_forces":c2.beginPath();c2.moveTo(cx,cy-r*.5);c2.lineTo(cx+r*.5,cy+r*.3);c2.moveTo(cx,cy-r*.5);c2.lineTo(cx-r*.5,cy+r*.3);c2.moveTo(cx,cy-r*.5);c2.lineTo(cx,cy+r*.5);c2.stroke();break;case"ranger":c2.font=`bold ${r*.9}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("RGR",cx,cy);break;case"civil_affairs":c2.font=`bold ${r}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("CA",cx,cy);break;case"psyop":c2.font=`bold ${r*.8}px sans-serif`;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("PO",cx,cy);break}}
function drawEch(c2,ech,aff){const isH=AFFILIATIONS[aff||"friendly"].shape==="diamond",hh=FRAME_H/2,by=CY-hh-U*.8-(isH?U*.6:0);c2.strokeStyle=AFFILIATIONS[aff||"friendly"].color;c2.fillStyle=AFFILIATIONS[aff||"friendly"].color;c2.lineWidth=2;const e=ECHELONS.find(x=>x.id===ech);if(!e)return;switch(e.mark){case"dot1":c2.beginPath();c2.arc(CX,by,2.5,0,Math.PI*2);c2.fill();break;case"dot2":c2.beginPath();c2.arc(CX-5,by,2.5,0,Math.PI*2);c2.fill();c2.beginPath();c2.arc(CX+5,by,2.5,0,Math.PI*2);c2.fill();break;case"dot3":c2.beginPath();c2.arc(CX-8,by,2.5,0,Math.PI*2);c2.fill();c2.beginPath();c2.arc(CX,by,2.5,0,Math.PI*2);c2.fill();c2.beginPath();c2.arc(CX+8,by,2.5,0,Math.PI*2);c2.fill();break;case"bar1":c2.beginPath();c2.moveTo(CX-10,by);c2.lineTo(CX+10,by);c2.stroke();break;case"bar1l":c2.beginPath();c2.moveTo(CX-10,by);c2.lineTo(CX+10,by);c2.stroke();c2.beginPath();c2.moveTo(CX,by-4);c2.lineTo(CX,by+4);c2.stroke();break;case"bar2":c2.beginPath();c2.moveTo(CX-10,by-3);c2.lineTo(CX+10,by-3);c2.stroke();c2.beginPath();c2.moveTo(CX-10,by+3);c2.lineTo(CX+10,by+3);c2.stroke();break;case"bar3":for(let i=-1;i<=1;i++){c2.beginPath();c2.moveTo(CX-10,by+i*5);c2.lineTo(CX+10,by+i*5);c2.stroke()}break;case"bar1x":c2.beginPath();c2.moveTo(CX-10,by);c2.lineTo(CX+10,by);c2.stroke();[[-6,-6,6,6],[6,-6,-6,6]].forEach(([a,b,c,d])=>{c2.beginPath();c2.moveTo(CX+a,by+b);c2.lineTo(CX+c,by+d);c2.stroke()});break;default:{const n=e.mark.length,g=8,tw=(n-1)*g;for(let i=0;i<n;i++){const px=CX-tw/2+i*g;c2.beginPath();c2.moveTo(px-3,by-4);c2.lineTo(px+3,by+4);c2.moveTo(px+3,by-4);c2.lineTo(px-3,by+4);c2.stroke()}}}}
function drawMods(c2,mods){c2.fillStyle="#aaa";c2.font=`${U*.9}px sans-serif`;c2.textAlign="center";c2.textBaseline="top";c2.fillText(mods.map(m=>(MODIFIERS.find(x=>x.id===m)||{}).symbol||"").join(" "),CX,CY+FRAME_H/2+U*2)}
function drawUnits(){const d=devicePixelRatio||1;S.units.forEach(u=>{const layer=S.layers.find(l=>l.id===u.layerId);if(layer&&!layer.visible)return;const sp=latlonToScreen(u.lat,u.lon),sz=getUSS();ctx.save();ctx.shadowColor="rgba(0,0,0,.45)";ctx.shadowBlur=3*d;ctx.shadowOffsetX=d;ctx.shadowOffsetY=d;drawUnitIcon(ctx,u,sp.x*d,sp.y*d,sz*d);ctx.restore();if(u.rings&&u.rings.length)u.rings.forEach(ring=>{const rp=metersToPixels(ring.radius,u.lat,S.zoom)*d;ctx.save();ctx.globalAlpha=ring.opacity||.3;ctx.strokeStyle=ring.color||"#f00";ctx.lineWidth=2*d;ctx.setLineDash([6*d,4*d]);ctx.beginPath();ctx.arc(sp.x*d,sp.y*d,rp,0,Math.PI*2);ctx.stroke();ctx.restore()});if(u.id===S.selectedUnitId){ctx.save();ctx.strokeStyle="#ffd700";ctx.lineWidth=2*d;ctx.setLineDash([4*d,4*d]);const h=sz*d/2+4*d;ctx.strokeRect(sp.x*d-h,sp.y*d-h,h*2,h*2);ctx.restore()}})}
function getUSS(){return Math.max(48,Math.min(120,60+(S.zoom-10)*8))}


// === part_05_graphics.js ===

function setDash(c2,s,d){c2.setLineDash(s==="dashed"?[10*d,6*d]:s==="dotted"?[3*d,3*d]:[])}
function drawAH(c2,fr,to,lw,col){const a=Math.atan2(to.y-fr.y,to.x-fr.x),sz=lw*3+6;c2.save();c2.fillStyle=col;c2.beginPath();c2.moveTo(to.x,to.y);c2.lineTo(to.x-sz*Math.cos(a-.4),to.y-sz*Math.sin(a-.4));c2.lineTo(to.x-sz*Math.cos(a+.4),to.y-sz*Math.sin(a+.4));c2.closePath();c2.fill();c2.restore()}
function drawGraphics(){const d=devicePixelRatio||1;S.graphics.forEach(g=>{const layer=S.layers.find(l=>l.id===g.layerId);if(layer&&!layer.visible)return;if(!g.points||g.points.length<1)return;const pts=g.points.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});ctx.save();ctx.shadowColor="rgba(0,0,0,.5)";ctx.shadowBlur=4*d;ctx.shadowOffsetX=d;ctx.shadowOffsetY=d;const col=g.color||"#f44",lw=(g.lineWidth||2)*d;ctx.strokeStyle=col;ctx.lineWidth=lw;setDash(ctx,g.lineStyle,d);if(g.overlayType&&g.overlayType!=="none")drawOvl(ctx,g,pts,d);else switch(g.tool){case"line":case"arrow":ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();if(g.tool==="arrow"&&pts.length>=2)drawAH(ctx,pts[1],pts[0],lw,col);break;case"polygon":ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.closePath();if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=.2;ctx.fill();ctx.globalAlpha=1}ctx.stroke();break;case"circle":if(pts.length>=2){const r=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);ctx.beginPath();ctx.arc(pts[0].x,pts[0].y,r,0,Math.PI*2);if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=.2;ctx.fill();ctx.globalAlpha=1}ctx.stroke()}break;case"rectangle":if(pts.length>=2){const x=Math.min(pts[0].x,pts[1].x),y=Math.min(pts[0].y,pts[1].y),w=Math.abs(pts[1].x-pts[0].x),h=Math.abs(pts[1].y-pts[0].y);if(g.fill){ctx.fillStyle=g.fillColor||col;ctx.globalAlpha=.2;ctx.fillRect(x,y,w,h);ctx.globalAlpha=1}ctx.strokeRect(x,y,w,h)}break;case"text":if(pts.length>=1&&g.label){ctx.font=`${(g.fontSize||14)*d}px ${g.fontFamily||"sans-serif"}`;ctx.fillStyle=col;ctx.textAlign="left";ctx.textBaseline="top";ctx.fillText(g.label,pts[0].x,pts[0].y)}break}ctx.restore();if(g.id===S.selectedGraphicId)pts.forEach(p=>{ctx.save();ctx.fillStyle="#4a9eff";ctx.strokeStyle="#fff";ctx.lineWidth=2*d;ctx.beginPath();ctx.arc(p.x,p.y,5*d,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.restore()})})}
function drawOvl(c2,g,pts,d){const col=g.color||"#f44",lw=(g.lineWidth||2)*d;switch(g.overlayType){case"pl":c2.setLineDash([10*d,6*d]);c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();if(g.label&&pts.length>=2){const mid=pts[Math.floor(pts.length/2)];c2.setLineDash([]);c2.font=`bold ${12*d}px sans-serif`;c2.fillStyle=col;c2.textAlign="center";c2.textBaseline="bottom";c2.fillText("PL "+g.label,mid.x,mid.y-6*d)}break;case"boundary":c2.setLineDash([10*d,6*d]);c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();c2.setLineDash([]);const ts=8*d;for(let i=0;i<pts.length-1;i++){const td=Math.hypot(pts[i+1].x-pts[i].x,pts[i+1].y-pts[i].y);for(let dd=60*d;dd<td;dd+=60*d){const t=dd/td,tx=pts[i].x+t*(pts[i+1].x-pts[i].x),ty=pts[i].y+t*(pts[i+1].y-pts[i].y);c2.beginPath();c2.moveTo(tx-ts,ty-ts);c2.lineTo(tx+ts,ty+ts);c2.moveTo(tx+ts,ty-ts);c2.lineTo(tx-ts,ty+ts);c2.stroke()}}break;case"obj":if(pts.length>=2){const r=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);c2.beginPath();c2.arc(pts[0].x,pts[0].y,r,0,Math.PI*2);c2.fillStyle=col;c2.globalAlpha=.15;c2.fill();c2.globalAlpha=1;c2.stroke();c2.font=`bold ${14*d}px sans-serif`;c2.fillStyle=col;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("OBJ "+(g.label||""),pts[0].x,pts[0].y)}break;case"aa":if(pts.length>=2){const x=Math.min(pts[0].x,pts[1].x),y=Math.min(pts[0].y,pts[1].y),w=Math.abs(pts[1].x-pts[0].x),h=Math.abs(pts[1].y-pts[0].y);c2.fillStyle=col;c2.globalAlpha=.1;c2.fillRect(x,y,w,h);c2.globalAlpha=1;c2.setLineDash([8*d,4*d]);c2.strokeRect(x,y,w,h);c2.setLineDash([]);c2.font=`bold ${12*d}px sans-serif`;c2.fillStyle=col;c2.textAlign="center";c2.textBaseline="middle";c2.fillText("AA "+(g.label||""),x+w/2,y+h/2)}break;case"axis":if(pts.length>=2){c2.lineWidth=lw*6;c2.globalAlpha=.2;c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();c2.globalAlpha=1;c2.lineWidth=lw;c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();drawAH(c2,pts[pts.length-2],pts[pts.length-1],lw*2,col)}break;case"route":c2.beginPath();pts.forEach((p,i)=>i?c2.lineTo(p.x,p.y):c2.moveTo(p.x,p.y));c2.stroke();for(let i=0;i<pts.length-1;i++){const mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;drawAH(c2,pts[i],{x:mx,y:my},lw,col)}break}}
function drawDrawPreview(){if(!S._drawMode)return;const d=devicePixelRatio||1,dm=S._drawMode;if(!dm.points.length)return;const pts=dm.points.map(p=>{const s=latlonToScreen(p.lat,p.lon);return{x:s.x*d,y:s.y*d}});ctx.save();ctx.strokeStyle=dm.color||"#ffd700";ctx.lineWidth=2*d;ctx.setLineDash([6*d,3*d]);ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));if(dm.tool==="polygon"&&pts.length>2)ctx.lineTo(pts[0].x,pts[0].y);ctx.stroke();ctx.setLineDash([]);pts.forEach((p,i)=>{const isLast=i===pts.length-1;ctx.beginPath();if(isLast){ctx.arc(p.x,p.y,9*d,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle="#ffd700";ctx.lineWidth=3*d;ctx.stroke()}else{ctx.arc(p.x,p.y,4*d,0,Math.PI*2);ctx.fillStyle="#ffd700";ctx.fill()}});ctx.restore()}


// === part_06_interaction.js ===

function smoothPanTo(lat,lon,dur){dur=dur||400;const sLat=S.lat,sLon=S.lon,sT=performance.now();function step(t){const p=Math.min(1,(t-sT)/dur),e=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2;S.lat=sLat+(lat-sLat)*e;S.lon=sLon+(lon-sLon)*e;requestRender();if(p<1)requestAnimationFrame(step)}requestAnimationFrame(step)}
function getPos(e){const r=canvas.getBoundingClientRect();return e.clientX!==undefined?{x:e.clientX-r.left,y:e.clientY-r.top}:e.touches&&e.touches[0]?{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}:{x:0,y:0}}
function hitTestUnit(pos){const sz=getUSS();for(let i=S.units.length-1;i>=0;i--){const u=S.units[i],layer=S.layers.find(l=>l.id===u.layerId);if(layer&&!layer.visible)continue;const sp=latlonToScreen(u.lat,u.lon);if(Math.abs(pos.x-sp.x)<sz/2&&Math.abs(pos.y-sp.y)<sz/2)return u}return null}
function hitTestGraphic(pos){for(let i=S.graphics.length-1;i>=0;i--){const g=S.graphics[i],layer=S.layers.find(l=>l.id===g.layerId);if(layer&&!layer.visible)continue;if(!g.points||g.points.length<1)continue;for(const p of g.points){const sp=latlonToScreen(p.lat,p.lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<15)return g}if(g.points.length>=2){for(let j=0;j<g.points.length-1;j++){const a=latlonToScreen(g.points[j].lat,g.points[j].lon),b=latlonToScreen(g.points[j+1].lat,g.points[j+1].lon),dx=b.x-a.x,dy=b.y-a.y,len=Math.hypot(dx,dy);if(len<1)continue;const t=Math.max(0,Math.min(1,((pos.x-a.x)*dx+(pos.y-a.y)*dy)/(len*len))),px=a.x+t*dx,py=a.y+t*dy;if(Math.hypot(pos.x-px,pos.y-py)<10)return g}}}return null}
function selectUnit(id){S.selectedUnitId=id;S.selectedGraphicId=null;if(id&&!S.editorPinned)openEditor();requestRender()}
function selectGraphic(id){S.selectedGraphicId=id;S.selectedUnitId=null;requestRender()}
function deselectAll(){S.selectedUnitId=null;S.selectedGraphicId=null;closeEditor();requestRender()}

let _ptrDownPos=null,_ptrDownTime=0,_selOnDown=false,_dragUnit=null,_dragGV=null;

function onPointerDown(e){if(e.target!==canvas)return;S._lastPointerType=e.pointerType||"mouse";const pos=getPos(e);_ptrDownPos=pos;_ptrDownTime=Date.now();_selOnDown=false;_dragUnit=null;_dragGV=null;
if(e.pointerId!==undefined)S._activePointers.set(e.pointerId,pos);
if(S._activePointers.size===2){const pts=[...S._activePointers.values()];S._pinchStartDist=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);S._pinchStartZoom=S.zoom;return}
if(S._drawMode||S._placementMode)return;
if(S.selectedGraphicId){const g=S.graphics.find(x=>x.id===S.selectedGraphicId);if(g&&g.points){for(let i=0;i<g.points.length;i++){const sp=latlonToScreen(g.points[i].lat,g.points[i].lon);if(Math.hypot(pos.x-sp.x,pos.y-sp.y)<15){_dragGV={gid:g.id,idx:i};_selOnDown=true;return}}}}
const hit=hitTestUnit(pos),isTouch=S._lastPointerType==="touch";
if(hit){if(isTouch){if(hit.id===S.selectedUnitId){_dragUnit=hit;_selOnDown=true}else{selectUnit(hit.id);_selOnDown=true}}else{selectUnit(hit.id);_dragUnit=hit;_selOnDown=true}return}
const hitG=hitTestGraphic(pos);if(hitG){selectGraphic(hitG.id);_selOnDown=true;return}
S._isPanning=true;S._panStart={x:pos.x,y:pos.y,lat:S.lat,lon:S.lon}}

function onPointerMove(e){const pos=getPos(e);if(e.pointerId!==undefined)S._activePointers.set(e.pointerId,pos);
if(S._activePointers.size===2&&S._pinchStartDist){const pts=[...S._activePointers.values()],dist=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);S.zoom=Math.max(2,Math.min(19,S._pinchStartZoom+Math.log2(dist/S._pinchStartDist)));requestRender();updateCoords(pos);return}
if(_dragUnit){const ll=screenToLatlon(pos.x,pos.y);S.undoStack.push({type:"move",unitId:_dragUnit.id,lat:_dragUnit.lat,lon:_dragUnit.lon});if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();_dragUnit.lat=ll.lat;_dragUnit.lon=ll.lon;netBroadcast({type:"unitEdit",unit:_dragUnit});requestRender();return}
if(_dragGV){const g=S.graphics.find(x=>x.id===_dragGV.gid);if(g){const ll=screenToLatlon(pos.x,pos.y);g.points[_dragGV.idx]={lat:ll.lat,lon:ll.lon};netBroadcast({type:"graphicEdit",graphic:g});requestRender()}return}
if(S._isPanning&&S._panStart){const dx=pos.x-S._panStart.x,dy=pos.y-S._panStart.y,d=devicePixelRatio||1,c=latlonToPixel(S._panStart.lat,S._panStart.lon,S.zoom);const newC=pixelToLatlon(c.x-dx/d,c.y-dy/d,S.zoom);S.lat=newC.lat;S.lon=newC.lon;requestRender()}
updateCoords(pos)}

function onPointerUp(e){const pos=getPos(e);if(e.pointerId!==undefined)S._activePointers.delete(e.pointerId);
if(S._activePointers.size<2){S._pinchStartDist=null;S._pinchStartZoom=null}
const wasPan=S._isPanning,moved=_ptrDownPos?Math.hypot(pos.x-_ptrDownPos.x,pos.y-_ptrDownPos.y):0;
S._isPanning=false;_dragUnit=null;_dragGV=null;

if(S._drawMode&&moved<10){const ll=screenToLatlon(pos.x,pos.y);const dm=S._drawMode;
if(dm.tool==="circle"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}
if(dm.tool==="circle"&&dm.points.length===1){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
if(dm.tool==="rectangle"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}
if(dm.tool==="rectangle"&&dm.points.length===1){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
if(dm.tool==="text"&&dm.points.length===0){dm.points.push({lat:ll.lat,lon:ll.lon});finishDrawing();return}
dm.points.push({lat:ll.lat,lon:ll.lon});updateModeBar();requestRender();return}

if(S._placementMode&&moved<10){const ll=screenToLatlon(pos.x,pos.y);const u={...S._placementMode,id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat:ll.lat,lon:ll.lon,layerId:S.activeLayerId,rings:[],equipment:{...(EQUIPMENT_DEFAULTS[S._placementMode.type]||{})}};S.units.push(u);S._placementMode=null;selectUnit(u.id);hideModeBar();netBroadcast({type:"unitAdd",unit:u});requestRender();return}

if(!_selOnDown&&wasPan&&moved<10){deselectAll()}}

function onWheel(e){e.preventDefault();const delta=e.deltaY>0?-0.3:0.3;S.zoom=Math.max(2,Math.min(19,S.zoom+delta));requestRender();updateCoords(getPos(e))}
function onContextMenu(e){e.preventDefault();if(S._drawMode&&S._drawMode.points.length>=getMinPoints(S._drawMode.tool)){finishDrawing()}}
function updateCoords(pos){const el=document.getElementById("coords");if(!el||!pos)return;const ll=screenToLatlon(pos.x,pos.y);if(S.coordDisplay==="mgrs")el.textContent=`\u2197 ${toMGRS(ll.lat,ll.lon)} z${S.zoom.toFixed(1)}`;else el.textContent=`\u2197 ${ll.lat.toFixed(4)}\u00b0 ${ll.lon.toFixed(4)}\u00b0 z${S.zoom.toFixed(1)}`}


// === part_07_ui_init.js ===

function notify(msg,type){const t=document.createElement("div");t.className="toast"+(type==="error"?" error":"");t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3500)}

function togglePanel(name){
  if(S._activePanel===name){S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"))}
  else{S._activePanel=name;renderFloatingPanel();document.getElementById("float-panel").classList.add("open");
  document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"));
  const btn=document.getElementById("sb-"+name);if(btn)btn.classList.add("active");
  if(name==="chat"){S._net.unreadCount=0;updateChatBadge()}}}

function renderFloatingPanel(){
  const title=document.getElementById("fp-title"),body=document.getElementById("fp-body");
  if(!S._activePanel){title.textContent="";body.innerHTML="";return}
  switch(S._activePanel){
    case"settings":title.textContent="Settings";body.innerHTML=renderSettings();break;
    case"comms":title.textContent="Comms";body.innerHTML=renderComms();break;
    case"chat":title.textContent="Chat";body.innerHTML=renderChat();break;
    case"layers":title.textContent="Layers";body.innerHTML=renderLayers();break;
    case"graphics":title.textContent="Graphics";body.innerHTML=renderGraphicsPanel();break;
    case"addunit":title.textContent="Add Unit";body.innerHTML=renderAddUnitPanel();break;
  }
  bindPanelEvents()}

function renderSettings(){
  let h='<div class="section"><div class="section-title">Map</div>';
  h+='<label>Tile Source</label><select id="set-tiles">';
  for(const[k,v]of Object.entries(TILE_SOURCES))h+=`<option value="${k}"${S.tileSource===k?" selected":""}>${v.name}</option>`;
  h+='</select>';
  h+='<label>Theme</label><select id="set-theme"><option value="dark"'+(S.theme==="dark"?" selected":"")+'>Dark</option><option value="light"'+(S.theme==="light"?" selected":"")+'>Light</option></select>';
  h+='</div><div class="section"><div class="section-title">Grid</div>';
  h+='<div class="toggle-row"><span>Show Grid</span><label class="switch"><input type="checkbox" id="set-grid"'+(S.showGrid?" checked":"")+'><span class="slider"></span></label></div>';
  h+='<label>Grid Mode</label><select id="set-gridmode"><option value="mgrs"'+(S.gridMode==="mgrs"?" selected":"")+'>MGRS</option><option value="latlon"'+(S.gridMode==="latlon"?" selected":"")+'>Lat/Lon</option></select>';
  h+='<label>Coord Display</label><select id="set-coorddisp"><option value="mgrs"'+(S.coordDisplay==="mgrs"?" selected":"")+'>MGRS</option><option value="latlon"'+(S.coordDisplay==="latlon"?" selected":"")+'>Lat/Lon</option></select>';
  h+='<label>Grid Color</label><div class="color-swatches" id="set-gridcolor">';
  const gridColors=[["#00ff00","Green"],["#00cccc","Teal"],["#ffffff","White"],["#000000","Black"],["#ff4444","Red"],["#888888","Gray"]];
  gridColors.forEach(([c,n])=>h+=`<div class="swatch${S.gridColor===c?" active":""}" style="background:${c}" onclick="S.gridColor='${c}';requestRender();renderFloatingPanel()" title="${n}"></div>`);
  h+='</div>';
  h+='<label>Grid Opacity</label><input type="range" id="set-gridop" min="0" max="1" step="0.1" value="'+S.gridOpacity+'">';
  h+='</div><div class="section"><div class="section-title">Device Overrides</div>';
  h+='<label>Layout</label><select id="set-layout"><option value="auto">Auto</option><option value="phone">Phone</option><option value="tablet">Tablet</option><option value="desktop">Desktop</option></select>';
  h+='</div>';
  return h}

function renderComms(){
  const n=S._net;let h='<div class="section"><div class="section-title">Connection</div>';
  h+='<label>Callsign</label><input type="text" id="net-name" value="'+(n.peerName||"")+'" placeholder="Your callsign">';
  if(n.mode==="offline"){
    h+='<div class="row"><button class="btn primary" onclick="netCreateRoom()">Create Room</button></div>';
    h+='<label>Join Room</label><div class="row"><input type="text" id="net-code" placeholder="Room code" maxlength="6" style="flex:2"><button class="btn" onclick="netJoinRoom()">Join</button></div>';
  }else{
    h+='<div style="font-size:11px;margin-bottom:6px">Room: <strong>'+(n.roomCode||"---")+'</strong> <button class="btn" onclick="navigator.clipboard.writeText(\''+(n.roomCode||"")+'\')" style="padding:1px 4px;font-size:9px">Copy</button></div>';
    h+='<div style="font-size:11px;margin-bottom:6px">Mode: '+(n.isHost?"HOST":"PEER")+'</div>';
    h+='<div style="font-size:11px;margin-bottom:6px">Status: '+n.status+'</div>';
    if(n.isHost){h+='<div class="toggle-row"><span>All Edit (LWW)</span><label class="switch"><input type="checkbox" id="net-lww"'+(n.editMode==="lww"?" checked":"")+'><span class="slider"></span></label></div>'}
    const peers=Object.entries(n.peerNames);if(peers.length){h+='<div class="section-title">Peers</div>';peers.forEach(([id,name])=>h+=`<div style="font-size:11px;padding:2px 0">${name||id.substr(0,8)}</div>`)}
    h+='<div class="row"><button class="btn danger" onclick="netLeave()">Leave Room</button></div>';
  }
  h+='<div class="section"><div class="section-title">Encryption</div>';
  h+='<div class="toggle-row"><span>Encrypt</span><label class="switch"><input type="checkbox" id="net-enc"'+(n.encEnabled?" checked":"")+'><span class="slider"></span></label></div>';
  if(n.encEnabled)h+='<label>Passphrase</label><input type="password" id="net-pass" value="'+(n.passphrase||"")+'" placeholder="Passphrase">';
  h+='</div></div>';
  return h}

function renderChat(){
  const n=S._net;if(n.mode==="offline")return'<div style="font-size:11px;opacity:.5;text-align:center;padding:20px">Connect to a room to chat</div>';
  let h='<div style="flex:1;overflow-y:auto;max-height:300px;margin-bottom:8px" id="chat-messages">';
  n.chatMessages.forEach(m=>{h+=`<div style="font-size:11px;margin-bottom:4px"><strong>${m.fromName||"???"}</strong>: ${m.text}</div>`});
  h+='</div>';
  h+='<div class="row"><input type="text" id="chat-input" placeholder="Message..." style="flex:1"><button class="btn primary" onclick="sendChat()">Send</button></div>';
  return h}

function renderLayers(){
  let h='<div class="row" style="margin-bottom:8px"><button class="btn primary" onclick="addLayer()">+ Add Layer</button></div>';
  S.layers.forEach(l=>{
    h+=`<div class="layer-item${l.id===S.activeLayerId?" active":""}" onclick="setActiveLayer(\'${l.id}\')">`;
    h+=`<div class="layer-dot" style="background:${l.color}"></div>`;
    h+=`<span class="layer-name">${l.name}</span>`;
    h+=`<span class="layer-eye ${l.visible?"visible":""}" onclick="event.stopPropagation();toggleLayerVis(\'${l.id}\')">${l.visible?"\ud83d\udc41":"\ud83d\udc41\u200d\ud83d\udde8"}</span>`;
    if(l.id!=="default")h+=`<span style="cursor:pointer;font-size:10px;opacity:.5" onclick="event.stopPropagation();removeLayer(\'${l.id}\')">\u2715</span>`;
    h+='</div>'});
  return h}

function renderGraphicsPanel(){
  let h='<div class="section"><div class="section-title">Drawing Tools</div>';
  const tools=[["line","Line"],["polygon","Polygon"],["circle","Circle"],["rectangle","Rectangle"],["arrow","Arrow"],["text","Text"]];
  h+='<div class="row" style="flex-wrap:wrap">';tools.forEach(([id,label])=>h+=`<button class="btn" onclick="startDrawing(\'${id}\')" style="min-width:60px">${label}</button>`);h+='</div></div>';
  h+='<div class="section"><div class="section-title">OPORD Overlays</div><div class="row" style="flex-wrap:wrap">';
  OVERLAY_TYPES.filter(o=>o.id!=="none").forEach(o=>h+=`<button class="btn" onclick="startOverlayDraw(\'${o.id}\')" style="min-width:80px">${o.label}</button>`);
  h+='</div></div>';
  if(S.graphics.length){h+='<div class="section"><div class="section-title">Graphics ('+S.graphics.length+')</div>';
  S.graphics.forEach(g=>{h+=`<div class="layer-item${g.id===S.selectedGraphicId?" active":""}" onclick="selectGraphic(\'${g.id}\');requestRender()"><span style="color:${g.color||'#f44'}">\u25cf</span><span class="layer-name">${g.overlayType&&g.overlayType!=="none"?g.overlayType.toUpperCase()+" ":""}${g.label||g.tool}</span><span style="cursor:pointer;font-size:10px;opacity:.5" onclick="event.stopPropagation();deleteGraphic(\'${g.id}\')">\u2715</span></div>`});
  h+='</div>'}
  return h}

function renderAddUnitPanel(){
  let h='<label>Affiliation</label><div class="row" style="margin-bottom:8px">';
  const curAff=S._addUnitAff||"friendly";
  for(const[k,v]of Object.entries(AFFILIATIONS))h+=`<button class="btn${curAff===k?" primary":""}" onclick="S._addUnitAff='${k}';renderFloatingPanel()" style="flex:1;border-color:${v.color};color:${v.color}">${v.label}</button>`;
  h+='</div>';
  UNIT_CATEGORIES.forEach((cat,ci)=>{
    h+=`<div class="cat-header open" onclick="this.classList.toggle('open');this.nextElementSibling.style.display=this.classList.contains('open')?'':'none'">${cat.name}</div><div class="icon-grid">`;
    cat.types.forEach(t=>{h+=`<div class="icon-cell" onclick="startPlacement('${t.id}','${curAff}');togglePanel(null)"><canvas width="52" height="52" data-utype="${t.id}" data-uaff="${curAff}"></canvas><div class="tooltip">${t.label}</div></div>`});
    h+='</div>'});
  setTimeout(()=>{document.querySelectorAll(".icon-cell canvas[data-utype]").forEach(cv=>{const c=cv.getContext("2d");drawUnitIcon(c,{type:cv.dataset.utype,affiliation:cv.dataset.uaff||"friendly"},26,26,46)})},10);
  return h}

function bindPanelEvents(){
  const el=id=>document.getElementById(id);
  if(el("set-tiles"))el("set-tiles").onchange=e=>{S.tileSource=e.target.value;tileCache.clear();requestRender()};
  if(el("set-theme"))el("set-theme").onchange=e=>{S.theme=e.target.value;document.body.setAttribute("data-theme",S.theme);requestRender()};
  if(el("set-grid"))el("set-grid").onchange=e=>{S.showGrid=e.target.checked;requestRender()};
  if(el("set-gridmode"))el("set-gridmode").onchange=e=>{S.gridMode=e.target.value;requestRender()};
  if(el("set-coorddisp"))el("set-coorddisp").onchange=e=>{S.coordDisplay=e.target.value};
  if(el("set-gridop"))el("set-gridop").oninput=e=>{S.gridOpacity=parseFloat(e.target.value);requestRender()};
  if(el("net-name"))el("net-name").onchange=e=>{S._net.peerName=e.target.value;localStorage.setItem("scheffmap_callsign",e.target.value)};
  if(el("net-lww"))el("net-lww").onchange=e=>{S._net.editMode=e.target.checked?"lww":"observer";netBroadcast({type:"editModeChange",editMode:S._net.editMode})};
  if(el("net-enc"))el("net-enc").onchange=e=>{S._net.encEnabled=e.target.checked;renderFloatingPanel()};
  if(el("chat-input"))el("chat-input").onkeydown=e=>{if(e.key==="Enter")sendChat()};
}

// Editor
function openEditor(){const el=document.getElementById("editor");el.classList.add("open");el.style.display="flex";renderEditor()}
function closeEditor(){const el=document.getElementById("editor");el.classList.remove("open");el.style.display="none"}
function renderEditor(){
  const el=document.getElementById("editor");if(!el)return;
  const u=S.units.find(x=>x.id===S.selectedUnitId);if(!u){closeEditor();return}
  let h='<div class="editor-grip"></div><div class="editor-header"><div class="editor-tabs">';
  ["icon","info","equip","rings"].forEach(tab=>{h+=`<button class="editor-tab${S.editorTab===tab?" active":""}" onclick="S.editorTab=\'${tab}\';renderEditor()">${tab}</button>`});
  h+='</div><div class="editor-actions"><button class="btn" onclick="S.editorPinned=!S.editorPinned" title="Pin">${S.editorPinned?"\ud83d\udccc":"\ud83d\udccc"}</button><button class="btn danger" onclick="deleteUnit(\'${u.id}\')">Del</button><button class="btn" onclick="closeEditor()">\u2715</button></div></div>';
  h+='<div class="editor-body">';
  switch(S.editorTab){
    case"icon":h+=renderIconTab(u);break;
    case"info":h+=renderInfoTab(u);break;
    case"equip":h+=renderEquipTab(u);break;
    case"rings":h+=renderRingsTab(u);break;
  }
  h+='</div>';el.innerHTML=h;bindEditorEvents(u)}

function renderIconTab(u){
  let h='<div class="preview-wrap"><canvas id="preview-cv" width="120" height="140"></canvas></div>';
  h+='<label>Affiliation</label><div class="row" style="margin-bottom:8px">';
  for(const[k,v]of Object.entries(AFFILIATIONS))h+=`<button class="btn${u.affiliation===k?" primary":""}" onclick="editUnit(\'${u.id}\',{affiliation:\'${k}\'})" style="flex:1;border-color:${v.color};color:${v.color}">${v.label}</button>`;
  h+='</div><label>Echelon</label><select id="ed-ech">';
  h+='<option value="">None</option>';ECHELONS.forEach(e=>h+=`<option value="${e.id}"${u.echelon===e.id?" selected":""}>${e.label}</option>`);
  h+='</select>';
  UNIT_CATEGORIES.forEach((cat,ci)=>{
    h+=`<div class="cat-header open" onclick="this.classList.toggle(\'open\');this.nextElementSibling.style.display=this.classList.contains(\'open\')?\'\':\'none\'">${cat.name}</div><div class="icon-grid">`;
    cat.types.forEach(t=>{h+=`<div class="icon-cell${u.type===t.id?" selected":""}" onclick="editUnit(\'${u.id}\',{type:\'${t.id}\'})"><canvas width="52" height="52" data-type="${t.id}" data-aff="${u.affiliation}"></canvas><div class="tooltip">${t.label}</div></div>`});
    h+='</div>'});
  h+='<label>Modifiers</label><div class="row" style="flex-wrap:wrap;margin-bottom:8px">';
  MODIFIERS.forEach(m=>h+=`<button class="btn${(u.modifiers||[]).includes(m.id)?" primary":""}" onclick="toggleMod(\'${u.id}\',\'${m.id}\')" style="min-width:30px">${m.symbol} ${m.label}</button>`);
  h+='</div>';
  return h}

function renderInfoTab(u){
  return`<label>Designation</label><input type="text" id="ed-desig" value="${u.designation||""}" placeholder="e.g. 1-66 AR"><label>Parent Unit</label><input type="text" id="ed-parent" value="${u.parentUnit||""}" placeholder="e.g. 4th ABCT"><div class="toggle-row"><span>HQ</span><label class="switch"><input type="checkbox" id="ed-hq"${u.isHQ?" checked":""}><span class="slider"></span></label></div>`}

function renderEquipTab(u){
  const eq=u.equipment||{};
  return`<label>Vehicle</label><input type="text" id="ed-vehicle" value="${eq.vehicle||""}"><label>Crew</label><input type="number" id="ed-crew" value="${eq.crew||""}"><label>Weapon</label><input type="text" id="ed-weapon" value="${eq.weapon||""}"><label>Max Range (m)</label><input type="number" id="ed-maxrange" value="${eq.maxRange||""}"><label>Sensor Range (m)</label><input type="number" id="ed-sensorrange" value="${eq.sensorRange||""}"><label>Speed (km/h)</label><input type="number" id="ed-speed" value="${eq.speed||""}">`}

function renderRingsTab(u){
  let h='<button class="btn primary" onclick="addRing(\''+u.id+'\')">+ Add Range Ring</button>';
  if(u.rings)u.rings.forEach((r,i)=>{h+=`<div style="display:flex;gap:4px;align-items:center;margin-top:6px"><input type="number" value="${r.radius}" onchange="editRing(\'${u.id}\',${i},\'radius\',this.value)" style="flex:1" placeholder="Radius (m)"><input type="text" value="${r.color||'#f00'}" onchange="editRing(\'${u.id}\',${i},\'color\',this.value)" style="width:60px"><button class="btn danger" onclick="removeRing(\'${u.id}\',${i})">\u2715</button></div>`});
  const eq=u.equipment||{};
  if(eq.maxRange&&!(u.rings||[]).some(r=>r.radius==eq.maxRange))h+=`<div style="margin-top:8px"><button class="btn" onclick="addAutoRing(\'${u.id}\',\'maxRange\',${eq.maxRange})">+ Max Range (${eq.maxRange}m)</button></div>`;
  if(eq.sensorRange&&!(u.rings||[]).some(r=>r.radius==eq.sensorRange))h+=`<button class="btn" onclick="addAutoRing(\'${u.id}\',\'sensor\',${eq.sensorRange})" style="margin-top:4px">+ Sensor (${eq.sensorRange}m)</button>`;
  return h}

function bindEditorEvents(u){
  const el=id=>document.getElementById(id);
  if(el("ed-ech"))el("ed-ech").onchange=e=>editUnit(u.id,{echelon:e.target.value||null});
  if(el("ed-desig"))el("ed-desig").onchange=e=>editUnit(u.id,{designation:e.target.value});
  if(el("ed-parent"))el("ed-parent").onchange=e=>editUnit(u.id,{parentUnit:e.target.value});
  if(el("ed-hq"))el("ed-hq").onchange=e=>editUnit(u.id,{isHQ:e.target.checked});
  ["vehicle","crew","weapon","maxrange","sensorrange","speed"].forEach(f=>{
    const inp=el("ed-"+f);if(inp)inp.onchange=e=>{const eq={...(u.equipment||{})};eq[f==="maxrange"?"maxRange":f==="sensorrange"?"sensorRange":f]=inp.type==="number"?parseFloat(e.target.value):e.target.value;editUnit(u.id,{equipment:eq})}});
  // Render icon previews
  document.querySelectorAll(".icon-cell canvas[data-type]").forEach(cv=>{
    const c=cv.getContext("2d"),t=cv.dataset.type,a=cv.dataset.aff;
    drawUnitIcon(c,{type:t,affiliation:a||"friendly"},26,26,46)});
  const pcv=el("preview-cv");if(pcv){const pc=pcv.getContext("2d");pc.clearRect(0,0,120,140);drawUnitIcon(pc,u,60,70,110)}}

function editUnit(id,changes){
  const u=S.units.find(x=>x.id===id);if(!u)return;
  S.undoStack.push({type:"edit",unitId:id,prev:{...u}});if(S.undoStack.length>MAX_UNDO)S.undoStack.shift();
  Object.assign(u,changes);netBroadcast({type:"unitEdit",unit:u});renderEditor();requestRender()}
function deleteUnit(id){
  S.undoStack.push({type:"delete",unit:{...S.units.find(x=>x.id===id)}});
  S.units=S.units.filter(x=>x.id!==id);S.selectedUnitId=null;closeEditor();netBroadcast({type:"unitDelete",unitId:id});requestRender()}
function toggleMod(id,mod){
  const u=S.units.find(x=>x.id===id);if(!u)return;u.modifiers=u.modifiers||[];
  if(u.modifiers.includes(mod))u.modifiers=u.modifiers.filter(m=>m!==mod);else u.modifiers.push(mod);
  editUnit(id,{modifiers:u.modifiers})}
function addRing(id){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings=u.rings||[];u.rings.push({radius:1000,color:"#ff0000",opacity:0.3});editUnit(id,{rings:u.rings})}
function addAutoRing(id,type,radius){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings=u.rings||[];u.rings.push({radius:radius,color:type==="sensor"?"#00ff00":"#ff0000",opacity:0.3});editUnit(id,{rings:u.rings})}
function editRing(id,idx,field,val){const u=S.units.find(x=>x.id===id);if(!u||!u.rings[idx])return;u.rings[idx][field]=field==="radius"?parseFloat(val):val;editUnit(id,{rings:u.rings})}
function removeRing(id,idx){const u=S.units.find(x=>x.id===id);if(!u)return;u.rings.splice(idx,1);editUnit(id,{rings:u.rings})}
function deleteGraphic(id){S.graphics=S.graphics.filter(g=>g.id!==id);if(S.selectedGraphicId===id)S.selectedGraphicId=null;netBroadcast({type:"graphicDelete",graphicId:id});requestRender();if(S._activePanel==="graphics")renderFloatingPanel()}

// Drawing
function getMinPoints(tool){return{line:2,arrow:2,polygon:3,circle:2,rectangle:2,text:1}[tool]||2}
function startDrawing(tool){S._drawMode={tool,points:[],color:GRAPHIC_COLORS[1],lineWidth:2,lineStyle:"solid",overlayType:"none",fill:false,label:""};showModeBar();requestRender()}
function startOverlayDraw(type){const toolMap={pl:"line",boundary:"line",obj:"circle",aa:"rectangle",axis:"line",route:"line"};S._drawMode={tool:toolMap[type]||"line",points:[],color:GRAPHIC_COLORS[0],lineWidth:2,lineStyle:"solid",overlayType:type,fill:type==="obj"||type==="aa",label:""};showModeBar();requestRender()}
function finishDrawing(){
  if(!S._drawMode)return;const dm=S._drawMode;
  if(dm.points.length<getMinPoints(dm.tool)){notify("Not enough points","error");return}
  const g={id:"g"+Date.now()+Math.random().toString(36).substr(2,4),tool:dm.tool,points:[...dm.points],color:dm.color,lineWidth:dm.lineWidth,lineStyle:dm.lineStyle,overlayType:dm.overlayType,fill:dm.fill,fillColor:dm.color,label:dm.label||(dm.overlayType!=="none"?prompt("Label:")||"":""),layerId:S.activeLayerId};
  S.graphics.push(g);S._drawMode=null;hideModeBar();netBroadcast({type:"graphicAdd",graphic:g});requestRender();if(S._activePanel==="graphics")renderFloatingPanel()}
function cancelDrawing(){S._drawMode=null;hideModeBar();requestRender()}
function undoDrawPoint(){if(!S._drawMode||!S._drawMode.points.length)return;S._drawMode.points.pop();updateModeBar();requestRender()}

// Mode bar
function showModeBar(){document.getElementById("mode-bar").classList.add("open");document.getElementById("mode-bar").style.display="flex";updateModeBar()}
function hideModeBar(){const mb=document.getElementById("mode-bar");mb.classList.remove("open");mb.style.display="none"}
function showPlacementBar(){document.getElementById("mode-bar").style.display="flex";document.getElementById("mode-bar").classList.add("open");document.getElementById("mode-bar").innerHTML='<span class="mode-info">TAP MAP TO PLACE UNIT</span><button class="btn danger" onclick="S._placementMode=null;hideModeBar()">\u2715 Cancel</button>'}
function updateModeBar(){
  if(!S._drawMode)return;const dm=S._drawMode,n=dm.points.length,min=getMinPoints(dm.tool);
  let dist="";if(n>=2){let total=0;for(let i=1;i<n;i++){const a=dm.points[i-1],b=dm.points[i];total+=Math.sqrt((a.lat-b.lat)**2+(a.lon-b.lon)**2)*111139}dist=total>1000?`${(total/1000).toFixed(2)}km`:`${Math.round(total)}m`}
  document.getElementById("mode-bar").innerHTML=`<span class="mode-info">${dm.overlayType!=="none"?dm.overlayType.toUpperCase():dm.tool.toUpperCase()} ${n}pts ${dist}</span><button class="btn" onclick="undoDrawPoint()"${n===0?" disabled":""}">\u21a9</button><button class="btn done${n>=min?" ready":""}" onclick="finishDrawing()"${n<min?" disabled":""}>\u2713</button><button class="btn danger" onclick="cancelDrawing()">\u2715</button>`}

// Layers
function addLayer(){const id="l"+Date.now();const colors=["#ff8800","#44cc44","#ff00ff","#00ffff","#ffd700"];S.layers.push({id,name:"Layer "+(S.layers.length+1),color:colors[S.layers.length%colors.length],visible:true});S.activeLayerId=id;renderFloatingPanel();updateLayerIndicator()}
function setActiveLayer(id){S.activeLayerId=id;renderFloatingPanel();updateLayerIndicator();requestRender()}
function toggleLayerVis(id){const l=S.layers.find(x=>x.id===id);if(l)l.visible=!l.visible;renderFloatingPanel();requestRender()}
function removeLayer(id){if(S.layers.length<=1)return;S.units.filter(u=>u.layerId===id).forEach(u=>u.layerId="default");S.graphics.filter(g=>g.layerId===id).forEach(g=>g.layerId="default");S.layers=S.layers.filter(l=>l.id!==id);if(S.activeLayerId===id)S.activeLayerId=S.layers[0].id;renderFloatingPanel();updateLayerIndicator();requestRender()}
function updateLayerIndicator(){const el=document.querySelector(".layer-indicator");if(!el)return;const l=S.layers.find(x=>x.id===S.activeLayerId);el.innerHTML=l?`<div class="dot" style="background:${l.color}"></div>${l.name}`:``}

// Undo
function undo(){if(!S.undoStack.length)return;const a=S.undoStack.pop();switch(a.type){case"delete":S.units.push(a.unit);break;case"move":{const u=S.units.find(x=>x.id===a.unitId);if(u){u.lat=a.lat;u.lon=a.lon}}break;case"edit":{const idx=S.units.findIndex(x=>x.id===a.unitId);if(idx>=0)S.units[idx]=a.prev}break}requestRender();updateUndoBtn()}
function updateUndoBtn(){const btn=document.getElementById("undo-btn");if(btn){btn.style.opacity=S.undoStack.length?"1":"0.3";btn.style.pointerEvents=S.undoStack.length?"auto":"none"}}

// File menu
function toggleFileMenu(){_fileMenuOpen=!_fileMenuOpen;const m=document.getElementById("file-menu");if(m)m.classList.toggle("open",_fileMenuOpen)}
function closeFileMenu(){_fileMenuOpen=false;const m=document.getElementById("file-menu");if(m)m.classList.remove("open")}

// Chat
function sendChat(){const inp=document.getElementById("chat-input");if(!inp||!inp.value.trim())return;const msg={type:"chat",fromName:S._net.peerName||"Anon",to:S._net.chatTarget,text:inp.value.trim()};S._net.chatMessages.push({from:"me",fromName:S._net.peerName||"Me",to:msg.to,text:msg.text,ts:Date.now()});netBroadcast(msg);inp.value="";renderFloatingPanel()}
function updateChatBadge(){const btn=document.getElementById("sb-chat");if(!btn)return;const existing=btn.querySelector(".badge");if(existing)existing.remove();if(S._net.unreadCount>0){const b=document.createElement("span");b.className="badge";b.textContent=S._net.unreadCount;btn.appendChild(b)}}

// Place unit from palette
function startPlacement(type,affiliation){S._placementMode={type:type,affiliation:affiliation||"friendly",echelon:null,designation:"",modifiers:[],isHQ:false};showPlacementBar()}

function detectLayout(){const w=window.innerWidth,h=window.innerHeight;S._isLandscape=h<500;S._layout=S._overrides.layout&&S._overrides.layout!=="auto"?S._overrides.layout:w<500?"phone":w<900?"tablet":"desktop";document.body.setAttribute("data-layout",S._layout);document.body.setAttribute("data-orientation",S._isLandscape?"landscape":"portrait")}


// === part_08_net_fileio_init.js ===

// ─── P2P NETWORKING ──────────────────────
function netBroadcast(msg){const n=S._net;if(n.mode==="offline")return;const str=JSON.stringify(msg);if(n.isHost){n.conns.forEach(c=>{try{c.conn.send(str)}catch(e){}})}else if(n.hostConn){try{n.hostConn.send(str)}catch(e){}}}
function netCreateRoom(){
  const n=S._net;n.roomCode=Math.random().toString(36).substr(2,6).toUpperCase();
  n.peer=new Peer("scheffmap-"+n.roomCode,{debug:0});
  n.peer.on("open",()=>{n.isHost=true;n.mode="hosting";n.status="Hosting";updateNetDot("connected");renderFloatingPanel()});
  n.peer.on("connection",conn=>{
    conn.on("open",()=>{n.conns.push({conn,peerId:conn.peer,joinOrder:n.nextJoinOrder++});conn.send(JSON.stringify({type:"fullState",units:S.units,graphics:S.graphics,layers:S.layers,activeLayerId:S.activeLayerId,editMode:n.editMode}));n.status=n.conns.length+" peer(s)";renderFloatingPanel()});
    conn.on("data",data=>{handleNetMsg(JSON.parse(data),conn.peer)});
    conn.on("close",()=>{n.conns=n.conns.filter(c=>c.conn!==conn);n.status=n.conns.length+" peer(s)";renderFloatingPanel()})});
  n.peer.on("error",e=>{n.status="Error: "+e.type;updateNetDot("error");renderFloatingPanel()})}

function netJoinRoom(){
  const n=S._net,code=(document.getElementById("net-code")||{}).value;if(!code)return;
  n.roomCode=code.toUpperCase();n.peer=new Peer(undefined,{debug:0});
  n.peer.on("open",()=>{
    const conn=n.peer.connect("scheffmap-"+n.roomCode);n.hostConn=conn;
    conn.on("open",()=>{n.mode="connected";n.status="Connected";updateNetDot("connected");conn.send(JSON.stringify({type:"hello",name:n.peerName}));renderFloatingPanel()});
    conn.on("data",data=>{handleNetMsg(JSON.parse(data),null)});
    conn.on("close",()=>{n.mode="offline";n.status="Disconnected";n.hostConn=null;updateNetDot("");renderFloatingPanel()})});
  n.peer.on("error",e=>{n.status="Error: "+e.type;updateNetDot("error");renderFloatingPanel()})}

function netLeave(){const n=S._net;if(n.peer)n.peer.destroy();n.peer=null;n.conns=[];n.hostConn=null;n.isHost=false;n.roomCode=null;n.mode="offline";n.status="";n.peerNames={};updateNetDot("");renderFloatingPanel()}

function handleNetMsg(msg,fromPeer){
  if(msg.type==="fullState"){S.units=msg.units||[];S.graphics=msg.graphics||[];S.layers=msg.layers||S.layers;if(msg.activeLayerId)S.activeLayerId=msg.activeLayerId;S._net.editMode=msg.editMode||"observer";requestRender();updateLayerIndicator()}
  else if(msg.type==="hello"){S._net.peerNames[fromPeer]=msg.name||"Peer";renderFloatingPanel()}
  else if(msg.type==="unitAdd"){if(!S.units.find(u=>u.id===msg.unit.id))S.units.push(msg.unit);requestRender()}
  else if(msg.type==="unitEdit"){const idx=S.units.findIndex(u=>u.id===msg.unit.id);if(idx>=0)S.units[idx]=msg.unit;requestRender()}
  else if(msg.type==="unitDelete"){S.units=S.units.filter(u=>u.id!==msg.unitId);requestRender()}
  else if(msg.type==="graphicAdd"){if(!S.graphics.find(g=>g.id===msg.graphic.id))S.graphics.push(msg.graphic);requestRender()}
  else if(msg.type==="graphicEdit"){const idx=S.graphics.findIndex(g=>g.id===msg.graphic.id);if(idx>=0)S.graphics[idx]=msg.graphic;requestRender()}
  else if(msg.type==="graphicDelete"){S.graphics=S.graphics.filter(g=>g.id!==msg.graphicId);requestRender()}
  else if(msg.type==="editModeChange"){S._net.editMode=msg.editMode;renderFloatingPanel()}
  else if(msg.type==="chat"){S._net.chatMessages.push({from:fromPeer,fromName:msg.fromName,to:msg.to,text:msg.text,ts:Date.now()});if(S._activePanel!=="chat")S._net.unreadCount++;updateChatBadge();if(S._activePanel==="chat")renderFloatingPanel();if(S._net.isHost&&msg.to==="room"){S._net.conns.forEach(c=>{if(c.peerId!==fromPeer)try{c.conn.send(JSON.stringify(msg))}catch(e){}})}}
}
function updateNetDot(state){const dot=document.querySelector(".topbar-dot");if(dot)dot.className="topbar-dot"+(state?" "+state:"");const cb=document.getElementById("sb-comms");if(cb){cb.classList.remove("pulse-blue","pulse-green");if(S._net.mode==="hosting")cb.classList.add("pulse-green");else if(S._net.mode==="connected")cb.classList.add("pulse-blue")}}

// ─── FILE I/O ────────────────────────────
const IO={
  isNative(){return!!window.nativeBridge},
  notify(msg,type){notify(msg,type)},
  projectSave(){
    const data={version:"3.0",app:"ScheffMap",timestamp:new Date().toISOString(),map:{lat:S.lat,lon:S.lon,zoom:S.zoom,tileSource:S.tileSource},units:S.units,graphics:S.graphics,layers:S.layers};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="scheffmap-"+new Date().toISOString().slice(0,10)+".tacmap";a.click();IO.notify("Project saved")},
  projectLoad(text){
    try{const data=JSON.parse(text);if(data.units)S.units=data.units;if(data.graphics)S.graphics=data.graphics;if(data.layers)S.layers=data.layers;if(data.map){S.lat=data.map.lat;S.lon=data.map.lon;S.zoom=data.map.zoom;if(data.map.tileSource)S.tileSource=data.map.tileSource}requestRender();updateLayerIndicator();IO.notify("Project loaded: "+S.units.length+" units")}catch(e){IO.notify("Load error: "+e.message,"error")}},
  requestImport(){
    if(IO.isNative()){window.nativeBridge.requestImport();return}
    const inp=document.createElement("input");inp.type="file";inp.accept=".tacmap,.geojson,.kml,.json";inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=ev=>{const ext=f.name.split(".").pop().toLowerCase();if(ext==="tacmap"||ext==="json")IO.projectLoad(ev.target.result);else if(ext==="geojson")IO.importGeoJSON(ev.target.result);else if(ext==="kml")IO.importKML(ev.target.result);else IO.notify("Unsupported file type","error")};reader.readAsText(f)};inp.click()},
  importGeoJSON(text){try{const fc=JSON.parse(text);if(fc.features)fc.features.forEach(f=>{if(f.geometry&&f.geometry.type==="Point"){const[lon,lat]=f.geometry.coordinates;const p=f.properties||{};S.units.push({id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat,lon,type:p.type||"infantry",affiliation:p.affiliation||"friendly",echelon:p.echelon||null,designation:p.designation||p.name||"",modifiers:[],isHQ:false,layerId:S.activeLayerId,rings:[],equipment:{}})}});requestRender();IO.notify("Imported "+fc.features.length+" features")}catch(e){IO.notify("GeoJSON error: "+e.message,"error")}},
  importKML(text){try{const parser=new DOMParser(),doc=parser.parseFromString(text,"text/xml"),pms=doc.getElementsByTagName("Placemark");let count=0;for(const pm of pms){const coords=pm.getElementsByTagName("coordinates")[0];if(!coords)continue;const parts=coords.textContent.trim().split(",");if(parts.length<2)continue;const lon=parseFloat(parts[0]),lat=parseFloat(parts[1]);const nameEl=pm.getElementsByTagName("name")[0];S.units.push({id:"u"+Date.now()+Math.random().toString(36).substr(2,4),lat,lon,type:"infantry",affiliation:"friendly",echelon:null,designation:nameEl?nameEl.textContent:"",modifiers:[],isHQ:false,layerId:S.activeLayerId,rings:[],equipment:{}});count++}requestRender();IO.notify("Imported "+count+" placemarks")}catch(e){IO.notify("KML error: "+e.message,"error")}},
  exportGeoJSON(){
    const features=S.units.map(u=>({type:"Feature",geometry:{type:"Point",coordinates:[u.lon,u.lat]},properties:{type:u.type,affiliation:u.affiliation,echelon:u.echelon,designation:u.designation,modifiers:u.modifiers}}));
    const fc={type:"FeatureCollection",features};const blob=new Blob([JSON.stringify(fc,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="scheffmap-export.geojson";a.click();IO.notify("Exported "+features.length+" units as GeoJSON")},
  exportKML(){
    let kml='<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>ScheffMap Export</name>';
    S.units.forEach(u=>{kml+="<Placemark><name>"+((u.designation||u.type).replace(/&/g,"&amp;").replace(/</g,"&lt;"))+"</name><Point><coordinates>"+u.lon+","+u.lat+",0</coordinates></Point></Placemark>"});
    kml+="</Document></kml>";const blob=new Blob([kml],{type:"application/vnd.google-earth.kml+xml"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="scheffmap-export.kml";a.click();IO.notify("Exported "+S.units.length+" units as KML")},
  autosave(){try{localStorage.setItem("scheffmap_autosave",JSON.stringify({units:S.units,graphics:S.graphics,layers:S.layers,lat:S.lat,lon:S.lon,zoom:S.zoom,tileSource:S.tileSource}))}catch(e){}},
  autorestore(){try{const d=localStorage.getItem("scheffmap_autosave");if(d){const s=JSON.parse(d);if(s.units&&s.units.length){S.units=s.units;S.graphics=s.graphics||[];S.layers=s.layers||S.layers;S.lat=s.lat||S.lat;S.lon=s.lon||S.lon;S.zoom=s.zoom||S.zoom;S.tileSource=s.tileSource||S.tileSource;return true}}}catch(e){}return false},
  autosaveClear(){localStorage.removeItem("scheffmap_autosave")},
};

// ─── KEYBOARD SHORTCUTS ──────────────────
function onKeyDown(e){
  if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.tagName==="TEXTAREA")return;
  if(e.ctrlKey&&e.key==="s"){e.preventDefault();IO.projectSave()}
  else if(e.ctrlKey&&e.key==="o"){e.preventDefault();IO.requestImport()}
  else if(e.ctrlKey&&e.key==="z"){e.preventDefault();undo()}
  else if(e.key==="Delete"||e.key==="Backspace"){if(S.selectedUnitId)deleteUnit(S.selectedUnitId);else if(S.selectedGraphicId)deleteGraphic(S.selectedGraphicId)}
  else if(e.key==="Escape"){if(S._drawMode){if(S._drawMode.points.length)undoDrawPoint();else cancelDrawing()}else if(S._placementMode){S._placementMode=null;hideModeBar()}else{deselectAll()}}}

// ─── INIT ────────────────────────────────
function init(){
  document.getElementById("app").innerHTML=`
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-dot"></div>
        <span class="topbar-title">SCHEFFMAP</span><span style="font-size:9px;opacity:0.4;margin-left:4px">v3.5</span>
        <button class="btn" id="file-btn" style="padding:2px 6px;font-size:10px;margin-left:4px">\u2630 FILE</button>
        <div class="file-menu" id="file-menu">
          <div class="fm-section">Project</div>
          <div class="fm-item" onclick="IO.autosaveClear();S.units=[];S.graphics=[];S.selectedUnitId=null;requestRender();closeFileMenu()">New Project</div>
          <div class="fm-item" onclick="IO.projectSave();closeFileMenu()">Save Project (.tacmap)</div>
          <div class="fm-item" onclick="IO.requestImport();closeFileMenu()">Open Project</div>
          <div class="fm-divider"></div>
          <div class="fm-section">Import</div>
          <div class="fm-item" onclick="IO.requestImport();closeFileMenu()">Import File (.tacmap .geojson .kml)</div>
          <div class="fm-divider"></div>
          <div class="fm-section">Export</div>
          <div class="fm-item${S.units.length?'':' disabled'}" onclick="IO.exportGeoJSON();closeFileMenu()">Export GeoJSON</div>
          <div class="fm-item${S.units.length?'':' disabled'}" onclick="IO.exportKML();closeFileMenu()">Export KML</div>
          <div class="fm-divider"></div>
          <div class="fm-status">${S.units.length} units</div>
        </div>
        <button class="btn" id="undo-btn" style="padding:2px 6px;opacity:0.3;pointer-events:none" title="Undo" onclick="undo()">\u21a9</button>
      </div>
      <span class="topbar-coords" id="coords"></span>
    </div>
    <div class="main">
      <canvas id="mapCanvas"></canvas>
      <div class="icon-stack">
        <button class="stack-btn" id="sb-settings" title="Settings"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
        <button class="stack-btn" id="sb-comms" title="Comms"><svg viewBox="0 0 24 24"><path d="M5 12.55a11 11 0 0114.08 0"/><path d="M1.42 9a16 16 0 0121.16 0"/><path d="M8.53 16.11a6 6 0 016.95 0"/><circle cx="12" cy="20" r="1" fill="currentColor"/></svg></button>
        <button class="stack-btn" id="sb-chat" title="Chat" style="display:none"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>
        <button class="stack-btn" id="sb-layers" title="Layers"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></button>
        <button class="stack-btn" id="sb-graphics" title="Graphics"><svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg></button>
        <button class="stack-btn" id="sb-addunit" title="Add Unit"><svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></button>
      </div>
      <div class="float-panel" id="float-panel">
        <div class="fp-header"><span class="fp-title" id="fp-title"></span><button class="btn" id="fp-close" style="padding:2px 6px;font-size:12px">\u2715</button></div>
        <div class="fp-body" id="fp-body"></div>
      </div>
      <div class="editor-overlay" id="editor" style="display:none"></div>
      <div class="mode-bar" id="mode-bar" style="display:none"></div>
      <div class="zoom-ctrl"><button class="btn" id="zoom-in">+</button><button class="btn" id="zoom-out">\u2212</button><button class="btn" id="zoom-fit">FIT</button></div>
      <div class="layer-indicator"><div class="dot" style="background:#4a9eff"></div>Default</div>
    </div>`;

  canvas=document.getElementById("mapCanvas");ctx=canvas.getContext("2d");

  // Resize
  function resize(){const d=devicePixelRatio||1,r=canvas.parentElement.getBoundingClientRect();canvas.style.width=r.width+"px";canvas.style.height=r.height+"px";canvas.width=r.width*d;canvas.height=r.height*d;detectLayout();requestRender()}
  window.addEventListener("resize",resize);resize();

  // Pointer events
  canvas.addEventListener("pointerdown",onPointerDown);
  canvas.addEventListener("pointermove",onPointerMove);
  canvas.addEventListener("pointerup",onPointerUp);
  canvas.addEventListener("pointercancel",onPointerUp);
  canvas.addEventListener("wheel",onWheel,{passive:false});
  canvas.addEventListener("contextmenu",onContextMenu);
  document.addEventListener("keydown",onKeyDown);

  // Stack buttons
  document.getElementById("sb-settings").addEventListener("click",()=>togglePanel("settings"));
  document.getElementById("sb-comms").addEventListener("click",()=>togglePanel("comms"));
  document.getElementById("sb-chat").addEventListener("click",()=>togglePanel("chat"));
  document.getElementById("sb-layers").addEventListener("click",()=>togglePanel("layers"));
  document.getElementById("sb-graphics").addEventListener("click",()=>togglePanel("graphics"));
  document.getElementById("sb-addunit").addEventListener("click",()=>togglePanel("addunit"));
  document.getElementById("fp-close").addEventListener("click",()=>{S._activePanel=null;document.getElementById("float-panel").classList.remove("open");document.querySelectorAll(".stack-btn").forEach(b=>b.classList.remove("active"))});

  // File menu
  document.getElementById("file-btn").addEventListener("click",toggleFileMenu);
  document.addEventListener("pointerdown",e=>{if(_fileMenuOpen&&!e.target.closest(".file-menu")&&!e.target.closest("#file-btn"))closeFileMenu()});

  // Zoom
  document.getElementById("zoom-in").addEventListener("click",()=>{S.zoom=Math.min(19,S.zoom+1);requestRender()});
  document.getElementById("zoom-out").addEventListener("click",()=>{S.zoom=Math.max(2,S.zoom-1);requestRender()});
  document.getElementById("zoom-fit").addEventListener("click",()=>{if(!S.units.length)return;let minLat=90,maxLat=-90,minLon=180,maxLon=-180;S.units.forEach(u=>{minLat=Math.min(minLat,u.lat);maxLat=Math.max(maxLat,u.lat);minLon=Math.min(minLon,u.lon);maxLon=Math.max(maxLon,u.lon)});S.lat=(minLat+maxLat)/2;S.lon=(minLon+maxLon)/2;const dLat=maxLat-minLat||0.01,dLon=maxLon-minLon||0.01;S.zoom=Math.max(2,Math.min(16,Math.floor(Math.log2(360/Math.max(dLat,dLon)))));requestRender()});

  // Outside click dismiss
  document.addEventListener("pointerdown",e=>{if(S._activePanel&&!e.target.closest(".float-panel")&&!e.target.closest(".stack-btn")&&!e.target.closest(".icon-stack")){/* keep panel */}});

  // Theme
  document.body.setAttribute("data-theme",S.theme);

  // Autorestore
  if(IO.autorestore()){requestRender();updateLayerIndicator();notify("Restored autosave")}

  // Autosave timer
  setInterval(()=>IO.autosave(),30000);
  window.addEventListener("beforeunload",()=>IO.autosave());

  // Drag and drop import
  document.addEventListener("dragover",e=>e.preventDefault());
  document.addEventListener("drop",e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(!f)return;const reader=new FileReader();reader.onload=ev=>{const ext=f.name.split(".").pop().toLowerCase();if(ext==="tacmap"||ext==="json")IO.projectLoad(ev.target.result);else if(ext==="geojson")IO.importGeoJSON(ev.target.result);else if(ext==="kml")IO.importKML(ev.target.result)};reader.readAsText(f)});

  // iOS keyboard handling
  if(window.visualViewport)window.visualViewport.addEventListener("resize",()=>{document.documentElement.style.height=window.visualViewport.height+"px"});

  // Show chat button when connected
  setInterval(()=>{const chatBtn=document.getElementById("sb-chat");if(chatBtn)chatBtn.style.display=S._net.mode!=="offline"?"":"none"},1000);

  // Service worker
  if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js").catch(()=>{})}
}

document.addEventListener("DOMContentLoaded",init);


</script>
</body>
</html>
